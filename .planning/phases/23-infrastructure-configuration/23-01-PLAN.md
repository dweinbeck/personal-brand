---
phase: 23-infrastructure-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - firestore.indexes.json
  - firebase.json
  - scripts/seed-billing.ts
  - docs/DEPLOYMENT.md
autonomous: true

must_haves:
  truths:
    - "firestore.indexes.json declares composite indexes for billing_tool_usage (uid+createdAt, uid+externalJobId) and billing_purchases (uid+createdAt)"
    - "firebase.json references both firestore.rules and firestore.indexes.json"
    - "scripts/seed-billing.ts imports and calls seedToolPricing() from src/lib/billing/tools.ts"
    - "DEPLOYMENT.md shows IAM grant to Cloud Run SA (not Cloud Build SA)"
  artifacts:
    - path: "firestore.indexes.json"
      provides: "Composite index definitions for billing Firestore queries"
      contains: "billing_tool_usage"
    - path: "firebase.json"
      provides: "Firebase deploy config referencing indexes and rules"
      contains: "firestore.indexes.json"
    - path: "scripts/seed-billing.ts"
      provides: "Seed script for billing tool pricing data"
      contains: "seedToolPricing"
    - path: "docs/DEPLOYMENT.md"
      provides: "Corrected IAM instructions"
      contains: "cloudrun-site"
  key_links:
    - from: "firebase.json"
      to: "firestore.indexes.json"
      via: "indexes field reference"
      pattern: '"indexes".*"firestore.indexes.json"'
    - from: "scripts/seed-billing.ts"
      to: "src/lib/billing/tools.ts"
      via: "import seedToolPricing"
      pattern: 'import.*seedToolPricing.*from.*billing/tools'
---

<objective>
Create all file artifacts needed for Phase 23 infrastructure configuration: Firestore composite index definitions, updated firebase.json, billing seed script, and corrected DEPLOYMENT.md.

Purpose: Produce the files that the user will deploy via CLI in Plan 02. These files are version-controlled infrastructure-as-code artifacts.
Output: 4 files created/modified, all quality gates passing.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-infrastructure-configuration/23-RESEARCH.md
@firebase.json
@firestore.rules
@src/lib/billing/firestore.ts
@src/lib/billing/tools.ts
@docs/DEPLOYMENT.md
@vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Firestore indexes and update firebase.json</name>
  <files>firestore.indexes.json, firebase.json</files>
  <action>
    1. Create `firestore.indexes.json` at project root with three composite indexes matching the billing queries in `src/lib/billing/firestore.ts`:
       - `billing_tool_usage`: fields `uid` ASC + `createdAt` DESC (for `getUserUsage()`)
       - `billing_tool_usage`: fields `uid` ASC + `externalJobId` ASC (for `findUsageByExternalJobId()`)
       - `billing_purchases`: fields `uid` ASC + `createdAt` DESC (for `getUserPurchases()`)
       Include empty `fieldOverrides` array.

    2. Update `firebase.json` to add `"indexes": "firestore.indexes.json"` inside the existing `firestore` section. The current file only has `"rules": "firestore.rules"`. Result should be:
       ```json
       {
         "firestore": {
           "rules": "firestore.rules",
           "indexes": "firestore.indexes.json"
         }
       }
       ```

    3. Verify existing `firestore.rules` already has `allow read, write: if false` (satisfying INFRA-09). Do NOT modify the rules file -- just confirm it's correct in the summary.
  </action>
  <verify>
    - `firestore.indexes.json` exists and is valid JSON
    - `firebase.json` references both rules and indexes
    - `npm run build` still succeeds (no TS impact)
    - `npm run lint` still succeeds
  </verify>
  <done>
    firestore.indexes.json contains 3 composite indexes matching billing queries; firebase.json references both rules and indexes files; firestore.rules confirmed as denying all client access (INFRA-09).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create seed script and fix DEPLOYMENT.md IAM instructions</name>
  <files>scripts/seed-billing.ts, docs/DEPLOYMENT.md</files>
  <action>
    1. Create `scripts/seed-billing.ts` that imports and calls the existing `seedToolPricing()` function from `src/lib/billing/tools.ts`. The script:
       - Imports `@/lib/firebase` to initialize the Admin SDK
       - Imports `seedToolPricing` from `@/lib/billing/tools`
       - Calls `seedToolPricing()` in an async main function
       - Logs success/failure messages
       - Exits with code 0 on success, 1 on failure
       - Can be run with `npx tsx scripts/seed-billing.ts` (tsx resolves `@/` aliases via tsconfig.json)

       Note: The vitest.config.ts already has the `@` alias configured. For tsx runtime, the user will need to ensure tsconfig paths are available. The existing `tsconfig.json` should have `"paths": { "@/*": ["./src/*"] }` which tsx respects.

    2. Fix the IAM binding error in `docs/DEPLOYMENT.md` line 163-168. The current instructions incorrectly show granting `secretmanager.secretAccessor` to the Cloud Build service account (`PROJECT_NUMBER@cloudbuild.gserviceaccount.com`). Change this to the Cloud Run service account (`cloudrun-site@PROJECT_ID.iam.gserviceaccount.com`), because:
       - Cloud Run accesses secrets at RUNTIME via its revision service account
       - The `--set-secrets` flag in cloudbuild.yaml maps secrets to env vars at deploy time
       - The Cloud Run SA is `cloudrun-site@{PROJECT_ID}.iam.gserviceaccount.com` (matching cloudbuild.yaml `_SA_NAME`)

       Also update the secret creation commands to use test-mode keys (`sk_test_`, `whsec_`) as placeholders (matching Phase 23's scope).

    3. Add a "Firestore Setup" section to DEPLOYMENT.md after the Stripe section, documenting:
       - How to deploy indexes: `firebase deploy --only firestore:indexes --project=PROJECT_ID`
       - How to deploy rules: `firebase deploy --only firestore:rules --project=PROJECT_ID`
       - How to run seed script: `npx tsx scripts/seed-billing.ts`
  </action>
  <verify>
    - `scripts/seed-billing.ts` exists and TypeScript compiles (`npx tsx --no-cache --eval "import './scripts/seed-billing.ts'" || echo "compile check"` -- this just checks syntax, actual execution requires Firestore connection)
    - `docs/DEPLOYMENT.md` references `cloudrun-site@` (not `@cloudbuild.gserviceaccount.com`)
    - `docs/DEPLOYMENT.md` contains "Firestore Setup" section with firebase deploy commands
    - `npm run build` still succeeds
    - `npm run lint` still succeeds
  </verify>
  <done>
    scripts/seed-billing.ts wraps existing seedToolPricing() for CLI execution; DEPLOYMENT.md corrected to show Cloud Run SA for secret IAM bindings; Firestore deployment instructions added to DEPLOYMENT.md.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes (0 TypeScript errors)
2. `npm run lint` passes (0 Biome errors)
3. `npm test` passes (26/26 tests)
4. `firestore.indexes.json` exists with 3 composite indexes
5. `firebase.json` has both `rules` and `indexes` fields
6. `scripts/seed-billing.ts` exists and imports seedToolPricing
7. `docs/DEPLOYMENT.md` shows cloudrun-site@ SA for IAM bindings
8. `firestore.rules` confirmed as `allow read, write: if false`
</verification>

<success_criteria>
All file artifacts for infrastructure deployment are created, version-controlled, and quality gates pass. DEPLOYMENT.md IAM instructions are corrected. The user can proceed to Plan 02 to execute infrastructure commands.
</success_criteria>

<output>
After completion, create `.planning/phases/23-infrastructure-configuration/23-01-SUMMARY.md`
</output>
