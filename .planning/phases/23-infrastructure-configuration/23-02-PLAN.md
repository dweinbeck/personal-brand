---
phase: 23-infrastructure-configuration
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified: []
autonomous: false

user_setup:
  - service: gcp-secret-manager
    why: "Store Stripe API keys securely for Cloud Run access"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key (test mode: sk_test_...)"
      - name: STRIPE_WEBHOOK_SECRET
        source: "Stripe Dashboard -> Developers -> Webhooks -> Create endpoint -> Signing secret (whsec_...)"
    dashboard_config:
      - task: "Enable Secret Manager API"
        location: "gcloud CLI: gcloud services enable secretmanager.googleapis.com"
      - task: "Create stripe-secret-key secret"
        location: "gcloud CLI: echo -n 'sk_test_...' | gcloud secrets create stripe-secret-key --data-file=-"
      - task: "Create stripe-webhook-secret secret"
        location: "gcloud CLI: echo -n 'whsec_...' | gcloud secrets create stripe-webhook-secret --data-file=-"
      - task: "Grant Cloud Run SA access to both secrets"
        location: "gcloud CLI: gcloud secrets add-iam-policy-binding"

  - service: stripe
    why: "Webhook endpoint for payment completion notifications"
    dashboard_config:
      - task: "Create webhook endpoint"
        location: "Stripe Dashboard -> Developers -> Webhooks -> Add endpoint"

  - service: firebase-auth
    why: "Google Sign-In for end users on production domain"
    dashboard_config:
      - task: "Add dan-weinbeck.com to authorized domains"
        location: "Firebase Console -> Authentication -> Settings -> Authorized domains"
      - task: "Add Cloud Run .run.app domain to authorized domains"
        location: "Firebase Console -> Authentication -> Settings -> Authorized domains"
      - task: "Enable Google Sign-In provider"
        location: "Firebase Console -> Authentication -> Sign-in method -> Google"

  - service: firebase-firestore
    why: "Deploy indexes and seed billing data"
    dashboard_config:
      - task: "Deploy composite indexes"
        location: "CLI: firebase deploy --only firestore:indexes"
      - task: "Deploy security rules"
        location: "CLI: firebase deploy --only firestore:rules"
      - task: "Run seed script"
        location: "CLI: npx tsx scripts/seed-billing.ts"

  - service: cloud-build
    why: "Verify substitution variables for billing deployment"
    dashboard_config:
      - task: "Verify _NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN is set"
        location: "GCP Console -> Cloud Build -> Triggers -> Edit trigger -> Substitution variables"

must_haves:
  truths:
    - "Stripe test-mode secrets exist in GCP Secret Manager and Cloud Run SA can access them"
    - "Stripe webhook endpoint is registered pointing to https://dan-weinbeck.com/api/billing/webhook for checkout.session.completed"
    - "Google Sign-In works on dan-weinbeck.com (Firebase Auth domains configured, provider enabled)"
    - "Firestore composite indexes exist for billing queries"
    - "Tool pricing seed data is populated with brand_scraper active at 50 credits"
    - "Firestore security rules deny client-side access to all billing collections"
    - "Cloud Build substitution variables are correct for billing deployment"
  artifacts: []
  key_links:
    - from: "GCP Secret Manager"
      to: "Cloud Run --set-secrets in cloudbuild.yaml"
      via: "Secret name references: stripe-secret-key:latest, stripe-webhook-secret:latest"
      pattern: "stripe-secret-key"
    - from: "Stripe webhook endpoint"
      to: "src/app/api/billing/webhook/route.ts"
      via: "HTTPS POST to https://dan-weinbeck.com/api/billing/webhook"
      pattern: "dan-weinbeck.com/api/billing/webhook"
    - from: "Firebase Auth authorized domains"
      to: "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN env var"
      via: "Auth domain must be in authorized list for signInWithPopup to work"
      pattern: "firebaseapp.com"
---

<objective>
Execute all infrastructure configuration commands to set up GCP Secret Manager, Stripe webhook, Firebase Auth, Firestore indexes/rules/seed data, and verify Cloud Build substitutions.

Purpose: After this plan completes, all external services are configured and ready for the first billing-enabled deployment in Phase 24.
Output: All 9 INFRA requirements satisfied. No file changes -- this is a pure infrastructure execution plan.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-infrastructure-configuration/23-RESEARCH.md
@.planning/phases/23-infrastructure-configuration/23-01-SUMMARY.md
@cloudbuild.yaml
@scripts/deploy.sh
@firestore.indexes.json
@firebase.json
@docs/DEPLOYMENT.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Configure GCP Secret Manager and Stripe webhook (INFRA-01, INFRA-02, INFRA-03)</name>
  <action>
    **IMPORTANT: Order matters. Create Stripe webhook FIRST to get the signing secret, then store both secrets in GCP Secret Manager.**

    **Step A: Enable Secret Manager API**
    ```bash
    PROJECT_ID="<your-gcp-project-id>"
    gcloud services enable secretmanager.googleapis.com --project="${PROJECT_ID}"
    ```

    **Step B: Create Stripe webhook endpoint (to get whsec_ signing secret)**

    Option 1 - Stripe Dashboard:
    1. Go to https://dashboard.stripe.com/test/webhooks (use test mode)
    2. Click "Add endpoint"
    3. Endpoint URL: `https://dan-weinbeck.com/api/billing/webhook`
    4. Select events: `checkout.session.completed`
    5. Click "Add endpoint"
    6. IMMEDIATELY copy the signing secret (`whsec_...`) -- it's only shown at creation

    Option 2 - Stripe API:
    ```bash
    curl https://api.stripe.com/v1/webhook_endpoints \
      -u "sk_test_YOUR_SECRET_KEY:" \
      -d "enabled_events[]=checkout.session.completed" \
      --data-urlencode "url=https://dan-weinbeck.com/api/billing/webhook"
    # Response includes: { "secret": "whsec_..." }
    ```

    **Step C: Create secrets in GCP Secret Manager**
    ```bash
    # Use your real test-mode Stripe secret key (sk_test_...)
    echo -n "sk_test_YOUR_REAL_KEY" | gcloud secrets create stripe-secret-key \
      --data-file=- \
      --project="${PROJECT_ID}"

    # Use the whsec_ signing secret from Step B
    echo -n "whsec_YOUR_REAL_SECRET" | gcloud secrets create stripe-webhook-secret \
      --data-file=- \
      --project="${PROJECT_ID}"
    ```

    **Step D: Grant Cloud Run service account access**
    ```bash
    SA_EMAIL="cloudrun-site@${PROJECT_ID}.iam.gserviceaccount.com"

    gcloud secrets add-iam-policy-binding stripe-secret-key \
      --member="serviceAccount:${SA_EMAIL}" \
      --role="roles/secretmanager.secretAccessor" \
      --project="${PROJECT_ID}"

    gcloud secrets add-iam-policy-binding stripe-webhook-secret \
      --member="serviceAccount:${SA_EMAIL}" \
      --role="roles/secretmanager.secretAccessor" \
      --project="${PROJECT_ID}"
    ```

    **Verification commands:**
    ```bash
    # Verify secrets exist
    gcloud secrets list --project="${PROJECT_ID}" --filter="name:stripe"

    # Verify IAM bindings
    gcloud secrets get-iam-policy stripe-secret-key --project="${PROJECT_ID}"
    gcloud secrets get-iam-policy stripe-webhook-secret --project="${PROJECT_ID}"
    ```
  </action>
  <resume-signal>Type "secrets done" when all 4 steps are complete and verified, or describe any errors</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Configure Firebase Auth domains and Google Sign-In (INFRA-04, INFRA-05)</name>
  <action>
    **Step A: Get Cloud Run .run.app URL**
    ```bash
    gcloud run services describe personal-brand \
      --region=us-central1 \
      --format="value(status.url)" \
      --project="${PROJECT_ID}"
    # Returns something like: https://personal-brand-HASH-uc.a.run.app
    ```

    **Step B: Add authorized domains to Firebase Auth**

    Option 1 - Firebase Console (recommended for first time):
    1. Go to https://console.firebase.google.com -> Your project -> Authentication -> Settings
    2. Scroll to "Authorized domains"
    3. Click "Add domain"
    4. Add: `dan-weinbeck.com`
    5. Click "Add domain" again
    6. Add the Cloud Run `.run.app` domain from Step A (e.g., `personal-brand-HASH-uc.a.run.app`)
    7. Verify defaults are still present: `localhost`, `*.firebaseapp.com`, `*.web.app`

    Option 2 - REST API:
    ```bash
    TOKEN=$(gcloud auth print-access-token)

    # GET current domains first
    curl --silent --request GET \
      --header "Authorization: Bearer ${TOKEN}" \
      "https://identitytoolkit.googleapis.com/v2/projects/${PROJECT_ID}/config" \
      | jq '.authorizedDomains'

    # PATCH with ALL domains (existing + new) -- this REPLACES the entire list!
    curl --request PATCH \
      --header "Authorization: Bearer ${TOKEN}" \
      --header "Content-Type: application/json" \
      --data '{
        "authorizedDomains": [
          "localhost",
          "YOUR_PROJECT.firebaseapp.com",
          "YOUR_PROJECT.web.app",
          "dan-weinbeck.com",
          "personal-brand-HASH-uc.a.run.app"
        ]
      }' \
      "https://identitytoolkit.googleapis.com/v2/projects/${PROJECT_ID}/config?updateMask=authorizedDomains"
    ```

    **Step C: Enable Google Sign-In provider (if not already enabled)**
    1. Go to Firebase Console -> Authentication -> Sign-in method
    2. Check if "Google" provider is already enabled
    3. If not: Click "Google" -> Toggle "Enable" -> Set project support email -> Save

    **Verification:**
    - Firebase Console -> Authentication -> Settings -> Authorized domains shows `dan-weinbeck.com` and `.run.app` domain
    - Firebase Console -> Authentication -> Sign-in method shows Google as "Enabled"
  </action>
  <resume-signal>Type "firebase auth done" when domains are added and Google Sign-In is enabled, or describe any errors</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Deploy Firestore indexes, rules, and seed data (INFRA-07, INFRA-08, INFRA-09)</name>
  <action>
    **Step A: Deploy Firestore composite indexes and security rules**
    ```bash
    # Deploy both indexes and rules together
    firebase deploy --only firestore --project=YOUR_PROJECT_ID

    # Or separately:
    # firebase deploy --only firestore:indexes --project=YOUR_PROJECT_ID
    # firebase deploy --only firestore:rules --project=YOUR_PROJECT_ID
    ```

    Note: Index creation is asynchronous. After deployment, indexes enter a "CREATING" state that can take 5-10 minutes.

    **Step B: Verify indexes are building**
    ```bash
    # Check index status
    firebase firestore:indexes --project=YOUR_PROJECT_ID
    ```
    Wait until all 3 indexes show status "READY" (or check Firebase Console -> Firestore -> Indexes).

    **Step C: Run billing seed script**
    ```bash
    # Ensure Firebase Admin credentials are available
    # (source .env.local or set GOOGLE_APPLICATION_CREDENTIALS)
    npx tsx scripts/seed-billing.ts
    ```
    Expected output: "Seeding billing tool pricing..." then "Done."

    **Step D: Verify seed data in Firestore**
    Check Firebase Console -> Firestore -> `billing_tool_pricing` collection:
    - `brand_scraper`: active=true, creditsPerUse=50
    - `lesson_60s`: active=false, creditsPerUse=10
    - `bus_text`: active=false, creditsPerUse=5
    - `dave_ramsey`: active=false, creditsPerUse=10

    **Verification:**
    - All 3 composite indexes show "READY" status
    - `billing_tool_pricing` has 4 documents with correct data
    - Security rules are deployed (Console shows `allow read, write: if false`)
  </action>
  <resume-signal>Type "firestore done" when indexes are READY, seed data is populated, and rules are deployed, or describe any errors</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 4: Verify Cloud Build substitution variables (INFRA-06)</name>
  <action>
    **Step A: Check Cloud Build trigger substitution variables**
    1. Go to GCP Console -> Cloud Build -> Triggers
    2. Edit the trigger for `personal-brand` (master branch)
    3. Check "Substitution variables" section
    4. Verify these variables are set with correct values:

    | Variable | Expected Value | Notes |
    |----------|---------------|-------|
    | `_NEXT_PUBLIC_FIREBASE_API_KEY` | Your Firebase API key | From Firebase Console -> Project Settings |
    | `_NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN` | `YOUR_PROJECT.firebaseapp.com` | NOT `dan-weinbeck.com` -- use Firebase default |
    | `_NEXT_PUBLIC_FIREBASE_PROJECT_ID` | Your GCP project ID | Same as FIREBASE_PROJECT_ID |
    | `_CHATBOT_API_URL` | Your FastAPI chatbot Cloud Run URL | e.g., `https://chatbot-HASH-uc.a.run.app` |
    | `_BRAND_SCRAPER_API_URL` | Your Brand Scraper Cloud Run URL | e.g., `https://brand-scraper-HASH-uc.a.run.app` |

    **Key insight for INFRA-06:** `_NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN` should be `YOUR_PROJECT.firebaseapp.com` (the Firebase default). Custom auth domains require Firebase Hosting setup and are out of scope. The production domain `dan-weinbeck.com` goes in the Firebase Auth *authorized domains* list (done in Task 2), NOT in this env var.

    **Step B: Verify `--set-secrets` in cloudbuild.yaml is correct**
    The deploy step already includes:
    ```
    --set-secrets=GITHUB_TOKEN=github-token:latest,TODOIST_API_TOKEN=todoist-api-token:latest,STRIPE_SECRET_KEY=stripe-secret-key:latest,STRIPE_WEBHOOK_SECRET=stripe-webhook-secret:latest
    ```
    This references the secrets created in Task 1 by their Secret Manager names (`stripe-secret-key`, `stripe-webhook-secret`). No changes needed.

    **Verification:**
    - All 5 substitution variables have non-empty values
    - `_NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN` uses `*.firebaseapp.com` format
    - `_BRAND_SCRAPER_API_URL` is set (needed for brand scraper tool flow)
  </action>
  <resume-signal>Type "cloud build verified" when all substitution variables are confirmed correct, or list any missing/incorrect values</resume-signal>
</task>

</tasks>

<verification>
**All 9 INFRA requirements verified:**

| Req | Criterion | How to Verify |
|-----|-----------|---------------|
| INFRA-01 | Stripe secrets in GCP Secret Manager | `gcloud secrets list --filter="name:stripe"` shows 2 secrets |
| INFRA-02 | Stripe webhook registered | Stripe Dashboard shows endpoint for `dan-weinbeck.com/api/billing/webhook` |
| INFRA-03 | Cloud Run SA has secretAccessor | `gcloud secrets get-iam-policy stripe-secret-key` shows cloudrun-site@ |
| INFRA-04 | Firebase Auth authorized domains | Console shows dan-weinbeck.com and .run.app domain |
| INFRA-05 | Google Sign-In enabled | Console shows Google provider as Enabled |
| INFRA-06 | Cloud Build substitutions correct | Trigger shows _NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN = *.firebaseapp.com |
| INFRA-07 | Composite indexes exist | `firebase firestore:indexes` shows 3 indexes as READY |
| INFRA-08 | Seed data populated | Firestore Console shows brand_scraper active at 50 credits |
| INFRA-09 | Security rules deny client access | Console shows `allow read, write: if false` |
</verification>

<success_criteria>
All external services (GCP Secret Manager, Stripe, Firebase Auth, Firestore) are configured and ready to receive a billing-enabled deployment. Phase 24 (Deploy & Smoke Test) can proceed.
</success_criteria>

<output>
After completion, create `.planning/phases/23-infrastructure-configuration/23-02-SUMMARY.md`
</output>
