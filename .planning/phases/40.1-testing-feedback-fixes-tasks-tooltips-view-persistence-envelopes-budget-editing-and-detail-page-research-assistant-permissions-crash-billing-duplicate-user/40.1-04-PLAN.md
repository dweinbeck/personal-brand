---
phase: 40.1-testing-feedback-fixes
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/envelopes/[envelopeId]/page.tsx
  - src/components/envelopes/EnvelopeDetailPage.tsx
  - src/lib/envelopes/hooks.ts
  - src/components/envelopes/EnvelopeCard.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking an envelope card on the home page navigates to /envelopes/{envelopeId}"
    - "The envelope detail page shows the envelope name, budget, status, and remaining amount"
    - "The detail page lists all transactions for the current week filtered to that envelope"
    - "User can add a new transaction from the detail page with the envelope pre-filled and hidden"
    - "User can navigate back to the envelope home page"
  artifacts:
    - path: "src/app/envelopes/[envelopeId]/page.tsx"
      provides: "Next.js dynamic route page for individual envelope"
      contains: "EnvelopeDetailPage"
    - path: "src/components/envelopes/EnvelopeDetailPage.tsx"
      provides: "Client component showing envelope details and filtered transactions"
      contains: "EnvelopeDetailPage"
    - path: "src/lib/envelopes/hooks.ts"
      provides: "useEnvelopeTransactions hook for fetching transactions filtered by envelope"
      contains: "useEnvelopeTransactions"
  key_links:
    - from: "src/components/envelopes/EnvelopeCard.tsx"
      to: "/envelopes/[envelopeId]"
      via: "Next.js Link or router.push on card click"
      pattern: "href.*envelopeId"
    - from: "src/components/envelopes/EnvelopeDetailPage.tsx"
      to: "src/lib/envelopes/hooks.ts"
      via: "useEnvelopes and useTransactions hooks"
      pattern: "useEnvelopes|useTransactions"
---

<objective>
Create an envelope detail page that users navigate to by clicking an envelope card. The detail page shows envelope info and its current-week transactions with an inline form to add new transactions.

Purpose: Users want to click an envelope card to see its transactions and add new ones specific to that envelope, without navigating through the full transactions page.
Output: New route `/envelopes/[envelopeId]` with a detail page component showing envelope summary + filtered transactions + inline add form.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/components/envelopes/EnvelopeCard.tsx
@src/components/envelopes/EnvelopesHomePage.tsx
@src/components/envelopes/TransactionsPage.tsx
@src/components/envelopes/InlineTransactionForm.tsx
@src/components/envelopes/TransactionList.tsx
@src/components/envelopes/TransactionRow.tsx
@src/lib/envelopes/hooks.ts
@src/lib/envelopes/types.ts
@src/lib/envelopes/api.ts
@src/lib/envelopes/format.ts
@src/lib/envelopes/week-math.ts
@src/app/envelopes/layout.tsx
@src/app/envelopes/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create envelope detail page route and component</name>
  <files>src/app/envelopes/[envelopeId]/page.tsx, src/components/envelopes/EnvelopeDetailPage.tsx</files>
  <action>
  1. Create `src/app/envelopes/[envelopeId]/page.tsx`:
     ```tsx
     "use client";

     import { use } from "react";
     import { EnvelopeDetailPage } from "@/components/envelopes/EnvelopeDetailPage";
     import { useAuth } from "@/context/AuthContext";
     import { redirect } from "next/navigation";

     export default function Page({ params }: { params: Promise<{ envelopeId: string }> }) {
       const { envelopeId } = use(params);
       const { user, loading } = useAuth();

       if (loading) {
         return (
           <div className="flex items-center justify-center min-h-[50vh]">
             <p className="text-text-tertiary text-sm">Loading...</p>
           </div>
         );
       }

       if (!user) {
         redirect("/envelopes");
       }

       return <EnvelopeDetailPage envelopeId={envelopeId} />;
     }
     ```
     NOTE: Next.js 16 uses `params: Promise<...>` which must be unwrapped with `use()`.

  2. Create `src/components/envelopes/EnvelopeDetailPage.tsx`:
     This component should:
     - Use `useEnvelopes()` to get the full list and find the specific envelope by ID
     - Use `useTransactions(weekStartStr, weekEndStr)` to get current-week transactions, then client-side filter to only show transactions for this envelope
     - Show a header with the envelope title, status badge, and a back link to `/envelopes`
     - Show budget summary: remaining/budget, spent, status
     - Show the list of filtered transactions using a simple table (date, merchant, description, amount) â€” reuse the styling from TransactionRow or create a simpler inline list
     - Show an "Add Transaction" button that toggles the InlineTransactionForm with:
       - `envelopeId` pre-filled (the current envelope's ID)
       - Current week's date range for min/max dates
       - Today's date as default
     - When a transaction is added, mutate both useEnvelopes and useTransactions to refresh
     - Handle the overage flow by checking if envelope is now over budget after adding

     The component should follow the same patterns as TransactionsPage.tsx but scoped to a single envelope. Key differences:
     - No WeekSelector (always shows current week)
     - No envelope dropdown in the form (envelope is implicit)
     - Includes envelope summary info at the top
     - Back navigation link

     Use `formatCents` from `@/lib/envelopes/format` for dollar formatting.
     Use `StatusBadge` from `@/components/envelopes/StatusBadge` for status display.
     Use `getWeekRange` from `@/lib/envelopes/week-math` for week calculations.
     Use `format` from `date-fns` for date string formatting.

     Layout structure:
     ```
     [Back to Envelopes link]
     [Envelope Title]  [StatusBadge]
     [Remaining] of [Budget] budget  |  [Spent] spent this week
     ---
     [Add Transaction button / InlineTransactionForm]
     ---
     [Transaction list for this envelope, current week]
     ```
  </action>
  <verify>
  - `npm run lint` passes
  - `npm run build` passes
  - Route file exists at `src/app/envelopes/[envelopeId]/page.tsx`
  - Component file exists at `src/components/envelopes/EnvelopeDetailPage.tsx`
  </verify>
  <done>
  Navigating to `/envelopes/{id}` shows the envelope's details and transactions for the current week. Users can add transactions directly from this page.
  </done>
</task>

<task type="auto">
  <name>Task 2: Make EnvelopeCard clickable to navigate to detail page</name>
  <files>src/components/envelopes/EnvelopeCard.tsx</files>
  <action>
  Make the EnvelopeCard navigate to `/envelopes/{envelopeId}` when clicked in NON-edit mode. In edit mode, the card should NOT be clickable (edit/delete buttons take priority).

  1. Import `Link` from `next/link` (or use `useRouter` from `next/navigation`)
  2. When `isEditMode` is false:
     - Wrap the Card content in a `<Link href={`/envelopes/${envelope.id}`}>` or make the Card itself a clickable link
     - Use `cursor-pointer` class and add hover state: `hover:border-gold/50` or `hover:shadow-md`
     - The entire card should be the click target (not just the title)
  3. When `isEditMode` is true:
     - Card is NOT clickable (current behavior with edit/delete buttons)

  Approach: Use a conditional wrapper. In non-edit mode, wrap the Card in a Next.js Link. In edit mode, render the Card as-is.

  Important: Do NOT make the card clickable when `isDeleting` is true either (delete confirmation UI is showing).
  </action>
  <verify>
  - `npm run lint` passes
  - `npm run build` passes
  - EnvelopeCard renders a Link wrapper when not in edit mode
  - EnvelopeCard does NOT link when in edit mode
  </verify>
  <done>
  Clicking an envelope card in normal view mode navigates to the envelope's detail page. Cards in edit mode remain non-clickable so users can use edit/delete buttons.
  </done>
</task>

</tasks>

<verification>
- `npm run lint && npm run build && npm test` all pass
- Clicking an envelope card navigates to `/envelopes/{id}`
- Detail page shows envelope info + current-week transactions
- InlineTransactionForm on detail page has envelope pre-filled
- Back link returns to `/envelopes`
- Edit mode cards are not clickable
</verification>

<success_criteria>
Users can click an envelope card to see its detail page with transactions and add new transactions specific to that envelope.
</success_criteria>

<output>
After completion, create `.planning/phases/40.1-testing-feedback-fixes-tasks-tooltips-view-persistence-envelopes-budget-editing-and-detail-page-research-assistant-permissions-crash-billing-duplicate-user/40.1-04-SUMMARY.md`
</output>
