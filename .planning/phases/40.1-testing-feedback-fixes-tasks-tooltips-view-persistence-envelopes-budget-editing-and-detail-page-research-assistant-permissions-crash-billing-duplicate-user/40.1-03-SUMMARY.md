---
phase: 40.1-testing-feedback-fixes
plan: 03
subsystem: payments
tags: [firebase, firestore, billing, deduplication, admin]

# Dependency graph
requires:
  - phase: 34-weekly-credit-gating
    provides: billing system with billing_users collection and admin billing page
provides:
  - Email-based deduplication in ensureBillingUser prevents future duplicate billing users
  - consolidateBillingUsers function for admin merge of existing duplicates
  - POST /api/admin/billing/users/consolidate endpoint with admin auth
  - Duplicate badge and Consolidate button in admin billing UI
affects: [billing, admin]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Email-based deduplication with canonicalUid stub document pattern"
    - "Admin consolidation with atomic Firestore transaction merging balances and lifetime stats"

key-files:
  created:
    - src/app/api/admin/billing/users/consolidate/route.ts
  modified:
    - src/lib/billing/firestore.ts
    - src/components/admin/billing/AdminBillingPage.tsx

key-decisions:
  - "Email dedup query runs outside transaction to avoid complexity; stub doc created at new UID with canonicalUid field"
  - "Consolidation keeps the user with more credits by default in UI; merges all lifetime stats atomically"
  - "Consolidation creates admin_adjustment ledger entry to maintain audit trail"

patterns-established:
  - "canonicalUid field pattern: stub billing_users documents point to canonical account"
  - "Duplicate detection in admin UI: group by email, show badge + action for duplicates"

# Metrics
duration: 12min
completed: 2026-02-16
---

# Phase 40.1 Plan 03: Billing Duplicate User Summary

**Email deduplication in ensureBillingUser with canonicalUid stub pattern, plus admin consolidation endpoint and duplicate warning UI in billing management page**

## Performance

- **Duration:** 12 min
- **Started:** 2026-02-17T02:53:09Z
- **Completed:** 2026-02-17T03:05:09Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments
- ensureBillingUser now checks for existing email match before creating new billing entries, preventing future duplicates from different auth providers
- New consolidateBillingUsers function merges credits, lifetime stats, and deletes duplicate atomically in a Firestore transaction
- Admin billing page highlights duplicate email entries with amber "Duplicate" badge and provides one-click "Consolidate" button
- Admin consolidation API endpoint with Zod validation and admin auth protection

## Task Commits

Each task was committed atomically:

1. **Task 1: Add email deduplication to ensureBillingUser and create consolidation function** - `c922725` (feat)
2. **Task 2: Create admin consolidation endpoint and add UI warning for duplicates** - `9fdaa42` (included in prior agent's docs commit)

## Files Created/Modified
- `src/lib/billing/firestore.ts` - Email dedup in ensureBillingUser, consolidateBillingUsers function
- `src/app/api/admin/billing/users/consolidate/route.ts` - POST endpoint for admin consolidation
- `src/components/admin/billing/AdminBillingPage.tsx` - Duplicate badge, consolidate button, handleConsolidate logic

## Decisions Made
- Email dedup query runs outside the transaction since it's a read-only check, avoiding transaction complexity
- Stub document at the new UID includes canonicalUid field pointing to the original billing user
- Consolidation automatically keeps the user with higher credit balance and merges the other
- Consolidation creates admin_adjustment ledger entry for audit trail before deleting the duplicate

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
- Pre-existing build error (missing EnvelopeDetailPage component from plan 02's uncommitted files) prevented full `npm run build` verification; used lint + tsc + test to verify instead
- Task 2 changes were inadvertently committed by a concurrent plan-01 agent in commit 9fdaa42; verified all changes are correct and in place

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Billing duplicate user issue is fully addressable from admin UI
- Future duplicate prevention is automatic via email dedup in ensureBillingUser
- Ready for plan 04 execution

## Self-Check: PASSED

- src/lib/billing/firestore.ts: FOUND
- src/app/api/admin/billing/users/consolidate/route.ts: FOUND
- src/components/admin/billing/AdminBillingPage.tsx: FOUND
- Commit c922725: FOUND
- Commit 9fdaa42: FOUND

---
*Phase: 40.1-testing-feedback-fixes*
*Completed: 2026-02-16*
