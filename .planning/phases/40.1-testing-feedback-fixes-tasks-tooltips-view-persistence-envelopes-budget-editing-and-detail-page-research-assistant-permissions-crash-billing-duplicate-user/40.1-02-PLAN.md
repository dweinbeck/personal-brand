---
phase: 40.1-testing-feedback-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/tools/research-assistant/ResponseDisplay.tsx
  - src/lib/hooks/use-credit-balance.ts
autonomous: true

must_haves:
  truths:
    - "Research Assistant does not crash when Firestore permissions expire during a session"
    - "Token usage display does not crash when usage data is partially undefined"
    - "Credit balance listener recovers gracefully from permission errors"
  artifacts:
    - path: "src/components/tools/research-assistant/ResponseDisplay.tsx"
      provides: "Safe access to usage.promptTokens and usage.completionTokens with fallback"
      contains: "toLocaleString"
    - path: "src/lib/hooks/use-credit-balance.ts"
      provides: "Error handling that sets balance to fallback instead of crashing"
      contains: "error"
  key_links:
    - from: "src/lib/hooks/use-credit-balance.ts"
      to: "billing_users Firestore collection"
      via: "onSnapshot listener with error callback"
      pattern: "onSnapshot.*error"
---

<objective>
Fix the Research Assistant crash caused by Firestore permissions errors on the credit balance listener and undefined usage token data in the response display.

Purpose: Users experience 500 errors and crashes when the Firestore auth token expires during a research session. The `useCreditBalance` hook's `onSnapshot` listener fires an error callback but the error is only logged, not handled gracefully. Additionally, `response.usage.promptTokens.toLocaleString()` crashes when `promptTokens` is undefined.
Output: Both error scenarios are handled gracefully without crashing the UI.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/components/tools/research-assistant/ResponseDisplay.tsx
@src/lib/hooks/use-credit-balance.ts
@src/components/tools/research-assistant/CreditBalanceDisplay.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ResponseDisplay token usage crash and credit balance error handling</name>
  <files>src/components/tools/research-assistant/ResponseDisplay.tsx, src/lib/hooks/use-credit-balance.ts</files>
  <action>
  In `ResponseDisplay.tsx` (line 131), the token usage display calls:
  ```
  response.usage.promptTokens.toLocaleString()
  response.usage.completionTokens.toLocaleString()
  ```
  This crashes with `TypeError: Cannot read properties of undefined (reading 'toLocaleString')` when `response.usage` exists but `promptTokens` or `completionTokens` is undefined.

  Fix: Replace line 131's expression with safe optional chaining:
  ```tsx
  {response.usage
    ? `Tokens: ${(response.usage.promptTokens ?? 0).toLocaleString()} in / ${(response.usage.completionTokens ?? 0).toLocaleString()} out`
    : "Usage data unavailable"}
  ```

  In `use-credit-balance.ts` (line 33-35), the error callback only logs the error and sets loading to false. When Firestore permissions expire:
  1. Add an `error` state: `const [error, setError] = useState<Error | null>(null);`
  2. In the error callback, set the error state and set balance to the last known value (keep current balance if available, otherwise 0):
     ```ts
     (error) => {
       console.error("Credit balance listener error:", error);
       setError(error);
       setLoading(false);
       // Don't clear balance — keep last known value so UI doesn't break
     },
     ```
  3. Return `error` from the hook: `return { balance, loading, error };`
  4. This is a non-breaking change — existing consumers ignore the new `error` field.

  In `CreditBalanceDisplay.tsx` — no changes needed since it already handles `balance === null` gracefully. The key fix is in the hook not crashing and in ResponseDisplay not crashing on undefined tokens.
  </action>
  <verify>
  - `npm run lint` passes
  - `npm run build` passes
  - Confirm `ResponseDisplay.tsx` uses optional chaining / nullish coalescing for token display
  - Confirm `use-credit-balance.ts` exposes `error` and doesn't crash on Firestore permission errors
  </verify>
  <done>
  The Research Assistant no longer crashes when Firestore permissions expire. Token usage shows "0" for any undefined values instead of crashing. The credit balance listener continues to show the last known balance instead of breaking the UI.
  </done>
</task>

</tasks>

<verification>
- `npm run lint && npm run build && npm test` all pass
- ResponseDisplay token usage line uses safe access (optional chaining or nullish coalescing)
- use-credit-balance error callback doesn't clear balance state
</verification>

<success_criteria>
Research Assistant page does not crash on Firestore permission errors or undefined token usage data.
</success_criteria>

<output>
After completion, create `.planning/phases/40.1-testing-feedback-fixes-tasks-tooltips-view-persistence-envelopes-budget-editing-and-detail-page-research-assistant-permissions-crash-billing-duplicate-user/40.1-02-SUMMARY.md`
</output>
