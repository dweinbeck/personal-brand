---
phase: 40.1-testing-feedback-fixes
plan: 02
subsystem: ui
tags: [react, firestore, error-handling, research-assistant, credit-balance]

# Dependency graph
requires:
  - phase: research-assistant
    provides: ResponseDisplay component and useCreditBalance hook
provides:
  - Crash-safe token usage display with nullish coalescing
  - Graceful Firestore permission error handling in credit balance listener
  - Error state exposed from useCreditBalance hook
affects: [research-assistant, billing]

# Tech tracking
tech-stack:
  added: []
  patterns: [nullish-coalescing-for-optional-data, graceful-listener-error-recovery]

key-files:
  created: []
  modified:
    - src/components/tools/research-assistant/ResponseDisplay.tsx
    - src/lib/hooks/use-credit-balance.ts

key-decisions:
  - "Keep last known balance on Firestore permission errors instead of clearing to null"
  - "Use nullish coalescing (0 fallback) for undefined token counts rather than optional chaining"

patterns-established:
  - "Firestore onSnapshot error callbacks should preserve last known state rather than clearing"
  - "Always use nullish coalescing for numeric display values from API responses"

# Metrics
duration: 13min
completed: 2026-02-16
---

# Phase 40.1 Plan 02: Research Assistant Permissions Crash Fix Summary

**Nullish coalescing for token display and graceful Firestore error recovery in credit balance listener**

## Performance

- **Duration:** 13 min
- **Started:** 2026-02-17T02:53:05Z
- **Completed:** 2026-02-17T03:06:17Z
- **Tasks:** 1
- **Files modified:** 2

## Accomplishments
- Fixed crash when `response.usage.promptTokens` or `completionTokens` is undefined by adding nullish coalescing (`?? 0`)
- Added `error` state to `useCreditBalance` hook so Firestore permission errors are tracked rather than silently swallowed
- Credit balance listener now preserves last known balance on error instead of leaving UI in broken state
- Error exposed from hook as non-breaking addition (existing consumers like CreditBalanceDisplay ignore it)

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix ResponseDisplay token usage crash and credit balance error handling** - `d6389ff` (fix)

**Plan metadata:** TBD (docs: complete plan)

## Files Created/Modified
- `src/components/tools/research-assistant/ResponseDisplay.tsx` - Added `?? 0` fallback for promptTokens and completionTokens in token display string
- `src/lib/hooks/use-credit-balance.ts` - Added error state, graceful Firestore error handling, preserved last known balance on errors

## Decisions Made
- Used `?? 0` (nullish coalescing with zero fallback) rather than optional chaining with empty string, so token counts always display as numbers
- Keep last known balance on Firestore permission errors rather than clearing to null -- prevents downstream display crash in CreditBalanceDisplay
- Renamed error callback parameter from `error` to `err` to avoid shadowing the state setter variable name

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
- Turbopack build had transient ENOENT errors requiring multiple `.next` directory cleanups before succeeding -- pre-existing infrastructure issue unrelated to code changes
- Pre-existing TypeScript errors in 3 test files (conversation-store, integration, streaming-controller-phase3) for ModelMessage content types -- not related to this plan

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Research Assistant crash fix complete, ready for manual verification
- No blockers for subsequent plans

## Self-Check: PASSED

All files exist, commit verified, key code patterns confirmed in both modified files.

---
*Phase: 40.1-testing-feedback-fixes*
*Completed: 2026-02-16*
