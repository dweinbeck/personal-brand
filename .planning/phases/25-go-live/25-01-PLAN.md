---
phase: 25-go-live
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

user_setup:
  - service: stripe
    why: "Live payment processing requires activated account and live API keys"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard (live mode) -> Developers -> API keys -> Secret key (sk_live_*)"
      - name: STRIPE_WEBHOOK_SECRET
        source: "Stripe Dashboard (live mode) -> Developers -> Webhooks -> Add endpoint -> Signing secret (whsec_*)"
    dashboard_config:
      - task: "Verify Stripe account is fully activated (KYC complete)"
        location: "Stripe Dashboard -> Settings -> Account details"
      - task: "Register live webhook endpoint for https://dan-weinbeck.com/api/billing/webhook listening to checkout.session.completed"
        location: "Stripe Dashboard (live mode) -> Developers -> Webhooks -> Add endpoint"

must_haves:
  truths:
    - "GCP Secret Manager stripe-secret-key contains a live key (sk_live_*)"
    - "GCP Secret Manager stripe-webhook-secret contains a live webhook signing secret (whsec_* from live endpoint)"
    - "Cloud Run is running a revision that was deployed AFTER the secret updates"
    - "A real $5 purchase completes: Checkout loads, payment succeeds, webhook fires (HTTP 200), 500 credits are granted"
  artifacts: []
  key_links:
    - from: "Stripe Dashboard (live mode)"
      to: "GCP Secret Manager"
      via: "sk_live_* and whsec_* copied into new secret versions"
      pattern: "gcloud secrets versions add"
    - from: "GCP Secret Manager (:latest)"
      to: "Cloud Run environment variables"
      via: "New revision resolves :latest at startup"
      pattern: "Cloud Build deploy"
    - from: "Cloud Run /api/billing/webhook"
      to: "Stripe live events"
      via: "Webhook signature verification using live whsec_*"
      pattern: "checkout.session.completed"
---

<objective>
Switch the billing system from Stripe test mode to live mode by updating two GCP Secret Manager secrets with live Stripe keys, redeploying Cloud Run, and verifying a real $5 purchase.

Purpose: This is the final phase of v1.5 -- making the billing system accept real payments. Zero code changes required. The existing codebase uses environment-based secrets, inline price_data, and server-side-only Stripe integration, so switching from test to live is purely an infrastructure operation.

Output: A live billing system that accepts real credit card payments and grants credits.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-go-live/25-RESEARCH.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Configure live Stripe keys in GCP Secret Manager</name>
  <action>
The user must perform these steps in order. There are no code changes -- this is entirely infrastructure configuration.

**Step 1: Verify Stripe account activation**
1. Go to https://dashboard.stripe.com/settings/account
2. Confirm account status shows "Activated" or "Live" (not "Test only")
3. If not activated, complete KYC (business info, identity verification, bank account) before proceeding

**Step 2: Copy live secret key**
1. In Stripe Dashboard, ensure you are in LIVE mode (not test mode -- check the toggle in the top-right or confirm URL is `dashboard.stripe.com` without `/test`)
2. Go to Developers > API keys
3. Reveal and copy the Secret key (`sk_live_...`)

**Step 3: Register live webhook endpoint**
1. In Stripe Dashboard (LIVE mode), go to Developers > Webhooks
2. Click "Add endpoint"
3. Endpoint URL: `https://dan-weinbeck.com/api/billing/webhook`
4. Select event: `checkout.session.completed` (under "Checkout" category)
5. Click "Add endpoint"
6. Copy the Signing secret (`whsec_...`) -- shown on the endpoint detail page

**Step 4: Update GCP Secret Manager**
Run these commands in your terminal, replacing the placeholder values with the real keys from steps 2 and 3:

```bash
# Update stripe-secret-key with live key
echo -n "sk_live_YOUR_LIVE_SECRET_KEY" | \
  gcloud secrets versions add stripe-secret-key \
    --data-file=- \
    --project="$(gcloud config get-value project)"

# Update stripe-webhook-secret with live webhook signing secret
echo -n "whsec_YOUR_LIVE_WEBHOOK_SECRET" | \
  gcloud secrets versions add stripe-webhook-secret \
    --data-file=- \
    --project="$(gcloud config get-value project)"

# Verify new versions were created
gcloud secrets versions list stripe-secret-key --project="$(gcloud config get-value project)" --limit=3
gcloud secrets versions list stripe-webhook-secret --project="$(gcloud config get-value project)" --limit=3
```

Both commands should show a new version (likely v3) with state ENABLED.
  </action>
  <resume-signal>Type "secrets updated" when all four steps are complete, or describe any issues encountered.</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Deploy and verify real payment</name>
  <what-built>
After Task 1, Claude will trigger a Cloud Build deployment to pick up the new live secrets. The deployment creates a new Cloud Run revision that resolves the `:latest` secret versions at startup.

Claude will:
1. Trigger the deployment via `gcloud builds triggers run deploy-on-push --region=global --branch=master --project="$(gcloud config get-value project)"` or an empty commit + push
2. Monitor the build until it completes
3. Verify the new revision is serving
  </what-built>
  <how-to-verify>
After Claude confirms the deployment is complete, verify with a real $5 purchase:

1. Navigate to https://dan-weinbeck.com/billing
2. Sign in with Google
3. Note your current credit balance
4. Click "Buy 500 Credits ($5)"
5. **Confirm this is LIVE mode** -- the Stripe Checkout page should NOT show a "test mode" banner at the top
6. Enter a REAL credit card and complete the payment
7. After redirect to /billing/success, navigate back to /billing
8. Verify balance increased by 500 credits

Then verify in Stripe Dashboard:
1. Go to https://dashboard.stripe.com/payments (live mode)
2. Confirm the $5.00 payment appears
3. Go to Developers > Webhooks > select the live endpoint
4. Confirm `checkout.session.completed` was delivered successfully (HTTP 200)

Optional: Refund the $5 test purchase via Stripe Dashboard > Payments > select payment > Refund (available for 180 days).
  </how-to-verify>
  <resume-signal>Type "verified" if the purchase completed and credits were granted, or describe what went wrong (e.g., "checkout failed", "credits not granted", "webhook 400 error").</resume-signal>
</task>

</tasks>

<verification>
- GCP Secret Manager `stripe-secret-key` latest version contains `sk_live_*` (not `sk_test_*`)
- GCP Secret Manager `stripe-webhook-secret` latest version contains live webhook `whsec_*`
- Cloud Run revision was deployed AFTER secret updates (check revision timestamp)
- Stripe Dashboard (live mode) shows successful $5 payment
- Stripe Dashboard (live mode) shows webhook delivery with HTTP 200
- User's credit balance increased by 500 after purchase
</verification>

<success_criteria>
1. Stripe secrets in GCP Secret Manager contain live keys (sk_live_*, whsec_* for live endpoint)
2. A real $5 purchase completes end-to-end: Checkout page loads, payment succeeds, webhook fires, 500 credits are granted
3. Requirement E2E-10 is satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/25-go-live/25-01-SUMMARY.md`
</output>
