---
phase: 16-dependency-and-environment-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - cloudbuild.yaml
  - scripts/setup-cicd.sh
  - .env.local.example
  - docs/DEPLOYMENT.md
  - docs/TECHNICAL_DESIGN.md
  - docs/FRD.md
autonomous: true
user_setup:
  - service: gcp-cloud-build
    why: "CHATBOT_API_URL must be configured as a substitution variable in the Cloud Build trigger"
    dashboard_config:
      - task: "Add _CHATBOT_API_URL substitution variable with the FastAPI Cloud Run service URL"
        location: "GCP Console -> Cloud Build -> Triggers -> deploy-on-push -> Edit -> Substitution variables"
  - service: gcp-secret-manager
    why: "Orphaned google-ai-api-key secret should be deleted for security hygiene"
    dashboard_config:
      - task: "Delete the google-ai-api-key secret (no longer referenced by any service)"
        location: "GCP Console -> Security -> Secret Manager -> google-ai-api-key -> Delete"
      - task: "Optionally revoke the Gemini API key in Google AI Studio"
        location: "Google AI Studio -> API keys"

must_haves:
  truths:
    - "@ai-sdk/google is not in package.json and npm ls confirms zero dependents"
    - "Build passes with npm run build after @ai-sdk/google removal"
    - "cloudbuild.yaml deploys CHATBOT_API_URL as an env var and no longer references google-ai-api-key secret"
    - ".env.local.example documents CHATBOT_API_URL with accurate FastAPI description"
    - "Documentation references FastAPI proxy architecture, not Gemini direct calls"
  artifacts:
    - path: "package.json"
      provides: "Clean dependency list without @ai-sdk/google"
      not_contains: "@ai-sdk/google"
    - path: "cloudbuild.yaml"
      provides: "Cloud Run deployment config with CHATBOT_API_URL"
      contains: "CHATBOT_API_URL"
      not_contains: "google-ai-api-key"
    - path: "scripts/setup-cicd.sh"
      provides: "CI/CD setup without google-ai-api-key secret creation"
      not_contains: "google-ai-api-key"
    - path: ".env.local.example"
      provides: "Env var template with FastAPI section"
      contains: "FastAPI"
      not_contains: "Gemini via Vercel AI SDK"
    - path: "docs/DEPLOYMENT.md"
      provides: "Deployment docs referencing CHATBOT_API_URL"
      not_contains: "GOOGLE_API_KEY"
    - path: "docs/TECHNICAL_DESIGN.md"
      provides: "Architecture docs reflecting FastAPI proxy"
      not_contains: "@ai-sdk/google"
    - path: "docs/FRD.md"
      provides: "Requirements reflecting current architecture"
      not_contains: "Gemini 2.0 Flash"
  key_links:
    - from: "cloudbuild.yaml"
      to: "src/lib/assistant/fastapi-client.ts"
      via: "CHATBOT_API_URL env var passed through --set-env-vars"
      pattern: "CHATBOT_API_URL"
    - from: ".env.local.example"
      to: "src/lib/assistant/fastapi-client.ts"
      via: "CHATBOT_API_URL documented for local dev"
      pattern: "CHATBOT_API_URL"
---

<objective>
Remove the last vestiges of the old Gemini-direct assistant architecture: uninstall the orphaned @ai-sdk/google package, update CI/CD configuration to remove the old secret and add CHATBOT_API_URL, and update all documentation to reflect the FastAPI proxy architecture.

Purpose: Complete the v1.3 migration. No orphaned packages, secrets, or stale documentation should remain from the old assistant backend.
Output: Clean package.json, updated cloudbuild.yaml and setup script, accurate documentation across DEPLOYMENT.md, TECHNICAL_DESIGN.md, and FRD.md.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-dependency-and-environment-cleanup/16-RESEARCH.md
@cloudbuild.yaml
@scripts/setup-cicd.sh
@.env.local.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Uninstall @ai-sdk/google and verify build</name>
  <files>package.json, package-lock.json</files>
  <action>
    1. Run `npm uninstall @ai-sdk/google` to remove the package from both package.json and package-lock.json.
    2. Verify the package is gone: `grep "@ai-sdk/google" package.json` should return no results.
    3. Run `npm run build` to confirm the build passes without the package.
    4. Run `npm test` and `npm run lint` to confirm no regressions.

    Do NOT manually edit package.json or package-lock.json -- use `npm uninstall` which handles both atomically.
    Do NOT remove `ai` or `@ai-sdk/react` -- these are actively used by the FastAPI proxy route and ChatInterface.
  </action>
  <verify>
    - `grep "@ai-sdk/google" package.json` returns no results (exit code 1)
    - `npm run build` exits 0
    - `npm test` exits 0
    - `npm run lint` exits 0
  </verify>
  <done>@ai-sdk/google is removed from package.json and package-lock.json. Build, tests, and lint all pass.</done>
</task>

<task type="auto">
  <name>Task 2: Update CI/CD configuration files</name>
  <files>cloudbuild.yaml, scripts/setup-cicd.sh, .env.local.example</files>
  <action>
    **cloudbuild.yaml (3 changes):**

    1. On line 38 (`--set-env-vars=...`), append `,CHATBOT_API_URL=${_CHATBOT_API_URL}` to the end of the existing env var list. Result:
       `'--set-env-vars=FIREBASE_PROJECT_ID=${PROJECT_ID},NEXT_PUBLIC_FIREBASE_API_KEY=${_NEXT_PUBLIC_FIREBASE_API_KEY},NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${_NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN},NEXT_PUBLIC_FIREBASE_PROJECT_ID=${_NEXT_PUBLIC_FIREBASE_PROJECT_ID},CHATBOT_API_URL=${_CHATBOT_API_URL}'`

    2. On line 39 (`--update-secrets=...`), remove `GOOGLE_GENERATIVE_AI_API_KEY=google-ai-api-key:latest,` from the beginning. Result:
       `'--update-secrets=GITHUB_TOKEN=github-token:latest,TODOIST_API_TOKEN=todoist-api-token:latest'`

    3. In the `substitutions:` section (after line 48), add:
       `_CHATBOT_API_URL: ''`

    **scripts/setup-cicd.sh (3 changes):**

    1. Delete lines 39-40 (the `echo "${GOOGLE_GENERATIVE_AI_API_KEY:-}" | gcloud secrets create google-ai-api-key ...` block).

    2. On line 51 (the fallback echo for manual secret creation), remove the line:
       `echo "    gcloud secrets create google-ai-api-key --data-file=-"`

    3. On line 62, change the secrets loop from:
       `for SECRET in google-ai-api-key github-token todoist-api-token; do`
       to:
       `for SECRET in github-token todoist-api-token; do`

    **.env.local.example (2 changes):**

    1. Change line 19 from:
       `# --- AI Assistant (Gemini via Vercel AI SDK) ---`
       to:
       `# --- AI Assistant (FastAPI Proxy) ---`

    2. Change line 22 from:
       `CHATBOT_API_URL=/api/assistant/chat`
       to:
       `CHATBOT_API_URL=https://your-fastapi-service-url.run.app`

    3. Change lines 20-21 from:
       ```
       # Required for the AI Assistant chatbot
       # URL for the chatbot API endpoint (defaults to /api/assistant/chat)
       ```
       to:
       ```
       # URL for the external FastAPI RAG backend
       # Local dev: point to your local FastAPI instance or deployed Cloud Run service
       # Production: set via _CHATBOT_API_URL substitution in Cloud Build trigger
       ```
  </action>
  <verify>
    - `grep "CHATBOT_API_URL" cloudbuild.yaml` shows it in both --set-env-vars and substitutions
    - `grep "google-ai-api-key" cloudbuild.yaml` returns no results
    - `grep "google-ai-api-key" scripts/setup-cicd.sh` returns no results
    - `grep "GOOGLE_GENERATIVE_AI_API_KEY" scripts/setup-cicd.sh` returns no results
    - `grep "FastAPI" .env.local.example` returns the updated comment
    - `grep "Gemini via Vercel" .env.local.example` returns no results
  </verify>
  <done>cloudbuild.yaml passes CHATBOT_API_URL to Cloud Run and no longer references google-ai-api-key. setup-cicd.sh no longer creates the google-ai-api-key secret. .env.local.example documents CHATBOT_API_URL with accurate FastAPI description.</done>
</task>

<task type="auto">
  <name>Task 3: Update documentation to reflect FastAPI proxy architecture</name>
  <files>docs/DEPLOYMENT.md, docs/TECHNICAL_DESIGN.md, docs/FRD.md</files>
  <action>
    **docs/DEPLOYMENT.md -- targeted replacements:**

    1. In the environment variables table (around line 27), replace the row:
       `| GOOGLE_API_KEY | Gemini API key for AI assistant |`
       with:
       `| CHATBOT_API_URL | URL for the external FastAPI RAG backend |`

    2. Around line 70, in the Docker run example, replace:
       `-e GOOGLE_API_KEY=your-gemini-key \`
       with:
       `-e CHATBOT_API_URL=https://your-fastapi-service-url.run.app \`

    3. Around line 98, in the Cloud Run environment list, replace:
       `- GOOGLE_API_KEY`
       with:
       `- CHATBOT_API_URL`

    4. Around line 153, in the troubleshooting table, replace:
       `| AI assistant not responding | Verify GOOGLE_API_KEY is set in Cloud Run env |`
       with:
       `| AI assistant not responding | Verify CHATBOT_API_URL is set in Cloud Run env and the FastAPI service is reachable |`

    **docs/TECHNICAL_DESIGN.md -- targeted replacements:**

    1. Around line 29 in the architecture diagram, change `Gemini 2.0 Flash` to `FastAPI RAG Backend`.

    2. Around line 61, change the route description from:
       `# Streaming chat API (Gemini 2.0 Flash)`
       to:
       `# Streaming chat API (FastAPI RAG proxy)`

    3. Around lines 140-143, replace the request flow description. The old flow describes safety pipeline, Gemini call, and knowledge base loading. Replace with:
       ```
       3. Route handler validates with Zod, checks rate limit (10 msg/15min per IP), proxies to FastAPI RAG backend
       4. FastAPI backend performs RAG retrieval, LLM generation, and returns structured JSON (answer, citations, confidence)
       5. Route handler translates FastAPI response into UIMessageStream chunks (text, source-url, messageMetadata)
       6. Client receives stream via useChat hook and renders message with citations and confidence badge
       ```

    4. Around line 314, replace `before reaching Gemini` with `before reaching the LLM (handled by FastAPI backend)`.

    5. Around lines 352-353, update the security/streaming notes:
       - Change "Multi-layer pipeline (sanitize -> detect -> refuse) before Gemini call; blocked queries return pre-approved static refusals" to "Input validation and rate limiting before proxying to FastAPI RAG backend"
       - Change "Error during Gemini streaming displays generic error in chat UI" to "Error during FastAPI proxy displays generic error in chat UI"

    6. Around lines 382-387, replace the "Google AI (Gemini)" section:
       Change section header from `### Google AI (Gemini)` to `### FastAPI RAG Backend`
       Replace the content with:
       ```
       - **Service:** External FastAPI RAG backend on Cloud Run
       - **Connection:** HTTP proxy via CHATBOT_API_URL env var
       - **Auth:** Cloud Run IAM (service-to-service)
       - **Response:** JSON with answer, citations (source + relevance), confidence (low/medium/high)
       ```

    7. Around lines 434-435, update the ADR table:
       - Row 33: Change "Gemini 2.0 Flash for AI assistant" to "FastAPI RAG backend for AI assistant" and rationale to "Centralized RAG pipeline, backend-managed LLM, citation support"
       - Row 34: Change "`ai` + `@ai-sdk/google` + `@ai-sdk/react`" to "`ai` + `@ai-sdk/react` (proxy to FastAPI)" and rationale to "UIMessageStream for streaming, useChat for client, FastAPI handles LLM"

    **docs/FRD.md -- targeted replacements:**

    1. Around line 229, change ASST-02 from:
       `| ASST-02 | Streaming API route at /api/assistant/chat using Gemini 2.0 Flash | Complete |`
       to:
       `| ASST-02 | Streaming API route at /api/assistant/chat proxying to FastAPI RAG backend | Complete |`

    2. Around line 230, change ASST-03 from:
       `| ASST-03 | Curated knowledge base from src/data/ (canon, projects, FAQ, services, contact, writing) | Complete |`
       to:
       `| ASST-03 | Knowledge base managed by external FastAPI RAG backend (old src/data/ files removed) | Complete |`

    3. Around line 254, change ASST-19 from:
       `| ASST-19 | Safety pipeline runs before Gemini -- blocked queries never reach API | Complete |`
       to:
       `| ASST-19 | Input validation and rate limiting before proxying to FastAPI backend | Complete |`

    IMPORTANT: These are targeted line replacements only. Do NOT rewrite entire documents. Read each file first, make the specific changes, write the file back.
  </action>
  <verify>
    - `grep "GOOGLE_API_KEY" docs/DEPLOYMENT.md` returns no results
    - `grep "CHATBOT_API_URL" docs/DEPLOYMENT.md` returns results
    - `grep "@ai-sdk/google" docs/TECHNICAL_DESIGN.md` returns no results
    - `grep "GOOGLE_GENERATIVE_AI_API_KEY" docs/TECHNICAL_DESIGN.md` returns no results
    - `grep "FastAPI" docs/TECHNICAL_DESIGN.md` returns results
    - `grep "Gemini 2.0 Flash" docs/FRD.md` returns no results
    - `grep "FastAPI" docs/FRD.md` returns results
    - `npm run build` still passes (docs changes should not affect build, but verify)
  </verify>
  <done>All three documentation files reference the FastAPI proxy architecture. No stale Gemini, @ai-sdk/google, GOOGLE_API_KEY, or GOOGLE_GENERATIVE_AI_API_KEY references remain in docs.</done>
</task>

</tasks>

<verification>
Run these checks after all tasks complete:

1. **Package verification:**
   - `grep "@ai-sdk/google" package.json` -- no results
   - `npm ls @ai-sdk/google 2>&1` -- should show "not a dependency" or error

2. **Build verification:**
   - `npm run build` exits 0
   - `npm test` exits 0
   - `npm run lint` exits 0

3. **Config verification:**
   - `grep "CHATBOT_API_URL" cloudbuild.yaml` -- present in --set-env-vars and substitutions
   - `grep "google-ai-api-key" cloudbuild.yaml scripts/setup-cicd.sh` -- no results
   - `grep "GOOGLE_GENERATIVE_AI_API_KEY" cloudbuild.yaml scripts/setup-cicd.sh` -- no results

4. **Documentation verification:**
   - `grep "GOOGLE_API_KEY" docs/DEPLOYMENT.md` -- no results
   - `grep "@ai-sdk/google" docs/TECHNICAL_DESIGN.md` -- no results
   - `grep "Gemini 2.0 Flash" docs/FRD.md` -- no results

5. **Stale reference sweep:**
   - `grep -r "GOOGLE_GENERATIVE_AI_API_KEY" --include="*.yaml" --include="*.sh" --include="*.md" --include="*.example" .` -- should only appear in RESEARCH.md and planning docs
   - `grep -r "@ai-sdk/google" --include="*.ts" --include="*.tsx" --include="*.json" --include="*.md" .` -- should only appear in planning docs and package-lock removal diff
</verification>

<success_criteria>
1. `@ai-sdk/google` uninstalled -- not in package.json, build passes
2. `cloudbuild.yaml` passes `CHATBOT_API_URL` to Cloud Run via `--set-env-vars` with `_CHATBOT_API_URL` substitution
3. `cloudbuild.yaml` no longer references `google-ai-api-key` secret in `--update-secrets`
4. `scripts/setup-cicd.sh` no longer creates `google-ai-api-key` secret
5. `.env.local.example` documents `CHATBOT_API_URL` with FastAPI description (not Gemini)
6. All three docs (DEPLOYMENT.md, TECHNICAL_DESIGN.md, FRD.md) reference FastAPI proxy, not Gemini direct
7. Zero stale references to `GOOGLE_API_KEY`, `GOOGLE_GENERATIVE_AI_API_KEY`, `@ai-sdk/google`, or `google-ai-api-key` outside of planning docs
</success_criteria>

<output>
After completion, create `.planning/phases/16-dependency-and-environment-cleanup/16-01-SUMMARY.md`
</output>
