---
phase: 37-chatbot-popup-widget
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/context/ChatWidgetContext.tsx
  - src/components/assistant/ChatPopupWidget.tsx
  - src/components/assistant/ChatInterface.tsx
  - src/components/layout/NavLinks.tsx
  - src/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking Ask My Assistant in the navbar opens a chatbot widget anchored to the bottom-right of the viewport"
    - "The widget persists across page navigation within the same session (conversation is not lost when changing pages)"
    - "The widget collapses via an X button and can be reopened without losing conversation history"
  artifacts:
    - path: "src/context/ChatWidgetContext.tsx"
      provides: "React context managing widget open/closed state"
      exports: ["ChatWidgetProvider", "useChatWidget"]
    - path: "src/components/assistant/ChatPopupWidget.tsx"
      provides: "Floating popup shell that wraps ChatInterface"
      min_lines: 30
    - path: "src/components/assistant/ChatInterface.tsx"
      provides: "Chat UI adapted for both popup and full-page contexts"
      min_lines: 50
    - path: "src/components/layout/NavLinks.tsx"
      provides: "Ask My Assistant as toggle button instead of Link"
      min_lines: 40
    - path: "src/app/layout.tsx"
      provides: "Root layout rendering ChatWidgetProvider and ChatPopupWidget"
      min_lines: 30
  key_links:
    - from: "src/components/layout/NavLinks.tsx"
      to: "src/context/ChatWidgetContext.tsx"
      via: "useChatWidget().toggle"
      pattern: "useChatWidget.*toggle"
    - from: "src/components/assistant/ChatPopupWidget.tsx"
      to: "src/context/ChatWidgetContext.tsx"
      via: "useChatWidget().isOpen"
      pattern: "useChatWidget.*isOpen"
    - from: "src/app/layout.tsx"
      to: "src/context/ChatWidgetContext.tsx"
      via: "ChatWidgetProvider wrapping children"
      pattern: "ChatWidgetProvider"
    - from: "src/app/layout.tsx"
      to: "src/components/assistant/ChatPopupWidget.tsx"
      via: "ChatPopupWidget rendered inside provider"
      pattern: "ChatPopupWidget"
---

<objective>
Create a persistent chatbot popup widget that opens from the navbar and survives page navigation.

Purpose: Visitors can ask Dan's AI assistant from any page without navigating away. The "Ask My Assistant" navbar link becomes a toggle button that opens/closes a floating chat widget anchored to the bottom-right of the viewport. Conversation state persists across page navigation because the widget lives in the root layout and its state is managed via React context.

Output: Working chatbot popup accessible from every page via navbar toggle, with conversation persistence across navigation.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-tools-page-and-nav-restructure/36-02-SUMMARY.md

@src/components/assistant/ChatInterface.tsx
@src/components/assistant/ChatHeader.tsx
@src/components/assistant/ChatInput.tsx
@src/components/assistant/ExitRamps.tsx
@src/components/assistant/HumanHandoff.tsx
@src/components/assistant/PrivacyDisclosure.tsx
@src/components/layout/NavLinks.tsx
@src/components/layout/Navbar.tsx
@src/app/layout.tsx
@src/context/AuthContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ChatWidgetContext and ChatPopupWidget shell</name>
  <files>
    src/context/ChatWidgetContext.tsx
    src/components/assistant/ChatPopupWidget.tsx
  </files>
  <action>
**1. Create `src/context/ChatWidgetContext.tsx`:**

A "use client" React context that manages the popup widget's open/closed state. Follow the same pattern as `src/context/AuthContext.tsx` (createContext + Provider + hook).

State to manage:
- `isOpen: boolean` (default false)
- `toggle: () => void` — flips isOpen
- `close: () => void` — sets isOpen to false
- `open: () => void` — sets isOpen to true

Export `ChatWidgetProvider` (wraps children with context) and `useChatWidget` hook.

**2. Create `src/components/assistant/ChatPopupWidget.tsx`:**

A "use client" component that renders the floating popup shell. This component:

- Calls `useChatWidget()` to get `isOpen` and `close`
- When `isOpen` is false, renders nothing (return null)
- When `isOpen` is true, renders a fixed-position panel:
  - Position: `fixed bottom-4 right-4 z-[60]` (above the navbar's z-50)
  - Size: `w-[400px] h-[600px]` on desktop, `w-full h-[calc(100dvh-5rem)] bottom-0 right-0` on mobile (use responsive classes: `sm:w-[400px] sm:h-[600px] sm:bottom-4 sm:right-4`)
  - Styling: `rounded-2xl border border-border bg-background shadow-2xl overflow-hidden flex flex-col` (on sm+; on mobile no border-radius on sides)
  - Header bar at top with: "Dan's AI Assistant" title (left), X close button (right). Use the same DW avatar circle from ChatHeader. The close button should call `close()`.
  - Below the header, render `<ChatInterface mode="popup" />` (we will add the mode prop in Task 2)

The header bar styling: `flex items-center justify-between px-4 py-3 border-b border-border bg-surface/80 backdrop-blur-sm`

The X button: a small button with an X SVG icon, `h-8 w-8 rounded-full hover:bg-gold-light transition-colors flex items-center justify-center text-text-secondary hover:text-text-primary`

Use the standard heroicons X mark path: `M6 18L18 6M6 6l12 12` (strokeLinecap="round", strokeLinejoin="round", strokeWidth={1.5}).

Do NOT add animations/transitions for the open/close — keep it simple, just show/hide.
  </action>
  <verify>
Run `npm run build` — both new files should compile without errors. Grep for `ChatWidgetProvider` and `useChatWidget` exports. Grep for `ChatPopupWidget` export.
  </verify>
  <done>
ChatWidgetContext exports ChatWidgetProvider and useChatWidget. ChatPopupWidget renders a fixed-position floating panel with header, close button, and ChatInterface when isOpen is true. Both files compile cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire popup into layout, adapt ChatInterface, convert NavLinks toggle</name>
  <files>
    src/app/layout.tsx
    src/components/assistant/ChatInterface.tsx
    src/components/layout/NavLinks.tsx
  </files>
  <action>
**1. Update `src/app/layout.tsx`:**

- Import `ChatWidgetProvider` from `@/context/ChatWidgetContext`
- Import `ChatPopupWidget` from `@/components/assistant/ChatPopupWidget`
- Wrap the existing `AuthProvider` children with `ChatWidgetProvider` (inside AuthProvider so ChatPopupWidget can access auth if needed)
- Add `<ChatPopupWidget />` right before `<Footer />` (inside ChatWidgetProvider, after `</main>`)

The layout structure becomes:
```
<AuthProvider>
  <ChatWidgetProvider>
    <Navbar />
    <main>{children}</main>
    <ChatPopupWidget />
    <Footer />
  </ChatWidgetProvider>
</AuthProvider>
```

**2. Update `src/components/assistant/ChatInterface.tsx`:**

Add an optional `mode` prop: `mode?: "page" | "popup"` (default "page").

Changes when `mode === "popup"`:
- Replace the outer div's `h-[calc(100dvh-4rem)]` with `h-full` (the popup shell controls the height)
- Do NOT render `<ChatHeader />` (the popup shell already has a header with close button)
- Make the empty-state welcome section more compact: reduce the icon from `h-16 w-16` to `h-12 w-12` and the inner SVG from `h-8 w-8` to `h-6 w-6`. Reduce heading from `text-lg` to `text-base`. Hide the description paragraph in popup mode.
- Reduce the SuggestedPrompts section padding
- In the ChatInput, reduce the textarea rows from 4 to 2 when in popup mode (pass a `compact` prop or use a smaller rows value). Actually, simpler: just pass `rows={2}` as a prop. Update ChatInput to accept an optional `rows` prop (default 4).
- In the footer area (ExitRamps + HumanHandoff + PrivacyDisclosure), hide ExitRamps and PrivacyDisclosure when mode is "popup" to save space. Keep HumanHandoff visible.

Update ChatInput component: Add optional `rows?: number` prop (default 4). Use it for the textarea rows attribute.

**3. Update `src/components/layout/NavLinks.tsx`:**

- Import `useChatWidget` from `@/context/ChatWidgetContext`
- Remove `{ name: "Ask My Assistant", href: "/assistant" }` from the links array
- In the desktop nav, AFTER the links.map loop, add a `<button>` element for "Ask My Assistant" that calls `toggle()`. Style it identically to the nav links (same `px-3 py-1.5 text-sm font-medium rounded-full transition-all duration-200` classes). When the widget is open (`isOpen`), use the active style (`bg-primary text-white font-bold shadow-sm border border-gold`), otherwise the default style (`text-text-secondary hover:text-primary hover:bg-gold-light`).
- In the mobile nav, similarly add a `<button>` after the links.map, styled like the mobile nav links. When clicked, call `toggle()` and also `setMobileOpen(false)` to close the mobile menu.
- The button text should be "Ask My Assistant" in both desktop and mobile.

IMPORTANT: The "Ask My Assistant" item must NOT be a `<Link>` anymore. It must be a `<button>` that toggles the popup via `useChatWidget().toggle`. Remove `"/assistant"` from the `isActive()` check since it's no longer a link.
  </action>
  <verify>
Run `npm run build` — all modified files compile. Run `npm run lint` — no errors. Run `npm test` — all tests pass. Verify that NavLinks no longer contains an href to "/assistant" (grep). Verify layout.tsx imports and renders ChatWidgetProvider and ChatPopupWidget (grep).
  </verify>
  <done>
Root layout renders ChatWidgetProvider and ChatPopupWidget so the widget persists across all page navigation. ChatInterface accepts mode="popup" with compact layout. NavLinks "Ask My Assistant" is a toggle button that opens/closes the popup widget. Clicking it opens the floating chat panel bottom-right; clicking X or the button again closes it. Conversation state persists because ChatInterface is never unmounted during navigation — it lives in the root layout.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. `npm run lint` passes with zero errors
3. `npm test` passes (all existing tests)
4. Grep confirms no `href="/assistant"` in NavLinks.tsx
5. Grep confirms `ChatWidgetProvider` in layout.tsx
6. Grep confirms `ChatPopupWidget` in layout.tsx
7. Grep confirms `useChatWidget` in NavLinks.tsx
8. Grep confirms `mode` prop in ChatInterface.tsx
</verification>

<success_criteria>
- Clicking "Ask My Assistant" in the navbar toggles a floating chatbot popup anchored bottom-right
- The popup contains the full chat interface (messages, input, suggested prompts)
- The popup has a close (X) button in its header
- Navigating between pages does NOT close or reset the popup
- Conversation history is preserved when closing and reopening the popup
- The popup is rendered at a z-index above the navbar
- All quality gates pass (build, lint, tests)
</success_criteria>

<output>
After completion, create `.planning/phases/37-chatbot-popup-widget/37-01-SUMMARY.md`
</output>
