---
phase: 30-assets-page-user-history
plan: 03
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - src/components/tools/brand-scraper/ScrapeHistory.tsx
  - src/components/tools/brand-scraper/UserBrandScraperPage.tsx
autonomous: true

must_haves:
  truths:
    - "Below the URL input on the Brand Scraper page, authenticated users see a history of previously scraped URLs with dates sorted newest first"
    - "Clicking View Results on a history entry opens the Brand Card for that job"
    - "History section only appears when the user has at least one history entry"
    - "When navigated to via jobId query parameter, the page auto-enters results view for that job"
  artifacts:
    - path: "src/components/tools/brand-scraper/ScrapeHistory.tsx"
      provides: "History section component fetching and displaying user's scrape history"
      exports: ["ScrapeHistory"]
    - path: "src/components/tools/brand-scraper/UserBrandScraperPage.tsx"
      provides: "Updated page with ScrapeHistory section and jobId query param support"
  key_links:
    - from: "src/components/tools/brand-scraper/ScrapeHistory.tsx"
      to: "/api/tools/brand-scraper/history"
      via: "SWR fetch with Bearer auth token"
      pattern: "fetch.*history"
    - from: "src/components/tools/brand-scraper/ScrapeHistory.tsx"
      to: "src/components/tools/brand-scraper/UserBrandScraperPage.tsx"
      via: "rendered below the URL form in BrandScraperContent"
      pattern: "<ScrapeHistory"
    - from: "src/components/tools/brand-scraper/UserBrandScraperPage.tsx"
      to: "useSearchParams"
      via: "reads jobId from URL search params on mount to auto-enter results view"
      pattern: "useSearchParams.*jobId"
---

<objective>
Build the history UI section that shows below the URL input, and wire the "View Results" navigation via query parameters to auto-show the Brand Card for previously scraped jobs.

Purpose: Fulfills HIST-03 (history section showing scraped URLs + dates + "View Results"), HIST-04 ("View Results" opens Brand Card for that job). Depends on Plan 01 for the history API route.
Output: One new ScrapeHistory component and modifications to UserBrandScraperPage for history display and query param support.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-assets-page-user-history/30-RESEARCH.md
@.planning/phases/30-assets-page-user-history/30-01-SUMMARY.md

# Reference files
@src/components/tools/brand-scraper/UserBrandScraperPage.tsx (existing page -- will be modified)
@src/lib/brand-scraper/types.ts (ScrapeHistoryEntry type from Plan 01)
@src/context/AuthContext.tsx (useAuth hook for token management)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ScrapeHistory component</name>
  <files>
    src/components/tools/brand-scraper/ScrapeHistory.tsx
  </files>
  <action>
**Create `src/components/tools/brand-scraper/ScrapeHistory.tsx`:**

1. Mark as `"use client"`.
2. Import: `useCallback`, `useEffect`, `useState` from React. `useSWR` from `swr`. `useAuth` from `@/context/AuthContext`. `format` from `date-fns`. `type ScrapeHistoryEntry` from `@/lib/brand-scraper/types`.
3. Export `ScrapeHistory({ onViewResults }: { onViewResults: (jobId: string) => void })`.
   - The `onViewResults` callback lets the parent component (UserBrandScraperPage) handle navigation -- it will set the jobId state to enter results view.
4. Implementation:
   - Get `user` from `useAuth()`.
   - State: `token` (string | null, initialized to null).
   - Effect: `user?.getIdToken().then(setToken)` on user change.
   - SWR fetcher: `useCallback` that fetches `/api/tools/brand-scraper/history` with `Authorization: Bearer ${token}`.
   - SWR key: `token ? "/api/tools/brand-scraper/history" : null` (skip fetch without token).
   - SWR options: `{ revalidateOnFocus: false }`.
   - Parse `data?.entries` as `ScrapeHistoryEntry[]`.
   - If no entries or empty array: return `null` (hide section entirely).
5. Render:
   - Section wrapper: `mt-8 pt-6 border-t border-border`.
   - Heading: `text-sm font-semibold text-text-secondary uppercase tracking-wide mb-3` â€” "Recent Scrapes".
   - List: `space-y-2`.
   - Each entry:
     - Container: `flex items-center justify-between rounded-lg border border-border px-4 py-3 bg-white hover:bg-gray-50 transition-colors`.
     - Left side (flex items-center gap-3):
       - Status dot: small colored circle (green for succeeded, amber for partial, red for failed, gray for queued/processing). Use a `<span>` with `h-2 w-2 rounded-full` and conditional bg color.
       - URL hostname: `text-sm text-text-primary font-medium`. Extract hostname from `entry.siteUrl` using `new URL(entry.siteUrl).hostname` wrapped in try/catch (fallback to raw siteUrl).
       - Date: `text-xs text-text-tertiary ml-2`. Format `entry.createdAt` with `format(new Date(entry.createdAt), "MMM d, yyyy")`.
     - Right side:
       - "View Results" button: `<button onClick={() => onViewResults(entry.jobId)}>` styled as `text-xs text-gold hover:text-gold/80 font-medium transition-colors`.
       - Only show "View Results" for terminal statuses (succeeded, partial, failed). For queued/processing, show "In Progress" in muted text.
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors. Run `npm run lint` for lint cleanliness. Verify the component accepts the `onViewResults` prop and renders entries correctly.
  </verify>
  <done>
ScrapeHistory component fetches user's history via authenticated SWR call, renders a list of recent scrapes with hostname, date, status dot, and "View Results" button. Returns null when no history entries exist. Build and lint pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire ScrapeHistory into UserBrandScraperPage with query param support</name>
  <files>
    src/components/tools/brand-scraper/UserBrandScraperPage.tsx
  </files>
  <action>
**Modify `src/components/tools/brand-scraper/UserBrandScraperPage.tsx`:**

1. Add imports:
   - `useSearchParams` from `next/navigation`.
   - `ScrapeHistory` from `./ScrapeHistory`.
2. Inside `BrandScraperContent`, add `useSearchParams()`:
   - `const searchParams = useSearchParams()`.
   - `const initialJobId = searchParams.get("jobId")`.
3. Add an effect that auto-enters results view when `initialJobId` is present:
   - On mount (or when `initialJobId` or `user` changes): if `initialJobId` is truthy and `user` is available and `jobId` state is still null (haven't started a fresh scrape):
     - Call `user.getIdToken()` to get a fresh token.
     - Set `setToken(idToken)` and `setJobId(initialJobId)`.
   - This makes the page behave as if the user just submitted a scrape -- the `useJobStatus` hook will pick up the jobId and start fetching status.
4. Add `handleViewResults` callback:
   ```typescript
   const handleViewResults = useCallback(async (historyJobId: string) => {
     if (!user) return;
     const idToken = await user.getIdToken();
     setToken(idToken);
     setJobId(historyJobId);
     setError(null);
   }, [user]);
   ```
5. Render `<ScrapeHistory onViewResults={handleViewResults} />` below the URL form, INSIDE the `{!jobId && (...)}` conditional block -- the history should only show when no active job is being viewed.
   - Place it after the `</form>` closing tag but still inside the `{!jobId && (...)}` fragment.
   - The structure becomes:
     ```tsx
     {!jobId && (
       <>
         <form ...>...</form>
         <ScrapeHistory onViewResults={handleViewResults} />
       </>
     )}
     ```
   - Note: the existing form is NOT wrapped in a fragment. You'll need to wrap both the form and ScrapeHistory in a fragment `<>...</>`.
6. When `handleNewScrape` is called (user clicks "Scrape Another URL"), the existing logic already resets jobId to null, which will re-show the form + history section. No change needed there.

**Important considerations:**
- The `useSearchParams()` hook requires the component to be a client component (already is).
- The `initialJobId` effect should only run once -- use a ref or conditional to prevent re-triggering after `handleNewScrape` resets the state.
- Add a `hasInitialized` ref to track whether the initialJobId has been processed, so it doesn't re-trigger after navigating back from results:
  ```typescript
  const hasInitialized = useRef(false);
  useEffect(() => {
    if (initialJobId && user && !hasInitialized.current) {
      hasInitialized.current = true;
      user.getIdToken().then((idToken) => {
        setToken(idToken);
        setJobId(initialJobId);
      });
    }
  }, [initialJobId, user]);
  ```
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors. Run `npm run lint` for lint cleanliness. Run `npm test` for existing test health.

Manual verification checklist:
- `/apps/brand-scraper` shows history section below URL form
- `/apps/brand-scraper?jobId=xxx` auto-enters results view
- Clicking "View Results" in history enters results view
- Clicking "Scrape Another URL" returns to form + history
  </verify>
  <done>
UserBrandScraperPage renders ScrapeHistory below the URL form when no active job. Query param `?jobId=xxx` auto-enters results view. "View Results" callback sets jobId + token to enter results view. "Scrape Another URL" returns to form + history. Build, lint, and tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no TypeScript errors
2. `npm run lint` passes with no lint issues
3. `npm test` passes (existing tests still work)
4. ScrapeHistory component renders below URL form when no active job
5. History entries show hostname, date, status indicator, and "View Results" button
6. Clicking "View Results" enters the results view with the Brand Card
7. URL query param `?jobId=xxx` auto-enters results view on page load
8. "Scrape Another URL" returns to form + history
</verification>

<success_criteria>
- History section appears below URL input showing previously scraped URLs, dates, and status indicators sorted newest first
- "View Results" button navigates to Brand Card view for that job
- Query parameter navigation (/apps/brand-scraper?jobId=xxx) auto-shows results
- History section hides when no entries exist
- History section hides when an active job is being viewed
- All quality gates pass (build, lint, test)
</success_criteria>

<output>
After completion, create `.planning/phases/30-assets-page-user-history/30-03-SUMMARY.md`
</output>
