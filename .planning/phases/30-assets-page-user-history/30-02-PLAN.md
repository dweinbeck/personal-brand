---
phase: 30-assets-page-user-history
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/apps/brand-scraper/[jobId]/assets/page.tsx
  - src/components/tools/brand-scraper/AssetsPage.tsx
  - src/components/tools/brand-scraper/AssetGrid.tsx
autonomous: true

must_haves:
  truths:
    - "Route /apps/brand-scraper/[jobId]/assets displays a list of extracted assets with image previews, filenames, categories, and per-asset download buttons"
    - "A Download Zip File button at the top of the assets page triggers on-demand zip generation and download"
    - "Non-image assets show a file type icon placeholder instead of a broken image"
    - "Invalid or not-found job IDs display a graceful error message with a link back to the scraper"
  artifacts:
    - path: "src/app/apps/brand-scraper/[jobId]/assets/page.tsx"
      provides: "Server component shell for the dynamic assets route"
      exports: ["default", "metadata"]
    - path: "src/components/tools/brand-scraper/AssetsPage.tsx"
      provides: "Client component wrapping AuthGuard with job status fetch and asset rendering"
      exports: ["AssetsPage"]
    - path: "src/components/tools/brand-scraper/AssetGrid.tsx"
      provides: "Grid of asset cards with image previews and download buttons"
      exports: ["AssetGrid"]
  key_links:
    - from: "src/app/apps/brand-scraper/[jobId]/assets/page.tsx"
      to: "src/components/tools/brand-scraper/AssetsPage.tsx"
      via: "renders AssetsPage with jobId prop"
      pattern: "<AssetsPage jobId="
    - from: "src/components/tools/brand-scraper/AssetsPage.tsx"
      to: "/api/tools/brand-scraper/jobs/[id]"
      via: "fetch job status with Bearer token to get assets_manifest"
      pattern: "fetch.*jobs/"
    - from: "src/components/tools/brand-scraper/AssetsPage.tsx"
      to: "/api/tools/brand-scraper/jobs/[id]/assets/zip"
      via: "POST request for on-demand zip download"
      pattern: "assets/zip"
---

<objective>
Build the individual assets browsing page at /apps/brand-scraper/[jobId]/assets where users can see previews of all extracted assets, download individual files via signed URLs, and trigger a full zip download.

Purpose: Fulfills APAG-01 (route with asset list and previews), APAG-02 (Download Zip button), and APAG-03 (per-asset preview with filename/category and download button). This is a self-contained vertical slice with no dependency on the history backend.
Output: Three new files: server component route shell, AssetsPage client component, and AssetGrid component.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-assets-page-user-history/30-RESEARCH.md

# Reference files for patterns and types
@src/lib/brand-scraper/types.ts (AssetManifestEntry type with signed_url, filename, category, content_type, size_bytes)
@src/lib/brand-scraper/hooks.ts (useJobStatus hook -- reusable for fetching job data)
@src/components/tools/brand-scraper/BrandCardDownloads.tsx (zip download pattern -- POST to zip proxy, anchor download)
@src/components/tools/brand-scraper/UserBrandScraperPage.tsx (token management pattern, AuthGuard usage)
@src/components/auth/AuthGuard.tsx (AuthGuard wrapper)
@src/context/AuthContext.tsx (useAuth hook)
@src/components/ui/Button.tsx (Button component)
@src/app/about/[slug]/page.tsx (dynamic route pattern: params: Promise<{ slug: string }>)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create the assets page route and AssetsPage client component</name>
  <files>
    src/app/apps/brand-scraper/[jobId]/assets/page.tsx
    src/components/tools/brand-scraper/AssetsPage.tsx
  </files>
  <action>
**Create `src/app/apps/brand-scraper/[jobId]/assets/page.tsx`** (server component shell):

```typescript
import { AssetsPage } from "@/components/tools/brand-scraper/AssetsPage";

export const metadata = {
  title: "Brand Assets | Daniel Weinbeck",
  description: "View and download extracted brand assets.",
};

export default async function Page({
  params,
}: {
  params: Promise<{ jobId: string }>;
}) {
  const { jobId } = await params;
  return <AssetsPage jobId={jobId} />;
}
```

**Create `src/components/tools/brand-scraper/AssetsPage.tsx`** (client component):

1. Mark as `"use client"`.
2. Import: `AuthGuard`, `useAuth`, `Button`, `AssetGrid`, `useState`, `useEffect`, `useCallback`.
3. Import `type AssetManifestEntry` and `type JobStatus` from `@/lib/brand-scraper/types`.
4. Export `AssetsPage({ jobId })` that wraps `<AuthGuard><AssetsPageContent jobId={jobId} /></AuthGuard>`.
5. `AssetsPageContent` implementation:
   - `useAuth()` to get `user`.
   - State: `token`, `assets` (AssetManifestEntry[] | null), `jobStatus` (string | null), `siteUrl` (string | null), `loading` (true), `error` (string | null).
   - `useEffect` to get fresh token via `user?.getIdToken().then(setToken)`.
   - `useEffect` with `token` dependency to fetch `${API_BASE}/jobs/${jobId}` with Bearer auth.
     - On success: parse response, set `assets` from `data.assets_manifest?.assets ?? []`, set `jobStatus` from `data.status`, extract `siteUrl` from `data.result?.source?.site_url`.
     - On 404/error: set `error` with appropriate message.
     - Finally: set `loading(false)`.
   - Zip download handler: reuse the same pattern from `BrandCardDownloads.tsx`.
     - `handleZipDownload` calls `user?.getIdToken()` for a fresh token (handles expiry).
     - POST to `/api/tools/brand-scraper/jobs/${jobId}/assets/zip` with Bearer auth.
     - Parse response for `zip_url`, create temp anchor, trigger download.
     - Track `downloading` and `downloadError` states.
   - Render:
     - Back link: `<Link href="/apps/brand-scraper">` with left arrow and "Back to Brand Scraper".
     - Page title: "Brand Assets" with optional hostname subtitle from siteUrl.
     - Loading state: "Loading assets..." skeleton or spinner text.
     - Error state: "Job not found" or error message with link back to scraper.
     - Processing state (jobStatus not terminal): "This job is still processing. Check back soon." with link back.
     - Empty assets: "No assets were extracted for this job."
     - Success: "Download Zip File" button at top (APAG-02), then `<AssetGrid assets={assets} />`.
   - Use `const API_BASE = "/api/tools/brand-scraper"` at module scope.
   - Navy/gold styling consistent with existing brand scraper pages.
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors. Verify the route is accessible at /apps/brand-scraper/[jobId]/assets. Run `npm run lint` for lint cleanliness.
  </verify>
  <done>
Server component shell renders AssetsPage with jobId prop from dynamic route. AssetsPage fetches job status with auth, extracts assets_manifest, renders loading/error/empty/success states. Zip download button uses POST to zip proxy with fresh token.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AssetGrid component with image previews and per-asset downloads</name>
  <files>
    src/components/tools/brand-scraper/AssetGrid.tsx
  </files>
  <action>
**Create `src/components/tools/brand-scraper/AssetGrid.tsx`:**

1. Mark as `"use client"`.
2. Import `type AssetManifestEntry` from `@/lib/brand-scraper/types`.
3. Export `AssetGrid({ assets }: { assets: AssetManifestEntry[] })`.
4. Helper function `isImageType(contentType: string): boolean` — returns `contentType.startsWith("image/")`.
5. Helper function `formatFileSize(bytes: number): string` — converts bytes to human-readable (B, KB, MB).
6. Helper function `getCategoryLabel(category: string): string` — capitalizes and formats category (e.g., "logos" -> "Logo", "favicons" -> "Favicon", "og_images" -> "OG Image").
7. Render a responsive grid: `grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4`.
8. Each asset card:
   - Container: `rounded-xl border border-border bg-white shadow-sm overflow-hidden` (consistent with BrandCard styling).
   - Preview area (fixed height ~h-40):
     - If `isImageType(asset.content_type)` AND `asset.signed_url`: render `<img>` with `src={asset.signed_url}`, `alt={asset.filename}`, `loading="lazy"`, `className="h-40 w-full object-contain bg-gray-50 p-2"`.
       - Add `// biome-ignore lint/performance/noImgElement: GCS signed URLs have dynamic hostnames` comment above `<img>`.
     - Else: render a placeholder div with file type icon. Use a simple SVG file icon or text showing the content_type (e.g., "SVG", "CSS", "JSON"). Background: `bg-gray-50`, centered, `h-40`.
   - Info area (below preview): `p-3` padding.
     - Filename: `text-sm font-medium text-text-primary truncate` — show `asset.filename`.
     - Category badge: `inline-block text-xs bg-gray-100 text-text-secondary rounded-full px-2 py-0.5 mt-1` — show category label.
     - File size: `text-xs text-text-tertiary mt-1` — show formatted size.
   - Download button area: `px-3 pb-3`.
     - If `asset.signed_url`: render `<a href={asset.signed_url} download={asset.filename}>` styled as a small button/link.
       - Style: `inline-flex items-center gap-1 text-xs text-gold hover:text-gold/80 font-medium transition-colors`.
       - Text: "Download".
     - If no signed_url: show "Unavailable" in muted text.
9. Group assets by category if there are multiple categories. Use section headers:
   - Group the assets array by `category` field.
   - Render each category group with a heading: `text-sm font-semibold text-text-secondary uppercase tracking-wide mb-3 mt-6 first:mt-0`.
   - Then the grid of assets for that category.
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors. Run `npm run lint` to confirm no lint issues. Verify the component renders correctly with the existing AssetManifestEntry type shape.
  </verify>
  <done>
AssetGrid renders a responsive grid of asset cards grouped by category. Image assets show previews via signed URLs. Non-image assets show file type placeholders. Each card shows filename, category badge, file size, and a download link via signed URL. Build and lint pass.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no TypeScript errors
2. `npm run lint` passes with no lint issues
3. `npm test` passes (existing tests still work)
4. Route `/apps/brand-scraper/[jobId]/assets` resolves correctly (page.tsx exists in App Router)
5. AssetsPage wraps content in AuthGuard
6. AssetsPage fetches job status via authenticated request
7. Zip download button uses POST to existing zip proxy
8. AssetGrid renders image previews for image content types
9. Per-asset download links use signed URLs from assets_manifest
</verification>

<success_criteria>
- /apps/brand-scraper/[jobId]/assets route renders the assets page
- Assets are displayed with image previews (when applicable), filenames, categories, file sizes
- Per-asset download via signed URLs works
- "Download Zip File" button at top triggers on-demand zip via POST to existing proxy
- Graceful error handling for invalid jobs, processing jobs, and empty asset lists
- All quality gates pass (build, lint, test)
</success_criteria>

<output>
After completion, create `.planning/phases/30-assets-page-user-history/30-02-SUMMARY.md`
</output>
