---
phase: 24-deploy-and-smoke-test
plan: 02
type: execute
wave: 2
depends_on: ["24-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "User can sign in with Google on dan-weinbeck.com"
    - "New user receives 100 free credits on first sign-in (signup grant)"
    - "User can purchase 500 credits for $5 via Stripe Checkout (test card 4242)"
    - "Stripe webhook fires after purchase and credits are granted"
    - "User can submit a brand scrape and credits are debited (50 credits)"
    - "Failed scrape job auto-refunds credits to user"
    - "Admin can view all billing users with balance"
    - "Admin can adjust credits and refund usage from user detail page"
    - "Admin can edit tool pricing from pricing tab"
  artifacts: []
  key_links:
    - from: "Google Sign-In button"
      to: "Firebase Auth"
      via: "Firebase SDK → Google provider → token → ensureBillingUser()"
      pattern: "signInWithPopup"
    - from: "Buy Credits button"
      to: "Stripe Checkout"
      via: "/api/billing/checkout → createCheckoutSession() → redirect"
      pattern: "checkout/route.ts"
    - from: "Stripe webhook"
      to: "Billing credits"
      via: "/api/billing/webhook → handleCheckoutCompleted() → applyPurchaseCredits()"
      pattern: "webhook/route.ts"
    - from: "Brand scrape submit"
      to: "Credits debit"
      via: "/api/tools/brand-scraper/scrape → debitCredits() → submitScrapeJob()"
      pattern: "scrape/route.ts"
---

<objective>
Smoke test every end-to-end user flow on the live production deployment: authentication, billing purchase, brand scraper, and admin panel.

Purpose: Verify that the billing-enabled site works correctly in the real production environment with Firebase Auth, Stripe test mode, Firestore, and the brand scraper service.
Output: Validated E2E requirements (E2E-01 through E2E-09) and brand scraper integration (BSINT-01, BSINT-02) documented with pass/fail status.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-deploy-and-smoke-test/24-RESEARCH.md
@.planning/phases/24-deploy-and-smoke-test/24-01-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action">
  <name>Task 1: Smoke test authentication and signup grant (E2E-01, E2E-02)</name>
  <action>
Test the complete Google Sign-In flow and verify the signup grant creates a billing user with 100 credits.

**Step-by-step:**

1. **Open an incognito/private browser window** (to ensure clean state — no cached auth)

2. **Navigate to https://dan-weinbeck.com/**
   - Verify: Site loads correctly, navigation works

3. **Click the Sign In button**
   - A Google Sign-In popup should appear
   - **If error "auth/unauthorized-domain":** Check Firebase Console -> Authentication -> Settings -> Authorized domains. `dan-weinbeck.com` must be listed.

4. **Complete the Google OAuth flow** with a test Google account (NOT the admin account `daniel.weinbeck@gmail.com` — use a different Google account for testing the regular user flow)

5. **After sign-in completes:**
   - User should see their name/avatar in the header
   - **E2E-01 PASS** if sign-in completes without errors

6. **Navigate to the billing page** (e.g., https://dan-weinbeck.com/billing or via navigation)
   - The page should show the user's credit balance
   - Balance should be **100 credits** (signup grant from `ensureBillingUser()`)
   - **E2E-02 PASS** if balance = 100 credits

7. **Check browser console for errors** (F12 -> Console tab)
   - No Firebase Auth errors
   - No 500 errors from billing API

**Pass criteria:**
- E2E-01: Google Sign-In completes successfully on dan-weinbeck.com
- E2E-02: New user's billing page shows 100 credits

**Fail criteria:**
- Sign-in popup fails or shows unauthorized domain error
- Billing page shows 0 credits or errors
- Browser console shows 500 errors from /api/billing/me
  </action>
  <verify>
  - User is signed in and can see their name in the header
  - Billing page shows 100 credits balance
  - Browser console has no auth or billing errors
  </verify>
  <done>
  E2E-01: User can sign in with Google on production domain. E2E-02: New user receives 100 free credits on first sign-in.
  </done>
</task>

<task type="checkpoint:human-action">
  <name>Task 2: Smoke test Stripe purchase flow and webhook (E2E-03, E2E-04)</name>
  <action>
Test the complete Stripe Checkout purchase flow using a test card and verify credits are granted after webhook fires.

**Prerequisites:** Must be signed in from Task 1 (same browser session).

**Step-by-step:**

1. **Navigate to the billing page** (https://dan-weinbeck.com/billing)
   - Current balance should be 100 credits (from signup grant)

2. **Click the "Buy 500 Credits ($5)" button** (or equivalent purchase button)
   - Should redirect to Stripe Checkout page
   - **If error/no redirect:** Check browser console. The /api/billing/checkout endpoint may be failing.

3. **On the Stripe Checkout page, enter test card details:**
   - Card number: `4242 4242 4242 4242`
   - Expiration: any future date (e.g., `12/28`)
   - CVC: any 3 digits (e.g., `123`)
   - ZIP: any 5 digits (e.g., `10001`)
   - Email: your test account email

4. **Complete the payment**
   - Should redirect to /billing/success page
   - **E2E-03 PASS** if payment completes and redirects to success page

5. **Navigate back to the billing page** (https://dan-weinbeck.com/billing)
   - Balance should now show **600 credits** (100 signup + 500 purchased)
   - **If balance still shows 100:** The webhook may not have fired yet. Wait 10-15 seconds and refresh.
   - **If balance still shows 100 after 30 seconds:** Check Stripe Dashboard -> Webhooks -> Recent events to see if the webhook delivery succeeded or failed.

6. **Verify webhook delivery in Stripe Dashboard:**
   - Go to https://dashboard.stripe.com/test/webhooks
   - Find the webhook endpoint for `dan-weinbeck.com/api/billing/webhook`
   - Check recent delivery: status should be 200 OK
   - **E2E-04 PASS** if webhook fired and credits appeared

7. **If webhook failed (non-200 response):**
   - Check the webhook signing secret: `gcloud secrets versions access latest --secret=stripe-webhook-secret`
   - Compare with Stripe Dashboard -> Webhooks -> Signing secret
   - If mismatch: update Secret Manager and redeploy

**Pass criteria:**
- E2E-03: Stripe Checkout completes with test card and redirects to success page
- E2E-04: Balance increases from 100 to 600 credits after webhook fires

**Fail criteria:**
- Checkout page fails to load or returns error
- Payment succeeds but credits never appear (webhook delivery failure)
- Webhook returns non-200 status (signature mismatch, route error)
  </action>
  <verify>
  - Stripe Checkout completed with test card
  - Success page displayed after payment
  - Billing page shows 600 credits (100 + 500)
  - Stripe Dashboard shows successful webhook delivery (200 OK)
  </verify>
  <done>
  E2E-03: User can purchase 500 credits for $5 via Stripe Checkout (test mode). E2E-04: Stripe webhook fires and credits are granted after purchase.
  </done>
</task>

<task type="checkpoint:human-action">
  <name>Task 3: Smoke test brand scraper flow (E2E-05, E2E-06, BSINT-01, BSINT-02)</name>
  <action>
Test the brand scraper submission flow: credit debit, job processing, and auto-refund on failure. Also verify GCS signed URL download buttons if the brand-scraper v1.1 service is live.

**Prerequisites:** Must be signed in with credits available (e.g., 600 from Task 2).

**NOTE:** If `BRAND_SCRAPER_API_URL` was empty in Plan 01, the brand scraper service is not yet deployed. In that case:
- E2E-05 and E2E-06 can still be partially tested (credit debit and auto-refund on 503 error)
- BSINT-01 and BSINT-02 should be marked as "blocked on external dependency"

**Step-by-step:**

1. **Navigate to the brand scraper page** (https://dan-weinbeck.com/apps/brand-scraper)
   - Should show the scrape submission form
   - Should display current credit balance and cost (50 credits)

2. **Submit a brand scrape request:**
   - Enter a URL to scrape (e.g., `https://example.com`)
   - Click Submit/Scrape button
   - **E2E-05 partial PASS** if the request is accepted and credits are debited

3. **Check credit balance:**
   - Navigate to billing page or check balance on the scraper page
   - Balance should decrease by 50 credits (e.g., 600 -> 550)
   - **E2E-05 PASS** if credits were debited

4. **Monitor the job status:**
   - The page should poll for job status updates
   - **If brand-scraper v1.1 IS deployed:**
     - Wait for job to complete (may take 30-60 seconds)
     - If job succeeds: verify results page shows brand data
     - Check for download buttons (brand JSON and assets ZIP)
     - **BSINT-02 PASS** if download buttons appear with working links
   - **If brand-scraper v1.1 is NOT deployed:**
     - Job should fail with connection error / 503
     - Credits should be auto-refunded (balance returns to pre-debit level)
     - **E2E-06 PASS** if auto-refund occurs

5. **Test auto-refund explicitly** (if scrape succeeded in step 4):
   - Submit another scrape with an obviously invalid URL that will cause a failure
   - Verify credits are debited and then auto-refunded when the job fails
   - **E2E-06 PASS** if auto-refund occurs on failure

6. **If brand-scraper v1.1 IS deployed, verify BSINT-01:**
   - Confirm `BRAND_SCRAPER_API_URL` env var points to the real Cloud Run URL
   - **BSINT-01 PASS** if the URL is set and the service responds

7. **Document results:**
   - If brand-scraper v1.1 not deployed: "BSINT-01 BLOCKED, BSINT-02 BLOCKED — external dependency"
   - If deployed but download links fail: "BSINT-02 FAIL — check GCS CORS config"

**Pass criteria:**
- E2E-05: Brand scrape submission accepted and credits debited (50 credits)
- E2E-06: Failed scrape auto-refunds credits
- BSINT-01: BRAND_SCRAPER_API_URL updated to real URL (conditional)
- BSINT-02: Download buttons work for brand JSON and assets ZIP (conditional)

**Fail criteria:**
- Submit button returns error without debiting credits
- Credits debited but never refunded on failure
- Download buttons show CORS errors (GCS bucket config issue)
  </action>
  <verify>
  - Brand scrape submission debited 50 credits from balance
  - Failed job triggered auto-refund (balance restored)
  - If brand-scraper v1.1 live: download buttons render and links work
  </verify>
  <done>
  E2E-05: User can submit a brand scrape and credits are debited. E2E-06: Failed scrape job auto-refunds credits. BSINT-01 and BSINT-02 status documented (pass or blocked on external dependency).
  </done>
</task>

<task type="checkpoint:human-action">
  <name>Task 4: Smoke test admin billing panel (E2E-07, E2E-08, E2E-09)</name>
  <action>
Test the admin billing panel: user list, credit adjustments, usage refunds, and pricing edits.

**Prerequisites:** Must be signed in as the admin user (`daniel.weinbeck@gmail.com`). Switch accounts if currently signed in as a test user.

**Step-by-step:**

1. **Sign in as admin** (daniel.weinbeck@gmail.com)
   - Navigate to https://dan-weinbeck.com/ and sign in with the admin Google account
   - Should have access to the control center

2. **Navigate to the admin billing panel:**
   - Go to https://dan-weinbeck.com/control-center/billing
   - Should see a table of billing users with balances
   - The test user from Tasks 1-3 should appear in the list with their current balance
   - **E2E-07 PASS** if user list loads with balance data

3. **Click on the test user to view detail:**
   - Should see user detail page with:
     - Current balance
     - Ledger history (signup grant, purchase, tool usage, refunds)
     - Usage records
     - Purchase history

4. **Test credit adjustment (E2E-08):**
   - Find the "Adjust Credits" form on the user detail page
   - Enter an adjustment amount (e.g., +50 credits)
   - Enter a reason (e.g., "Test adjustment")
   - Submit the adjustment
   - Verify the user's balance updated correctly
   - **E2E-08 partial PASS** if credit adjustment works

5. **Test usage refund (E2E-08):**
   - Find a usage record from the brand scraper test (Task 3)
   - Click "Refund" on that usage record
   - Verify the refund appears in the ledger and balance is updated
   - **E2E-08 PASS** if both adjustment and refund work

6. **Navigate to the pricing tab:**
   - Go to the pricing section of the admin billing panel
   - Should see tool pricing entries (brand_scraper at 50 credits, etc.)

7. **Test pricing edit (E2E-09):**
   - Edit the brand_scraper price (e.g., change from 50 to 75 credits)
   - Save the change
   - Verify the new price is displayed
   - **IMPORTANT:** Change it back to 50 credits after testing to restore correct pricing
   - **E2E-09 PASS** if pricing edit saves and displays correctly

**Pass criteria:**
- E2E-07: Admin sees billing users table with balances
- E2E-08: Admin can adjust credits AND refund usage from user detail page
- E2E-09: Admin can edit tool pricing and change is persisted

**Fail criteria:**
- Admin billing page shows empty table or 403 error
- Credit adjustment fails or doesn't update balance
- Pricing edit doesn't save or returns error
  </action>
  <verify>
  - Admin billing page shows user list with balances
  - Credit adjustment completed and balance updated
  - Usage refund completed and balance updated
  - Tool pricing edited, verified, and restored to original value
  </verify>
  <done>
  E2E-07: Admin can view all billing users with balance. E2E-08: Admin can adjust credits and refund usage. E2E-09: Admin can edit tool pricing. All admin panel requirements verified.
  </done>
</task>

</tasks>

<verification>
**Complete E2E Requirements Checklist:**

| Requirement | Description | Pass/Fail |
|-------------|-------------|-----------|
| E2E-01 | User can sign in with Google on production domain | |
| E2E-02 | New user receives 100 free credits on first sign-in | |
| E2E-03 | User can purchase 500 credits for $5 via Stripe Checkout (test mode) | |
| E2E-04 | Stripe webhook fires and credits are granted after purchase | |
| E2E-05 | User can submit a brand scrape and credits are debited (50 credits) | |
| E2E-06 | Failed scrape job auto-refunds credits to user | |
| E2E-07 | Admin can view all billing users with balance | |
| E2E-08 | Admin can adjust credits and refund usage from user detail page | |
| E2E-09 | Admin can edit tool pricing from pricing tab | |
| BSINT-01 | BRAND_SCRAPER_API_URL updated to real Cloud Run URL | |
| BSINT-02 | GCS signed URL passthrough verified (download buttons) | |

Fill in Pass/Fail for each row. BSINT-01 and BSINT-02 may be "BLOCKED" if brand-scraper v1.1 is not yet deployed.
</verification>

<success_criteria>
All E2E requirements (E2E-01 through E2E-09) pass in the browser on the live production deployment. BSINT-01 and BSINT-02 either pass (if brand-scraper v1.1 is deployed) or are documented as blocked on external dependency.
</success_criteria>

<output>
After completion, create `.planning/phases/24-deploy-and-smoke-test/24-02-SUMMARY.md`
</output>
