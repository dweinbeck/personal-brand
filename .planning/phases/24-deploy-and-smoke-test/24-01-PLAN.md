---
phase: 24-deploy-and-smoke-test
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Cloud Build completes successfully with billing-enabled codebase"
    - "Cloud Run revision is live and serving at dan-weinbeck.com"
    - "All 5 substitution variables are populated with correct values in the Cloud Build trigger"
    - "All 4 secrets are accessible to the Cloud Run service account at runtime"
  artifacts: []
  key_links:
    - from: "Cloud Build trigger"
      to: "cloudbuild.yaml"
      via: "Substitution variables injected as build-args and env vars"
      pattern: "_NEXT_PUBLIC_FIREBASE"
    - from: "Cloud Run service"
      to: "GCP Secret Manager"
      via: "--set-secrets in deploy step"
      pattern: "stripe-secret-key|stripe-webhook-secret"
---

<objective>
Deploy the billing-enabled codebase to Cloud Run via Cloud Build and verify the deployment is live and correctly configured.

Purpose: This is the gateway to all subsequent smoke testing. If the deployment fails or has misconfigured variables, no E2E tests can proceed.
Output: A live Cloud Run revision at dan-weinbeck.com with all billing, auth, and brand scraper environment variables set.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-deploy-and-smoke-test/24-RESEARCH.md
@.planning/phases/23-infrastructure-configuration/23-02-SUMMARY.md
@cloudbuild.yaml
</context>

<tasks>

<task type="checkpoint:human-action">
  <name>Task 1: Trigger Cloud Build deployment and verify success</name>
  <action>
Push to master to trigger Cloud Build, or manually trigger the build. Then verify the build succeeds and a new Cloud Run revision is live.

**Step-by-step:**

1. **Discover the Cloud Build trigger name:**
   ```bash
   gcloud builds triggers list --region=us-central1 --format="table(name,createTime)"
   ```

2. **Verify all substitution variables are set before deploying:**
   ```bash
   gcloud builds triggers describe TRIGGER_NAME --region=us-central1 --format="yaml(substitutions)"
   ```
   Expected: All 5 variables populated:
   - `_NEXT_PUBLIC_FIREBASE_API_KEY` = AIza...
   - `_NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN` = personal-brand-486314.firebaseapp.com
   - `_NEXT_PUBLIC_FIREBASE_PROJECT_ID` = personal-brand-486314
   - `_CHATBOT_API_URL` = https://... (FastAPI RAG backend URL)
   - `_BRAND_SCRAPER_API_URL` = https://... (may be empty if brand-scraper v1.1 not yet deployed)

3. **Trigger the deployment** (one of two methods):
   ```bash
   # Option A: Push current master to trigger automatically
   git push origin master

   # Option B: Manually trigger the build
   gcloud builds triggers run TRIGGER_NAME --region=us-central1 --branch=master
   ```

4. **Monitor the build:**
   ```bash
   gcloud builds list --limit=1 --region=us-central1 --format="table(id,status,startTime,finishTime)"
   ```
   Wait for status = SUCCESS. If FAILURE, check logs:
   ```bash
   gcloud builds log BUILD_ID --region=us-central1
   ```

5. **Verify Cloud Run revision is live:**
   ```bash
   gcloud run services describe personal-brand --region=us-central1 --format="table(status.url,status.conditions.status)"
   ```

6. **Warm up the container** (avoid cold-start timeout on first real test):
   ```bash
   curl -s -o /dev/null -w "%{http_code}" https://dan-weinbeck.com/
   ```
   Expected: HTTP 200.
  </action>
  <verify>
  - Cloud Build status = SUCCESS
  - `gcloud run revisions list --service=personal-brand --region=us-central1 --limit=1` shows a new revision with READY status
  - `curl -s -o /dev/null -w "%{http_code}" https://dan-weinbeck.com/` returns 200
  </verify>
  <done>
  Cloud Build completed successfully and a new Cloud Run revision is serving at dan-weinbeck.com. Satisfies INFRA-10.
  </done>
</task>

<task type="checkpoint:human-action">
  <name>Task 2: Verify Cloud Run environment variables and secrets</name>
  <action>
After successful deployment, verify that all environment variables and secrets are correctly injected into the Cloud Run service.

**Step-by-step:**

1. **Check environment variables:**
   ```bash
   gcloud run services describe personal-brand \
     --region=us-central1 \
     --format="yaml(spec.template.spec.containers[0].env)"
   ```
   Verify all of these are present and non-empty:
   - `FIREBASE_PROJECT_ID`
   - `NEXT_PUBLIC_FIREBASE_API_KEY`
   - `NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN` (should be `personal-brand-486314.firebaseapp.com`)
   - `NEXT_PUBLIC_FIREBASE_PROJECT_ID`
   - `CHATBOT_API_URL`
   - `BRAND_SCRAPER_API_URL` (may be empty — acceptable if brand-scraper v1.1 not yet deployed)

2. **Check secrets are mounted:**
   ```bash
   gcloud run services describe personal-brand \
     --region=us-central1 \
     --format="yaml(spec.template.spec.containers[0].env)" | grep -A2 "secretKeyRef"
   ```
   Verify all 4 secrets are present:
   - `GITHUB_TOKEN` -> `github-token:latest`
   - `TODOIST_API_TOKEN` -> `todoist-api-token:latest`
   - `STRIPE_SECRET_KEY` -> `stripe-secret-key:latest`
   - `STRIPE_WEBHOOK_SECRET` -> `stripe-webhook-secret:latest`

3. **If `BRAND_SCRAPER_API_URL` is empty:**
   Document this as "BSINT-01 blocked — brand-scraper v1.1 not yet deployed." If the URL IS known, verify it's reachable:
   ```bash
   curl -s "${BRAND_SCRAPER_API_URL}/health" || echo "Brand scraper service not reachable"
   ```

**Pass criteria:**
- All 5 env vars set (BRAND_SCRAPER_API_URL can be empty)
- All 4 secrets mounted
- If BRAND_SCRAPER_API_URL is set, the /health endpoint responds

**Fail criteria:**
- Any Firebase env var is empty or incorrect
- STRIPE_SECRET_KEY or STRIPE_WEBHOOK_SECRET is missing
  </action>
  <verify>
  - `gcloud run services describe personal-brand --region=us-central1 --format=yaml` shows all env vars and secret refs
  - INFRA-11 satisfied: all substitution variables verified
  </verify>
  <done>
  All Cloud Build substitution variables are confirmed correct in the deployed Cloud Run service. BRAND_SCRAPER_API_URL status documented. Satisfies INFRA-11.
  </done>
</task>

</tasks>

<verification>
- Cloud Build status = SUCCESS for latest build
- Cloud Run service `personal-brand` in `us-central1` has a new READY revision
- Site loads at https://dan-weinbeck.com/ with HTTP 200
- All 5 env vars present in Cloud Run config (BRAND_SCRAPER_API_URL may be empty)
- All 4 secrets mounted via secretKeyRef
</verification>

<success_criteria>
- INFRA-10: Billing-enabled build deployed to Cloud Run via Cloud Build
- INFRA-11: All Cloud Build trigger substitution variables verified
- Site is accessible at dan-weinbeck.com and responding to requests
</success_criteria>

<output>
After completion, create `.planning/phases/24-deploy-and-smoke-test/24-01-SUMMARY.md`
</output>
