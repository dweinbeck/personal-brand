---
phase: 19-content-editor-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/schemas/content.ts
  - src/lib/actions/content.ts
  - src/components/admin/TutorialEditor.tsx
  - src/app/control-center/content/new/page.tsx
  - src/app/control-center/content/page.tsx
autonomous: true

must_haves:
  truths:
    - "Editor at /control-center/content/new presents form fields for title, description, date, tags, and a markdown body textarea"
    - "Switching to Preview tab renders the markdown body via react-markdown with prose styling matching published tutorials"
    - "Clicking Save calls saveTutorial with Firebase ID token and produces an MDX file on disk"
    - "Navigating away from editor with unsaved changes triggers a browser beforeunload warning"
    - "Toggling Include fast companion shows a second textarea and saving produces both main and _slug-fast.mdx files"
    - "Content listing page has a New Tutorial link navigating to /control-center/content/new"
  artifacts:
    - path: "src/lib/schemas/content.ts"
      provides: "Extended saveTutorialSchema with optional fastBody field"
      contains: "fastBody"
    - path: "src/lib/actions/content.ts"
      provides: "Fast companion file writing logic"
      contains: "_fast.mdx"
    - path: "src/components/admin/TutorialEditor.tsx"
      provides: "Client-side editor form with tabs, preview, dirty tracking, and save"
      min_lines: 100
    - path: "src/app/control-center/content/new/page.tsx"
      provides: "Thin page wrapper rendering TutorialEditor"
      min_lines: 3
    - path: "src/app/control-center/content/page.tsx"
      provides: "Tutorial listing with New Tutorial link"
      contains: "/control-center/content/new"
  key_links:
    - from: "src/components/admin/TutorialEditor.tsx"
      to: "src/lib/actions/content.ts"
      via: "saveTutorial(token, data) call in handleSave"
      pattern: "saveTutorial"
    - from: "src/components/admin/TutorialEditor.tsx"
      to: "src/context/AuthContext.tsx"
      via: "useAuth() hook for getIdToken()"
      pattern: "useAuth"
    - from: "src/components/admin/TutorialEditor.tsx"
      to: "react-markdown"
      via: "Markdown component for preview rendering"
      pattern: "Markdown"
    - from: "src/app/control-center/content/new/page.tsx"
      to: "src/components/admin/TutorialEditor.tsx"
      via: "import and render"
      pattern: "TutorialEditor"
    - from: "src/app/control-center/content/page.tsx"
      to: "/control-center/content/new"
      via: "Link component href"
      pattern: "content/new"
---

<objective>
Build the complete Content Editor UI: extend the schema/action for fast companion support, create the TutorialEditor form component with Edit/Preview tabs and unsaved changes warning, wire it into a page at /control-center/content/new, and add navigation from the content listing page.

Purpose: Delivers CC-01 (form-guided editor with live preview) and CC-03 (optional fast companion support), completing all content editor requirements for v1.4.
Output: Working editor at /control-center/content/new that saves MDX files to disk.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-content-editor-infrastructure/18-01-SUMMARY.md
@.planning/phases/19-content-editor-ui/19-RESEARCH.md
@src/lib/schemas/content.ts
@src/lib/actions/content.ts
@src/app/control-center/content/page.tsx
@src/components/building-blocks/ArticleTabs.tsx
@src/components/projects/ReadmeRenderer.tsx
@src/components/contact/ContactForm.tsx
@src/context/AuthContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend schema and Server Action for fast companion support</name>
  <files>
    src/lib/schemas/content.ts
    src/lib/actions/content.ts
  </files>
  <action>
**Schema extension** (`src/lib/schemas/content.ts`):
Add an optional `fastBody` field to `saveTutorialSchema`:
```typescript
export const saveTutorialSchema = z.object({
  slug: tutorialSlugSchema,
  metadata: tutorialMetaSchema,
  body: z.string().min(1, "Content body is required"),
  fastBody: z.string().min(1, "Fast companion body is required").optional(),
});
```
The field must be **optional** so existing calls without `fastBody` continue to work. When provided, it must be non-empty (min 1 char). The `SaveTutorialData` type infers automatically from the updated schema.

**Action extension** (`src/lib/actions/content.ts`):
After the main file write succeeds (between step 6 and step 7 in the existing code), add fast companion writing:
```typescript
// 6b. Write fast companion if provided
if (parsed.data.fastBody) {
  const fastPath = path.resolve(CONTENT_DIR, `_${parsed.data.slug}-fast.mdx`);
  if (!fastPath.startsWith(CONTENT_DIR + path.sep)) {
    return { success: false, error: "Invalid slug." };
  }
  await writeFile(fastPath, parsed.data.fastBody, "utf-8");
}
```
**IMPORTANT:** Fast companion files contain ONLY the markdown body -- no `export const metadata` block. This matches the existing `_custom-gpt-fast.mdx` and `_setting-up-a-repo-fast.mdx` files. Do NOT wrap `fastBody` in `buildMdxContent()`.

The fast companion path also gets the path traversal check (`startsWith(CONTENT_DIR + path.sep)`).
  </action>
  <verify>
Run `npm run lint && npm run build`. Both must pass with zero errors. Verify the `SaveTutorialData` type includes `fastBody?: string` by checking TypeScript compilation succeeds.
  </verify>
  <done>
`saveTutorialSchema` accepts an optional `fastBody` string. `saveTutorial` writes `_${slug}-fast.mdx` (body-only, no metadata) when `fastBody` is provided, with path traversal protection. Existing behavior unchanged when `fastBody` is omitted.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build TutorialEditor client component</name>
  <files>
    src/components/admin/TutorialEditor.tsx
  </files>
  <action>
Create `src/components/admin/TutorialEditor.tsx` as a `"use client"` component. This is the main editor form with all state management, tabs, preview, and save logic.

**Component structure:**

1. **Imports:**
   - `useState`, `useEffect` from React
   - `Markdown` from `react-markdown`
   - `remarkGfm` from `remark-gfm`
   - `clsx` from `clsx`
   - `useAuth` from `@/context/AuthContext`
   - `saveTutorial` from `@/lib/actions/content`

2. **State:**
   - `title` (string, empty)
   - `description` (string, empty)
   - `publishedAt` (string, today's date YYYY-MM-DD)
   - `tagsInput` (string, empty -- comma-separated raw input)
   - `slug` (string, empty)
   - `body` (string, empty)
   - `includeFast` (boolean, false -- toggle for fast companion)
   - `fastBody` (string, empty)
   - `activeTab` ("edit" | "preview", default "edit")
   - `isDirty` (boolean, false -- tracks unsaved changes)
   - `saving` (boolean, false -- loading state)
   - `message` ({ type: "success" | "error", text: string } | null)

3. **Slug auto-generation:**
   - When `title` changes and `slug` hasn't been manually edited, auto-generate slug from title: lowercase, replace non-alphanumeric chars with hyphens, collapse consecutive hyphens, trim leading/trailing hyphens.
   - Track whether slug was manually edited with a ref or derived flag. If the user edits the slug field directly, stop auto-generating.

4. **Dirty tracking (`beforeunload`):**
   - Set `isDirty = true` in every field's `onChange` handler.
   - `useEffect` that registers `beforeunload` handler when `isDirty` is true, removes when false.
   - Reset `isDirty = false` after successful save.

5. **Tab switching (Edit / Preview):**
   - Follow the `ArticleTabs.tsx` pattern exactly:
     ```
     <nav className="flex items-center gap-3 text-sm mb-6">
       <button>Edit</button>
       <span className="text-border select-none">|</span>
       <button>Preview</button>
     </nav>
     ```
   - Active tab: `font-semibold text-text-primary cursor-default`
   - Inactive tab: `text-text-tertiary hover:text-gold transition-colors cursor-pointer`

6. **Edit tab content:**
   - Use `inputBase` styling from ContactForm: `"mt-1 block w-full rounded-lg border border-border px-3 py-2 shadow-sm transition-colors focus:border-gold focus:ring-1 focus:ring-gold min-h-[44px]"`
   - Fields with labels:
     - **Title** (`<input type="text">`)
     - **Slug** (`<input type="text">`, auto-generated from title, editable)
     - **Description** (`<textarea>`, 3 rows)
     - **Published Date** (`<input type="date">`, default today)
     - **Tags** (`<input type="text">`, placeholder "Separate tags with commas")
     - **Body** (`<textarea>`, monospace font via `font-mono`, min 20 rows, placeholder "Write your markdown content here...")
   - Below the body textarea, a checkbox/toggle: **"Include fast companion"** with label text. When checked, show:
     - **Fast Companion Body** (`<textarea>`, monospace, min 10 rows, placeholder "Write the fast companion content...")

7. **Preview tab content:**
   - Render the markdown body using `react-markdown` with `remarkGfm`:
     ```tsx
     <div className="prose prose-neutral max-w-none">
       <Markdown remarkPlugins={[remarkGfm]}>{body}</Markdown>
     </div>
     ```
   - If body is empty, show a placeholder: "Nothing to preview yet. Switch to the Edit tab and write some content."
   - Use the EXACT same `prose prose-neutral max-w-none` classes as the published tutorial page.

8. **Save handler:**
   ```typescript
   async function handleSave() {
     setSaving(true);
     setMessage(null);
     try {
       const token = await user?.getIdToken();
       if (!token) {
         setMessage({ type: "error", text: "Not authenticated." });
         return;
       }
       const tags = tagsInput.split(",").map(t => t.trim()).filter(Boolean);
       const result = await saveTutorial(token, {
         slug,
         metadata: { title, description, publishedAt, tags },
         body,
         fastBody: includeFast && fastBody ? fastBody : undefined,
       });
       if (result.success) {
         setIsDirty(false);
         setMessage({ type: "success", text: `Tutorial "${result.slug}" saved!` });
       } else {
         setMessage({ type: "error", text: result.error });
       }
     } catch {
       setMessage({ type: "error", text: "An unexpected error occurred." });
     } finally {
       setSaving(false);
     }
   }
   ```

9. **Save button:**
   - Below the form, a Save button with loading state:
     - Normal: "Save Tutorial"
     - Saving: "Saving..." (disabled)
   - Style: use a primary-style button similar to existing project buttons (bg-navy text-white or bg-gold text-navy-dark).

10. **Message display:**
    - Below the save button, show success (green text) or error (red text) messages.

**Styling notes:**
- Labels: `text-sm font-medium text-text-secondary`
- Use `space-y-4` or `space-y-6` for field spacing
- Wrap in max width container for readability
  </action>
  <verify>
Run `npm run lint && npm run build`. Both must pass. Verify the component file exists at `src/components/admin/TutorialEditor.tsx` and exports a default or named component.
  </verify>
  <done>
`TutorialEditor.tsx` is a `"use client"` component with: Edit/Preview tabs, form fields for all metadata + body, optional fast companion textarea, beforeunload dirty tracking, slug auto-generation from title, save handler calling saveTutorial with Firebase token, loading state, and success/error messages.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create new tutorial page and add listing navigation</name>
  <files>
    src/app/control-center/content/new/page.tsx
    src/app/control-center/content/page.tsx
  </files>
  <action>
**New page** (`src/app/control-center/content/new/page.tsx`):
Create a thin server component page that renders the TutorialEditor:
```tsx
import { TutorialEditor } from "@/components/admin/TutorialEditor";

export default function NewTutorialPage() {
  return <TutorialEditor />;
}
```
The page inherits the Control Center layout (AdminGuard + ControlCenterNav) from the parent layout at `src/app/control-center/layout.tsx`. No additional wrapping needed.

**Listing page update** (`src/app/control-center/content/page.tsx`):
Add a "New Tutorial" link to the content listing page. Place it in the header area, after the subtitle paragraph, before the table:
```tsx
import Link from "next/link";
```
Add a link styled as a button between the subtitle and the tutorial table:
```tsx
<div className="flex items-center justify-between mb-8">
  <div>
    <h1 className="text-2xl font-bold text-gray-900">Building Blocks</h1>
    <p className="text-sm text-gray-500 mt-1">
      Manage your Building Blocks tutorials. {tutorials.length} tutorial(s) published.
    </p>
  </div>
  <Link
    href="/control-center/content/new"
    className="inline-flex items-center rounded-lg bg-gold px-4 py-2 text-sm font-medium text-navy-dark hover:bg-gold/90 transition-colors"
  >
    + New Tutorial
  </Link>
</div>
```
This restructures the existing `<h1>` and `<p>` into a flex row with the link on the right side. Remove the standalone `<h1>` and `<p>` that are currently at the top of the component and replace with this flex layout.
  </action>
  <verify>
Run `npm run lint && npm run build`. Both must pass. Verify:
1. `src/app/control-center/content/new/page.tsx` exists
2. `src/app/control-center/content/page.tsx` contains a Link to `/control-center/content/new`
  </verify>
  <done>
`/control-center/content/new` renders the TutorialEditor component. The content listing page shows a "New Tutorial" button linking to the editor.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. `npm run lint` passes with zero errors
2. `npm run build` passes with zero errors
3. `src/lib/schemas/content.ts` contains `fastBody` as optional field in `saveTutorialSchema`
4. `src/lib/actions/content.ts` writes `_${slug}-fast.mdx` when fastBody provided
5. `src/components/admin/TutorialEditor.tsx` exists as "use client" component with Edit/Preview tabs
6. `src/app/control-center/content/new/page.tsx` renders TutorialEditor
7. `src/app/control-center/content/page.tsx` links to `/control-center/content/new`
</verification>

<success_criteria>
Phase 19 success criteria fully addressed:
1. Editor at /control-center/content/new with form fields for title, description, date, tags, and markdown body -- Task 2 + Task 3
2. Preview tab renders markdown via react-markdown with prose styling -- Task 2
3. Save produces MDX file on disk -- Task 1 (schema/action) + Task 2 (save handler)
4. Unsaved changes trigger browser warning -- Task 2 (beforeunload)
5. Fast companion toggle shows second textarea, saving produces both files -- Task 1 + Task 2
</success_criteria>

<output>
After completion, create `.planning/phases/19-content-editor-ui/19-01-SUMMARY.md`
</output>
