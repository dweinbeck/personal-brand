---
phase: 41-envelopes-enhancements-fund-transfers-analytics-redesign-and-weekly-rollover-workflow
plan: 04
type: execute
wave: 3
depends_on: ["41-02", "41-03"]
files_modified:
  - src/lib/envelopes/firestore.ts
  - src/lib/envelopes/types.ts
  - src/components/envelopes/EnvelopeCard.tsx
  - src/components/envelopes/EnvelopeDetailPage.tsx
autonomous: true

must_haves:
  truths:
    - "Rollover envelopes display accumulated surplus from prior completed weeks"
    - "Rollover surplus is shown as a separate line item on envelope cards (not silently merged into budget)"
    - "Rollover surplus increases the effective remaining amount for the envelope"
    - "Rollover computation skips weeks before the envelope was created"
    - "Non-rollover envelopes are unaffected by rollover computation"
  artifacts:
    - path: "src/lib/envelopes/firestore.ts"
      provides: "computeRolloverSurplus() and integration into listEnvelopesWithRemaining()"
      contains: "computeRolloverSurplus"
    - path: "src/lib/envelopes/types.ts"
      provides: "EnvelopeWithStatus extended with rolloverSurplusCents field"
      contains: "rolloverSurplusCents"
    - path: "src/components/envelopes/EnvelopeCard.tsx"
      provides: "Rollover surplus display on envelope cards"
      contains: "rollover"
    - path: "src/components/envelopes/EnvelopeDetailPage.tsx"
      provides: "Rollover surplus display on detail page header"
      contains: "rolloverSurplusCents"
  key_links:
    - from: "src/lib/envelopes/firestore.ts"
      to: "src/lib/envelopes/types.ts"
      via: "computeRolloverSurplus returns number used in EnvelopeWithStatus"
      pattern: "rolloverSurplusCents"
    - from: "src/components/envelopes/EnvelopeCard.tsx"
      to: "src/lib/envelopes/types.ts"
      via: "EnvelopeWithStatus.rolloverSurplusCents"
      pattern: "rolloverSurplusCents"
---

<objective>
Implement the weekly rollover workflow so rollover-enabled envelopes accumulate unused budget from prior weeks, with the surplus visible on cards and detail pages.

Purpose: Transform the rollover flag from a display-only concept into actual budget carry-forward, giving users a real savings mechanism within individual envelopes.
Output: Rollover computation logic, updated envelope remaining calculations, and UI display of rollover surplus.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/41-envelopes-enhancements-fund-transfers-analytics-redesign-and-weekly-rollover-workflow/41-01-SUMMARY.md
@src/lib/envelopes/firestore.ts
@src/lib/envelopes/types.ts
@src/components/envelopes/EnvelopeCard.tsx
@src/components/envelopes/EnvelopeDetailPage.tsx
@src/lib/envelopes/week-math.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rollover computation and integrate into listEnvelopesWithRemaining</name>
  <files>
    src/lib/envelopes/firestore.ts
    src/lib/envelopes/types.ts
  </files>
  <action>
  **In `src/lib/envelopes/types.ts`:**

  1. Extend `EnvelopeWithStatus` to include rollover surplus:
     ```typescript
     export type EnvelopeWithStatus = Envelope & {
       spentCents: number;
       remainingCents: number;
       status: "On Track" | "Watch" | "Over";
       rolloverSurplusCents: number; // accumulated surplus from prior completed weeks (0 for non-rollover)
     };
     ```

  **In `src/lib/envelopes/firestore.ts`:**

  1. Add a pure computation function `computeRolloverSurplus()` in the pure computation helpers section (after `computeSavingsForWeek`):

     ```typescript
     /**
      * Computes accumulated rollover surplus for a single envelope across all
      * completed prior weeks. Only applies to rollover-enabled envelopes.
      *
      * For each completed week (from envelope creation to the week before current):
      *   surplus += max(0, weeklyBudgetCents - spentInThatWeek)
      *
      * This is computed on the fly -- no separate Firestore storage needed.
      * Returns 0 for non-rollover envelopes.
      */
     export function computeRolloverSurplus(
       envelope: { weeklyBudgetCents: number; rollover: boolean; createdAt: string },
       transactions: { amountCents: number; date: string }[],
       currentWeekStart: string,
     ): number {
       if (!envelope.rollover) return 0;

       let surplus = 0;
       // Start from the week the envelope was created
       const envelopeCreatedWeekStart = format(
         startOfWeek(new Date(`${envelope.createdAt}T00:00:00`), WEEK_OPTIONS),
         "yyyy-MM-dd",
       );

       let weekStart = envelopeCreatedWeekStart;

       while (weekStart < currentWeekStart) {
         const weekStartDate = new Date(`${weekStart}T00:00:00`);
         const nextWeekDate = addWeeks(weekStartDate, 1);
         const weekEnd = format(
           new Date(nextWeekDate.getTime() - 86_400_000),
           "yyyy-MM-dd",
         );

         // Sum transactions for this envelope in this week
         const weekSpent = transactions
           .filter(t => t.date >= weekStart && t.date <= weekEnd)
           .reduce((sum, t) => sum + t.amountCents, 0);

         // Surplus for this week (floored at 0 -- overspending doesn't create negative rollover)
         surplus += Math.max(0, envelope.weeklyBudgetCents - weekSpent);

         weekStart = format(nextWeekDate, "yyyy-MM-dd");
       }

       return surplus;
     }
     ```

  2. Update `listEnvelopesWithRemaining()` to compute and include rollover surplus:

     - The function already fetches current-week transactions. It also needs ALL historical transactions for rollover envelopes to compute surplus. However, to avoid performance issues:
       - First check if ANY envelopes have `rollover: true`
       - If yes, fetch all transactions for the user (same pattern as `computeCumulativeSavings()` which already fetches all transactions)
       - If no rollover envelopes, skip the extra query

     - For each rollover envelope, call `computeRolloverSurplus()` with the envelope data, all its historical transactions (filtered by envelopeId), and the current week start string.

     - Update the `computeEnvelopeStatus()` call to include rollover surplus. The rollover surplus should be added to the effective budget. Modify the call:
       ```typescript
       const rolloverSurplusCents = envelope.rollover
         ? computeRolloverSurplus(
             { weeklyBudgetCents: data.weeklyBudgetCents, rollover: true, createdAt: envelopeCreatedAt },
             allTransactionsForEnvelope,
             weekStartStr,
           )
         : 0;

       const { remainingCents, status } = computeEnvelopeStatus(
         data.weeklyBudgetCents + rolloverSurplusCents, // effective budget includes rollover
         spentCents,
         today,
         received,
         donated,
         receivedTransfers, // from Plan 01
         sentTransfers,     // from Plan 01
       );
       ```

     - Include `rolloverSurplusCents` in the returned `EnvelopeWithStatus` object.

     - To get the `createdAt` as a YYYY-MM-DD string for each envelope, format the Firestore Timestamp:
       ```typescript
       const createdAtDate = data.createdAt?.toDate?.() ?? new Date();
       const envelopeCreatedAt = format(createdAtDate, "yyyy-MM-dd");
       ```

     - For fetching all transactions (needed for rollover computation): fetch them with a parallel query at the start of the function, alongside the existing current-week query. Only run this extra query if at least one envelope has `rollover: true`. To check this efficiently: after the envelope snap is loaded, check if any doc has `rollover === true`. If so, run the all-transactions query:
       ```typescript
       const hasRolloverEnvelopes = envSnap.docs.some(d => d.data().rollover === true);
       let allTxDocs: FirebaseFirestore.QueryDocumentSnapshot[] = [];
       if (hasRolloverEnvelopes) {
         const allTxSnap = await transactionsCol()
           .where("userId", "==", userId)
           .get();
         allTxDocs = allTxSnap.docs;
       }
       ```

  IMPORTANT: Do NOT mutate `weeklyBudgetCents` on the Firestore document. The base budget stays constant. Rollover surplus is added only when computing effective remaining.

  IMPORTANT: Avoid double-counting between rollover and savings. The existing `computeSavingsForWeek()` already skips rollover envelopes (`if (env.rollover) continue`). This is correct -- rollover envelopes accumulate surplus within themselves, while non-rollover envelopes contribute to overall savings. No changes needed to savings logic.
  </action>
  <verify>
  `npm run build` passes. `computeRolloverSurplus` is exported. `EnvelopeWithStatus` includes `rolloverSurplusCents`.
  </verify>
  <done>
  - `computeRolloverSurplus()` computes accumulated surplus for rollover envelopes
  - `listEnvelopesWithRemaining()` includes rollover surplus in effective budget calculation
  - `EnvelopeWithStatus` type includes `rolloverSurplusCents` field
  - Non-rollover envelopes always have `rolloverSurplusCents: 0`
  - Savings computation is unaffected (rollover envelopes still excluded from savings)
  - Build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Display rollover surplus on EnvelopeCard and EnvelopeDetailPage</name>
  <files>
    src/components/envelopes/EnvelopeCard.tsx
    src/components/envelopes/EnvelopeDetailPage.tsx
  </files>
  <action>
  **Update `src/components/envelopes/EnvelopeCard.tsx`:**

  In the card's middle section where it shows remaining and budget, add a rollover line when the envelope has rollover surplus > 0:

  Current:
  ```tsx
  <div className="mt-auto">
    <p className="text-2xl font-bold text-text-primary">
      {formatCents(envelope.remainingCents)}
    </p>
    <p className="text-sm text-text-secondary">
      of {formatCents(envelope.weeklyBudgetCents)} budget
    </p>
  </div>
  ```

  Updated:
  ```tsx
  <div className="mt-auto">
    <p className="text-2xl font-bold text-text-primary">
      {formatCents(envelope.remainingCents)}
    </p>
    <p className="text-sm text-text-secondary">
      of {formatCents(envelope.weeklyBudgetCents)} budget
    </p>
    {envelope.rolloverSurplusCents > 0 && (
      <p className="text-xs text-sage mt-0.5">
        +{formatCents(envelope.rolloverSurplusCents)} rollover
      </p>
    )}
  </div>
  ```

  The rollover line uses `text-sage` (green) to indicate a positive surplus, and `text-xs` to keep it visually secondary to the main remaining amount.

  **Update `src/components/envelopes/EnvelopeDetailPage.tsx`:**

  In the budget summary section at the top of the detail page, add a rollover indicator when the envelope has rollover surplus:

  Current:
  ```tsx
  <div className="mb-6 flex flex-wrap items-baseline gap-x-6 gap-y-1">
    <p className="text-text-primary">
      <span className="text-xl font-bold">{formatCents(envelope.remainingCents)}</span>
      <span className="text-sm text-text-secondary">
        of {formatCents(envelope.weeklyBudgetCents)} budget
      </span>
    </p>
    <p className="text-sm text-text-secondary">
      {formatCents(envelope.spentCents)} spent this week
    </p>
  </div>
  ```

  Updated: Add a third item to the flex wrap showing rollover if present:
  ```tsx
  <div className="mb-6 flex flex-wrap items-baseline gap-x-6 gap-y-1">
    <p className="text-text-primary">
      <span className="text-xl font-bold">{formatCents(envelope.remainingCents)}</span>{" "}
      <span className="text-sm text-text-secondary">
        of {formatCents(envelope.weeklyBudgetCents)} budget
      </span>
    </p>
    <p className="text-sm text-text-secondary">
      {formatCents(envelope.spentCents)} spent this week
    </p>
    {envelope.rolloverSurplusCents > 0 && (
      <p className="text-sm text-sage">
        +{formatCents(envelope.rolloverSurplusCents)} rollover from prior weeks
      </p>
    )}
  </div>
  ```

  This shows the rollover as a separate, clearly labeled line item so users understand where the extra budget comes from.
  </action>
  <verify>
  `npm run build` passes. `npm run lint` passes. `npm test` passes. EnvelopeCard shows rollover line. Detail page shows rollover line.
  </verify>
  <done>
  - EnvelopeCard shows "+$X.XX rollover" in green below the budget line when surplus > 0
  - EnvelopeDetailPage shows "+$X.XX rollover from prior weeks" in the header when surplus > 0
  - Non-rollover envelopes show no rollover indicator
  - Envelopes with 0 rollover surplus show no rollover indicator
  - Display is consistent between card and detail page views
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. `npm run lint` passes with zero errors
3. `npm test` passes
4. Rollover envelopes show accumulated surplus on cards and detail pages
5. Non-rollover envelopes are unaffected
6. Remaining amount correctly includes rollover surplus
7. Savings calculation still excludes rollover envelopes (no double-counting)
</verification>

<success_criteria>
- Rollover envelopes carry forward unused budget from prior completed weeks
- Surplus is transparently shown as a separate line item (not hidden)
- Effective remaining accounts for: base budget + rollover surplus - spent + allocations + transfers
- All quality gates pass
</success_criteria>

<output>
After completion, create `.planning/phases/41-envelopes-enhancements-fund-transfers-analytics-redesign-and-weekly-rollover-workflow/41-04-SUMMARY.md`
</output>
