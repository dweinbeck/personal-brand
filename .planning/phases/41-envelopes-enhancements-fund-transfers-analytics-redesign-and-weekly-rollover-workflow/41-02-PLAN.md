---
phase: 41-envelopes-enhancements-fund-transfers-analytics-redesign-and-weekly-rollover-workflow
plan: 02
type: execute
wave: 2
depends_on: ["41-01"]
files_modified:
  - src/components/envelopes/TransferModal.tsx
  - src/lib/envelopes/hooks.ts
  - src/components/envelopes/EnvelopesHomePage.tsx
  - src/components/envelopes/EnvelopeDetailPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can open a Transfer Funds modal from the home page"
    - "User can select source and target envelopes in the transfer modal"
    - "User can enter a transfer amount (validated against source remaining)"
    - "Successful transfer refreshes envelope data showing updated remaining amounts"
    - "Transfer button is hidden when billing mode is readonly"
  artifacts:
    - path: "src/components/envelopes/TransferModal.tsx"
      provides: "Fund transfer UI modal"
      min_lines: 80
    - path: "src/lib/envelopes/hooks.ts"
      provides: "useTransfers SWR hook"
      contains: "useTransfers"
    - path: "src/components/envelopes/EnvelopesHomePage.tsx"
      provides: "Transfer Funds button and modal integration"
      contains: "TransferModal"
    - path: "src/components/envelopes/EnvelopeDetailPage.tsx"
      provides: "Transfer history section on detail page"
      contains: "transfer"
  key_links:
    - from: "src/components/envelopes/TransferModal.tsx"
      to: "/api/envelopes/transfers"
      via: "envelopeFetch POST call"
      pattern: "envelopeFetch.*transfers"
    - from: "src/components/envelopes/EnvelopesHomePage.tsx"
      to: "src/components/envelopes/TransferModal.tsx"
      via: "TransferModal component import and state management"
      pattern: "TransferModal"
---

<objective>
Create the TransferModal UI component and integrate fund transfers into the home page and detail page.

Purpose: Enable users to transfer budget between envelopes through an intuitive modal interface, accessible from the main envelopes view.
Output: Working TransferModal component, Transfer Funds button on home page, transfer history on detail page.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/41-envelopes-enhancements-fund-transfers-analytics-redesign-and-weekly-rollover-workflow/41-01-SUMMARY.md
@src/components/envelopes/OverageModal.tsx
@src/components/envelopes/EnvelopesHomePage.tsx
@src/components/envelopes/EnvelopeDetailPage.tsx
@src/lib/envelopes/hooks.ts
@src/lib/envelopes/api.ts
@src/components/ui/Modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TransferModal component and useTransfers hook</name>
  <files>
    src/components/envelopes/TransferModal.tsx
    src/lib/envelopes/hooks.ts
  </files>
  <action>
  **Create `src/components/envelopes/TransferModal.tsx`:**

  Follow the OverageModal pattern but simpler (no donor allocation rows). The modal should:

  1. Accept props:
     ```typescript
     type TransferModalProps = {
       isOpen: boolean;
       onClose: () => void;
       onTransferred: () => void;
       envelopes: { id: string; title: string; remainingCents: number }[];
       getToken: () => Promise<string>;
     };
     ```

  2. Internal state:
     - `fromEnvelopeId: string` (initially empty)
     - `toEnvelopeId: string` (initially empty)
     - `amountDollars: string` (text input for dollars, convert to cents on submit)
     - `note: string` (optional)
     - `isSubmitting: boolean`
     - `serverError: string | null`

  3. UI layout (inside `<Modal>` component with `aria-labelledby`):
     - Heading: "Transfer Funds" with a close X button (same pattern as OverageModal)
     - **From Envelope:** `<select>` dropdown listing envelopes with positive remaining. Show `title (remaining: $X.XX)` as option text. Filter: only show envelopes where `remainingCents > 0`.
     - **To Envelope:** `<select>` dropdown listing all envelopes EXCEPT the currently selected source. Show `title` as option text.
     - **Amount:** `<input type="number" step="0.01" min="0.01">` with label "Amount ($)". Show max available below the input: "Max: $X.XX" based on selected source remaining.
     - **Note:** `<input type="text" maxLength={200}>` with label "Note (optional)"
     - **Error display:** Show `serverError` in red text if present
     - **Submit button:** "Transfer" (disabled when submitting, or when from/to not selected, or amount is 0/empty/exceeds max). Use `<Button variant="primary">`.
     - **Cancel button:** "Cancel" using `<Button variant="secondary">`.

  4. Submit handler:
     - Convert `amountDollars` to cents: `Math.round(parseFloat(amountDollars) * 100)`
     - Validate: amount must be > 0 and <= source remaining
     - POST to `/api/envelopes/transfers` via `envelopeFetch` with `{ fromEnvelopeId, toEnvelopeId, amountCents, note }`
     - On success: call `onTransferred()`, then `onClose()`
     - On error: set `serverError` to error message

  5. Reset state when modal closes (useEffect on `isOpen`).

  Style with Tailwind using the same patterns as OverageModal: `p-6` padding, `space-y-4` for form fields, label text is `text-sm font-medium text-text-primary`, inputs use `rounded-lg border border-border bg-white px-3 py-2 text-sm`.

  **Update `src/lib/envelopes/hooks.ts`:**

  Add a `useTransfers` hook (not needed for the modal itself, but needed for the detail page transfer history):
  ```typescript
  export function useTransfers(weekStart: string, weekEnd: string) {
    const { user } = useAuth();
    const { data, error, isLoading, mutate } = useSWR<{ transfers: EnvelopeTransfer[]; billing: BillingStatus }>(
      user ? `/api/envelopes/transfers?weekStart=${weekStart}&weekEnd=${weekEnd}` : null,
      async (url: string) => {
        const token = await user?.getIdToken();
        if (!token) throw new Error("Not authenticated");
        return envelopeFetch(url, token);
      },
    );
    return { data, error, isLoading, mutate };
  }
  ```

  Import `EnvelopeTransfer` and `BillingStatus` from types.ts in hooks.ts.
  </action>
  <verify>
  `npm run build` passes. `npm run lint` passes. TransferModal.tsx exports the component. hooks.ts exports useTransfers.
  </verify>
  <done>
  - TransferModal component renders with source/target dropdowns, amount input, note field, and submit/cancel buttons
  - Only envelopes with positive remaining appear as source options
  - Target dropdown excludes the selected source
  - Amount validation enforces max = source remaining
  - Submit POSTs to /api/envelopes/transfers and refreshes data on success
  - useTransfers hook fetches transfer data for a week range
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate TransferModal into home page and detail page</name>
  <files>
    src/components/envelopes/EnvelopesHomePage.tsx
    src/components/envelopes/EnvelopeDetailPage.tsx
  </files>
  <action>
  **Update `src/components/envelopes/EnvelopesHomePage.tsx`:**

  1. Import `TransferModal` from `./TransferModal`
  2. Add state: `const [transferOpen, setTransferOpen] = useState(false);`
  3. Add a "Transfer Funds" button next to the existing "Add Transaction" button area. Place it in the same `mb-4` div, side by side. Use a flex layout with gap:
     ```tsx
     <div className="mb-4 flex gap-2">
       {/* Add Transaction button/form stays as-is but takes flex-1 */}
       <Button variant="secondary" size="sm" onClick={() => setTransferOpen(true)}>
         Transfer Funds
       </Button>
     </div>
     ```
     Show the Transfer Funds button only when: `!isReadOnly && !isEditing && envelopes.length >= 2` (need at least 2 envelopes to transfer between).

  4. Render `<TransferModal>` at the bottom of the component (same level as OverageModal):
     ```tsx
     <TransferModal
       isOpen={transferOpen}
       onClose={() => setTransferOpen(false)}
       onTransferred={() => mutate()}
       envelopes={envelopes.map(e => ({ id: e.id, title: e.title, remainingCents: e.remainingCents }))}
       getToken={getToken}
     />
     ```

  5. The `onTransferred` callback should call `mutate()` to refresh envelope data so remaining amounts update immediately.

  **Update `src/components/envelopes/EnvelopeDetailPage.tsx`:**

  1. Import `useTransfers` from `@/lib/envelopes/hooks`
  2. Import `formatCents` (already imported)
  3. Call `useTransfers(weekStartStr, weekEndStr)` to fetch transfers for the current week
  4. Filter transfers to show only those involving this envelope (where `fromEnvelopeId === envelopeId || toEnvelopeId === envelopeId`)
  5. Add a "Transfers" section after the transaction list (before the OverageModal):
     ```tsx
     {filteredTransfers.length > 0 && (
       <>
         <div className="border-t border-border mb-6 mt-6" />
         <h2 className="font-display text-lg font-semibold text-primary mb-4">Transfers This Week</h2>
         <div className="divide-y divide-border">
           {filteredTransfers.map(t => (
             <div key={t.id} className="flex flex-col gap-1 py-3 sm:flex-row sm:items-center sm:justify-between">
               <div>
                 <span className="text-sm text-text-primary">
                   {t.fromEnvelopeId === envelopeId ? "Sent to" : "Received from"} {/* resolve envelope title */}
                 </span>
               </div>
               <span className={clsx("text-sm font-semibold", t.fromEnvelopeId === envelopeId ? "text-red-600" : "text-sage")}>
                 {t.fromEnvelopeId === envelopeId ? "-" : "+"}{formatCents(t.amountCents)}
               </span>
             </div>
           ))}
         </div>
       </>
     )}
     ```
  6. To resolve envelope titles for transfers, use the `envData.envelopes` array to look up titles by ID. Create a small helper: `const envelopeTitle = (id: string) => envData?.envelopes.find(e => e.id === id)?.title ?? "Unknown"`.
  7. If the transfer has a note, show it as a secondary line: `<p className="text-xs text-text-secondary">{t.note}</p>`.
  8. Import `clsx` for the conditional color styling.
  </action>
  <verify>
  `npm run build` passes. `npm run lint` passes. `npm test` passes.
  </verify>
  <done>
  - Home page shows "Transfer Funds" button when 2+ envelopes exist and not in edit/readonly mode
  - Clicking "Transfer Funds" opens TransferModal
  - Successful transfer refreshes envelope cards with updated remaining amounts
  - Detail page shows "Transfers This Week" section with sent/received transfers color-coded
  - Transfer notes are displayed when present
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. `npm run lint` passes with zero errors
3. `npm test` passes
4. TransferModal renders correctly with form fields
5. Home page shows Transfer Funds button (only when appropriate)
6. Detail page shows transfer history for the specific envelope
7. No regressions in existing overage allocation flow
</verification>

<success_criteria>
- Users can transfer funds between envelopes via a modal accessible from the home page
- Transfer history is visible on envelope detail pages
- Remaining amounts update immediately after a transfer
- Readonly billing mode hides the transfer button
</success_criteria>

<output>
After completion, create `.planning/phases/41-envelopes-enhancements-fund-transfers-analytics-redesign-and-weekly-rollover-workflow/41-02-SUMMARY.md`
</output>
