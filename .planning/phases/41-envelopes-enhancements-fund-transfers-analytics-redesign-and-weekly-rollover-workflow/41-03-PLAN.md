---
phase: 41-envelopes-enhancements-fund-transfers-analytics-redesign-and-weekly-rollover-workflow
plan: 03
type: execute
wave: 2
depends_on: ["41-01"]
files_modified:
  - src/components/envelopes/SpendingByEnvelopeChart.tsx
  - src/components/envelopes/SpendingTrendChart.tsx
  - src/components/envelopes/AnalyticsPage.tsx
  - src/lib/envelopes/firestore.ts
  - src/lib/envelopes/types.ts
autonomous: true

must_haves:
  truths:
    - "Analytics page shows a bar chart of budget vs. spent per envelope"
    - "Analytics page shows a line chart of weekly spending totals over time"
    - "Existing analytics sections (SummaryStats, WeeklyPivotTable, SavingsChart) remain visible and functional"
    - "Analytics API returns enhanced data including spendingByEnvelope and weeklyTotals arrays"
  artifacts:
    - path: "src/components/envelopes/SpendingByEnvelopeChart.tsx"
      provides: "Horizontal bar chart showing budget vs spent per envelope"
      min_lines: 40
    - path: "src/components/envelopes/SpendingTrendChart.tsx"
      provides: "Line chart showing weekly spending totals over time"
      min_lines: 40
    - path: "src/components/envelopes/AnalyticsPage.tsx"
      provides: "Redesigned analytics layout with new chart sections"
      contains: "SpendingByEnvelopeChart"
    - path: "src/lib/envelopes/types.ts"
      provides: "Enhanced AnalyticsPageData type with new data fields"
      contains: "spendingByEnvelope"
  key_links:
    - from: "src/components/envelopes/AnalyticsPage.tsx"
      to: "src/components/envelopes/SpendingByEnvelopeChart.tsx"
      via: "component import and data prop"
      pattern: "SpendingByEnvelopeChart"
    - from: "src/components/envelopes/AnalyticsPage.tsx"
      to: "src/components/envelopes/SpendingTrendChart.tsx"
      via: "component import and data prop"
      pattern: "SpendingTrendChart"
    - from: "src/lib/envelopes/firestore.ts"
      to: "src/lib/envelopes/types.ts"
      via: "getAnalyticsData returns AnalyticsPageData"
      pattern: "spendingByEnvelope|weeklyTotals"
---

<objective>
Enhance the analytics page with two new chart components and extended API data: a per-envelope budget utilization bar chart and a weekly spending trend line chart.

Purpose: Give users better visual insight into their spending patterns across envelopes and over time.
Output: Two new recharts components, enhanced analytics API data, and an updated AnalyticsPage layout.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/components/envelopes/AnalyticsPage.tsx
@src/components/envelopes/SavingsChart.tsx
@src/components/envelopes/SummaryStats.tsx
@src/components/envelopes/WeeklyPivotTable.tsx
@src/lib/envelopes/types.ts
@src/lib/envelopes/firestore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend AnalyticsPageData type and getAnalyticsData function</name>
  <files>
    src/lib/envelopes/types.ts
    src/lib/envelopes/firestore.ts
  </files>
  <action>
  **In `src/lib/envelopes/types.ts`:**

  Add two new fields to the `AnalyticsPageData` type (extend it, don't replace existing fields):

  ```typescript
  export type AnalyticsPageData = {
    summary: { /* existing */ };
    envelopes: { id: string; title: string }[];
    pivotRows: PivotRow[];
    savingsByWeek: WeeklySavingsEntry[];
    billing: BillingStatus;
    // NEW: Per-envelope spending breakdown for bar chart
    spendingByEnvelope: {
      envelopeId: string;
      title: string;
      spentCents: number;
      budgetCents: number;
      percentUsed: number; // 0-100+, can exceed 100 for over-budget
    }[];
    // NEW: Weekly totals for trend line chart
    weeklyTotals: {
      weekStart: string;
      weekLabel: string;
      totalSpentCents: number;
      totalBudgetCents: number;
    }[];
  };
  ```

  **In `src/lib/envelopes/firestore.ts` â€” update `getAnalyticsData()`:**

  After the existing step 3 (computing SUMMARY), add computation of the two new data fields:

  1. **`spendingByEnvelope`:** For each envelope in `envelopeData`, compute:
     - `spentCents`: from `spentByEnvelope` map (current week)
     - `budgetCents`: `env.weeklyBudgetCents`
     - `percentUsed`: `Math.round((spentCents / budgetCents) * 100)` (handle division by zero: 0 if budgetCents is 0)
     - Sort descending by `percentUsed` (most utilized first)

  2. **`weeklyTotals`:** Iterate over completed weeks from `earliestWeekStart` to the current week end. For each week:
     - Sum all transaction amounts in that week for `totalSpentCents`
     - Sum all envelope budgets for `totalBudgetCents` (same value each week since budgets don't change per-week)
     - Use `getWeekNumber()` for `weekLabel`
     - Include the current week too (unlike savings which only counts completed weeks)
     - Reuse the existing `allTransactions` array that's already fetched

  Add both new fields to the return object of `getAnalyticsData()`.

  IMPORTANT: The `AnalyticsPageData` type has `billing` as a required field, but `getAnalyticsData()` returns `Omit<AnalyticsPageData, "billing">`. Make sure the new fields are part of the Omit return type. Actually, check the existing pattern: the function returns `Omit<AnalyticsPageData, "billing">` and the route handler adds `billing` when constructing the response. Follow this same pattern for the new fields.
  </action>
  <verify>
  `npm run build` passes. The new fields are part of the AnalyticsPageData type. `getAnalyticsData()` returns the new fields.
  </verify>
  <done>
  - AnalyticsPageData type includes `spendingByEnvelope` and `weeklyTotals` arrays
  - getAnalyticsData() computes and returns both new data arrays
  - Existing analytics data (summary, pivotRows, savingsByWeek) is unchanged
  - Build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Create chart components and update AnalyticsPage layout</name>
  <files>
    src/components/envelopes/SpendingByEnvelopeChart.tsx
    src/components/envelopes/SpendingTrendChart.tsx
    src/components/envelopes/AnalyticsPage.tsx
  </files>
  <action>
  **Create `src/components/envelopes/SpendingByEnvelopeChart.tsx`:**

  A horizontal bar chart showing budget utilization per envelope. Follow the SavingsChart pattern for recharts usage.

  ```typescript
  "use client";

  import { Bar, BarChart, CartesianGrid, ResponsiveContainer, Tooltip, XAxis, YAxis } from "recharts";
  import { formatCents } from "@/lib/envelopes/format";
  ```

  Props: `{ data: { title: string; spentCents: number; budgetCents: number; percentUsed: number }[] }`

  - Use `<BarChart layout="vertical">` for horizontal bars
  - XAxis: `type="number"`, tickFormatter using `formatCents`
  - YAxis: `type="category"`, `dataKey="title"`, width 120 for envelope names
  - Two bars stacked or grouped:
    - Bar for `spentCents` with fill `#1b2a4a` (primary color) and name "Spent"
    - Bar for remaining (`budgetCents - spentCents`, floor at 0) with fill `#e8e0d0` (gold-light) and name "Remaining"
    - Actually, use a single bar for `spentCents` with a reference line or background bar showing `budgetCents`. Simpler approach: use a stacked bar chart with two bars: "spent" and "unspent" (= max(0, budget - spent)).
  - Tooltip: Show spent, budget, and percent used
  - ResponsiveContainer: width 100%, height auto (calculate based on data length: `Math.max(200, data.length * 50)`)
  - Empty state: "No spending data for this week." if data is empty or all zeros

  Use colors consistent with the existing design system:
  - Spent: `#1b2a4a` (primary/navy)
  - Unspent/remaining: `#d4c9b0` (muted gold)

  **Create `src/components/envelopes/SpendingTrendChart.tsx`:**

  A line chart showing weekly spending totals over time. Follow the SavingsChart pattern closely.

  Props: `{ data: { weekLabel: string; totalSpentCents: number; totalBudgetCents: number }[] }`

  - Use `<LineChart>` from recharts
  - XAxis: `dataKey="weekLabel"`
  - YAxis: `tickFormatter` using `formatCents`
  - Two lines:
    - Spending line: `dataKey="totalSpentCents"`, stroke `#1b2a4a`, strokeWidth 2, name "Spent"
    - Budget line: `dataKey="totalBudgetCents"`, stroke `#b8860b` (gold), strokeWidth 2, strokeDasharray "5 5", name "Budget"
  - CartesianGrid: same style as SavingsChart (`strokeDasharray="3 3" stroke="rgba(27,42,74,0.1)"`)
  - Tooltip: Show both values formatted as currency
  - ResponsiveContainer: width 100%, height 300
  - Empty state: "Spending trend data will appear after your first week."

  **Update `src/components/envelopes/AnalyticsPage.tsx`:**

  1. Import `SpendingByEnvelopeChart` and `SpendingTrendChart`
  2. Add two new sections to the existing layout. Insert them BETWEEN the "This Week" (SummaryStats) section and the "Weekly Spending" (WeeklyPivotTable) section. New section order:
     - This Week (SummaryStats) -- existing
     - **Budget Utilization** (SpendingByEnvelopeChart) -- NEW
     - **Spending Trend** (SpendingTrendChart) -- NEW
     - Weekly Spending (WeeklyPivotTable) -- existing
     - Savings Growth (SavingsChart) -- existing

  3. Each new section follows the same pattern as existing sections:
     ```tsx
     <section>
       <h2 className="text-lg font-semibold font-display text-primary mb-4">
         Budget Utilization
       </h2>
       <SpendingByEnvelopeChart data={data.spendingByEnvelope} />
     </section>
     ```

  4. Pass the correct data props from `data` (which is `AnalyticsPageData`).
  </action>
  <verify>
  `npm run build` passes. `npm run lint` passes. `npm test` passes. AnalyticsPage renders all 5 sections.
  </verify>
  <done>
  - SpendingByEnvelopeChart renders a horizontal bar chart with budget vs. spent per envelope
  - SpendingTrendChart renders a line chart with weekly spending and budget lines
  - AnalyticsPage includes both new charts between SummaryStats and WeeklyPivotTable
  - All existing analytics sections remain functional
  - Design is consistent with existing chart styling (colors, fonts, grid)
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. `npm run lint` passes with zero errors
3. `npm test` passes
4. Analytics page renders 5 sections in the correct order
5. New charts use recharts components consistent with existing SavingsChart
6. Data flows correctly from API through hooks to chart components
</verification>

<success_criteria>
- Analytics page has two new visual charts providing spending insights
- Budget utilization bar chart shows per-envelope spending with a visual comparison to budget
- Spending trend line chart shows weekly totals with a budget reference line
- Existing analytics features (summary stats, pivot table, savings chart) are preserved
- All quality gates pass
</success_criteria>

<output>
After completion, create `.planning/phases/41-envelopes-enhancements-fund-transfers-analytics-redesign-and-weekly-rollover-workflow/41-03-SUMMARY.md`
</output>
