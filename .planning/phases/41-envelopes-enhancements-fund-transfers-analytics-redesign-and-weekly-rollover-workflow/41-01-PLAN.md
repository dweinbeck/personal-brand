---
phase: 41-envelopes-enhancements-fund-transfers-analytics-redesign-and-weekly-rollover-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/envelopes/types.ts
  - src/lib/envelopes/firestore.ts
  - src/app/api/envelopes/transfers/route.ts
  - firestore.indexes.json
autonomous: true

must_haves:
  truths:
    - "POST /api/envelopes/transfers creates a transfer document and returns 201"
    - "GET /api/envelopes/transfers?weekStart=...&weekEnd=... returns transfer documents for the user"
    - "Transfer validation rejects transfers where amountCents exceeds source envelope remaining"
    - "Transfer validation rejects transfers where fromEnvelopeId equals toEnvelopeId"
    - "Transfers are atomically written using Firestore runTransaction"
  artifacts:
    - path: "src/lib/envelopes/types.ts"
      provides: "Transfer Zod schema and TypeScript types"
      contains: "transferSchema"
    - path: "src/lib/envelopes/firestore.ts"
      provides: "transfersCol(), createTransfer(), listTransfersForWeek()"
      contains: "transfersCol"
    - path: "src/app/api/envelopes/transfers/route.ts"
      provides: "POST and GET API route for transfers"
      exports: ["POST", "GET"]
    - path: "firestore.indexes.json"
      provides: "Compound index for envelope_transfers collection"
      contains: "envelope_transfers"
  key_links:
    - from: "src/app/api/envelopes/transfers/route.ts"
      to: "src/lib/envelopes/firestore.ts"
      via: "createTransfer() and listTransfersForWeek()"
      pattern: "createTransfer|listTransfersForWeek"
    - from: "src/app/api/envelopes/transfers/route.ts"
      to: "src/lib/envelopes/types.ts"
      via: "transferSchema.safeParse()"
      pattern: "transferSchema\\.safeParse"
---

<objective>
Create the backend infrastructure for envelope fund transfers: Zod schemas, Firestore CRUD operations, and API route.

Purpose: Enable users to transfer budget between envelopes within a week. This is the data layer that the UI (Plan 02) will consume.
Output: Working POST/GET API endpoints for transfers, new Firestore collection + index, and validated type definitions.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/lib/envelopes/types.ts
@src/lib/envelopes/firestore.ts
@src/app/api/envelopes/allocations/route.ts
@firestore.indexes.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add transfer types, Zod schema, and Firestore operations</name>
  <files>
    src/lib/envelopes/types.ts
    src/lib/envelopes/firestore.ts
  </files>
  <action>
  **In `src/lib/envelopes/types.ts`:**

  1. Add a `transferSchema` Zod input schema (placed after `overageAllocationSchema`):
     ```typescript
     export const transferSchema = z.object({
       fromEnvelopeId: z.string().min(1),
       toEnvelopeId: z.string().min(1),
       amountCents: z.number().int().min(1),
       note: z.string().max(200).optional(),
     });
     export type TransferInput = z.infer<typeof transferSchema>;
     ```

  2. Add an `EnvelopeTransfer` Firestore document type (placed after `OverageAllocation`):
     ```typescript
     export type EnvelopeTransfer = {
       id: string;
       userId: string;
       fromEnvelopeId: string;
       toEnvelopeId: string;
       amountCents: number;
       weekStart: string; // YYYY-MM-DD -- scoped to the current week
       note?: string;
       createdAt: Timestamp;
     };
     ```

  **In `src/lib/envelopes/firestore.ts`:**

  1. Add `transfersCol()` function (placed after `envelopeProfilesCol()`):
     ```typescript
     export function transfersCol() {
       return requireDb().collection("envelope_transfers");
     }
     ```

  2. Add `createTransfer()` function that uses `firestore.runTransaction()` (NOT batch writes) for atomicity. The function should:
     - Accept `userId: string`, `input: TransferInput`, `weekStart: string`
     - Inside the transaction: read both envelope docs, verify they exist and belong to userId, verify `fromEnvelopeId !== toEnvelopeId`
     - Compute source envelope's remaining for the current week (query transactions + existing allocations + existing transfers for the week to get effective remaining). IMPORTANT: The remaining must account for transfers already made from/to this envelope in the current week.
     - Validate `amountCents <= sourceRemaining` (only allow transfers from positive remaining)
     - Create a document in `envelope_transfers` with: userId, fromEnvelopeId, toEnvelopeId, amountCents, weekStart, note (if provided), createdAt (FieldValue.serverTimestamp())
     - Note: Firestore transactions cannot query collections inside the transaction. Instead, compute remaining BEFORE the transaction using the same pattern as `listEnvelopesWithRemaining()`, then use the transaction only for the write + envelope existence check.
     - Actually, use this approach: Compute the source remaining outside the transaction (fetching transactions, allocations, and existing transfers for the week), then use `runTransaction()` only to verify envelope ownership and write the transfer document. This matches the allocations route pattern where validation happens before the write.

  3. Add `listTransfersForWeek()` function:
     - Accept `userId: string`, `weekStart: string`, `weekEnd: string`
     - Query `envelope_transfers` where `userId == userId` and `weekStart >= weekStart` and `weekStart <= weekEnd`, ordered by `createdAt` desc
     - Return `EnvelopeTransfer[]` with id included

  4. Update `computeEnvelopeStatus()` signature to also accept `receivedTransfersCents = 0` and `sentTransfersCents = 0` as optional parameters. Update the remainingCents formula:
     ```
     remainingCents = weeklyBudgetCents - spentCents + receivedAllocationsCents - donatedAllocationsCents + receivedTransfersCents - sentTransfersCents
     ```

  5. Update `listEnvelopesWithRemaining()` to also query `envelope_transfers` for the current week and factor transfer amounts into each envelope's remaining calculation. Add parallel fetch of transfers alongside the existing envelope + transaction queries. Build `receivedTransfersByEnvelope` and `sentTransfersByEnvelope` maps, then pass them to `computeEnvelopeStatus()`.

  Import `TransferInput` type in firestore.ts. Add `EnvelopeTransfer` to the imports from types.ts.
  </action>
  <verify>
  `npm run build` passes with no type errors. The new functions are exported and have correct signatures.
  </verify>
  <done>
  - `transferSchema` and `TransferInput` type exist in types.ts
  - `EnvelopeTransfer` Firestore document type exists in types.ts
  - `transfersCol()`, `createTransfer()`, `listTransfersForWeek()` exist in firestore.ts
  - `computeEnvelopeStatus()` accounts for transfer amounts
  - `listEnvelopesWithRemaining()` includes transfer data in remaining calculations
  - Build passes cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Create transfers API route and Firestore index</name>
  <files>
    src/app/api/envelopes/transfers/route.ts
    firestore.indexes.json
  </files>
  <action>
  **Create `src/app/api/envelopes/transfers/route.ts`:**

  Follow the exact same pattern as `src/app/api/envelopes/allocations/route.ts`:

  1. **POST handler:**
     - Call `verifyUser(request)` for auth, return `unauthorizedResponse` if not authorized
     - Call `checkEnvelopeAccess(auth.uid, auth.email)` for billing check, return 402 if readonly
     - Parse body with `transferSchema.safeParse(body)`, return 400 if invalid
     - Get current week with `getWeekRange(new Date())` and format weekStart
     - Call `createTransfer(auth.uid, parsed.data, weekStartStr)`
     - Return `{ success: true }` with status 201
     - Wrap in try/catch, log errors with `console.error("POST /api/envelopes/transfers error:", ...)`, return 500 on failure

  2. **GET handler:**
     - Call `verifyUser(request)` for auth
     - Extract `weekStart` and `weekEnd` from URL search params (required)
     - Return 400 if either is missing
     - Call `checkEnvelopeAccess(auth.uid, auth.email)` for billing status
     - Call `listTransfersForWeek(auth.uid, weekStart, weekEnd)`
     - Return `{ transfers, billing: { mode, reason } }` as JSON
     - Wrap in try/catch with error logging

  Import from:
  - `@/lib/auth/user`: `verifyUser`, `unauthorizedResponse`
  - `@/lib/envelopes/billing`: `checkEnvelopeAccess`
  - `@/lib/envelopes/firestore`: `createTransfer`, `listTransfersForWeek`
  - `@/lib/envelopes/types`: `transferSchema`
  - `@/lib/envelopes/week-math`: `getWeekRange`
  - `date-fns`: `format`

  **Update `firestore.indexes.json`:**

  Add a new compound index entry for the `envelope_transfers` collection:
  ```json
  {
    "collectionGroup": "envelope_transfers",
    "queryScope": "COLLECTION",
    "fields": [
      { "fieldPath": "userId", "order": "ASCENDING" },
      { "fieldPath": "weekStart", "order": "ASCENDING" }
    ]
  }
  ```

  Place it after the existing `envelope_transactions` indexes.
  </action>
  <verify>
  `npm run build` passes. `npm run lint` passes. The route file exports POST and GET functions.
  </verify>
  <done>
  - POST /api/envelopes/transfers accepts transfer input, validates with Zod, creates transfer via Firestore transaction, returns 201
  - GET /api/envelopes/transfers returns transfers for a week range
  - Both routes have auth checks (verifyUser) and billing checks (checkEnvelopeAccess)
  - Firestore index for envelope_transfers is defined
  - Build and lint pass cleanly
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. `npm run lint` passes with zero errors
3. `npm test` passes (existing tests still work)
4. New types are exported from types.ts
5. New functions are exported from firestore.ts
6. API route file exists and exports POST and GET
7. Firestore index includes envelope_transfers entry
</verification>

<success_criteria>
- Fund transfer backend is complete: types defined, Firestore operations work, API endpoints created
- Transfer amounts are factored into envelope remaining calculations (no double-counting with allocations)
- Existing overage allocation flow is unaffected
- All quality gates pass
</success_criteria>

<output>
After completion, create `.planning/phases/41-envelopes-enhancements-fund-transfers-analytics-redesign-and-weekly-rollover-workflow/41-01-SUMMARY.md`
</output>
