---
phase: 03-llm-router-destination-handlers
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/lib/gsd/destinations/github.ts
autonomous: true
requirements:
  - ROUTE-GITHUB

must_haves:
  truths:
    - "routeToGitHub creates a GitHub issue using @octokit/rest"
    - "Issue title comes from routing.title, body includes routing.summary"
    - "Issue body includes original capture metadata (priority, confidence, category)"
    - "Labels are applied based on routing priority (high → priority:high, etc.)"
    - "Bug label added when title/summary contains bug-related keywords"
    - "Returns the issue HTML URL as destinationRef"
    - "GITHUB_PAT env var is required — throws if not set"
    - "Target repo is configurable via GSD_GITHUB_REPO env var (format: owner/repo)"
    - "npm run build succeeds"
    - "npm run lint passes"
  artifacts:
    - path: "src/lib/gsd/destinations/github.ts"
      provides: "GitHub issue creation destination handler"
      exports: ["routeToGitHub"]
  key_links:
    - from: "src/lib/gsd/destinations/github.ts"
      to: "@octokit/rest"
      via: "import Octokit"
      pattern: "import.*Octokit.*from.*@octokit/rest"
    - from: "src/lib/gsd/router.ts"
      to: "src/lib/gsd/destinations/github.ts"
      via: "dynamic import"
      pattern: "import.*destinations/github"
---

<objective>
Create the GitHub destination handler that creates issues from classified captures using @octokit/rest. This is one of three destination handlers (GitHub, Tasks, Inbox) that the routing pipeline dispatches to.

Purpose: When a capture is classified as a code-related item (bug report, feature request, refactoring idea), it should automatically become a GitHub issue with proper labels and a structured body.

Output: One new file — src/lib/gsd/destinations/github.ts. Also requires installing @octokit/rest.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/lib/gsd/router.ts
@src/lib/gsd/schemas.ts
@src/lib/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @octokit/rest and add GSD_GITHUB_REPO env var</name>
  <files>
    src/lib/env.ts
  </files>
  <action>
    **1a. Install @octokit/rest:**

    ```bash
    npm install @octokit/rest
    ```

    **1b. Add GSD_GITHUB_REPO to `src/lib/env.ts`:**

    Add to `serverEnvBaseSchema` after `DISCORD_WEBHOOK_URL`:

    ```typescript
    GSD_GITHUB_REPO: z
      .string()
      .min(1)
      .refine(
        (val) => /^[^/]+\/[^/]+$/.test(val),
        "GSD_GITHUB_REPO must be in 'owner/repo' format",
      )
      .optional(),
    ```

    Add to both `serverEnv()` and `validateServerEnv()` parse calls:
    ```typescript
    GSD_GITHUB_REPO: optionalEnv(process.env.GSD_GITHUB_REPO),
    ```
  </action>
  <verify>
    1. `npm run build` succeeds
    2. `npm run lint` passes
    3. @octokit/rest is in package.json dependencies
    4. GSD_GITHUB_REPO is optional in env schema
  </verify>
  <done>
    - @octokit/rest installed
    - GSD_GITHUB_REPO env var registered as optional with owner/repo format validation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub destination handler</name>
  <files>
    src/lib/gsd/destinations/github.ts
  </files>
  <action>
    **Create `src/lib/gsd/destinations/github.ts`:**

    ```typescript
    import { Octokit } from "@octokit/rest";
    import type { RoutingOutput } from "../schemas";

    /**
     * Create a GitHub issue from a routing result.
     * Returns the issue HTML URL.
     */
    export async function routeToGitHub(routing: RoutingOutput): Promise<string> {
      const token = process.env.GITHUB_PAT;
      if (!token) {
        throw new Error("GITHUB_PAT not configured. Cannot create GitHub issues.");
      }

      const repo = process.env.GSD_GITHUB_REPO;
      if (!repo) {
        throw new Error(
          "GSD_GITHUB_REPO not configured. Set to 'owner/repo' format.",
        );
      }

      const [owner, repoName] = repo.split("/");

      const octokit = new Octokit({ auth: token });

      // Build labels
      const labels: string[] = [`priority:${routing.priority}`];

      // Add bug label if title/summary suggests a bug
      const bugKeywords = /\b(bug|fix|broken|error|crash|fail|500|404|issue)\b/i;
      if (
        bugKeywords.test(routing.title) ||
        bugKeywords.test(routing.summary)
      ) {
        labels.push("bug");
      } else {
        labels.push("enhancement");
      }

      // Add "gsd-capture" label to identify auto-created issues
      labels.push("gsd-capture");

      // Build issue body
      const body = [
        routing.summary,
        "",
        "---",
        "*Auto-created by GSD Builder OS capture pipeline*",
        "",
        `| Field | Value |`,
        `|-------|-------|`,
        `| Priority | ${routing.priority} |`,
        `| Confidence | ${(routing.confidence * 100).toFixed(0)}% |`,
        `| Category | ${routing.category} |`,
      ].join("\n");

      const { data: issue } = await octokit.issues.create({
        owner,
        repo: repoName,
        title: routing.title,
        body,
        labels,
      });

      return issue.html_url;
    }
    ```

    **Key decisions:**
    - `Octokit` instantiated per-call (not module-level singleton) — avoids stale tokens and simplifies testing
    - Labels auto-applied: priority level, bug/enhancement, and gsd-capture identifier
    - Bug detection via keyword regex on title and summary
    - Issue body includes metadata table for audit trail
    - GITHUB_PAT and GSD_GITHUB_REPO are required at runtime — throw clear errors if missing
  </action>
  <verify>
    1. `npm run build` succeeds
    2. `npm run lint` passes
    3. Verify Octokit uses GITHUB_PAT (not GITHUB_TOKEN — that's the read-only one)
    4. Verify labels include "gsd-capture" for identification
    5. Verify body includes metadata table
  </verify>
  <done>
    - routeToGitHub creates GitHub issues with proper labels and structured body
    - Uses GITHUB_PAT (write token) — not GITHUB_TOKEN (read-only)
    - Bug vs enhancement label applied based on keyword detection
    - gsd-capture label marks auto-created issues
    - Returns issue HTML URL for destinationRef
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` — zero errors
2. `npm run build` — zero errors
3. `npm test` — all existing tests pass
4. Manual check: @octokit/rest in package.json
5. Manual check: GitHub handler uses GITHUB_PAT env var
6. Manual check: Issue body includes routing metadata
</verification>

<success_criteria>
- @octokit/rest installed and imported correctly
- routeToGitHub creates issues with title, body, and labels
- Priority and bug/enhancement labels auto-applied
- gsd-capture label identifies auto-created issues
- GSD_GITHUB_REPO env var validates owner/repo format
- Build, lint, and test all pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-llm-router-destination-handlers/03-02-SUMMARY.md`
</output>
