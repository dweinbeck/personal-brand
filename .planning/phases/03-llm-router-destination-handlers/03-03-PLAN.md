---
phase: 03-llm-router-destination-handlers
plan: 03
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/lib/gsd/destinations/tasks.ts
  - src/lib/gsd/capture.ts
autonomous: true
requirements:
  - ROUTE-TASKS
  - ROUTE-INBOX
  - ROUTE-STATUS

must_haves:
  truths:
    - "routeToTask creates a task via the Tasks service layer (direct import, not HTTP)"
    - "routeToTask uses a configurable GSD_TASKS_USER_ID and GSD_TASKS_PROJECT_ID"
    - "routeToTask returns the created task ID as destinationRef"
    - "Task name comes from routing.title, description from routing.summary"
    - "Inbox fallback stores capture in Firestore with destination='inbox' (no external action needed)"
    - "getAllCaptures returns paginated list of captures for admin UI (Phase 4)"
    - "npm run build succeeds"
    - "npm run lint passes"
  artifacts:
    - path: "src/lib/gsd/destinations/tasks.ts"
      provides: "Tasks destination handler — creates tasks from captures"
      exports: ["routeToTask"]
    - path: "src/lib/gsd/capture.ts"
      provides: "Extended with getAllCaptures for admin listing"
      exports: ["getAllCaptures"]
  key_links:
    - from: "src/lib/gsd/destinations/tasks.ts"
      to: "src/services/tasks/task.service.ts"
      via: "import createTask"
      pattern: "import.*createTask.*from.*task\\.service"
    - from: "src/lib/gsd/router.ts"
      to: "src/lib/gsd/destinations/tasks.ts"
      via: "dynamic import"
      pattern: "import.*destinations/tasks"
---

<objective>
Create the Tasks destination handler and Builder Inbox fallback. Also add admin query helpers to capture.ts for the Phase 4 admin UI.

Purpose: Completes the routing pipeline — captures classified as personal todos become Tasks app entries, and low-confidence or ambiguous captures land in the Builder Inbox for manual review.

Output: One new file (destinations/tasks.ts), one modified file (capture.ts extended with listing queries).
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/lib/gsd/capture.ts
@src/lib/gsd/schemas.ts
@src/lib/gsd/router.ts
@src/services/tasks/task.service.ts
@src/lib/schemas/tasks/task.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GSD_TASKS env vars and create Tasks destination handler</name>
  <files>
    src/lib/env.ts
    src/lib/gsd/destinations/tasks.ts
  </files>
  <action>
    **1a. Add env vars to `src/lib/env.ts`:**

    Add to `serverEnvBaseSchema` after `GSD_GITHUB_REPO`:

    ```typescript
    GSD_TASKS_USER_ID: z.string().min(1).optional(),
    GSD_TASKS_PROJECT_ID: z.string().min(1).optional(),
    ```

    Add to both `serverEnv()` and `validateServerEnv()` parse calls:
    ```typescript
    GSD_TASKS_USER_ID: optionalEnv(process.env.GSD_TASKS_USER_ID),
    GSD_TASKS_PROJECT_ID: optionalEnv(process.env.GSD_TASKS_PROJECT_ID),
    ```

    **1b. Create `src/lib/gsd/destinations/tasks.ts`:**

    ```typescript
    import { createTask } from "@/services/tasks/task.service";
    import type { RoutingOutput } from "../schemas";

    /**
     * Create a task from a routing result.
     * Returns the created task ID.
     */
    export async function routeToTask(routing: RoutingOutput): Promise<string> {
      const userId = process.env.GSD_TASKS_USER_ID;
      if (!userId) {
        throw new Error(
          "GSD_TASKS_USER_ID not configured. Cannot create tasks from captures.",
        );
      }

      const projectId = process.env.GSD_TASKS_PROJECT_ID;
      if (!projectId) {
        throw new Error(
          "GSD_TASKS_PROJECT_ID not configured. Set to the target project ID for captured tasks.",
        );
      }

      // Map routing priority to effort score (used by Tasks app)
      const effortMap: Record<string, number> = {
        high: 3,
        medium: 2,
        low: 1,
      };

      const task = await createTask(userId, {
        projectId,
        name: routing.title,
        description: [
          routing.summary,
          "",
          `_Auto-created by GSD capture pipeline (confidence: ${(routing.confidence * 100).toFixed(0)}%)_`,
        ].join("\n"),
        effort: effortMap[routing.priority] ?? 2,
      });

      return task.id;
    }
    ```

    **Key decisions:**
    - Direct service layer import (no HTTP round-trip) — Tasks lives in the same app
    - userId and projectId from env vars — configurable without code changes
    - Effort score mapped from priority for Tasks app integration
    - Description includes confidence metadata for audit trail
  </action>
  <verify>
    1. `npm run build` succeeds
    2. `npm run lint` passes
    3. Verify tasks.ts imports createTask from the service layer (not an HTTP call)
    4. Verify env vars are optional
  </verify>
  <done>
    - routeToTask creates tasks via direct service layer import
    - GSD_TASKS_USER_ID and GSD_TASKS_PROJECT_ID env vars registered
    - Effort score maps from routing priority
    - Task description includes capture pipeline metadata
  </done>
</task>

<task type="auto">
  <name>Task 2: Add getAllCaptures and getCaptureCounts to capture.ts for admin UI</name>
  <files>
    src/lib/gsd/capture.ts
  </files>
  <action>
    **Extend `src/lib/gsd/capture.ts` — add admin query helpers:**

    Add after `getCapture`:

    ```typescript
    /**
     * List captures with optional status filter, ordered by creation time descending.
     * Used by Builder Inbox admin UI (Phase 4).
     */
    export async function getAllCaptures(options?: {
      status?: string;
      limit?: number;
    }): Promise<Array<Record<string, unknown>>> {
      const limit = options?.limit ?? 50;
      let query = capturesCol().orderBy("createdAt", "desc").limit(limit);

      if (options?.status) {
        query = capturesCol()
          .where("status", "==", options.status)
          .orderBy("createdAt", "desc")
          .limit(limit);
      }

      const snapshot = await query.get();
      return snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
    }

    /**
     * Get counts of captures by status.
     * Used by Builder Inbox dashboard.
     */
    export async function getCaptureCounts(): Promise<Record<string, number>> {
      const statuses = ["pending", "processing", "routed", "failed"];
      const counts: Record<string, number> = {};

      for (const status of statuses) {
        const snapshot = await capturesCol()
          .where("status", "==", status)
          .count()
          .get();
        counts[status] = snapshot.data().count;
      }

      return counts;
    }
    ```

    **Key decisions:**
    - `getAllCaptures` supports status filtering for the admin inbox filter tabs
    - Default limit of 50 prevents unbounded queries
    - `getCaptureCounts` uses Firestore count() aggregation (no full document reads)
    - Returns plain Record<string, unknown> to avoid tight coupling with Firestore types
  </action>
  <verify>
    1. `npm run build` succeeds
    2. `npm run lint` passes
    3. Verify getAllCaptures orders by createdAt descending
    4. Verify getCaptureCounts uses .count() aggregation
  </verify>
  <done>
    - getAllCaptures returns paginated, filterable capture list for admin UI
    - getCaptureCounts provides dashboard stats via Firestore count aggregation
    - Both helpers ready for Phase 4 Builder Inbox consumption
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` — zero errors
2. `npm run build` — zero errors
3. `npm test` — all existing tests pass
4. Manual check: destinations/tasks.ts imports from service layer directly
5. Manual check: capture.ts has getAllCaptures with status filter support
6. Manual check: All new env vars are optional
</verification>

<success_criteria>
- routeToTask creates tasks via direct service import (not HTTP)
- Inbox fallback requires no code — router.ts already marks destination="inbox"
- getAllCaptures and getCaptureCounts ready for Phase 4 admin UI
- GSD_TASKS_USER_ID and GSD_TASKS_PROJECT_ID env vars registered as optional
- Build, lint, and test all pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-llm-router-destination-handlers/03-03-SUMMARY.md`
</output>
