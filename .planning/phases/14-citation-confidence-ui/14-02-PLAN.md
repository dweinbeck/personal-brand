---
phase: 14-citation-confidence-ui
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/components/assistant/CitationList.tsx
  - src/components/assistant/ConfidenceBadge.tsx
  - src/components/assistant/ChatMessage.tsx
  - src/components/assistant/ChatInterface.tsx
  - src/components/assistant/SuggestedPrompts.tsx
  - src/components/assistant/PrivacyDisclosure.tsx
autonomous: false

must_haves:
  truths:
    - "Each assistant response displays a collapsible Sources (N) section showing citations"
    - "Each citation links to the exact lines on GitHub via permalink URL"
    - "Each assistant response displays a confidence badge (high/medium/low) with color coding"
    - "Suggested prompts reflect RAG capabilities"
    - "Privacy disclosure mentions external AI service"
  artifacts:
    - path: "src/components/assistant/CitationList.tsx"
      provides: "Collapsible source list component using HTML details/summary"
      exports: ["CitationList"]
    - path: "src/components/assistant/ConfidenceBadge.tsx"
      provides: "Color-coded confidence indicator badge"
      exports: ["ConfidenceBadge"]
    - path: "src/components/assistant/ChatMessage.tsx"
      provides: "Message component rendering parts + metadata instead of content string"
      contains: "CitationList"
    - path: "src/components/assistant/ChatInterface.tsx"
      provides: "Chat interface passing full message.parts and message.metadata to ChatMessage"
      contains: "message.parts"
  key_links:
    - from: "src/components/assistant/ChatInterface.tsx"
      to: "src/components/assistant/ChatMessage.tsx"
      via: "parts={message.parts} metadata={message.metadata}"
      pattern: "parts=.*message\\.parts"
    - from: "src/components/assistant/ChatMessage.tsx"
      to: "src/components/assistant/CitationList.tsx"
      via: "import { CitationList }"
      pattern: "import.*CitationList"
    - from: "src/components/assistant/ChatMessage.tsx"
      to: "src/components/assistant/ConfidenceBadge.tsx"
      via: "import { ConfidenceBadge }"
      pattern: "import.*ConfidenceBadge"
---

<objective>
Build the frontend UI for citations and confidence badges, then wire everything together so assistant messages display structured source lists and confidence indicators.

Purpose: Visitors can now see where answers come from (collapsible GitHub-linked sources) and how confident the assistant is (color-coded badge). Also updates suggested prompts and privacy disclosure to reflect the RAG backend.
Output: Two new components (CitationList, ConfidenceBadge), updated ChatMessage and ChatInterface, refreshed prompt and disclosure text.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/14-citation-confidence-ui/14-RESEARCH.md
@.planning/phases/14-citation-confidence-ui/14-01-SUMMARY.md
@src/components/assistant/ChatMessage.tsx
@src/components/assistant/ChatInterface.tsx
@src/components/assistant/SuggestedPrompts.tsx
@src/components/assistant/PrivacyDisclosure.tsx
@src/components/assistant/FeedbackButtons.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CitationList and ConfidenceBadge components, update ChatMessage</name>
  <files>
    src/components/assistant/CitationList.tsx
    src/components/assistant/ConfidenceBadge.tsx
    src/components/assistant/ChatMessage.tsx
  </files>
  <action>
**1. Create `src/components/assistant/CitationList.tsx`:**

A server-compatible component (no "use client" needed) that renders citations in a collapsible `<details>/<summary>` section:

- Props: `{ citations: Array<{ sourceId: string; url: string; title?: string }> }`
- If `citations.length === 0`, return `null` (do NOT render empty "Sources (0)")
- `<details>` element with Tailwind classes matching the design system:
  - `mt-2 rounded-lg border border-border bg-surface/50 text-sm`
- `<summary>` shows "Sources ({citations.length})" with cursor-pointer, text-text-secondary, hover:text-text-primary
- `<ul>` inside details with `border-t border-border px-3 py-2 space-y-1`
- Each `<li>` contains:
  - A small document icon (inline SVG, h-3 w-3, text-text-tertiary)
  - An `<a>` link with `href={cite.url}`, `target="_blank"`, `rel="noopener noreferrer"`
  - Styled with `font-mono text-xs text-primary hover:text-gold transition-colors underline decoration-border hover:decoration-gold`
  - Display text: `cite.title ?? cite.url`

**2. Create `src/components/assistant/ConfidenceBadge.tsx`:**

A server-compatible component rendering a color-coded inline badge:

- Type: `Confidence = "high" | "medium" | "low"` (exported)
- Props: `{ level: Confidence }`
- Style map (use existing design tokens):
  - `high`: green-ish — `bg-emerald-50 text-emerald-700 border-emerald-200` (accessible green)
  - `medium`: amber — `bg-amber-50 text-amber-700 border-amber-200`
  - `low`: red — `bg-red-50 text-red-600 border-red-200`
- Label map: `high` → "High confidence", `medium` → "Medium confidence", `low` → "Low confidence"
- Render: `<span>` with `inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-[10px] font-medium`
- Include a small dot indicator (`h-1.5 w-1.5 rounded-full bg-current`) before the label text
- Add `title` attribute with the full label for tooltip

**3. Update `src/components/assistant/ChatMessage.tsx`:**

Change the component's props and rendering:

a. **Replace** the `ChatMessageProps` type:
   - REMOVE `content: string`
   - ADD `parts: Array<{ type: string; text?: string; sourceId?: string; url?: string; title?: string }>`
   - ADD `metadata?: { confidence?: "low" | "medium" | "high" }`

b. **Add imports** for `CitationList` and `ConfidenceBadge`

c. **Inside the component:**
   - Extract text content: `parts.filter(p => p.type === "text").map(p => p.text ?? "").join("")`
   - Extract citations: `parts.filter(p => p.type === "source-url").map(p => ({ sourceId: p.sourceId ?? "", url: p.url ?? "", title: p.title }))`
   - Render the message bubble with `textContent` (same as before, just from parts)
   - Below the message bubble for assistant messages, render:
     ```tsx
     <div className="mt-1 flex flex-col gap-1">
       <div className="flex items-center gap-2">
         {metadata?.confidence && <ConfidenceBadge level={metadata.confidence} />}
         <FeedbackButtons conversationId={conversationId} messageId={messageId} />
       </div>
       <CitationList citations={citations} />
     </div>
     ```
  </action>
  <verify>
1. `npx tsc --noEmit` — no type errors
2. `npm run lint` — no errors
3. Verify CitationList returns null for empty array
4. Verify ConfidenceBadge has three color variants
5. Verify ChatMessage no longer accepts `content` prop; accepts `parts` and `metadata`
  </verify>
  <done>
CitationList renders collapsible source links. ConfidenceBadge renders color-coded confidence. ChatMessage renders both below assistant messages using parts array and metadata.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire ChatInterface, update SuggestedPrompts and PrivacyDisclosure</name>
  <files>
    src/components/assistant/ChatInterface.tsx
    src/components/assistant/SuggestedPrompts.tsx
    src/components/assistant/PrivacyDisclosure.tsx
  </files>
  <action>
**1. Update `src/components/assistant/ChatInterface.tsx`:**

a. In the `useChat` call, add `messageMetadataSchema` for type safety:
   ```typescript
   import { z } from "zod";
   // ... at module scope:
   const metadataSchema = z.object({
     confidence: z.enum(["low", "medium", "high"]).optional(),
   });
   ```
   Then pass it to `useChat`:
   ```typescript
   const { messages, sendMessage, status, error, id } = useChat({
     transport,
     messageMetadataSchema: metadataSchema,
   });
   ```

b. **Change** the `<ChatMessage>` usage in the messages map (around line 114-127):
   - REMOVE the `content={...}` prop that strips parts to string
   - ADD `parts={message.parts ?? []}` to pass the full parts array
   - ADD `metadata={message.metadata}` to pass the metadata
   - Keep `role`, `messageId`, `conversationId` unchanged

   Result:
   ```tsx
   <ChatMessage
     key={message.id}
     role={message.role as "user" | "assistant"}
     parts={message.parts ?? []}
     metadata={message.metadata}
     messageId={message.id}
     conversationId={conversationId}
   />
   ```

c. The `plainMessages` useMemo for HumanHandoff stays unchanged (it correctly extracts text-only content for email handoff).

**2. Update `src/components/assistant/SuggestedPrompts.tsx`:**

Replace the `SUGGESTED_PROMPTS` array with RAG-aware prompts:
```typescript
const SUGGESTED_PROMPTS = [
  "How does the chatbot backend work?",
  "What projects has Dan built?",
  "How is the portfolio site deployed?",
  "What's Dan's experience with AI?",
];
```

These reflect the RAG backend's actual knowledge base (personal-brand codebase + chatbot-assistant codebase).

**3. Update `src/components/assistant/PrivacyDisclosure.tsx`:**

Change the disclosure text to mention external service:
- FROM: "Conversations are processed by AI and stored anonymously for up to 90 days."
- TO: "Conversations are sent to an external AI service and stored anonymously for up to 90 days."

This accurately describes the data flow now that conversations go to the FastAPI RAG backend.
  </action>
  <verify>
1. `npm run build` — full build passes
2. `npm run lint` — no errors
3. `npm test` — all tests pass
4. Verify ChatInterface passes `parts` and `metadata` (not `content`) to ChatMessage
5. Verify SuggestedPrompts contains RAG-aware text
6. Verify PrivacyDisclosure mentions "external AI service"
  </verify>
  <done>
ChatInterface passes full message parts and metadata to ChatMessage. SuggestedPrompts shows RAG-aware prompts. PrivacyDisclosure mentions external AI service. Full build passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete citation and confidence UI for the assistant chat:
- Collapsible "Sources (N)" section below each assistant message with GitHub permalink links
- Color-coded confidence badge (high=green, medium=amber, low=red) on each response
- Updated suggested prompts reflecting RAG capabilities
- Updated privacy disclosure mentioning external service
  </what-built>
  <how-to-verify>
1. Run `npm run dev` and visit http://localhost:3000/assistant
2. Ask a question (e.g., "How does the chatbot backend work?")
3. Verify the assistant response shows:
   a. A confidence badge (e.g., "High confidence" in green, or "Medium confidence" in amber)
   b. A collapsible "Sources (N)" section below the message
   c. Clicking "Sources" expands to show citation file paths as clickable GitHub permalink links
   d. Each link opens the correct GitHub file with line numbers highlighted
4. Verify the suggested prompts on the empty state show RAG-aware text (not the old generic prompts)
5. Verify the privacy disclosure at the bottom says "sent to an external AI service" (not "processed by AI")
6. Verify messages without citations (if any) do NOT show an empty "Sources (0)" section
7. Verify the FeedbackButtons still appear and function next to the confidence badge
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` — builds cleanly (all new components compile, no missing imports)
2. `npm run lint` — no lint errors
3. `npm test` — all existing tests pass
4. Manual: Assistant messages show confidence badge and collapsible citations
5. Manual: Citations link to correct GitHub permalink URLs
6. Manual: Empty citations render nothing (no "Sources (0)")
7. Manual: Suggested prompts and privacy disclosure text are updated
</verification>

<success_criteria>
- Every assistant response shows a confidence badge with appropriate color
- Every assistant response with citations shows a collapsible "Sources (N)" section
- Each citation links to the correct GitHub file with line number anchors
- No duplicate citations (markdown text + structured UI)
- Suggested prompts reflect RAG capabilities
- Privacy disclosure mentions external AI service
- Full build, lint, and test suite pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-citation-confidence-ui/14-02-SUMMARY.md`
</output>
