---
phase: 14-citation-confidence-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/citation-utils.ts
  - src/app/api/assistant/chat/route.ts
autonomous: true

must_haves:
  truths:
    - "Route handler writes source-url chunks for each citation instead of appending markdown text"
    - "Route handler writes a start chunk with messageMetadata containing the confidence level"
    - "GitHub permalink URLs are correctly constructed from citation source strings"
  artifacts:
    - path: "src/lib/citation-utils.ts"
      provides: "buildGitHubPermalink() and extractFilePath() utility functions"
      exports: ["buildGitHubPermalink", "extractFilePath"]
    - path: "src/app/api/assistant/chat/route.ts"
      provides: "Proxy route returning UIMessageStream with source-url chunks and messageMetadata"
      contains: "source-url"
  key_links:
    - from: "src/app/api/assistant/chat/route.ts"
      to: "src/lib/citation-utils.ts"
      via: "import { buildGitHubPermalink, extractFilePath }"
      pattern: "import.*citation-utils"
    - from: "src/app/api/assistant/chat/route.ts"
      to: "createUIMessageStream writer"
      via: "writer.write({ type: 'source-url' })"
      pattern: "type.*source-url"
---

<objective>
Replace the temporary markdown-appended citations in the route handler with structured AI SDK `source-url` chunks and `messageMetadata` for confidence. Create a citation utility module for GitHub permalink construction.

Purpose: The route handler currently appends citations as raw markdown text to the answer body. This plan switches to the AI SDK's native `source-url` chunk type and `messageMetadata` on the `start` chunk, enabling the frontend (Plan 02) to render structured citation and confidence UI components.
Output: Updated route handler writing structured chunks; new citation-utils.ts with permalink builder.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/14-citation-confidence-ui/14-RESEARCH.md
@src/app/api/assistant/chat/route.ts
@src/lib/schemas/fastapi.ts
@src/lib/assistant/fastapi-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create citation utility module</name>
  <files>src/lib/citation-utils.ts</files>
  <action>
Create `src/lib/citation-utils.ts` exporting two functions:

1. `buildGitHubPermalink(source: string): string`
   - Parses the citation source format: `owner/repo/path@sha:start_line-end_line`
   - Returns a full GitHub permalink: `https://github.com/owner/repo/blob/sha/path#Lstart-Lend`
   - Handles edge cases:
     - If `@` or `:` is missing, fall back to `https://github.com/${source}`
     - If path has multiple `/` segments (e.g., `owner/repo/src/app/page.tsx@sha:1-10`), use `parts.slice(2).join("/")` for the path portion
     - If startLine equals endLine, only emit `#Lstart` (no range)
   - Example: `"dweinbeck/chatbot-assistant/app/main.py@abc123:1-10"` → `"https://github.com/dweinbeck/chatbot-assistant/blob/abc123/app/main.py#L1-L10"`

2. `extractFilePath(source: string): string`
   - Extracts a display-friendly path from the citation source string
   - Returns `path:start_line-end_line` (e.g., `"app/main.py:1-10"`)
   - If no `@` found, returns the full source string
   - Example: `"dweinbeck/chatbot-assistant/app/main.py@abc123:1-10"` → `"app/main.py:1-10"`
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors in the new file. Manually verify the two functions handle the format from `chatbot-assistant/app/routers/chat.py` line 81-85 citation construction.
  </verify>
  <done>
`buildGitHubPermalink` and `extractFilePath` are exported and correctly parse the `owner/repo/path@sha:start-end` format into GitHub permalink URLs and display paths.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update route handler to write structured chunks</name>
  <files>src/app/api/assistant/chat/route.ts</files>
  <action>
Modify the existing route handler's success path (the `try` block after `askFastApi`):

1. **Remove** the markdown citation appending block (lines 49-56 approximately):
   ```typescript
   // DELETE THIS ENTIRE BLOCK:
   let text = data.answer;
   if (data.citations.length > 0) {
     text += "\n\n---\n**Sources:**\n";
     for (const cite of data.citations) {
       text += `- ${cite.source}\n`;
     }
   }
   ```

2. **Add import** at top of file: `import { buildGitHubPermalink, extractFilePath } from "@/lib/citation-utils";`

3. **Rewrite** the `createUIMessageStream` execute callback to:
   a. Write a `start` chunk with `messageMetadata: { confidence: data.confidence }` FIRST
   b. Write `text-start` → `text-delta` (with `data.answer` only, no citations in text) → `text-end`
   c. Write a `source-url` chunk for each citation in `data.citations`:
      ```typescript
      writer.write({
        type: "source-url",
        sourceId: `cite-${i}`,
        url: buildGitHubPermalink(cite.source),
        title: extractFilePath(cite.source),
      });
      ```
   d. Write `finish` chunk at the end

4. **Keep** the error handling paths (`catch` block) UNCHANGED — errors use JSON responses, not UIMessageStream.

The final stream write sequence must be:
`start` → `text-start` → `text-delta` → `text-end` → `source-url` (×N) → `finish`
  </action>
  <verify>
1. `npm run build` passes with no errors
2. `npm run lint` passes
3. Verify the route handler no longer contains the markdown citation block (`---\n**Sources:**`)
4. Verify the route handler writes `type: "start"` with `messageMetadata` before text chunks
5. Verify the route handler writes `type: "source-url"` chunks for citations
  </verify>
  <done>
Route handler writes structured `source-url` chunks and `messageMetadata` confidence in the UIMessageStream. No citations appear in the text body. Error paths unchanged.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` — builds cleanly
2. `npm run lint` — no errors
3. Grep for `**Sources:**` in route.ts — should NOT be found (markdown citations removed)
4. Grep for `source-url` in route.ts — should be found (structured chunks)
5. Grep for `messageMetadata` in route.ts — should be found (confidence metadata)
</verification>

<success_criteria>
- Route handler sends `start` chunk with `messageMetadata: { confidence }` before text
- Route handler sends `source-url` chunk per citation with GitHub permalink URL and file path title
- No markdown citation text is appended to the answer body
- Build and lint pass cleanly
- Citation utility functions correctly parse the FastAPI source format
</success_criteria>

<output>
After completion, create `.planning/phases/14-citation-confidence-ui/14-01-SUMMARY.md`
</output>
