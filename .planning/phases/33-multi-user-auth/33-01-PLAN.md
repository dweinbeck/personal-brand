---
phase: 33-multi-user-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /Users/dweinbeck/Documents/todoist/src/lib/firebase-client.ts
  - /Users/dweinbeck/Documents/todoist/src/lib/firebase-admin.ts
  - /Users/dweinbeck/Documents/todoist/src/lib/auth.ts
  - /Users/dweinbeck/Documents/todoist/src/context/AuthContext.tsx
  - /Users/dweinbeck/Documents/todoist/src/components/auth/AuthGuard.tsx
  - /Users/dweinbeck/Documents/todoist/src/app/layout.tsx
  - /Users/dweinbeck/Documents/todoist/src/app/page.tsx
  - /Users/dweinbeck/Documents/todoist/package.json
autonomous: true
user_setup:
  - service: firebase
    why: "Firebase Auth for Google Sign-In (same project as personal-brand)"
    env_vars:
      - name: NEXT_PUBLIC_FIREBASE_API_KEY
        source: "Firebase Console -> Project Settings -> General -> Web app config"
      - name: NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN
        source: "Firebase Console -> Project Settings -> General -> Web app config"
      - name: NEXT_PUBLIC_FIREBASE_PROJECT_ID
        source: "Firebase Console -> Project Settings -> General -> Web app config"
      - name: FIREBASE_PROJECT_ID
        source: "Firebase Console -> Project Settings -> Service accounts (same value as NEXT_PUBLIC_FIREBASE_PROJECT_ID)"
      - name: FIREBASE_CLIENT_EMAIL
        source: "Firebase Console -> Project Settings -> Service accounts -> Firebase Admin SDK -> client_email from JSON key"
      - name: FIREBASE_PRIVATE_KEY
        source: "Firebase Console -> Project Settings -> Service accounts -> Generate new private key -> private_key from JSON"
    dashboard_config:
      - task: "Ensure Google Sign-In provider is enabled"
        location: "Firebase Console -> Authentication -> Sign-in method -> Google -> Enable"
      - task: "Add todoist localhost to authorized domains"
        location: "Firebase Console -> Authentication -> Settings -> Authorized domains -> Add localhost"
must_haves:
  truths:
    - "User can sign in to the todoist app via Google Sign-In popup"
    - "User sees a loading state while auth initializes"
    - "User sees a sign-in prompt when not authenticated"
    - "User's Firebase ID token is written to a __session cookie on sign-in and refreshed automatically"
    - "Server can verify the __session cookie and extract userId"
  artifacts:
    - path: "src/lib/firebase-client.ts"
      provides: "Client-side Firebase initialization with getFirebaseAuth() export"
      min_lines: 20
    - path: "src/lib/firebase-admin.ts"
      provides: "Server-side Firebase Admin SDK initialization"
      min_lines: 15
    - path: "src/lib/auth.ts"
      provides: "verifyUser(idToken) and getUserIdFromCookie() server functions"
      exports: ["verifyUser", "getUserIdFromCookie"]
    - path: "src/context/AuthContext.tsx"
      provides: "AuthProvider and useAuth hook with cookie sync"
      exports: ["AuthProvider", "useAuth"]
    - path: "src/components/auth/AuthGuard.tsx"
      provides: "Sign-in gate component wrapping protected content"
      exports: ["AuthGuard"]
    - path: "src/app/layout.tsx"
      provides: "Root layout wrapping children with AuthProvider"
      contains: "AuthProvider"
  key_links:
    - from: "src/context/AuthContext.tsx"
      to: "src/lib/firebase-client.ts"
      via: "import getFirebaseAuth"
      pattern: "import.*getFirebaseAuth.*from.*firebase-client"
    - from: "src/context/AuthContext.tsx"
      to: "__session cookie"
      via: "onIdTokenChanged callback writes document.cookie"
      pattern: "onIdTokenChanged"
    - from: "src/lib/auth.ts"
      to: "src/lib/firebase-admin.ts"
      via: "import for initialization side-effect"
      pattern: "import.*firebase-admin"
    - from: "src/components/auth/AuthGuard.tsx"
      to: "src/context/AuthContext.tsx"
      via: "useAuth hook"
      pattern: "useAuth"
    - from: "src/app/layout.tsx"
      to: "src/context/AuthContext.tsx"
      via: "wraps children with AuthProvider"
      pattern: "AuthProvider"
---

<objective>
Install Firebase Auth dependencies and create the authentication foundation for the todoist app: client-side Firebase init, server-side Admin SDK, AuthContext with cookie sync, AuthGuard sign-in gate, and root layout integration.

Purpose: Establishes the auth infrastructure that Plans 02 and 03 depend on. Without this, there is no way to identify users or verify tokens.
Output: Working Google Sign-In flow with token-to-cookie sync and server-side verification functions ready for use by service layer.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-multi-user-auth/33-RESEARCH.md

IMPORTANT: This plan operates in the **todoist** repo at `/Users/dweinbeck/Documents/todoist`.
All file paths below are relative to that repo. Run all commands from that directory.
Do NOT modify files in the personal-brand repo.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Firebase dependencies and create auth library files</name>
  <files>
    /Users/dweinbeck/Documents/todoist/package.json
    /Users/dweinbeck/Documents/todoist/src/lib/firebase-client.ts
    /Users/dweinbeck/Documents/todoist/src/lib/firebase-admin.ts
    /Users/dweinbeck/Documents/todoist/src/lib/auth.ts
  </files>
  <action>
    Work in `/Users/dweinbeck/Documents/todoist`. Verify with `pwd` before making changes.

    1. Install Firebase dependencies:
       ```bash
       cd /Users/dweinbeck/Documents/todoist && npm install firebase firebase-admin
       ```

    2. Create `src/lib/firebase-client.ts` -- copy the exact pattern from personal-brand's `src/lib/firebase-client.ts`:
       - `getFirebaseConfig()` reads `NEXT_PUBLIC_FIREBASE_API_KEY`, `NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN`, `NEXT_PUBLIC_FIREBASE_PROJECT_ID`
       - Throws descriptive error if any are missing
       - Module-level `_app` and `_auth` singletons
       - `getFirebaseApp()` uses `getApps().length ? getApp() : initializeApp(getFirebaseConfig())`
       - Exports `getFirebaseAuth()` returning Auth instance

    3. Create `src/lib/firebase-admin.ts` -- adapted from personal-brand's `src/lib/firebase.ts`:
       - `getCredential()` function: if `process.env.K_SERVICE` exists, return `applicationDefault()`. Otherwise, read `FIREBASE_PROJECT_ID`, `FIREBASE_CLIENT_EMAIL`, `FIREBASE_PRIVATE_KEY` (with `\\n` -> `\n` replacement). Return `cert(...)` wrapped in try/catch.
       - Module-level initialization: `if (getApps().length === 0 && credential) { initializeApp({ credential }); }`
       - No exports needed -- this file is imported for its side effect (initialization)

    4. Create `src/lib/auth.ts`:
       - Add `import "server-only"` at the top (install `server-only` package: `npm install server-only`)
       - Import `cookies` from `next/headers`
       - Import `getApps` from `firebase-admin/app` and `getAuth` from `firebase-admin/auth`
       - Import `./firebase-admin` for side-effect initialization
       - Export `verifyUser(idToken: string): Promise<string | null>` -- checks `getApps().length === 0` returns null, then tries `getAuth().verifyIdToken(idToken)` returning `decoded.uid`, catches and returns null
       - Export `getUserIdFromCookie(): Promise<string | null>` -- reads `(await cookies()).get("__session")?.value`, if no token returns null, otherwise calls and returns `verifyUser(token)`
  </action>
  <verify>
    Run `cd /Users/dweinbeck/Documents/todoist && npx tsc --noEmit` to verify TypeScript compiles. Check that `firebase` and `firebase-admin` appear in package.json dependencies.
  </verify>
  <done>
    Three library files exist with correct exports. `firebase` and `firebase-admin` are installed. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AuthContext, AuthGuard, and wire into root layout</name>
  <files>
    /Users/dweinbeck/Documents/todoist/src/context/AuthContext.tsx
    /Users/dweinbeck/Documents/todoist/src/components/auth/AuthGuard.tsx
    /Users/dweinbeck/Documents/todoist/src/app/layout.tsx
    /Users/dweinbeck/Documents/todoist/src/app/page.tsx
  </files>
  <action>
    Work in `/Users/dweinbeck/Documents/todoist`. Verify with `pwd` before making changes.

    1. Create `src/context/AuthContext.tsx` (client component):
       - "use client" directive
       - Import `onIdTokenChanged` (NOT `onAuthStateChanged`) and `User` from `firebase/auth`
       - Import `createContext`, `ReactNode`, `useContext`, `useEffect`, `useState` from `react`
       - Import `getFirebaseAuth` from `@/lib/firebase-client`
       - Interface `AuthContextValue` with `user: User | null` and `loading: boolean`
       - Create context with default `{ user: null, loading: true }`
       - `AuthProvider` component:
         - State: `user` (User | null, initially null), `loading` (boolean, initially true)
         - useEffect: subscribe to `onIdTokenChanged(getFirebaseAuth(), async (u) => { ... })`
         - In callback: `setUser(u)`, `setLoading(false)`
         - If `u` is truthy: `const token = await u.getIdToken()`, then `document.cookie = \`__session=${token}; path=/; max-age=3600; SameSite=Lax\``
         - If `u` is falsy: `document.cookie = "__session=; path=/; max-age=0"`
         - Return unsubscribe from useEffect
         - Render: `<AuthContext value={{ user, loading }}>{children}</AuthContext>`
       - Export `useAuth()` hook returning `useContext(AuthContext)`

    2. Create `src/components/auth/AuthGuard.tsx` (client component):
       - "use client" directive
       - Import `GoogleAuthProvider`, `signInWithPopup` from `firebase/auth`
       - Import `ReactNode` from `react`
       - Import `useAuth` from `@/context/AuthContext`
       - Import `getFirebaseAuth` from `@/lib/firebase-client`
       - Module-level: `const provider = new GoogleAuthProvider()`
       - `AuthGuard` component accepting `{ children: ReactNode }`:
         - Call `useAuth()` to get `{ user, loading }`
         - If loading: return centered "Loading..." text (`flex items-center justify-center min-h-screen`)
         - If no user: return centered sign-in UI with "Sign in to access Todoist" text and "Sign in with Google" button that calls `signInWithPopup(getFirebaseAuth(), provider)`
         - Style the sign-in button: `px-5 py-2.5 text-sm font-medium rounded-full border border-gold/40 text-text-secondary hover:bg-gold-light hover:text-primary transition-all cursor-pointer`
         - If user exists: render `<>{children}</>`

    3. Update `src/app/layout.tsx`:
       - Import `AuthProvider` from `@/context/AuthContext`
       - Wrap `{children}` inside the `<body>` tag with `<AuthProvider>{children}</AuthProvider>`
       - Keep all existing font imports and metadata unchanged

    4. Update `src/app/page.tsx`:
       - Currently does `redirect("/tasks")` unconditionally
       - Keep this behavior unchanged -- the AuthGuard wraps the tasks layout, not the root redirect
       - No changes needed to this file unless the redirect causes issues with SSR auth checks. Leave as-is for now.
  </action>
  <verify>
    Run `cd /Users/dweinbeck/Documents/todoist && npm run lint && npm run build`. Both must pass. Verify `AuthProvider` wraps children in layout.tsx by reading the file.
  </verify>
  <done>
    AuthContext.tsx exports AuthProvider and useAuth. AuthGuard.tsx exports AuthGuard with Google Sign-In. Root layout.tsx wraps children with AuthProvider. Build passes. The auth foundation is complete and ready for service layer integration in Plans 02 and 03.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/dweinbeck/Documents/todoist && npm run build` passes without errors
2. `cd /Users/dweinbeck/Documents/todoist && npm run lint` passes without errors
3. Files exist: `src/lib/firebase-client.ts`, `src/lib/firebase-admin.ts`, `src/lib/auth.ts`, `src/context/AuthContext.tsx`, `src/components/auth/AuthGuard.tsx`
4. `firebase` and `firebase-admin` appear in package.json dependencies
5. `server-only` appears in package.json dependencies
6. Root layout.tsx contains `<AuthProvider>`
7. AuthContext uses `onIdTokenChanged` (not `onAuthStateChanged`) for cookie sync
</verification>

<success_criteria>
- Firebase client and admin SDKs are installed and initialized with singleton patterns
- AuthContext provides user state and syncs ID token to __session cookie via onIdTokenChanged
- AuthGuard shows sign-in UI for unauthenticated users, loading state during init
- Server-side auth.ts can verify tokens and read userId from cookies
- Build and lint pass cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/33-multi-user-auth/33-01-SUMMARY.md`
</output>
