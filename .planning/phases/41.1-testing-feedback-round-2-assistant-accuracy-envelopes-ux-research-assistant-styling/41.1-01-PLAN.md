---
phase: 41.1-testing-feedback-round-2-assistant-accuracy-envelopes-ux-research-assistant-styling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/envelopes/EnvelopesHomePage.tsx
  - src/components/envelopes/EnvelopeCard.tsx
  - src/components/envelopes/TransferModal.tsx
autonomous: true
requirements: []

must_haves:
  truths:
    - "Edit Envelopes, Transfer Funds, and Add Transaction buttons appear on the same horizontal line on desktop"
    - "On mobile, the three buttons stack vertically in a single column"
    - "The button labeled 'Edit Cards' now reads 'Edit Envelopes'"
    - "When in edit mode, the budget value on each card is an inline input field"
    - "Blurring the inline budget input saves the new value immediately without a save button"
    - "Target savings (disposable income minus total budgets) recalculates live as budgets change"
    - "Transfer modal target dropdown shows total available balance next to each envelope name"
    - "Transfer modal has no note/reason field — only source, target, amount, and Transfer button"
  artifacts:
    - path: "src/components/envelopes/EnvelopesHomePage.tsx"
      provides: "Horizontal button row layout and inline budget editing orchestration"
    - path: "src/components/envelopes/EnvelopeCard.tsx"
      provides: "Inline budget input field in edit mode with blur-to-save"
    - path: "src/components/envelopes/TransferModal.tsx"
      provides: "Simplified modal with total available balance display"
  key_links:
    - from: "src/components/envelopes/EnvelopeCard.tsx"
      to: "EnvelopesHomePage handleUpdate"
      via: "onBudgetChange callback prop"
      pattern: "onBudgetChange.*handleUpdate"
---

<objective>
Fix three Envelopes UX issues from user testing: (1) reorganize action buttons into a horizontal row with "Edit Envelopes" rename, (2) convert budget editing from form popup to inline input with blur-to-save, (3) simplify transfer modal by showing total available balance and removing the note field.

Purpose: Improve Envelopes usability based on direct user feedback — faster budget editing, cleaner button layout, simpler transfers.
Output: Updated EnvelopesHomePage, EnvelopeCard, and TransferModal components.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/envelopes/EnvelopesHomePage.tsx
@src/components/envelopes/EnvelopeCard.tsx
@src/components/envelopes/TransferModal.tsx
@src/components/envelopes/KpiBox.tsx
@src/lib/envelopes/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reorganize button layout and rename Edit Cards to Edit Envelopes</name>
  <files>src/components/envelopes/EnvelopesHomePage.tsx</files>
  <action>
Restructure the button layout in EnvelopesHomePage.tsx:

1. **Rename "Edit Cards" to "Edit Envelopes"**: Change the button text on line 272 from `"Edit Cards"` to `"Edit Envelopes"`.

2. **Move all three buttons to the same row as "Week of..." text**: Currently "Edit Cards" is in the `justify-between` row with "Week of..." and "Add Transaction" / "Transfer Funds" are in a separate `mb-4` div below. Merge them into one row:
   - Remove the separate `{/* Full-width Add Transaction button + Transfer Funds */}` section (lines 278-312).
   - In the `mb-4 flex items-center justify-between` div (lines 258-276), replace the single Edit button with a button group containing all three: "Edit Envelopes", "Transfer Funds", and "Add Transaction".
   - Desktop: `flex flex-row gap-2` for the button group.
   - Mobile: `flex flex-col sm:flex-row gap-2` so buttons stack on small screens.
   - Keep the existing conditional logic: Transfer Funds only when `envelopes.length >= 2`, Add Transaction only when not editing.
   - When "Add Transaction" is clicked, the TransactionForm still renders in its own Card below the week heading (keep existing form rendering logic, just move the trigger button).

3. **Button order**: "Edit Envelopes" first, then "Transfer Funds", then "Add Transaction".
   - "Edit Envelopes" toggles edit mode (existing behavior).
   - "Transfer Funds" opens transfer modal (existing behavior).
   - "Add Transaction" shows transaction form inline (existing behavior).
   - Hide "Transfer Funds" and "Add Transaction" in edit mode.
   - Hide all three in readonly mode.

4. **TransactionForm rendering**: Keep the existing TransactionForm Card rendering where it is (below the button row), but gate it on `isAddingTransaction` state. The button just toggles `isAddingTransaction`.
  </action>
  <verify>npm run lint && npm run build</verify>
  <done>Three buttons appear on the same line after "Week of..." on desktop, stack vertically on mobile. Button reads "Edit Envelopes" not "Edit Cards".</done>
</task>

<task type="auto">
  <name>Task 2: Inline budget editing on EnvelopeCard and simplified TransferModal</name>
  <files>
    src/components/envelopes/EnvelopeCard.tsx
    src/components/envelopes/TransferModal.tsx
    src/components/envelopes/EnvelopesHomePage.tsx
  </files>
  <action>
**A. Inline budget editing on EnvelopeCard (replaces pencil/form popup approach):**

1. Add a new prop `onBudgetChange: (newBudgetCents: number) => void` to EnvelopeCard.
2. In edit mode (`isEditMode === true`), replace the static budget text (`of {formatCents(envelope.weeklyBudgetCents)} budget`) with an inline `<input>` field:
   - Type: `number`, step `0.01`, min `0.01`.
   - Default value: `envelope.weeklyBudgetCents / 100` (displayed as dollars).
   - Styling: match surrounding text size, use a subtle border (`border-b border-dashed border-gold`) to indicate it's editable. Keep inline with text — no form wrapper.
   - On blur: call `onBudgetChange(Math.round(parseFloat(value) * 100))`. Validate that the value is > 0 and is a valid number; if invalid, revert to the original budget.
   - Remove the existing pencil edit button and `onEdit` prop usage in edit mode since inline editing replaces it. Keep `onEdit` in the props interface for now (won't break) but it won't be called when inline editing is available.
3. Keep the delete button in edit mode (top-right X button).
4. The remaining amount and rollover surplus still display as static text — only the budget line becomes editable.

**B. Wire inline budget saving in EnvelopesHomePage:**

1. Pass `onBudgetChange` to each EnvelopeCard: `onBudgetChange={(newCents) => handleUpdate(env.id, { title: env.title, weeklyBudgetCents: newCents, rollover: env.rollover })}`.
2. Remove `setEditingId` wiring from EnvelopeCard's `onEdit` prop — the EnvelopeForm popup is no longer needed when editing. Remove the `editingId === env.id` conditional that rendered `EnvelopeForm` inside a Card. Instead, always render `EnvelopeCard` and let inline editing handle budget changes.
3. Keep `editingId` state variable for now but it won't be used in the render path (clean removal is optional).

**C. Simplify TransferModal:**

1. **Remove the note field entirely**: Delete the "Note (optional)" label, input, and state (`note`, `setNote`). Remove `note` from the `handleSubmit` JSON body (still send `note: undefined` — the server schema marks it optional so omission is fine).
2. **Show total available balance in target dropdown**: In the target `<select>`, update each `<option>` to show the total available balance:
   ```
   {e.title} (available: {formatCents(e.remainingCents)})
   ```
   Note: `remainingCents` already includes rollover surplus from the parent's computation.
3. Reset the `note` from the useEffect cleanup (remove the `setNote("")` line since note state no longer exists).
  </action>
  <verify>npm run lint && npm run build && npm test</verify>
  <done>In edit mode, each envelope card shows an inline input for budget amount that saves on blur. TransferModal has no note field and shows available balance in target dropdown. EnvelopeForm popup is no longer triggered by edit mode.</done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with zero errors
2. `npm run build` succeeds
3. `npm test` passes all existing tests
4. EnvelopesHomePage renders three buttons in a row on desktop
5. Budget editing works via inline input with blur-to-save
6. TransferModal is simplified (no note, shows available balance)
</verification>

<success_criteria>
- "Edit Envelopes", "Transfer Funds", and "Add Transaction" appear horizontally after "Week of..." on desktop
- On mobile, buttons stack vertically
- Clicking into the budget amount in edit mode shows an inline input
- Blurring the input saves the new budget immediately
- Transfer modal has only source, target, amount, and Transfer button
- Target dropdown shows available balance next to each envelope name
</success_criteria>

<output>
After completion, create `.planning/phases/41.1-testing-feedback-round-2-assistant-accuracy-envelopes-ux-research-assistant-styling/41.1-01-SUMMARY.md`
</output>
