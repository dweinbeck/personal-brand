---
phase: 48.1-tasks-app-testing-feedback
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/tasks/subtask-list.tsx
  - src/components/tasks/task-card.tsx
  - src/components/tasks/task-form.tsx
  - src/lib/schemas/tasks/task.ts
  - src/lib/tasks/effort.ts
autonomous: true
requirements: [TF-02]

must_haves:
  truths:
    - "Users can edit subtask name and effort from the subtask list"
    - "Parent task effort is a manual budget (not auto-summed from subtasks)"
    - "Task form shows Fibonacci quick-picks AND a number input for effort"
    - "Subtask add form shows Fibonacci quick-picks AND a number input for effort"
    - "Collapsed task row shows subtask count and allocation summary"
    - "Expanded task detail shows allocation indicator with over-budget warning"
    - "Effort schema accepts any positive integer, not just Fibonacci values"
  artifacts:
    - path: "src/components/tasks/subtask-list.tsx"
      provides: "Subtask list with edit capability and allocation display"
      contains: "editingId"
    - path: "src/components/tasks/task-card.tsx"
      provides: "Task card with allocation summary in collapsed and expanded views"
      contains: "allocated"
    - path: "src/components/tasks/task-form.tsx"
      provides: "Task form with Fibonacci quick-picks and numeric input"
      contains: "customEffort"
    - path: "src/lib/schemas/tasks/task.ts"
      provides: "Updated effort schema accepting any positive integer"
      contains: "z.number().int().positive()"
  key_links:
    - from: "src/components/tasks/task-card.tsx"
      to: "src/components/tasks/subtask-list.tsx"
      via: "props passing subtasks and parent effort"
      pattern: "parentEffort"
---

<objective>
Overhaul effort scoring to support subtask budgeting, add subtask editing, and provide both Fibonacci quick-picks and freeform numeric input for effort values.

Purpose: The current effort scoring is limited (Fibonacci-only, no subtask editing, no budget/allocation tracking). Users need to edit subtasks, use any effort value, and see how subtask effort relates to the parent task's budget.
Output: Full subtask editing, flexible effort input, and clear allocation indicators.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/tasks/subtask-list.tsx
@src/components/tasks/task-card.tsx
@src/components/tasks/task-form.tsx
@src/lib/schemas/tasks/task.ts
@src/lib/tasks/effort.ts
@src/actions/tasks/task.ts
@src/services/tasks/task.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update effort schema and constants to accept any positive integer</name>
  <files>
    src/lib/schemas/tasks/task.ts
    src/lib/tasks/effort.ts
  </files>
  <action>
    **1. Update `src/lib/schemas/tasks/task.ts`:**

    Change the effort field validation in BOTH `createTaskSchema` and `updateTaskSchema` from the union of Fibonacci literals to accept any positive integer:

    Replace:
    ```ts
    effort: z
      .union([
        z.literal(1), z.literal(2), z.literal(3),
        z.literal(5), z.literal(8), z.literal(13),
      ])
      .nullable()
      .optional(),
    ```

    With:
    ```ts
    effort: z.number().int().positive().nullable().optional(),
    ```

    Do this for BOTH `createTaskSchema` and `updateTaskSchema`.

    **2. Update `src/lib/tasks/effort.ts`:**

    Keep `EFFORT_VALUES` as-is (it's used for the quick-pick buttons). Rename the type:
    ```ts
    export const EFFORT_QUICK_PICKS = [1, 2, 3, 5, 8, 13] as const;
    export type EffortQuickPick = (typeof EFFORT_QUICK_PICKS)[number];
    ```

    Also export the old name as an alias for backward compatibility:
    ```ts
    export const EFFORT_VALUES = EFFORT_QUICK_PICKS;
    ```

    Keep the `computeEffortSum` function unchanged.
  </action>
  <verify>
    - `npm run lint` passes
    - `npm run build` passes
    - Effort schema now accepts `effort: 7` (non-Fibonacci) without validation error
    - EFFORT_QUICK_PICKS array still has [1,2,3,5,8,13]
  </verify>
  <done>Effort validation accepts any positive integer. Quick-pick constants remain available for UI buttons.</done>
</task>

<task type="auto">
  <name>Task 2: Add subtask editing and effort input overhaul to subtask-list, task-form, and task-card</name>
  <files>
    src/components/tasks/subtask-list.tsx
    src/components/tasks/task-form.tsx
    src/components/tasks/task-card.tsx
  </files>
  <action>
    **A. Update `src/components/tasks/subtask-list.tsx` — Add inline editing for subtasks:**

    Add state for editing: `editingId: string | null`, `editName: string`, `editEffort: number | null`.

    For each subtask row, add an edit button (pencil icon) next to the delete button (same opacity-0 group-hover pattern). When clicked, the subtask row transforms into an inline edit form with:
    - Name input (pre-filled with current subtask name)
    - Effort quick-picks (Fibonacci buttons from EFFORT_QUICK_PICKS) + a small number input for custom values
    - Save button and Cancel button
    - Save calls `updateTaskAction(token, { id: subtask.id, name: editName, effort: editEffort })`

    Import `updateTaskAction` from `@/actions/tasks/task`.

    For the ADD subtask form, replace the effort `<select>` dropdown with:
    - Fibonacci quick-pick buttons (same style as task-form) — small rounded pill buttons
    - A small number input (`type="number"`, min=1, max=100, width ~16) for custom values
    - When a quick-pick is clicked, it sets the effort (click again to deselect)
    - The number input allows typing any positive integer

    Also accept `parentEffort` prop (number | null) from the parent. Show an allocation line below the "Subtasks" header:
    ```
    Props: parentEffort: number | null
    ```
    Compute `subtaskTotal = subtasks.filter(s => s.effort != null).reduce((sum, s) => sum + s.effort!, 0)`.

    If parentEffort is set:
    - Show: `"{subtaskTotal} / {parentEffort} allocated"`
    - If subtaskTotal > parentEffort: show in red/danger color with warning text "Over budget by {diff}"
    - If subtaskTotal < parentEffort: show "Unallocated: {parentEffort - subtaskTotal}" in text-text-tertiary (non-warning hint)
    - If subtaskTotal === parentEffort: show in green/sage color "Fully allocated"

    If parentEffort is null, just show "{subtaskTotal} effort in subtasks" if subtaskTotal > 0.

    **B. Update `src/components/tasks/task-form.tsx` — Add number input alongside Fibonacci quick-picks:**

    In the Effort section, after the Fibonacci quick-pick buttons, add a number input:
    ```tsx
    <input
      type="number"
      min={1}
      max={100}
      value={effort ?? ""}
      onChange={(e) => setEffort(e.target.value ? Number(e.target.value) : null)}
      placeholder="Custom"
      className="w-16 px-2 py-1 text-xs border border-border rounded-[var(--radius-button)] bg-surface focus:outline-none focus:ring-2 focus:ring-gold/50 text-text-primary"
    />
    ```

    When a Fibonacci quick-pick is clicked, it still sets/toggles the effort. When the number input is used, it overrides the quick-pick selection. They are synced — if effort is 5 (a Fibonacci value), the 5 button shows as selected AND the input shows 5. If effort is 7 (non-Fibonacci), no button is selected but the input shows 7.

    Update the import from `EFFORT_VALUES` to `EFFORT_QUICK_PICKS` (or keep `EFFORT_VALUES` since it's aliased).

    **C. Update `src/components/tasks/task-card.tsx` — Add allocation summary to collapsed and expanded views:**

    In the **collapsed view** (the metadata line with date, effort, tags, subtasks), update the subtask count display. Currently it shows `{completed}/{total}`. Change to also show allocation when the parent has effort:

    If `task.effort != null && task.subtasks.length > 0`:
    - Compute `subtaskEffortTotal = task.subtasks.filter(s => s.effort != null).reduce((sum, s) => sum + s.effort!, 0)`
    - Show: `"{task.subtasks.length} subtasks - {subtaskEffortTotal}/{task.effort} allocated"`
    Else if `task.subtasks.length > 0`:
    - Keep current: `"{completed}/{total}"`

    In the **expanded view** (when `expanded` is true), pass `parentEffort={task.effort}` to the SubtaskList component:
    ```tsx
    <SubtaskList
      subtasks={task.subtasks}
      parentTaskId={task.id}
      projectId={projectId}
      parentEffort={task.effort}
    />
    ```

    Also in the expanded view, show the parent effort as a chip/badge above the allocation line:
    If `task.effort != null`:
    - Show: "Task budget: {task.effort}" as a small amber badge

    If subtasks over-budget in expanded view, show CTA buttons:
    - "Update task effort to {subtaskTotal}" — calls updateTaskAction to set parent effort = subtaskTotal
    - "Keep task effort at {task.effort}" — dismisses the warning (just close it, no action needed)
  </action>
  <verify>
    - `npm run lint` passes
    - `npm run build` passes
    - SubtaskList has editingId state management
    - TaskForm has number input alongside Fibonacci buttons
    - TaskCard collapsed view shows allocation summary
    - TaskCard expanded view passes parentEffort to SubtaskList
  </verify>
  <done>
    1. Subtasks can be edited (name + effort) inline from the subtask list
    2. Fibonacci quick-picks + number input available for both task and subtask effort
    3. Collapsed task row shows "N subtasks - X/Y allocated"
    4. Expanded task detail shows parent effort budget, allocation indicator, and over-budget warnings with CTAs
  </done>
</task>

</tasks>

<verification>
- `npm run lint && npm run build && npm test` — all pass
- Effort schema accepts non-Fibonacci integers
- Subtask editing works (name + effort)
- Allocation indicators display correctly
- Over-budget warnings show with CTA buttons
</verification>

<success_criteria>
1. Users can edit subtask names and effort scores inline
2. Effort input supports Fibonacci quick-picks AND freeform number entry
3. Effort schema validates any positive integer (not just Fibonacci)
4. Collapsed task shows subtask count + allocation summary
5. Expanded task shows parent budget chip + allocation line + over-budget CTAs
6. Build, lint, and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/48.1-tasks-app-testing-feedback-effort-scoring-drag-and-drop-ui-polish-data-import/48.1-03-SUMMARY.md`
</output>
