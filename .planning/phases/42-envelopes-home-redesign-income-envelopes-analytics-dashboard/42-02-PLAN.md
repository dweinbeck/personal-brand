---
phase: 42-envelopes-home-redesign-income-envelopes-analytics-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["42-01"]
files_modified:
  - src/components/envelopes/IncomeEntryForm.tsx
  - src/components/envelopes/IncomeBanner.tsx
  - src/components/envelopes/EnvelopesHomePage.tsx
  - src/lib/envelopes/hooks.ts
autonomous: true
requirements:
  - SC-1
  - SC-2
  - SC-3

must_haves:
  truths:
    - "The greeting and envelope cards appear BEFORE the KPI metrics box on the home page"
    - "Users can log extra income via a form accessible from the home page action buttons"
    - "This week's extra income total is shown on the home page as a visible banner/indicator"
    - "Income entries are created by calling POST /api/envelopes/income and the UI refreshes after creation"
    - "Income entries can be deleted from the banner and the total updates"
  artifacts:
    - path: "src/components/envelopes/IncomeEntryForm.tsx"
      provides: "Form component for logging extra income with amount + description fields"
      min_lines: 40
    - path: "src/components/envelopes/IncomeBanner.tsx"
      provides: "Banner showing this week's extra income total with list of entries"
      min_lines: 30
    - path: "src/components/envelopes/EnvelopesHomePage.tsx"
      provides: "Reorganized home page with greeting first, envelopes, then KPIs and supplementary info"
      min_lines: 200
    - path: "src/lib/envelopes/hooks.ts"
      provides: "useIncome hook for fetching and mutating income entries"
      contains: "useIncome"
  key_links:
    - from: "src/components/envelopes/EnvelopesHomePage.tsx"
      to: "src/components/envelopes/IncomeEntryForm.tsx"
      via: "import and render in action buttons area"
      pattern: "IncomeEntryForm"
    - from: "src/components/envelopes/EnvelopesHomePage.tsx"
      to: "src/components/envelopes/IncomeBanner.tsx"
      via: "import and render showing weekly income total"
      pattern: "IncomeBanner"
    - from: "src/lib/envelopes/hooks.ts"
      to: "/api/envelopes/income"
      via: "SWR fetch for income entries"
      pattern: "api/envelopes/income"
    - from: "src/components/envelopes/IncomeEntryForm.tsx"
      to: "/api/envelopes/income"
      via: "POST fetch to create income entry"
      pattern: "api/envelopes/income"
---

<objective>
Reorganize the envelopes home page layout and add income entry UI components.

Purpose: The current layout puts KPI metrics first, which is not ideal for daily budgeting use. The new layout puts the greeting and primary envelope content first (what users interact with daily), with KPI metrics and supplementary info below. Additionally, users need a way to log supplemental income that boosts their weekly spending power.
Output: Reorganized home page with income entry form and income total banner.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/42-envelopes-home-redesign-income-envelopes-analytics-dashboard/42-01-SUMMARY.md
@src/components/envelopes/EnvelopesHomePage.tsx
@src/components/envelopes/GreetingBanner.tsx
@src/components/envelopes/KpiBox.tsx
@src/components/envelopes/SavingsBanner.tsx
@src/components/envelopes/TransactionForm.tsx
@src/lib/envelopes/hooks.ts
@src/lib/envelopes/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useIncome hook, IncomeEntryForm, and IncomeBanner components</name>
  <files>src/lib/envelopes/hooks.ts, src/components/envelopes/IncomeEntryForm.tsx, src/components/envelopes/IncomeBanner.tsx</files>
  <action>
**In src/lib/envelopes/hooks.ts -- add useIncome hook:**

Follow the exact pattern of `useTransactions` hook. Create `useIncome(weekStart: string, weekEnd: string)` that:
- Uses SWR with key `/api/envelopes/income?weekStart=${weekStart}&weekEnd=${weekEnd}`
- Returns `{ entries, totalCents, error, isLoading, mutate }` where `totalCents` is computed from `entries.reduce((sum, e) => sum + e.amountCents, 0)`
- Uses `envelopeFetch` for the fetcher, same auth pattern as other hooks
- The response type should be `{ entries: IncomeEntry[], billing: BillingStatus }`

Import `IncomeEntry` from types.ts.

**Create src/components/envelopes/IncomeEntryForm.tsx:**

A compact inline form (similar to TransactionForm pattern but simpler) with:
- Amount input (dollar value, type="number", step="0.01", min="0.01")
- Description input (text, required, max 200 chars, placeholder "e.g., Sold old speaker")
- Date input (defaults to today, type="date")
- Submit button ("Add Income") and Cancel button
- Props: `onSubmit: (data: { amountCents: number; description: string; date: string }) => void`, `onCancel: () => void`, `isSubmitting: boolean`
- On submit: convert dollar amount to cents (Math.round(parseFloat * 100)), validate amount > 0 and description non-empty
- Use the same styling patterns as TransactionForm (label + input pairs, flex gap layout, Button components)
- "use client" directive at top

**Create src/components/envelopes/IncomeBanner.tsx:**

A banner component (similar pattern to SavingsBanner) that:
- Props: `totalCents: number`, `entries: { id: string; amountCents: number; description: string }[]`, `onDelete?: (id: string) => void`
- Shows only if `totalCents > 0`
- Displays: "Extra Income This Week: $XX.XX" in a banner with a light green/sage background (similar to SavingsBanner's sage theme)
- Below the total, show a compact list of entries: "{description} - {formatCents(amount)}" with a small X delete button next to each (only if onDelete is provided)
- Uses `formatCents` for formatting
- "use client" directive at top
  </action>
  <verify>Run `npm run build` -- all three files should compile. Run `npm run lint` -- no lint errors.</verify>
  <done>useIncome hook fetches income entries via SWR. IncomeEntryForm provides amount+description+date inputs with validation. IncomeBanner shows weekly income total with entry list and delete buttons. All compile and lint clean.</done>
</task>

<task type="auto">
  <name>Task 2: Reorganize EnvelopesHomePage layout and integrate income components</name>
  <files>src/components/envelopes/EnvelopesHomePage.tsx</files>
  <action>
Restructure the EnvelopesHomePage component render order. The current order is:
1. ReadOnlyBanner
2. KpiBox
3. GreetingBanner
4. SavingsBanner
5. Week header + action buttons
6. TransactionForm
7. Empty state
8. EnvelopeCardGrid
9. Modals

The NEW order should be:
1. ReadOnlyBanner (conditional, stays at top)
2. GreetingBanner (moved up -- personal greeting first)
3. "Week of {label}" header + action buttons (moved up -- primary interaction)
   - Add "Log Income" button to the action buttons row (alongside Edit Envelopes, Transfer Funds, Add Transaction)
   - "Log Income" toggles `isAddingIncome` state, similar to `isAddingTransaction`
4. IncomeEntryForm (conditional -- shown when isAddingIncome is true, wrapped in Card like TransactionForm)
5. TransactionForm (conditional -- same as before)
6. Empty state (conditional)
7. EnvelopeCardGrid with cards
8. IncomeBanner (show this week's extra income total -- below the cards, above KPIs)
9. SavingsBanner (stays after income banner)
10. KpiBox (moved to bottom -- supplementary metrics)
11. Modals (same as before)

**State changes:**
- Add `const [isAddingIncome, setIsAddingIncome] = useState(false)` state
- Import and use `useIncome` hook -- compute weekStart/weekEnd from current date using `getWeekRange` from `@/lib/envelopes/week-math`, then pass to `useIncome(weekStart, weekEnd)`
- Import `IncomeEntryForm` and `IncomeBanner`
- Import `getWeekRange` from `@/lib/envelopes/week-math` and `format` from `date-fns`

**Income form handler:**
Add `handleAddIncome` function:
```typescript
async function handleAddIncome(incomeData: { amountCents: number; description: string; date: string }) {
  if (isReadOnly) return;
  setIsSubmitting(true);
  try {
    const token = await getToken();
    await envelopeFetch("/api/envelopes/income", token, {
      method: "POST",
      body: JSON.stringify(incomeData),
    });
    await mutateIncome(); // refresh income entries
    setIsAddingIncome(false);
  } catch (err) {
    window.alert(err instanceof Error ? err.message : "Failed to add income.");
  } finally {
    setIsSubmitting(false);
  }
}
```

**Income delete handler:**
Add `handleDeleteIncome` function:
```typescript
async function handleDeleteIncome(entryId: string) {
  if (isReadOnly) return;
  try {
    const token = await getToken();
    await envelopeFetch(`/api/envelopes/income/${entryId}`, token, { method: "DELETE" });
    await mutateIncome();
  } catch (err) {
    window.alert(err instanceof Error ? err.message : "Failed to delete income entry.");
  }
}
```

**"Log Income" button:**
In the action buttons row, add a "Log Income" button (between Transfer Funds and Add Transaction):
```tsx
{!isEditing && (
  <Button
    variant="secondary"
    size="sm"
    onClick={() => {
      setIsAddingIncome(!isAddingIncome);
      setIsAddingTransaction(false); // close transaction form if open
    }}
  >
    {isAddingIncome ? "Cancel Income" : "Log Income"}
  </Button>
)}
```

When "Log Income" is clicked, close the transaction form (and vice versa -- when "Add Transaction" is clicked, close the income form).

**IncomeBanner placement:**
After the EnvelopeCardGrid, render:
```tsx
{incomeEntries && incomeEntries.length > 0 && (
  <div className="mt-6">
    <IncomeBanner
      totalCents={incomeTotalCents}
      entries={incomeEntries.map(e => ({ id: e.id, amountCents: e.amountCents, description: e.description }))}
      onDelete={isReadOnly ? undefined : handleDeleteIncome}
    />
  </div>
)}
```

Where `incomeEntries` and `incomeTotalCents` come from the `useIncome` hook.

**Important:** When toggling between "Add Transaction" and "Log Income", close the other form:
- setIsAddingTransaction should also set setIsAddingIncome(false)
- setIsAddingIncome should also set setIsAddingTransaction(false)
  </action>
  <verify>Run `npm run build` -- EnvelopesHomePage compiles. Run `npm run lint` -- no lint errors. Visually verify the component structure shows greeting first, then week header, then cards, then income banner, then savings, then KPIs at bottom.</verify>
  <done>EnvelopesHomePage renders in new order: greeting first, week header with action buttons (including Log Income), envelope cards, income banner with entries, savings banner, KPI metrics at bottom. Income form creates entries via API. Income entries visible with delete capability. Build and lint pass.</done>
</task>

</tasks>

<verification>
- `npm run build` passes
- `npm run lint` passes
- EnvelopesHomePage renders greeting before KPI metrics
- Income entry form is accessible from action buttons
- Income banner shows total and list of entries
- Income entries persist via API calls
</verification>

<success_criteria>
The envelopes home page has a reorganized layout with greeting and primary content first, KPI metrics below. Users can log supplemental income via a form, see this week's extra income total on the home page, and delete individual entries.
</success_criteria>

<output>
After completion, create `.planning/phases/42-envelopes-home-redesign-income-envelopes-analytics-dashboard/42-02-SUMMARY.md`
</output>
