---
phase: 42-envelopes-home-redesign-income-envelopes-analytics-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/envelopes/types.ts
  - src/lib/envelopes/firestore.ts
  - src/app/api/envelopes/income/route.ts
  - src/app/api/envelopes/income/[id]/route.ts
  - firestore.indexes.json
autonomous: true
requirements:
  - SC-2
  - SC-3

must_haves:
  truths:
    - "Income entries can be created via POST /api/envelopes/income with amount, description, and date"
    - "Income entries for the current week can be retrieved via GET /api/envelopes/income"
    - "Income entries can be deleted via DELETE /api/envelopes/income/[id]"
    - "Income entry amounts are stored in cents and scoped to a specific week"
  artifacts:
    - path: "src/lib/envelopes/types.ts"
      provides: "IncomeEntry type, incomeEntrySchema Zod schema"
      contains: "incomeEntrySchema"
    - path: "src/lib/envelopes/firestore.ts"
      provides: "createIncomeEntry, listIncomeEntries, deleteIncomeEntry functions"
      contains: "createIncomeEntry"
    - path: "src/app/api/envelopes/income/route.ts"
      provides: "GET and POST handlers for income entries"
      exports: ["GET", "POST"]
    - path: "src/app/api/envelopes/income/[id]/route.ts"
      provides: "DELETE handler for single income entry"
      exports: ["DELETE"]
  key_links:
    - from: "src/app/api/envelopes/income/route.ts"
      to: "src/lib/envelopes/firestore.ts"
      via: "createIncomeEntry / listIncomeEntries calls"
      pattern: "(createIncomeEntry|listIncomeEntries)"
    - from: "src/app/api/envelopes/income/route.ts"
      to: "src/lib/envelopes/types.ts"
      via: "Zod validation at API boundary"
      pattern: "incomeEntrySchema.safeParse"
---

<objective>
Create the income entries data layer: types, Zod validation schema, Firestore CRUD operations, and API routes.

Purpose: Income entries allow users to log supplemental/extra income (e.g., "Sold speaker -- $30") that boosts weekly spending power without changing base income KPIs. This plan builds the backend foundation that Plans 02 and 04 consume.
Output: Working API at /api/envelopes/income with GET, POST, DELETE; Firestore collection `envelope_income_entries`; validated types.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/envelopes/types.ts
@src/lib/envelopes/firestore.ts
@src/app/api/envelopes/route.ts
@src/app/api/envelopes/transactions/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Income entry types, Zod schema, and Firestore CRUD</name>
  <files>src/lib/envelopes/types.ts, src/lib/envelopes/firestore.ts</files>
  <action>
**In src/lib/envelopes/types.ts:**

Add the income entry input schema and types at the end of the "Input schemas" section (before the Firestore document shapes section):

```typescript
/** Income entry creation payload. */
export const incomeEntrySchema = z.object({
  amountCents: z.number().int().min(1),
  description: z.string().min(1).max(200),
  date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, "Date must be YYYY-MM-DD"),
});
export type IncomeEntryInput = z.infer<typeof incomeEntrySchema>;
```

Add the Firestore document shape in the "Firestore document shapes" section:

```typescript
/** Income entry Firestore document (supplemental income for a specific week). */
export type IncomeEntry = {
  id: string;
  userId: string;
  amountCents: number;
  description: string;
  date: string; // YYYY-MM-DD
  weekStart: string; // YYYY-MM-DD (Sunday of the week this income belongs to)
  createdAt: Timestamp;
};
```

Add to the HomePageData type -- add an `incomeEntries` field:
```typescript
export type HomePageData = {
  envelopes: EnvelopeWithStatus[];
  weekLabel: string;
  cumulativeSavingsCents: number;
  billing: BillingStatus;
  weeklyIncomeCents: number; // total extra income for current week
};
```

Add analytics type for income tracking:
```typescript
/** Weekly income entry for analytics charts. */
export type WeeklyIncomeEntry = {
  weekStart: string;
  weekLabel: string;
  totalIncomeCents: number;
};
```

Add `weeklyIncome` to AnalyticsPageData:
```typescript
// Add to existing AnalyticsPageData type:
weeklyIncome: WeeklyIncomeEntry[];
```

**In src/lib/envelopes/firestore.ts:**

1. Add collection reference function:
```typescript
export function incomeEntriesCol() {
  return requireDb().collection("envelope_income_entries");
}
```

2. Add helper query for income entries by user and week:
```typescript
function incomeEntriesForUserInWeek(userId: string, weekStart: string, weekEnd: string) {
  return incomeEntriesCol()
    .where("userId", "==", userId)
    .where("date", ">=", weekStart)
    .where("date", "<=", weekEnd);
}
```

3. Add CRUD functions -- follow the exact patterns used by `createTransaction` / `listTransactions` in the same file:

`createIncomeEntry(userId: string, input: IncomeEntryInput): Promise<{ id: string }>` -- Computes `weekStart` from `input.date` using `startOfWeek` with `WEEK_OPTIONS`, creates doc with `FieldValue.serverTimestamp()` for createdAt, returns `{ id: docRef.id }`.

`listIncomeEntriesForWeek(userId: string, weekStart: string, weekEnd: string): Promise<IncomeEntry[]>` -- Queries `incomeEntriesForUserInWeek`, maps docs to IncomeEntry objects. Sort by date descending.

`deleteIncomeEntry(userId: string, entryId: string): Promise<void>` -- Gets doc by ID, verifies `userId` matches, deletes. Throws if not found or ownership mismatch.

`getWeeklyIncomeTotal(userId: string, weekStart: string, weekEnd: string): Promise<number>` -- Sums `amountCents` from all income entries in the week range. Used by the home page data loader.

4. Update `listEnvelopesWithRemaining` to also return `weeklyIncomeCents` -- add a parallel fetch of income entries for the current week, sum their amountCents, and include in the returned HomePageData. The current function returns `{ envelopes, weekLabel, cumulativeSavingsCents }` -- add `weeklyIncomeCents` to this return.

Import `IncomeEntryInput` and `IncomeEntry` from types at the top of the file.
  </action>
  <verify>Run `npm run build` -- types.ts and firestore.ts should compile without errors. Verify the new types and functions are exported correctly.</verify>
  <done>IncomeEntry type and incomeEntrySchema exist in types.ts. createIncomeEntry, listIncomeEntriesForWeek, deleteIncomeEntry, getWeeklyIncomeTotal functions exist in firestore.ts. listEnvelopesWithRemaining returns weeklyIncomeCents. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Income entry API routes and Firestore index</name>
  <files>src/app/api/envelopes/income/route.ts, src/app/api/envelopes/income/[id]/route.ts, firestore.indexes.json</files>
  <action>
**Create src/app/api/envelopes/income/route.ts:**

Follow the exact same patterns as `src/app/api/envelopes/transactions/route.ts` (auth check with `verifyUser`, billing check with `checkEnvelopeAccess`, Zod validation, error handling).

GET handler:
- Accepts query params `weekStart` and `weekEnd` (required, YYYY-MM-DD format)
- Calls `listIncomeEntriesForWeek(auth.uid, weekStart, weekEnd)`
- Returns `{ entries: IncomeEntry[], billing: { mode, reason } }`
- If weekStart/weekEnd missing, return 400

POST handler:
- Validates body with `incomeEntrySchema.safeParse(body)`
- Checks billing access (readonly = 402)
- Calls `createIncomeEntry(auth.uid, parsed.data)`
- Returns 201 with `{ id }`

**Create src/app/api/envelopes/income/[id]/route.ts:**

DELETE handler:
- Auth check + billing check
- Calls `deleteIncomeEntry(auth.uid, params.id)`
- Returns 200 with `{ success: true }`
- Catches "not found" / "not owner" errors and returns 404 or 403

**Update firestore.indexes.json:**

Add composite index for the `envelope_income_entries` collection:
```json
{
  "collectionGroup": "envelope_income_entries",
  "queryScope": "COLLECTION",
  "fields": [
    { "fieldPath": "userId", "order": "ASCENDING" },
    { "fieldPath": "date", "order": "ASCENDING" }
  ]
}
```

This matches the query pattern: `where("userId", "==", ...).where("date", ">=", ...).where("date", "<=", ...)`.
  </action>
  <verify>Run `npm run build` to verify API routes compile. Run `npm run lint` to verify no lint issues. Verify the route files exist at the expected paths.</verify>
  <done>GET /api/envelopes/income returns income entries for a week range. POST /api/envelopes/income creates a new income entry with validation. DELETE /api/envelopes/income/[id] removes an entry. Firestore index defined for userId+date queries. Build and lint pass.</done>
</task>

</tasks>

<verification>
- `npm run build` passes with no type errors
- `npm run lint` passes with no lint errors
- New API route files exist at correct paths
- Types are properly exported from types.ts
- Firestore index added for envelope_income_entries
</verification>

<success_criteria>
Income entry data layer is complete: types validated with Zod, Firestore CRUD operations work, API routes handle GET/POST/DELETE with proper auth and billing checks, and the home page data loader returns weeklyIncomeCents.
</success_criteria>

<output>
After completion, create `.planning/phases/42-envelopes-home-redesign-income-envelopes-analytics-dashboard/42-01-SUMMARY.md`
</output>
