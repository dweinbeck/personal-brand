---
phase: 42-envelopes-home-redesign-income-envelopes-analytics-dashboard
plan: 04
type: execute
wave: 3
depends_on: ["42-02", "42-03"]
files_modified:
  - src/components/envelopes/demo/seed-data.ts
  - src/components/envelopes/demo/DemoProvider.tsx
  - src/components/envelopes/demo/DemoHomePage.tsx
  - src/components/envelopes/demo/DemoAnalyticsPage.tsx
  - src/lib/envelopes/__tests__/income.test.ts
autonomous: true
requirements:
  - SC-5
  - SC-6

must_haves:
  truths:
    - "Demo home page shows KpiBox with income/bills/disposable/savings metrics"
    - "Demo home page supports Transfer Funds between envelopes via a modal"
    - "Demo home page supports inline budget editing on envelope cards"
    - "Demo home page supports logging and viewing income entries"
    - "Demo home page layout matches real version: greeting first, cards, income banner, savings, KPIs"
    - "Demo analytics page shows all 7 chart sections matching the real analytics page"
    - "Demo banner is visible announcing demo mode with data-resets-on-refresh message"
    - "All existing tests pass and income entry logic has test coverage"
  artifacts:
    - path: "src/components/envelopes/demo/DemoProvider.tsx"
      provides: "Expanded reducer with profile, transfers, budget edits, income entry actions"
      contains: "ADD_INCOME_ENTRY"
    - path: "src/components/envelopes/demo/DemoHomePage.tsx"
      provides: "Full-parity home page with KpiBox, TransferModal, inline editing, income"
      min_lines: 200
    - path: "src/components/envelopes/demo/DemoAnalyticsPage.tsx"
      provides: "Full analytics page with all 7 chart sections"
      min_lines: 100
    - path: "src/components/envelopes/demo/seed-data.ts"
      provides: "Seed data including profile, transfers, and income entries"
      contains: "DEMO_PROFILE"
    - path: "src/lib/envelopes/__tests__/income.test.ts"
      provides: "Unit tests for income entry validation and computation logic"
      min_lines: 30
  key_links:
    - from: "src/components/envelopes/demo/DemoHomePage.tsx"
      to: "src/components/envelopes/KpiBox.tsx"
      via: "import and render with demo profile data"
      pattern: "KpiBox"
    - from: "src/components/envelopes/demo/DemoHomePage.tsx"
      to: "src/components/envelopes/IncomeBanner.tsx"
      via: "import and render with demo income entries"
      pattern: "IncomeBanner"
    - from: "src/components/envelopes/demo/DemoAnalyticsPage.tsx"
      to: "src/components/envelopes/SpendingDistributionChart.tsx"
      via: "import and render with computed demo data"
      pattern: "SpendingDistributionChart"
---

<objective>
Bring the demo version to full feature parity with the real version and add test coverage for new income functionality.

Purpose: The demo at /envelopes/demo should mirror the real version's interface and functionality so visitors can experience the full app without signing in. Data is stored in-memory only (resets on refresh) with clear demo announcements. Additionally, new income entry functionality needs test coverage.
Output: Full-parity demo with KPIs, transfers, inline editing, income entries, and all analytics charts. Test file for income logic.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/42-envelopes-home-redesign-income-envelopes-analytics-dashboard/42-01-SUMMARY.md
@.planning/phases/42-envelopes-home-redesign-income-envelopes-analytics-dashboard/42-02-SUMMARY.md
@.planning/phases/42-envelopes-home-redesign-income-envelopes-analytics-dashboard/42-03-SUMMARY.md
@src/components/envelopes/demo/DemoProvider.tsx
@src/components/envelopes/demo/DemoHomePage.tsx
@src/components/envelopes/demo/DemoAnalyticsPage.tsx
@src/components/envelopes/demo/seed-data.ts
@src/components/envelopes/EnvelopesHomePage.tsx
@src/components/envelopes/AnalyticsPage.tsx
@src/components/envelopes/KpiBox.tsx
@src/components/envelopes/TransferModal.tsx
@src/components/envelopes/EnvelopeCard.tsx
@src/components/envelopes/IncomeBanner.tsx
@src/components/envelopes/IncomeEntryForm.tsx
@src/components/envelopes/IncomeVsSpendingChart.tsx
@src/components/envelopes/SpendingDistributionChart.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand DemoProvider and seed data for full feature parity</name>
  <files>src/components/envelopes/demo/seed-data.ts, src/components/envelopes/demo/DemoProvider.tsx</files>
  <action>
**In src/components/envelopes/demo/seed-data.ts:**

Add new demo types and seed data:

```typescript
export type DemoProfile = {
  averageWeeklyIncomeCents: number;
  averageWeeklyBillsCents: number;
  targetWeeklySavingsCents: number;
};

export type DemoTransfer = {
  id: string;
  fromEnvelopeId: string;
  toEnvelopeId: string;
  amountCents: number;
  weekStart: string;
};

export type DemoIncomeEntry = {
  id: string;
  amountCents: number;
  description: string;
  date: string;
};
```

Add seed profile:
```typescript
export const DEMO_PROFILE: DemoProfile = {
  averageWeeklyIncomeCents: 200000, // $2,000/week
  averageWeeklyBillsCents: 120000, // $1,200/week
  targetWeeklySavingsCents: 30000,  // $300/week
};
```

Add seed income entries:
```typescript
export const DEMO_INCOME_ENTRIES: DemoIncomeEntry[] = [
  {
    id: "demo-income-1",
    amountCents: 3000,
    description: "Sold old speaker",
    date: weekDay(1),
  },
  {
    id: "demo-income-2",
    amountCents: 2500,
    description: "Freelance task",
    date: weekDay(3),
  },
];
```

Add seed historical transactions for prior weeks (needed for analytics trend/savings charts). Create 2-3 weeks of prior transaction data using a helper:
```typescript
function priorWeekDay(weeksAgo: number, dayOffset: number): string {
  const priorWeekStart = addDays(weekStart, -(weeksAgo * 7));
  return format(addDays(priorWeekStart, dayOffset), "yyyy-MM-dd");
}

export const DEMO_HISTORICAL_TRANSACTIONS: DemoTransaction[] = [
  // Week -2 (two weeks ago)
  { id: "demo-hist-1", envelopeId: "demo-env-1", amountCents: 12000, date: priorWeekDay(2, 1), merchant: "Kroger" },
  { id: "demo-hist-2", envelopeId: "demo-env-2", amountCents: 5000, date: priorWeekDay(2, 2), merchant: "Olive Garden" },
  { id: "demo-hist-3", envelopeId: "demo-env-3", amountCents: 4500, date: priorWeekDay(2, 0), merchant: "Shell" },
  { id: "demo-hist-4", envelopeId: "demo-env-4", amountCents: 2000, date: priorWeekDay(2, 3), merchant: "AMC" },
  { id: "demo-hist-5", envelopeId: "demo-env-5", amountCents: 1800, date: priorWeekDay(2, 1), merchant: "Starbucks" },
  // Week -1 (last week)
  { id: "demo-hist-6", envelopeId: "demo-env-1", amountCents: 14000, date: priorWeekDay(1, 0), merchant: "Trader Joe's" },
  { id: "demo-hist-7", envelopeId: "demo-env-2", amountCents: 7000, date: priorWeekDay(1, 2), merchant: "Chipotle" },
  { id: "demo-hist-8", envelopeId: "demo-env-3", amountCents: 3500, date: priorWeekDay(1, 1), merchant: "BP" },
  { id: "demo-hist-9", envelopeId: "demo-env-4", amountCents: 3000, date: priorWeekDay(1, 4), merchant: "Steam" },
  { id: "demo-hist-10", envelopeId: "demo-env-5", amountCents: 2200, date: priorWeekDay(1, 3), merchant: "Local Coffee Co" },
];

export const DEMO_HISTORICAL_INCOME: DemoIncomeEntry[] = [
  { id: "demo-hist-inc-1", amountCents: 5000, description: "Garage sale", date: priorWeekDay(1, 2) },
];
```

**In src/components/envelopes/demo/DemoProvider.tsx:**

Expand the state to include profile, transfers, and income entries:

```typescript
type DemoState = {
  envelopes: DemoEnvelope[];
  transactions: DemoTransaction[];
  transfers: DemoTransfer[];
  incomeEntries: DemoIncomeEntry[];
  profile: DemoProfile;
  historicalTransactions: DemoTransaction[]; // for analytics
  historicalIncome: DemoIncomeEntry[]; // for analytics
};
```

Add new action types:
```typescript
type DemoAction =
  | { type: "ADD_ENVELOPE"; payload: ... }
  | { type: "ADD_TRANSACTION"; payload: ... }
  | { type: "DELETE_ENVELOPE"; payload: { id: string } }
  | { type: "DELETE_TRANSACTION"; payload: { id: string } }
  | { type: "UPDATE_ENVELOPE_BUDGET"; payload: { id: string; weeklyBudgetCents: number } }
  | { type: "TRANSFER_FUNDS"; payload: { fromEnvelopeId: string; toEnvelopeId: string; amountCents: number } }
  | { type: "ADD_INCOME_ENTRY"; payload: Omit<DemoIncomeEntry, "id"> }
  | { type: "DELETE_INCOME_ENTRY"; payload: { id: string } }
  | { type: "UPDATE_PROFILE"; payload: DemoProfile };
```

Implement reducer cases:

**UPDATE_ENVELOPE_BUDGET:** Find envelope by id, update weeklyBudgetCents, recompute with `recomputeEnvelope`.

**TRANSFER_FUNDS:** Reduce source envelope's spentCents by amountCents (effectively freeing up budget), increase target envelope's spentCents by amountCents (or more precisely, add a transfer record and recompute). Simpler approach: create a DemoTransfer record, then recompute both envelopes' remaining using original budget + transfers in/out.

Actually, the simplest approach that matches the real version's behavior: transfers affect `remainingCents` by adding to the target and removing from the source. In the real version, transfers are tracked as separate documents and the remaining computation accounts for them. For demo simplicity:
- Add the transfer to state.transfers
- Recompute envelopes factoring in transfers: for each envelope, net transfer = sum(transfers where toEnvelopeId == id).amountCents - sum(transfers where fromEnvelopeId == id).amountCents. Then remainingCents = weeklyBudgetCents - spentCents + netTransfer.

Update `recomputeEnvelope` to accept transfers array and factor in net transfers.

**ADD_INCOME_ENTRY:** Add new entry with crypto.randomUUID() id to state.incomeEntries.

**DELETE_INCOME_ENTRY:** Remove entry from state.incomeEntries.

**UPDATE_PROFILE:** Replace state.profile.

Initialize state with all seed data:
```typescript
const [state, dispatch] = useReducer(demoReducer, {
  envelopes: DEMO_ENVELOPES,
  transactions: DEMO_TRANSACTIONS,
  transfers: [],
  incomeEntries: DEMO_INCOME_ENTRIES,
  profile: DEMO_PROFILE,
  historicalTransactions: DEMO_HISTORICAL_TRANSACTIONS,
  historicalIncome: DEMO_HISTORICAL_INCOME,
});
```

Import all new seed data types and constants from seed-data.ts.
  </action>
  <verify>Run `npm run build` -- DemoProvider and seed-data compile. Run `npm run lint` -- no lint errors.</verify>
  <done>DemoProvider supports all actions: envelope CRUD, budget editing, fund transfers, income entries CRUD, profile updates. Seed data includes profile, income entries, and 2 weeks of historical data for analytics charts. Build and lint pass.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite DemoHomePage and DemoAnalyticsPage for full parity</name>
  <files>src/components/envelopes/demo/DemoHomePage.tsx, src/components/envelopes/demo/DemoAnalyticsPage.tsx</files>
  <action>
**Rewrite src/components/envelopes/demo/DemoHomePage.tsx:**

Mirror the real EnvelopesHomePage's structure and layout from Plan 02 (reorganized order). The demo version dispatches actions to DemoProvider instead of making API calls.

Key components to import from the real version (reuse, do NOT duplicate):
- `GreetingBanner` -- CANNOT reuse directly because it calls `useAuth()`. Create a simple inline greeting instead: "Welcome to Envelopes Demo" with the same stats line.
- `KpiBox` -- CAN reuse! Pass `profile={state.profile}`, `isLoading={false}`, `onEdit={() => {}}` (no edit in demo, or dispatch UPDATE_PROFILE)
- `SavingsBanner` -- CAN reuse
- `EnvelopeCardGrid` -- CAN reuse
- `CreateEnvelopeCard` -- CAN reuse
- `EnvelopeForm` -- CAN reuse
- `TransactionForm` -- CAN reuse
- `StatusBadge` -- CAN reuse
- `IncomeBanner` -- CAN reuse (from Plan 02)
- `IncomeEntryForm` -- CAN reuse (from Plan 02)

For `TransferModal` -- CANNOT reuse directly because it calls `envelopeFetch` with a real API. Create a `DemoTransferModal` that:
- Has the same UI as TransferModal (copy the JSX structure)
- On submit, dispatches `TRANSFER_FUNDS` action instead of calling API
- Props: `isOpen`, `onClose`, `onTransferred`, `envelopes` (same shape as real TransferModal minus `getToken`)

For `EnvelopeCard` -- CANNOT reuse directly because it uses `Link` to `/envelopes/${id}` and expects `EnvelopeWithStatus` with Firestore Timestamp. Enhance the existing `DemoEnvelopeCard` inline component to support:
- Inline budget editing (same pattern as real EnvelopeCard: number input on blur-to-save in edit mode)
- On budget change, dispatch `UPDATE_ENVELOPE_BUDGET`
- Rollover surplus display (show if > 0 on the card, like real version)
- Remove the Link wrapper (demo cards don't navigate to detail pages)

Layout order (matching real version from Plan 02):
1. Demo greeting (inline, not GreetingBanner since that uses useAuth)
2. "Week of {weekLabel}" header + action buttons: Edit Envelopes, Transfer Funds (if >= 2 envelopes), Log Income, Add Transaction
3. IncomeEntryForm (conditional)
4. TransactionForm (conditional)
5. Empty state (conditional)
6. EnvelopeCardGrid with enhanced DemoEnvelopeCards
7. IncomeBanner (showing demo income entries with delete)
8. SavingsBanner
9. KpiBox (with demo profile data)
10. DemoTransferModal

State variables needed: isEditing, isCreating, deletingId, isAddingTransaction, isAddingIncome, transferOpen.

Handlers:
- handleCreate: dispatch ADD_ENVELOPE
- handleDelete: dispatch DELETE_ENVELOPE
- handleAddTransaction: dispatch ADD_TRANSACTION
- handleBudgetChange: dispatch UPDATE_ENVELOPE_BUDGET
- handleTransfer: dispatch TRANSFER_FUNDS, close modal
- handleAddIncome: dispatch ADD_INCOME_ENTRY
- handleDeleteIncome: dispatch DELETE_INCOME_ENTRY

Compute savingsCents from envelopes (same as current DemoHomePage), pass to SavingsBanner.

**Rewrite src/components/envelopes/demo/DemoAnalyticsPage.tsx:**

Mirror the real AnalyticsPage's 7 sections, computing all data from DemoProvider state.

Import these chart components (reuse directly -- they take plain data props, no API/auth dependency):
- `SummaryStats`
- `SpendingByEnvelopeChart`
- `SpendingDistributionChart` (new from Plan 03)
- `SpendingTrendChart`
- `IncomeVsSpendingChart` (new from Plan 03)
- `WeeklyPivotTable`
- `SavingsChart`

Compute analytics data from demo state:

```typescript
const { state } = useDemo();
const allTransactions = [...state.transactions, ...state.historicalTransactions];
const allIncomeEntries = [...state.incomeEntries, ...state.historicalIncome];
```

**Summary stats:** computed from current-week envelopes (same as current DemoAnalyticsPage).

**spendingByEnvelope:** map envelopes to `{ envelopeId, title, spentCents, budgetCents, percentUsed }`, sorted by percentUsed descending.

**Spending distribution data:** `spendingByEnvelope.map(e => ({ title: e.title, spentCents: e.spentCents }))`.

**weeklyTotals (for SpendingTrendChart):** Group all transactions by week. Iterate weeks from earliest transaction date to current week. For each week, sum transaction amounts. Each entry has `{ weekLabel, totalSpentCents, totalBudgetCents }`.

Use `startOfWeek`, `addWeeks`, `format` from `date-fns` and `getWeekNumber`, `formatWeekLabel` from `@/lib/envelopes/week-math`.

**weeklyIncome (for IncomeVsSpendingChart):** Group all income entries by week, same week iteration as weeklyTotals.

**pivotRows (for WeeklyPivotTable):** Group transactions by week and envelope. Each row has `{ weekStart, weekLabel, cells: Record<envelopeId, sumCents>, totalCents }`. Newest week first.

**savingsByWeek (for SavingsChart):** For each completed week (not current week), compute savings = totalBudget - totalSpent for that week (only if positive). Track cumulative.

**Envelope headers:** `state.envelopes.map(e => ({ id: e.id, title: e.title }))` for pivot table column headers.

Render all 7 sections in the same order as the real AnalyticsPage:
1. This Week (SummaryStats)
2. Budget Utilization (SpendingByEnvelopeChart)
3. Spending Distribution (SpendingDistributionChart)
4. Spending Trend (SpendingTrendChart)
5. Income vs Spending (IncomeVsSpendingChart)
6. Weekly Spending (WeeklyPivotTable)
7. Savings Growth (SavingsChart)

Remove the "sign in" CTA card that currently exists at the bottom -- the demo should show full analytics, not promote sign-in within the analytics page.

Wrap in the same container: `<div className="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 py-8 space-y-8">`
  </action>
  <verify>Run `npm run build` -- both demo pages compile. Run `npm run lint` -- no lint errors. Verify DemoHomePage imports and renders KpiBox, IncomeBanner, IncomeEntryForm, DemoTransferModal. Verify DemoAnalyticsPage imports and renders all 7 chart sections.</verify>
  <done>DemoHomePage mirrors real version with KpiBox, transfer modal, inline budget editing, income entries, and reorganized layout. DemoAnalyticsPage shows all 7 chart sections with data computed from demo state. Demo banner remains visible. Build and lint pass.</done>
</task>

<task type="auto">
  <name>Task 3: Add test coverage for income entry logic</name>
  <files>src/lib/envelopes/__tests__/income.test.ts</files>
  <action>
**Create src/lib/envelopes/__tests__/income.test.ts:**

Write unit tests for the income entry validation schema and computation logic. Follow the test patterns from `src/lib/billing/__tests__/types.test.ts`.

Tests to write:

**incomeEntrySchema validation tests:**
```typescript
import { incomeEntrySchema } from "../types";

describe("incomeEntrySchema", () => {
  it("accepts valid input", () => {
    const result = incomeEntrySchema.safeParse({
      amountCents: 3000,
      description: "Sold old speaker",
      date: "2026-02-17",
    });
    expect(result.success).toBe(true);
  });

  it("rejects zero amount", () => {
    const result = incomeEntrySchema.safeParse({
      amountCents: 0,
      description: "Free item",
      date: "2026-02-17",
    });
    expect(result.success).toBe(false);
  });

  it("rejects negative amount", () => {
    const result = incomeEntrySchema.safeParse({
      amountCents: -100,
      description: "Negative",
      date: "2026-02-17",
    });
    expect(result.success).toBe(false);
  });

  it("rejects empty description", () => {
    const result = incomeEntrySchema.safeParse({
      amountCents: 1000,
      description: "",
      date: "2026-02-17",
    });
    expect(result.success).toBe(false);
  });

  it("rejects description over 200 chars", () => {
    const result = incomeEntrySchema.safeParse({
      amountCents: 1000,
      description: "a".repeat(201),
      date: "2026-02-17",
    });
    expect(result.success).toBe(false);
  });

  it("rejects invalid date format", () => {
    const result = incomeEntrySchema.safeParse({
      amountCents: 1000,
      description: "Valid desc",
      date: "02-17-2026",
    });
    expect(result.success).toBe(false);
  });

  it("accepts exactly 200 char description", () => {
    const result = incomeEntrySchema.safeParse({
      amountCents: 1000,
      description: "a".repeat(200),
      date: "2026-02-17",
    });
    expect(result.success).toBe(true);
  });

  it("rejects float amountCents", () => {
    const result = incomeEntrySchema.safeParse({
      amountCents: 10.5,
      description: "Float cents",
      date: "2026-02-17",
    });
    expect(result.success).toBe(false);
  });
});
```

**KPI computation tests (computeDisposableIncomeCents):**
```typescript
import { computeDisposableIncomeCents } from "../kpi-math";

describe("computeDisposableIncomeCents", () => {
  it("computes income minus bills", () => {
    expect(computeDisposableIncomeCents(200000, 120000)).toBe(80000);
  });

  it("returns negative when bills exceed income", () => {
    expect(computeDisposableIncomeCents(100000, 150000)).toBe(-50000);
  });

  it("returns zero when equal", () => {
    expect(computeDisposableIncomeCents(100000, 100000)).toBe(0);
  });
});
```

Run all tests with `npm test` to ensure both new and existing tests pass.
  </action>
  <verify>Run `npm test` -- all tests pass including new income.test.ts. Run `npm run build` -- build passes. Run `npm run lint` -- lint passes.</verify>
  <done>Income entry schema has comprehensive validation tests (valid input, zero/negative amounts, empty/long description, invalid date, float cents). KPI computation has tests. All existing and new tests pass.</done>
</task>

</tasks>

<verification>
- `npm test` passes (all existing + new tests)
- `npm run build` passes
- `npm run lint` passes
- Demo home page has all features: KpiBox, transfers, inline editing, income entries
- Demo analytics page has all 7 chart sections
- Demo mode banner is visible on all demo pages
</verification>

<success_criteria>
The demo version at /envelopes/demo provides full feature parity: KPI display, fund transfers, inline budget editing, income entries, and all 7 analytics charts -- all with in-memory data that resets on refresh. Clear demo announcements are visible. All tests pass with new coverage for income entry validation.
</success_criteria>

<output>
After completion, create `.planning/phases/42-envelopes-home-redesign-income-envelopes-analytics-dashboard/42-04-SUMMARY.md`
</output>
