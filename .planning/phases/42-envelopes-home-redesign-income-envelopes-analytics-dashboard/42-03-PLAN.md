---
phase: 42-envelopes-home-redesign-income-envelopes-analytics-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["42-01"]
files_modified:
  - src/lib/envelopes/firestore.ts
  - src/lib/envelopes/types.ts
  - src/components/envelopes/IncomeVsSpendingChart.tsx
  - src/components/envelopes/SpendingDistributionChart.tsx
  - src/components/envelopes/AnalyticsPage.tsx
autonomous: true
requirements:
  - SC-4

must_haves:
  truths:
    - "The analytics page shows an income vs spending comparison chart with weekly bars"
    - "The analytics page shows a spending distribution pie/donut chart by envelope"
    - "Income data is included in the analytics API response"
    - "All existing analytics charts continue to render correctly"
  artifacts:
    - path: "src/components/envelopes/IncomeVsSpendingChart.tsx"
      provides: "Grouped bar chart comparing weekly income (base + extra) vs spending"
      min_lines: 40
    - path: "src/components/envelopes/SpendingDistributionChart.tsx"
      provides: "Pie/donut chart showing spending proportion by envelope"
      min_lines: 40
    - path: "src/components/envelopes/AnalyticsPage.tsx"
      provides: "Analytics page with 2 new chart sections added"
      min_lines: 80
    - path: "src/lib/envelopes/firestore.ts"
      provides: "getAnalyticsData returns weeklyIncome data"
      contains: "weeklyIncome"
  key_links:
    - from: "src/components/envelopes/AnalyticsPage.tsx"
      to: "src/components/envelopes/IncomeVsSpendingChart.tsx"
      via: "import and render with data.weeklyIncome + data.weeklyTotals"
      pattern: "IncomeVsSpendingChart"
    - from: "src/components/envelopes/AnalyticsPage.tsx"
      to: "src/components/envelopes/SpendingDistributionChart.tsx"
      via: "import and render with data.spendingByEnvelope"
      pattern: "SpendingDistributionChart"
    - from: "src/lib/envelopes/firestore.ts"
      to: "envelope_income_entries collection"
      via: "Firestore query in getAnalyticsData"
      pattern: "envelope_income_entries"
---

<objective>
Add new analytics charts (income vs spending comparison, spending distribution pie chart) and wire income data into the analytics backend.

Purpose: The analytics page currently shows budget utilization, spending trend, pivot table, and savings. Users need to see how their income compares to spending over time, and how spending is distributed across envelopes. The income vs spending chart also incorporates the new income entries feature.
Output: Two new chart components on the analytics page, analytics API returns weekly income data.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/42-envelopes-home-redesign-income-envelopes-analytics-dashboard/42-01-SUMMARY.md
@src/components/envelopes/AnalyticsPage.tsx
@src/components/envelopes/SpendingByEnvelopeChart.tsx
@src/components/envelopes/SpendingTrendChart.tsx
@src/components/envelopes/SavingsChart.tsx
@src/lib/envelopes/firestore.ts
@src/lib/envelopes/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add income data to analytics backend and create new chart components</name>
  <files>src/lib/envelopes/firestore.ts, src/components/envelopes/IncomeVsSpendingChart.tsx, src/components/envelopes/SpendingDistributionChart.tsx</files>
  <action>
**In src/lib/envelopes/firestore.ts -- update getAnalyticsData:**

Add income entries query to the parallel fetch in `getAnalyticsData`. Currently it fetches `[envSnap, currentTxSnap, allTxSnap]`. Add a 4th fetch:

```typescript
const [envSnap, currentTxSnap, allTxSnap, allIncomeSnap] = await Promise.all([
  envelopesForUser(userId).get(),
  transactionsForUserInWeek(userId, weekStartStr, weekEndStr).get(),
  transactionsCol().where("userId", "==", userId).get(),
  incomeEntriesCol().where("userId", "==", userId).get(), // all income entries
]);
```

Parse income entries:
```typescript
const allIncomeEntries = allIncomeSnap.docs.map((doc) => {
  const data = doc.data();
  return {
    amountCents: data.amountCents as number,
    date: data.date as string,
  };
});
```

After the weeklyTotals computation (step 8), add step 9 to compute weekly income:

```typescript
// 9. Compute WEEKLY INCOME (for income vs spending chart)
const weeklyIncome: WeeklyIncomeEntry[] = [];
// Iterate same weeks as weeklyTotals
let incomeIterWeek = earliestWeekStart;
while (incomeIterWeek < nextWeekAfterCurrent) {
  const iterWeekDate = new Date(`${incomeIterWeek}T00:00:00`);
  const nextWeekDate = addWeeks(iterWeekDate, 1);
  const iterWeekEnd = format(
    new Date(nextWeekDate.getTime() - 86_400_000),
    "yyyy-MM-dd",
  );

  const weekIncomeEntries = allIncomeEntries.filter(
    (e) => e.date >= incomeIterWeek && e.date <= iterWeekEnd,
  );
  const totalIncome = weekIncomeEntries.reduce((sum, e) => sum + e.amountCents, 0);

  const weekNumber = getWeekNumber(iterWeekDate);
  weeklyIncome.push({
    weekStart: incomeIterWeek,
    weekLabel: `Wk ${weekNumber}`,
    totalIncomeCents: totalIncome,
  });

  incomeIterWeek = format(nextWeekDate, "yyyy-MM-dd");
}
```

Add `weeklyIncome` to the return object.

Import `WeeklyIncomeEntry` from types.ts.

**Create src/components/envelopes/IncomeVsSpendingChart.tsx:**

A grouped bar chart using Recharts that compares weekly income vs spending:

Props:
```typescript
type IncomeVsSpendingChartProps = {
  weeklyTotals: { weekLabel: string; totalSpentCents: number; totalBudgetCents: number }[];
  weeklyIncome: { weekLabel: string; totalIncomeCents: number }[];
  baseWeeklyIncomeCents?: number; // from profile, if available
};
```

Chart data: merge weeklyTotals and weeklyIncome by weekLabel. Each data point has:
- `weekLabel`: the x-axis label
- `income`: base weekly income + extra income for that week (in cents)
- `spending`: totalSpentCents for that week

Use Recharts `BarChart` with:
- Two `Bar` elements side by side (grouped, not stacked): income bar (fill="#6b8e6f" sage green) and spending bar (fill="#1b2a4a" primary)
- `XAxis` with weekLabel
- `YAxis` with formatCents tick formatter
- `Tooltip` with formatCents formatter, names "Income" and "Spending"
- `CartesianGrid` with same stroke as other charts
- `Legend` at bottom

Empty state: "Income and spending comparison will appear after your first week."

"use client" directive.

**Create src/components/envelopes/SpendingDistributionChart.tsx:**

A pie/donut chart showing spending proportion by envelope:

Props:
```typescript
type SpendingDistributionChartProps = {
  data: { title: string; spentCents: number }[];
};
```

Use Recharts `PieChart` with `Pie` component:
- Data: filter out envelopes with 0 spending, map to `{ name: title, value: spentCents }`
- Use donut style: `innerRadius={60} outerRadius={100}`
- Color palette: cycle through a set of 6-8 colors: ["#1b2a4a", "#b8860b", "#6b8e6f", "#d4c9b0", "#4a6fa5", "#8b6914", "#2d5016", "#7a6b52"]
- `Cell` components for each slice with colors from palette
- `Tooltip` with formatCents formatter
- `Legend` below the chart showing envelope names
- Center label: total spending amount using a custom label element

Empty state: "No spending data to display."

"use client" directive.

Recharts Pie import: `import { PieChart, Pie, Cell, Tooltip, Legend, ResponsiveContainer } from "recharts";`
  </action>
  <verify>Run `npm run build` -- all files compile. Run `npm run lint` -- no lint errors.</verify>
  <done>getAnalyticsData returns weeklyIncome array. IncomeVsSpendingChart renders grouped bars for income vs spending. SpendingDistributionChart renders a donut chart of spending by envelope. Build and lint pass.</done>
</task>

<task type="auto">
  <name>Task 2: Wire new charts into AnalyticsPage</name>
  <files>src/components/envelopes/AnalyticsPage.tsx, src/lib/envelopes/hooks.ts</files>
  <action>
**In src/components/envelopes/AnalyticsPage.tsx:**

Import the two new chart components:
```typescript
import { IncomeVsSpendingChart } from "./IncomeVsSpendingChart";
import { SpendingDistributionChart } from "./SpendingDistributionChart";
```

Also import `useEnvelopeProfile` from hooks to get base weekly income:
```typescript
import { useAnalytics, useEnvelopeProfile } from "@/lib/envelopes/hooks";
```

In the component body, add:
```typescript
const { profile } = useEnvelopeProfile();
```

Add two new sections to the page. Insert them AFTER the "Budget Utilization" section and BEFORE "Spending Trend":

**Section: "Spending Distribution" (pie/donut chart):**
```tsx
<section>
  <h2 className="text-lg font-semibold font-display text-primary mb-4">
    Spending Distribution
  </h2>
  <SpendingDistributionChart
    data={data.spendingByEnvelope.map(e => ({ title: e.title, spentCents: e.spentCents }))}
  />
</section>
```

**Section: "Income vs Spending" (grouped bar chart):**
Insert AFTER "Spending Trend":
```tsx
<section>
  <h2 className="text-lg font-semibold font-display text-primary mb-4">
    Income vs Spending
  </h2>
  <IncomeVsSpendingChart
    weeklyTotals={data.weeklyTotals}
    weeklyIncome={data.weeklyIncome}
    baseWeeklyIncomeCents={profile?.averageWeeklyIncomeCents}
  />
</section>
```

Final section order on AnalyticsPage:
1. This Week (SummaryStats)
2. Budget Utilization (SpendingByEnvelopeChart)
3. Spending Distribution (SpendingDistributionChart) -- NEW
4. Spending Trend (SpendingTrendChart)
5. Income vs Spending (IncomeVsSpendingChart) -- NEW
6. Weekly Spending (WeeklyPivotTable)
7. Savings Growth (SavingsChart)

**In src/lib/envelopes/hooks.ts -- no changes needed** unless the AnalyticsPageData type import needs updating. The existing `useAnalytics` hook already returns all data from the analytics endpoint, and the new `weeklyIncome` field will be included automatically since the backend now returns it and the type has been updated in Plan 01.
  </action>
  <verify>Run `npm run build` -- AnalyticsPage compiles with new chart imports. Run `npm run lint` -- no lint errors. Verify the section order in the JSX matches the specified order.</verify>
  <done>AnalyticsPage renders 7 sections including new Spending Distribution donut chart and Income vs Spending grouped bar chart. All existing charts continue to work. Build and lint pass.</done>
</task>

</tasks>

<verification>
- `npm run build` passes
- `npm run lint` passes
- AnalyticsPage has 7 sections (5 existing + 2 new)
- New charts use Recharts library consistently with existing charts
- getAnalyticsData returns weeklyIncome data
</verification>

<success_criteria>
The analytics page displays spending distribution as a pie/donut chart and income vs spending as a grouped bar chart, in addition to all existing charts. The analytics backend provides weekly income data.
</success_criteria>

<output>
After completion, create `.planning/phases/42-envelopes-home-redesign-income-envelopes-analytics-dashboard/42-03-SUMMARY.md`
</output>
