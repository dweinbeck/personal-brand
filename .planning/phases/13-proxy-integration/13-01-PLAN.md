---
phase: 13-proxy-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/schemas/fastapi.ts
  - src/lib/assistant/fastapi-client.ts
autonomous: true

must_haves:
  truths:
    - "FastAPI response JSON is validated with a Zod schema before reaching the route handler"
    - "Network errors, timeouts, and non-200 responses from FastAPI are translated into typed errors"
    - "The FastAPI client uses CHATBOT_API_URL env var and 15-second timeout"
  artifacts:
    - path: "src/lib/schemas/fastapi.ts"
      provides: "Zod schemas and inferred types for FastAPI ChatRequest/ChatResponse contract"
      exports: ["fastApiResponseSchema", "fastApiCitationSchema", "FastApiResponse", "FastApiCitation"]
    - path: "src/lib/assistant/fastapi-client.ts"
      provides: "Typed fetch wrapper for FastAPI /chat endpoint with error handling"
      exports: ["askFastApi", "FastApiError"]
  key_links:
    - from: "src/lib/assistant/fastapi-client.ts"
      to: "src/lib/schemas/fastapi.ts"
      via: "import fastApiResponseSchema"
      pattern: "import.*fastApiResponseSchema.*from.*schemas/fastapi"
    - from: "src/lib/assistant/fastapi-client.ts"
      to: "process.env.CHATBOT_API_URL"
      via: "environment variable read"
      pattern: "process\\.env\\.CHATBOT_API_URL"
---

<objective>
Create the FastAPI integration layer: Zod schemas for the FastAPI request/response contract and a typed client wrapper with error handling.

Purpose: These are the building blocks that the route handler (Plan 02) will import. Separating them enables clean testing and reuse, and keeps the route handler thin.
Output: Two new files -- `src/lib/schemas/fastapi.ts` and `src/lib/assistant/fastapi-client.ts`
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-proxy-integration/13-RESEARCH.md

# Existing pattern reference
@src/lib/schemas/assistant.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zod schemas for FastAPI contract</name>
  <files>src/lib/schemas/fastapi.ts</files>
  <action>
Create `src/lib/schemas/fastapi.ts` with Zod schemas matching the verified FastAPI contract from 13-RESEARCH.md:

```typescript
import { z } from "zod";

export const fastApiCitationSchema = z.object({
  source: z.string(),
  relevance: z.string(),
});

export const fastApiResponseSchema = z.object({
  answer: z.string(),
  citations: z.array(fastApiCitationSchema),
  confidence: z.enum(["low", "medium", "high"]),
});

export type FastApiResponse = z.infer<typeof fastApiResponseSchema>;
export type FastApiCitation = z.infer<typeof fastApiCitationSchema>;
```

Critical details:
- `answer` (NOT `response`) -- verified from actual `chat.py`
- `relevance` is a string (NOT `content`, NOT `line_range`)
- `confidence` is `z.enum(["low", "medium", "high"])` (NOT `z.number()`)
- Follow the same style as `src/lib/schemas/assistant.ts` (import from "zod", export types)
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors in the new file.
Run `npm run lint` -- passes with no errors.
  </verify>
  <done>
`src/lib/schemas/fastapi.ts` exists, exports `fastApiResponseSchema`, `fastApiCitationSchema`, `FastApiResponse`, and `FastApiCitation`. Types compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FastAPI client wrapper</name>
  <files>src/lib/assistant/fastapi-client.ts</files>
  <action>
Create `src/lib/assistant/fastapi-client.ts` with a typed fetch wrapper for the FastAPI `/chat` endpoint.

```typescript
import { fastApiResponseSchema, type FastApiResponse } from "@/lib/schemas/fastapi";

const CHATBOT_API_URL = process.env.CHATBOT_API_URL;

export class FastApiError extends Error {
  constructor(
    message: string,
    public status: number,
    public isTimeout: boolean = false,
  ) {
    super(message);
    this.name = "FastApiError";
  }
}

export async function askFastApi(question: string): Promise<FastApiResponse> {
  if (!CHATBOT_API_URL) {
    throw new FastApiError("CHATBOT_API_URL not configured", 503);
  }

  let res: Response;
  try {
    res = await fetch(`${CHATBOT_API_URL}/chat`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question }),
      signal: AbortSignal.timeout(15_000),
    });
  } catch (err) {
    const isTimeout = err instanceof DOMException && err.name === "TimeoutError";
    throw new FastApiError(
      isTimeout ? "Request timed out" : "Network error",
      503,
      isTimeout,
    );
  }

  if (!res.ok) {
    throw new FastApiError(`FastAPI returned ${res.status}`, res.status);
  }

  const raw = await res.json();
  const parsed = fastApiResponseSchema.safeParse(raw);
  if (!parsed.success) {
    throw new FastApiError("Invalid response shape from FastAPI", 502);
  }

  return parsed.data;
}
```

Critical details:
- Uses `AbortSignal.timeout(15_000)` for 15-second timeout (NOT manual AbortController)
- Sends `{ question }` (NOT `{ messages: [...] }` -- verified from actual FastAPI schema)
- Validates response with `safeParse()` and throws `FastApiError` on validation failure
- `FastApiError` carries `status` (for HTTP mapping) and `isTimeout` (for user-facing messages)
- Reads `CHATBOT_API_URL` at module level (same pattern as existing env var usage in the project)
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors.
Run `npm run lint` -- passes.
Verify import resolution: `grep -r "from.*schemas/fastapi" src/lib/assistant/fastapi-client.ts` shows the import exists.
  </verify>
  <done>
`src/lib/assistant/fastapi-client.ts` exists, exports `askFastApi` function and `FastApiError` class. The function sends `{ question }` to `${CHATBOT_API_URL}/chat`, validates the response with Zod, and returns typed `FastApiResponse`. Errors are typed with status codes. All compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes -- both new files compile
2. `npm run lint` passes -- code follows project conventions
3. `npm run build` passes -- no build regressions
4. Both files exist in the expected locations
5. Import chain works: `fastapi-client.ts` imports from `schemas/fastapi.ts`
</verification>

<success_criteria>
- Two new files created with correct exports
- Zero new npm dependencies
- Build and lint pass with no errors
- Schema matches verified FastAPI contract (answer/citations/confidence)
</success_criteria>

<output>
After completion, create `.planning/phases/13-proxy-integration/13-01-SUMMARY.md`
</output>
