---
phase: 44-server-side-code-migration
plan: 03
type: execute
wave: 2
depends_on: ["44-01", "44-02"]
files_modified:
  - src/actions/tasks/workspace.ts
  - src/actions/tasks/project.ts
  - src/actions/tasks/section.ts
  - src/actions/tasks/task.ts
  - src/actions/tasks/tag.ts
  - src/lib/actions/tasks-test.ts
  - src/app/api/tasks-test/route.ts
autonomous: true
requirements: [MIG-02, RT-04]

must_haves:
  truths:
    - "Tasks server actions (workspace, project, section, task, tag CRUD) can be imported and called from the personal-brand app"
    - "All revalidatePath calls use the /apps/tasks prefix instead of /tasks"
    - "Server actions use verifyUser from @/lib/tasks/auth (shared Firebase Admin)"
    - "Server actions use checkBillingAccess and billingGuard from @/lib/tasks/billing (direct import)"
    - "The Phase 43 test endpoint (tasks-test.ts and api/tasks-test/route.ts) is removed"
  artifacts:
    - path: "src/actions/tasks/workspace.ts"
      provides: "Workspace CRUD server actions"
      exports: ["createWorkspaceAction", "updateWorkspaceAction", "deleteWorkspaceAction"]
      contains: "revalidatePath(\"/apps/tasks\")"
    - path: "src/actions/tasks/project.ts"
      provides: "Project CRUD server actions"
      exports: ["createProjectAction", "updateProjectAction", "updateProjectViewModeAction", "deleteProjectAction"]
      contains: "revalidatePath(\"/apps/tasks\")"
    - path: "src/actions/tasks/section.ts"
      provides: "Section CRUD server actions"
      exports: ["createSectionAction", "updateSectionAction", "deleteSectionAction"]
      contains: "revalidatePath(\"/apps/tasks\")"
    - path: "src/actions/tasks/task.ts"
      provides: "Task CRUD server actions"
      exports: ["createTaskAction", "updateTaskAction", "deleteTaskAction", "toggleTaskAction", "assignTaskToSectionAction"]
      contains: "revalidatePath(\"/apps/tasks\")"
    - path: "src/actions/tasks/tag.ts"
      provides: "Tag CRUD server actions"
      exports: ["createTagAction", "updateTagAction", "deleteTagAction"]
      contains: "revalidatePath(\"/apps/tasks\")"
  key_links:
    - from: "src/actions/tasks/workspace.ts"
      to: "src/lib/tasks/auth.ts"
      via: "import { verifyUser }"
      pattern: "import.*verifyUser.*from.*@/lib/tasks/auth"
    - from: "src/actions/tasks/workspace.ts"
      to: "src/lib/tasks/billing.ts"
      via: "import { billingGuard, checkBillingAccess }"
      pattern: "import.*billingGuard.*checkBillingAccess.*from.*@/lib/tasks/billing"
    - from: "src/actions/tasks/workspace.ts"
      to: "src/lib/schemas/tasks/workspace.ts"
      via: "import schemas"
      pattern: "import.*from.*@/lib/schemas/tasks/workspace"
    - from: "src/actions/tasks/workspace.ts"
      to: "src/services/tasks/workspace.service.ts"
      via: "import service functions"
      pattern: "import.*from.*@/services/tasks/workspace.service"
---

<objective>
Copy and adapt the 5 Tasks server action files from the standalone todoist app, updating all import paths and revalidatePath calls. Also remove the Phase 43 temporary test endpoint.

Purpose: Provides the complete server action layer that UI components (Phase 45) will call for all Tasks CRUD operations. Actions wire together auth, billing, validation, and service layers.
Output: 5 server action files in `src/actions/tasks/`, 2 files deleted (test endpoint cleanup)
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-server-side-code-migration/44-01-SUMMARY.md
@.planning/phases/44-server-side-code-migration/44-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Copy and adapt all 5 server action files with updated imports and path prefix</name>
  <files>
    src/actions/tasks/workspace.ts
    src/actions/tasks/project.ts
    src/actions/tasks/section.ts
    src/actions/tasks/task.ts
    src/actions/tasks/tag.ts
  </files>
  <action>
Create directory `src/actions/tasks/` and copy the 5 server action files from `/Users/dweinbeck/ai/todoist/src/actions/`. Each file needs THREE categories of import path changes plus ONE revalidatePath change:

**Import changes (apply to ALL 5 files):**
1. Auth: `import { verifyUser } from "@/lib/auth"` -> `import { verifyUser } from "@/lib/tasks/auth"`
2. Billing: `import { billingGuard, checkBillingAccess } from "@/lib/billing"` -> `import { billingGuard, checkBillingAccess } from "@/lib/tasks/billing"`
3. Schemas: `from "@/lib/schemas/..."` -> `from "@/lib/schemas/tasks/..."` (add `tasks/` prefix)
4. Services: `from "@/services/..."` -> `from "@/services/tasks/..."` (add `tasks/` prefix)

**revalidatePath changes (apply to ALL 5 files):**
- `revalidatePath("/tasks")` -> `revalidatePath("/apps/tasks")`
- `revalidatePath(\`/tasks/${projectId}\`)` -> `revalidatePath(\`/apps/tasks/${projectId}\`)` (only in project.ts, updateProjectViewModeAction)

**Per-file specifics:**

**workspace.ts** (3 actions: create, update, delete):
- Imports: verifyUser from `@/lib/tasks/auth`, billing from `@/lib/tasks/billing`, schemas from `@/lib/schemas/tasks/workspace`, services from `@/services/tasks/workspace.service`
- All 3 `revalidatePath("/tasks")` -> `revalidatePath("/apps/tasks")`
- Function signatures and bodies unchanged

**project.ts** (4 actions: create, update, updateViewMode, delete):
- Imports: same pattern as workspace
- `revalidatePath("/tasks")` -> `revalidatePath("/apps/tasks")` (3 occurrences)
- `revalidatePath(\`/tasks/${projectId}\`)` -> `revalidatePath(\`/apps/tasks/${projectId}\`)` (1 occurrence in updateProjectViewModeAction)
- Function signatures and bodies unchanged

**section.ts** (3 actions: create, update, delete):
- Imports: schemas from `@/lib/schemas/tasks/section`, services from `@/services/tasks/section.service`
- All 3 `revalidatePath("/tasks")` -> `revalidatePath("/apps/tasks")`
- Function signatures and bodies unchanged

**task.ts** (5 actions: create, update, delete, toggle, assignToSection):
- Imports: schemas from `@/lib/schemas/tasks/task`, services from `@/services/tasks/task.service`
- All 5 `revalidatePath("/tasks")` -> `revalidatePath("/apps/tasks")`
- Function signatures and bodies unchanged

**tag.ts** (3 actions: create, update, delete):
- Imports: schemas from `@/lib/schemas/tasks/tag`, services from `@/services/tasks/tag.service`
- All 3 `revalidatePath("/tasks")` -> `revalidatePath("/apps/tasks")`
- Function signatures and bodies unchanged

IMPORTANT:
- Every file must start with `"use server";`
- Do NOT modify any function body logic (validation, try/catch, return values)
- Do NOT change function signatures
- Verify ZERO occurrences of `revalidatePath("/tasks")` (without /apps prefix) remain across all 5 files
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Then verify path prefix:
- `grep -r 'revalidatePath("/tasks")' src/actions/tasks/` should return ZERO results
- `grep -r 'revalidatePath("/apps/tasks")' src/actions/tasks/` should return results in all 5 files
- `grep -r '@/lib/auth"' src/actions/tasks/` should return ZERO results (must use @/lib/tasks/auth)
- `grep -r '@/lib/billing"' src/actions/tasks/` should return ZERO results (must use @/lib/tasks/billing)
  </verify>
  <done>All 5 server action files exist in src/actions/tasks/ with "use server" directive, updated import paths pointing to personal-brand modules, and all revalidatePath calls using /apps/tasks prefix. 18 total actions across the 5 files.</done>
</task>

<task type="auto">
  <name>Task 2: Remove Phase 43 temporary test endpoint</name>
  <files>
    src/lib/actions/tasks-test.ts
    src/app/api/tasks-test/route.ts
  </files>
  <action>
Delete the 2 temporary test files created in Phase 43 that are no longer needed now that real server actions exist:

1. Delete `src/lib/actions/tasks-test.ts` (the getTestWorkspaces server action)
2. Delete `src/app/api/tasks-test/route.ts` (the GET endpoint)

Then verify no other files import from these paths:
- Search for `tasks-test` across the codebase to confirm no dangling references

Per the Phase 43-03 decision: "Temporary test endpoint /api/tasks-test with no auth (will be removed in Phase 44)".
  </action>
  <verify>
Confirm both files are deleted. Run `grep -r "tasks-test" src/` to verify no remaining references. Run `npx tsc --noEmit` to confirm no broken imports.
  </verify>
  <done>Phase 43 test endpoint fully removed. No dangling imports or references remain.</done>
</task>

<task type="auto">
  <name>Task 3: Run full quality gates</name>
  <files></files>
  <action>
Run the complete quality gate sequence to verify the entire Phase 44 migration builds and passes:

1. `npm run lint` -- fix any lint errors in new files
2. `npm run build` -- full Next.js build including type checking
3. `npm test` -- run test suite to confirm nothing is broken

If lint or build errors arise in the new files, fix them (likely Biome formatting issues). Do NOT modify function logic to fix lint -- only formatting/style adjustments.
  </action>
  <verify>`npm run lint && npm run build && npm test` all pass with zero errors.</verify>
  <done>Full codebase builds, lints clean, and tests pass with all 12 new files (5 schemas, 5 services, 2 adapters) plus 5 server actions integrated and 2 test files removed.</done>
</task>

</tasks>

<verification>
1. `npm run lint && npm run build && npm test` all pass
2. 5 server action files in src/actions/tasks/ with "use server" directive
3. All actions import verifyUser from `@/lib/tasks/auth` (NOT `@/lib/auth`)
4. All actions import billing from `@/lib/tasks/billing` (NOT `@/lib/billing`)
5. All schemas imported from `@/lib/schemas/tasks/...` path
6. All services imported from `@/services/tasks/...` path
7. ZERO occurrences of `revalidatePath("/tasks")` without /apps prefix in src/actions/tasks/
8. Phase 43 test endpoint files deleted with no dangling references
9. `grep -r "BILLING_API_URL" src/actions/ src/lib/tasks/ src/services/tasks/` returns nothing
</verification>

<success_criteria>
- All 18 Tasks server actions (workspace: 3, project: 4, section: 3, task: 5, tag: 3) can be imported from src/actions/tasks/
- revalidatePath uses /apps/tasks prefix consistently
- Auth uses shared Firebase Admin SDK via @/lib/tasks/auth
- Billing uses direct function import via @/lib/tasks/billing
- Phase 43 test endpoint removed
- Full quality gates pass
</success_criteria>

<output>
After completion, create `.planning/phases/44-server-side-code-migration/44-03-SUMMARY.md`
</output>
