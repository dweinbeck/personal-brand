---
phase: 02-fix-brand-scraper-asset-downloads-color-accuracy-color-labels-and-company-name-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/brand-scraper/client.ts
  - src/app/api/tools/brand-scraper/jobs/[id]/assets/zip/route.ts
autonomous: true
requirements:
  - ASSET-DOWNLOAD
must_haves:
  truths:
    - "ZIP download proxy sends GCP identity token to scraper service"
    - "ZIP download returns binary ZIP data on success instead of 403"
    - "ZIP download shows clear user-friendly error message if backend still fails"
  artifacts:
    - path: "src/lib/brand-scraper/client.ts"
      provides: "Exported getIdentityToken function for reuse"
      exports: ["getIdentityToken"]
    - path: "src/app/api/tools/brand-scraper/jobs/[id]/assets/zip/route.ts"
      provides: "ZIP proxy with auth header forwarding"
      contains: "getIdentityToken"
  key_links:
    - from: "src/app/api/tools/brand-scraper/jobs/[id]/assets/zip/route.ts"
      to: "src/lib/brand-scraper/client.ts"
      via: "import getIdentityToken"
      pattern: "import.*getIdentityToken.*from.*client"
---

<objective>
Fix ZIP asset downloads by adding GCP identity token authentication to the ZIP proxy route.

Purpose: The ZIP download proxy returns 403 because it does not forward a GCP identity token to the brand scraper backend service. All other scraper API calls (submitScrapeJob, getScrapeJobStatus) use getIdentityToken — the ZIP route is the only one missing it. This is the root cause of the "I still can't download the assets" bug.

Output: ZIP proxy route with proper auth headers, exported getIdentityToken for reuse.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/brand-scraper/client.ts
@src/app/api/tools/brand-scraper/jobs/[id]/assets/zip/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Export getIdentityToken and add auth to ZIP proxy route</name>
  <files>
    src/lib/brand-scraper/client.ts
    src/app/api/tools/brand-scraper/jobs/[id]/assets/zip/route.ts
  </files>
  <action>
    In `src/lib/brand-scraper/client.ts`:
    - Change `async function getIdentityToken` to `export async function getIdentityToken` (add `export` keyword)
    - This is the ONLY change to client.ts — do not modify anything else

    In `src/app/api/tools/brand-scraper/jobs/[id]/assets/zip/route.ts`:
    - Add import: `import { getIdentityToken } from "@/lib/brand-scraper/client";`
    - Remove the top-level `const BRAND_SCRAPER_API_URL = process.env.BRAND_SCRAPER_API_URL;` and instead read it from `process.env` inside the handler (or import from serverEnv — match the pattern in client.ts which uses `serverEnv().BRAND_SCRAPER_API_URL`)
    - Before the `fetch()` call to the scraper service (Step 1: zip creation), add auth headers:
      ```
      const headers: Record<string, string> = {};
      const idToken = await getIdentityToken(BRAND_SCRAPER_API_URL);
      if (idToken) {
        headers.Authorization = `Bearer ${idToken}`;
      }
      ```
    - Pass `headers` to the fetch call for zip creation (the POST to `${BRAND_SCRAPER_API_URL}/jobs/${id}/assets/zip`)
    - Keep the existing error handling, streaming, and Content-Disposition logic unchanged
    - Do NOT add auth headers to the Step 2 fetch (fetching from the GCS signed URL) — that URL has its own auth baked in
  </action>
  <verify>
    - `npm run lint` passes
    - `npm run build` passes (confirms import/export types resolve)
    - `npm test` passes
    - Grep confirms: `getIdentityToken` is exported from client.ts and imported in zip/route.ts
    - Grep confirms: Authorization header is set before the scraper service fetch
  </verify>
  <done>
    ZIP proxy route sends GCP identity token in Authorization header when calling the scraper backend for zip creation. The getIdentityToken function is exported from client.ts for reuse. The GCS signed URL fetch remains unchanged (no auth header needed). Build passes clean.
  </done>
</task>

</tasks>

<verification>
- `npm run lint && npm run build && npm test` — all pass
- `grep -r "export async function getIdentityToken" src/lib/brand-scraper/client.ts` returns a match
- `grep -r "getIdentityToken" src/app/api/tools/brand-scraper/jobs/*/assets/zip/route.ts` returns a match
- `grep -r "Authorization" src/app/api/tools/brand-scraper/jobs/*/assets/zip/route.ts` returns a match
</verification>

<success_criteria>
The ZIP proxy route authenticates with the scraper backend using the same GCP identity token pattern as all other scraper API calls. The fix is minimal and surgical — only the auth gap is addressed.
</success_criteria>

<output>
After completion, create `.planning/phases/02-fix-brand-scraper-asset-downloads-color-accuracy-color-labels-and-company-name-extraction/02-01-SUMMARY.md`
</output>
