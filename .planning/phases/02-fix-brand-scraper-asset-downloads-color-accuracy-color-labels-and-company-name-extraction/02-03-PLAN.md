---
phase: 02-fix-brand-scraper-asset-downloads-color-accuracy-color-labels-and-company-name-extraction
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/brand-scraper/types.ts
  - src/lib/brand-scraper/display-name.ts
  - src/components/tools/brand-scraper/BrandCard.tsx
  - src/components/tools/brand-scraper/BrandCardHeader.tsx
  - src/components/tools/brand-scraper/BrandProfileCard.tsx
autonomous: true
requirements:
  - COMPANY-NAME
must_haves:
  truths:
    - "Brand card header shows company name instead of raw hostname when available"
    - "Profile card shows company name instead of raw hostname when available"
    - "When no company name is available, a cleaned-up hostname is shown (title-cased, TLD stripped)"
    - "Existing brands without company_name data still render correctly"
  artifacts:
    - path: "src/lib/brand-scraper/types.ts"
      provides: "Extended identity schema with optional company_name and site_name fields"
      contains: "company_name"
    - path: "src/lib/brand-scraper/display-name.ts"
      provides: "getBrandDisplayName utility with fallback chain"
      exports: ["getBrandDisplayName"]
      min_lines: 15
    - path: "src/components/tools/brand-scraper/BrandCardHeader.tsx"
      provides: "Header showing display name instead of hostname"
      contains: "displayName"
    - path: "src/components/tools/brand-scraper/BrandProfileCard.tsx"
      provides: "Profile card showing display name"
      contains: "getBrandDisplayName"
  key_links:
    - from: "src/components/tools/brand-scraper/BrandCard.tsx"
      to: "src/lib/brand-scraper/display-name.ts"
      via: "import getBrandDisplayName"
      pattern: "import.*getBrandDisplayName.*from.*display-name"
    - from: "src/components/tools/brand-scraper/BrandProfileCard.tsx"
      to: "src/lib/brand-scraper/display-name.ts"
      via: "import getBrandDisplayName"
      pattern: "import.*getBrandDisplayName.*from.*display-name"
    - from: "src/components/tools/brand-scraper/BrandCard.tsx"
      to: "src/components/tools/brand-scraper/BrandCardHeader.tsx"
      via: "displayName prop"
      pattern: "displayName"
---

<objective>
Show company names instead of raw hostnames in brand card headers and profile cards.

Purpose: The UI currently shows hostnames like "3m.com" and "transparent.partners" instead of proper company names. The user expects "3M" and "Transparent Partners". This plan extends the taxonomy schema to accept company name fields from the scraper (when available) and implements a fallback chain: explicit company_name > site_name > cleaned hostname. Even without backend scraper changes, the cleaned hostname provides a better experience than the raw one.

Output: Schema extension, display name utility, updated brand card header and profile card.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/brand-scraper/types.ts
@src/components/tools/brand-scraper/BrandCard.tsx
@src/components/tools/brand-scraper/BrandCardHeader.tsx
@src/components/tools/brand-scraper/BrandProfileCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend taxonomy schema and create display name utility</name>
  <files>
    src/lib/brand-scraper/types.ts
    src/lib/brand-scraper/display-name.ts
  </files>
  <action>
    **types.ts — Extend identity schema:**
    In the `brandTaxonomySchema`, find the `identity` field's `.object({...})` and add two optional fields:
    ```
    identity: z
      .object({
        tagline: z.string().optional(),
        industry_guess: z.string().optional(),
        company_name: z.string().optional(),  // NEW: extracted company/brand name
        site_name: z.string().optional(),     // NEW: raw og:site_name value
      })
      .passthrough()
      .optional(),
    ```
    CRITICAL: Both fields MUST be `.optional()` — existing stored jobs do not have these fields. The `.passthrough()` already handles unknown fields, but being explicit in the schema makes the types available to consumers.

    **display-name.ts — Create display name utility:**
    Create `src/lib/brand-scraper/display-name.ts`:
    ```typescript
    import type { BrandTaxonomy } from "./types";

    /**
     * Extract a human-friendly display name from brand taxonomy data.
     * Fallback chain: company_name > site_name > cleaned hostname.
     */
    export function getBrandDisplayName(
      identity: BrandTaxonomy["identity"],
      siteUrl: string,
    ): string {
      if (identity?.company_name) return identity.company_name;
      if (identity?.site_name) return identity.site_name;
      return formatHostname(siteUrl);
    }

    /**
     * Convert a URL to a clean display name.
     * - Strips protocol, www. prefix, and TLD
     * - Title-cases the result
     * - Handles edge cases: "3m.com" -> "3m", "transparent.partners" -> "Transparent Partners"
     */
    function formatHostname(urlStr: string): string {
      try {
        const hostname = new URL(urlStr).hostname.replace(/^www\./, "");
        // Split on dots - domain could be "transparent.partners" (2 parts) or "3m.com" (2 parts)
        const parts = hostname.split(".");
        // Common TLDs to strip
        const commonTLDs = new Set(["com", "org", "net", "io", "co", "dev", "app", "ai"]);
        // If last part is a common TLD, use only the name part(s) before it
        // If not (e.g., "partners"), keep all parts as they form the brand name
        let nameParts: string[];
        if (parts.length >= 2 && commonTLDs.has(parts[parts.length - 1])) {
          nameParts = parts.slice(0, -1);
        } else if (parts.length >= 3 && commonTLDs.has(parts[parts.length - 1])) {
          // e.g., "brand.co.uk" -> ["brand"]
          nameParts = parts.slice(0, -2);
        } else {
          // Non-standard TLD like "transparent.partners" -> use all parts
          nameParts = parts;
        }
        // Title-case each part: "transparent" -> "Transparent", but keep all-caps like "3m" -> "3m"
        return nameParts
          .map((p) => (p.length <= 3 ? p : p.charAt(0).toUpperCase() + p.slice(1)))
          .join(" ");
      } catch {
        return urlStr;
      }
    }
    ```

    Design notes:
    - Short names (<=3 chars like "3m", "ibm") are NOT title-cased to avoid "3M" -> "3m" confusion (the original case is already lowercase from the URL, and forced capitalization may be wrong)
    - Multi-part domains like "transparent.partners" keep all parts since the TLD is part of the brand identity
    - The function is pure with no side effects — easy to test
  </action>
  <verify>
    - `npm run build` passes (type changes compile cleanly, no existing code breaks)
    - `npm run lint` passes
    - File exists: `src/lib/brand-scraper/display-name.ts`
    - Grep confirms `company_name` and `site_name` are in the identity schema in types.ts
    - Grep confirms `getBrandDisplayName` is exported from display-name.ts
  </verify>
  <done>
    The `brandTaxonomySchema.identity` accepts optional `company_name` and `site_name` fields. A `getBrandDisplayName()` utility exists with a fallback chain from explicit name to cleaned hostname. All existing data continues to parse correctly (new fields are optional).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update BrandCard, BrandCardHeader, and BrandProfileCard to show company name</name>
  <files>
    src/components/tools/brand-scraper/BrandCard.tsx
    src/components/tools/brand-scraper/BrandCardHeader.tsx
    src/components/tools/brand-scraper/BrandProfileCard.tsx
  </files>
  <action>
    **BrandCardHeader.tsx:**
    1. Add a new `displayName` prop alongside `hostname`:
       ```typescript
       type BrandCardHeaderProps = {
         favicon?: string;
         hostname: string;
         displayName?: string;
       };
       ```
    2. In the rendered tab text, show `displayName` if available, falling back to `hostname`:
       ```
       <span className="text-sm text-text-secondary truncate">
         {displayName ?? hostname}
       </span>
       ```

    **BrandCard.tsx:**
    1. Add import: `import { getBrandDisplayName } from "@/lib/brand-scraper/display-name";`
    2. After computing `hostname`, compute the display name:
       ```typescript
       const displayName = getBrandDisplayName(result.identity, result.source.site_url);
       ```
    3. Pass `displayName` to BrandCardHeader:
       ```
       <BrandCardHeader favicon={favicon} hostname={hostname} displayName={displayName} />
       ```

    **BrandProfileCard.tsx:**
    1. Add import: `import { getBrandDisplayName } from "@/lib/brand-scraper/display-name";`
    2. After computing `hostname` and `result`, compute the display name from the loaded job data:
       ```typescript
       const displayName = result
         ? getBrandDisplayName(result.identity, siteUrl)
         : formatHostname(siteUrl);
       ```
       Wait — `formatHostname` is not exported. Instead, just use `getBrandDisplayName(undefined, siteUrl)` which falls through to the hostname formatting:
       ```typescript
       const displayName = getBrandDisplayName(
         result?.identity,
         siteUrl,
       );
       ```
    3. Replace the hostname display (`<p>` tag showing `{hostname}`) with `{displayName}`:
       ```
       <p className="text-sm font-semibold text-text-primary truncate mb-2">
         {displayName}
       </p>
       ```
    4. Also update the logo alt text from `${hostname} logo` to `${displayName} logo`
    5. Also update the fallback letter (first char) to use `displayName.charAt(0).toUpperCase()` instead of `hostname.charAt(0).toUpperCase()`
  </action>
  <verify>
    - `npm run lint` passes
    - `npm run build` passes
    - `npm test` passes
    - BrandCardHeader.tsx has `displayName` prop
    - BrandCard.tsx imports and uses `getBrandDisplayName`
    - BrandProfileCard.tsx imports and uses `getBrandDisplayName`
    - No references to bare `hostname` remain as the primary display text in card titles
  </verify>
  <done>
    Brand card headers and profile cards show company names (when available from scraper) or cleaned-up hostnames (title-cased, TLD stripped) instead of raw hostnames. The display name fallback chain works: company_name > site_name > formatted hostname. All existing brands without company name data render with improved hostname formatting.
  </done>
</task>

</tasks>

<verification>
- `npm run lint && npm run build && npm test` — all pass
- `grep "company_name" src/lib/brand-scraper/types.ts` returns match in identity schema
- `grep "getBrandDisplayName" src/components/tools/brand-scraper/BrandCard.tsx` returns match
- `grep "getBrandDisplayName" src/components/tools/brand-scraper/BrandProfileCard.tsx` returns match
- `grep "displayName" src/components/tools/brand-scraper/BrandCardHeader.tsx` returns match
</verification>

<success_criteria>
Brand cards and profile cards show human-friendly company names instead of raw hostnames. The schema is ready to accept company_name data from the scraper when it's updated. Even without backend changes, the hostname formatting provides a meaningful improvement.
</success_criteria>

<output>
After completion, create `.planning/phases/02-fix-brand-scraper-asset-downloads-color-accuracy-color-labels-and-company-name-extraction/02-03-SUMMARY.md`
</output>
