---
phase: 06-infrastructure-and-deploy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dockerfile
  - .dockerignore
  - next.config.ts
  - src/lib/firebase.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Docker image builds successfully with Next.js standalone output"
    - "Docker image is under 150MB"
    - "Container runs as non-root user (nextjs:nodejs)"
    - "firebase-admin uses ADC on Cloud Run and cert() locally"
    - "Local development still works with explicit env vars"
  artifacts:
    - path: "Dockerfile"
      provides: "Multi-stage build (deps -> builder -> runner) on node:20-alpine"
      contains: "USER nextjs"
    - path: ".dockerignore"
      provides: "Excludes .git, node_modules, .next, .env*, .planning from build context"
    - path: "next.config.ts"
      provides: "Standalone output mode for Docker deployment"
      contains: "output.*standalone"
    - path: "src/lib/firebase.ts"
      provides: "Dual-mode credential init (ADC on Cloud Run, cert() locally)"
      contains: "K_SERVICE"
  key_links:
    - from: "next.config.ts"
      to: ".next/standalone"
      via: "output: standalone produces standalone server.js"
      pattern: "output.*standalone"
    - from: "Dockerfile"
      to: ".next/standalone"
      via: "COPY standalone output to runner stage"
      pattern: "COPY.*standalone"
    - from: "src/lib/firebase.ts"
      to: "firebase-admin/app"
      via: "applicationDefault() when K_SERVICE is set"
      pattern: "applicationDefault"
---

<objective>
Create all Docker and configuration files needed for a production-ready Next.js standalone build on GCP Cloud Run.

Purpose: This plan produces every file needed to build a sub-150MB Docker image that runs securely as a non-root user, with firebase-admin using Application Default Credentials on Cloud Run.
Output: Dockerfile, .dockerignore, updated next.config.ts with standalone output, refactored firebase.ts with dual-mode credentials, and verified Docker image build.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-infrastructure-and-deploy/06-RESEARCH.md
@next.config.ts
@src/lib/firebase.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Standalone config, firebase.ts ADC refactor, and sharp dependency</name>
  <files>next.config.ts, src/lib/firebase.ts, package.json</files>
  <action>
    1. **next.config.ts** -- Add `output: "standalone"` to the nextConfig object. Keep all existing config (pageExtensions, images, MDX wrapper) unchanged. Place `output` as the first property for visibility.

    2. **src/lib/firebase.ts** -- Refactor to dual-mode credential initialization:
       - Import `applicationDefault` from "firebase-admin/app" (add to existing import, keep alphabetical per Biome)
       - Create a `getCredential()` function that:
         - If `process.env.K_SERVICE` is set (Cloud Run environment), return `applicationDefault()`
         - Otherwise, read `FIREBASE_PROJECT_ID`, `FIREBASE_CLIENT_EMAIL`, `FIREBASE_PRIVATE_KEY` from env vars
         - If all three exist, return `cert({ projectId, clientEmail, privateKey })` with the `\\n` replacement on privateKey
         - If none exist, fall back to `applicationDefault()` (works with `gcloud auth application-default login`)
       - Keep the existing `getApps().length > 0` guard
       - Keep `db` export and `saveContactSubmission` function unchanged
       - Update the warning message: instead of listing all three env vars, say "Firebase credentials not found. On Cloud Run, ADC is used automatically. For local dev, set FIREBASE_PROJECT_ID, FIREBASE_CLIENT_EMAIL, and FIREBASE_PRIVATE_KEY."
       - The warning should only trigger when NOT on Cloud Run (no K_SERVICE) AND the explicit env vars are missing

    3. **package.json** -- Add `sharp` to dependencies: `"sharp": "^0.34.3"`. This is required for `next/image` optimization in standalone mode on Alpine. Run `npm install` after adding.

    Run `biome check --write .` to fix any import ordering issues.
    Run `npm run build` to verify standalone output is produced.
  </action>
  <verify>
    - `npm run build` succeeds and produces `.next/standalone/server.js`
    - `ls .next/standalone/server.js` exists
    - `grep "standalone" next.config.ts` shows the output config
    - `grep "K_SERVICE" src/lib/firebase.ts` shows dual-mode detection
    - `grep "applicationDefault" src/lib/firebase.ts` shows ADC import and usage
    - `grep "sharp" package.json` shows sharp in dependencies
    - `npm list sharp` confirms sharp is installed successfully
    - `npx biome check .` passes with no errors
  </verify>
  <done>
    next.config.ts has `output: "standalone"`, firebase.ts uses ADC on Cloud Run and cert() locally, sharp is installed, and `npm run build` produces standalone output.
  </done>
</task>

<task type="auto">
  <name>Task 2: Dockerfile, .dockerignore, and image build verification</name>
  <files>Dockerfile, .dockerignore</files>
  <action>
    1. **Create `.dockerignore`** with these entries (one per line):
       ```
       .git
       .gitignore
       node_modules
       .next
       .env*
       !.env.local.example
       *.md
       .planning
       .DS_Store
       headshot.jpeg
       *.pem
       ```
       Note: `!.env.local.example` is negated so the example file is available if needed. `headshot.jpeg` at repo root is excluded (the actual site image is in `public/`).

    2. **Create `Dockerfile`** with three-stage multi-stage build:

       ```dockerfile
       # syntax=docker.io/docker/dockerfile:1

       FROM node:20-alpine AS base

       # --- Stage 1: Install dependencies ---
       FROM base AS deps
       RUN apk add --no-cache libc6-compat
       WORKDIR /app
       COPY package.json package-lock.json ./
       RUN npm ci

       # --- Stage 2: Build the application ---
       FROM base AS builder
       WORKDIR /app
       COPY --from=deps /app/node_modules ./node_modules
       COPY . .
       ENV NEXT_TELEMETRY_DISABLED=1
       RUN npm run build

       # --- Stage 3: Production runner ---
       FROM base AS runner
       WORKDIR /app

       ENV NODE_ENV=production
       ENV NEXT_TELEMETRY_DISABLED=1

       RUN addgroup --system --gid 1001 nodejs
       RUN adduser --system --uid 1001 nextjs

       COPY --from=builder /app/public ./public
       COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
       COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

       USER nextjs

       EXPOSE 3000
       ENV PORT=3000
       ENV HOSTNAME="0.0.0.0"

       CMD ["node", "server.js"]
       ```

       Key points:
       - Use `node:20-alpine` for all stages (smallest base)
       - `libc6-compat` in deps stage for native module compatibility (sharp)
       - `npm ci` (not `npm install`) for reproducible installs
       - Non-root user `nextjs:nodejs` (uid/gid 1001)
       - Copy `public/`, `.next/standalone/`, and `.next/static/` to runner
       - `HOSTNAME="0.0.0.0"` so Cloud Run can reach the server
       - `PORT=3000` matching Cloud Run `--port 3000` in deploy script

    3. **Build and verify the Docker image:**
       - Run `docker build -t personal-brand:latest .`
       - Run `docker images personal-brand:latest --format "{{.Size}}"` and verify under 150MB
       - Run `docker run --rm -d -p 3000:3000 --name pb-test personal-brand:latest`
       - Run `curl -s -o /dev/null -w "%{http_code}" http://localhost:3000` and verify 200
       - Run `docker stop pb-test`
       - If image is over 150MB, investigate with `docker history personal-brand:latest` and report findings

    Note: The build stage does NOT need Firebase env vars -- firebase-admin is only used at runtime, and the build will succeed without credentials (the code handles missing vars gracefully).
  </action>
  <verify>
    - `docker build -t personal-brand:latest .` completes successfully
    - `docker images personal-brand:latest --format "{{.Size}}"` shows under 150MB
    - Container starts and responds with HTTP 200 on port 3000
    - `docker inspect personal-brand:latest --format '{{.Config.User}}'` shows "nextjs" (non-root)
  </verify>
  <done>
    Docker image builds successfully, is under 150MB, runs as non-root user, and serves the site on port 3000.
  </done>
</task>

</tasks>

<verification>
- `npm run build` produces `.next/standalone/server.js`
- Docker image builds and is under 150MB
- Container starts, listens on 0.0.0.0:3000, and returns HTTP 200
- Container runs as non-root user (nextjs)
- firebase.ts detects K_SERVICE for ADC vs cert() fallback
- `npx biome check .` passes
</verification>

<success_criteria>
1. Dockerfile exists with three-stage build (deps, builder, runner) on node:20-alpine
2. .dockerignore excludes .git, node_modules, .next, .env*, .planning
3. next.config.ts includes `output: "standalone"`
4. firebase.ts uses applicationDefault() when K_SERVICE is set, cert() otherwise
5. sharp is in package.json dependencies
6. Docker image is under 150MB
7. Container runs as non-root user and responds on port 3000
</success_criteria>

<output>
After completion, create `.planning/phases/06-infrastructure-and-deploy/06-01-SUMMARY.md`
</output>
