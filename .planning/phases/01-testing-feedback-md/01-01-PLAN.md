---
phase: 01-testing-feedback-md
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/tools/brand-scraper/UserBrandScraperPage.tsx
  - src/components/tools/brand-scraper/BrandCardColors.tsx
  - src/components/tools/brand-scraper/BrandCardLogos.tsx
  - src/components/tools/brand-scraper/BrandCardDownloads.tsx
autonomous: true
requirements: []

must_haves:
  truths:
    - "Brand scraper page does NOT show dollar amounts next to credit balance or cost"
    - "Brand card only shows asset thumbnails for logos/favicons/OG images with valid, loadable URLs -- no blank rectangles"
    - "Color palette entries display their role label (e.g. 'secondary', 'primary') when the role field is present"
    - "Download Brand JSON button triggers a file download rather than opening in a new browser tab"
    - "Download Assets (zip) button either works or shows a meaningful error -- no silent 403 failure"
  artifacts:
    - path: "src/components/tools/brand-scraper/UserBrandScraperPage.tsx"
      provides: "Credits display without dollar amounts"
    - path: "src/components/tools/brand-scraper/BrandCardLogos.tsx"
      provides: "Filtered logo/favicon/OG image rendering -- no empty URL entries"
    - path: "src/components/tools/brand-scraper/BrandCardColors.tsx"
      provides: "Color swatch labels including role (primary/secondary/etc.)"
    - path: "src/components/tools/brand-scraper/BrandCardDownloads.tsx"
      provides: "Brand JSON download via fetch+blob, zip download with improved error handling"
  key_links:
    - from: "src/components/tools/brand-scraper/BrandCardDownloads.tsx"
      to: "GCS signed URL"
      via: "fetch+blob for brand JSON download"
      pattern: "fetch.*brand_json.*blob"
    - from: "src/components/tools/brand-scraper/BrandCardLogos.tsx"
      to: "BrandTaxonomy assets"
      via: "filter out entries with empty/missing URLs"
      pattern: "filter.*url"
---

<objective>
Fix all Brand Scraper testing feedback: remove dollar price display, fix blank asset rectangles, label secondary colors, and fix broken download buttons.

Purpose: Address 4 testing feedback items (3.1, 3.2, 3.3, 3.4) for the Brand Scraper area.
Output: Corrected Brand Scraper UI with working downloads and clean asset display.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/tools/brand-scraper/UserBrandScraperPage.tsx
@src/components/tools/brand-scraper/BrandCardColors.tsx
@src/components/tools/brand-scraper/BrandCardLogos.tsx
@src/components/tools/brand-scraper/BrandCardDownloads.tsx
@src/components/tools/brand-scraper/BrandCard.tsx
@src/components/tools/brand-scraper/AssetsPage.tsx
@src/components/ui/Button.tsx
@src/lib/brand-scraper/types.ts
@src/app/api/tools/brand-scraper/jobs/[id]/assets/zip/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix credits display and color labels</name>
  <files>
    src/components/tools/brand-scraper/UserBrandScraperPage.tsx
    src/components/tools/brand-scraper/BrandCardColors.tsx
  </files>
  <action>
**UserBrandScraperPage.tsx** -- Remove dollar amounts from credits display:
1. In the "Balance" / "Cost per profile" section (~line 219), remove the `($X.XX)` display. Change `Cost per profile: <strong>{creditCost} credits</strong> (${(creditCost / 100).toFixed(2)})` to just `Cost per profile: <strong>{creditCost} credits</strong>`. Only show credits, never dollars.
2. Scan the rest of the file for any other dollar display and remove those too.

**BrandCardColors.tsx** -- Ensure all color roles are labeled:
1. The component already renders `entry.value.role` when present (~line 63). Verify that the role field (which contains values like "primary", "secondary", "accent") is being displayed for ALL palette entries.
2. The current code shows role below the hex value in a small `text-[10px]` span. This is correct -- just verify it works for "secondary" and other roles. No code change needed if the role rendering path already handles it (it does -- the schema has `role: z.string().optional()` and the component renders it when truthy).

Actually reading the code again -- the existing BrandCardColors.tsx already renders the role label when present. The user's feedback says "label the secondary color too" which suggests secondary colors don't have a `role` field in the API response, OR the role IS present but the label is too small/invisible. Since the `role` field is optional in the schema, some colors may not have it set. The fix should ensure that even if `role` isn't set by the API, colors are at least numbered or labeled by position (e.g., "Color 1", "Color 2") to make identification easier. But to be minimal and respect the feedback literally -- just make sure the existing role label is clearly visible. Increase the role label from `text-[10px]` to `text-xs` and use a slightly more visible color like `text-text-secondary` instead of `text-text-tertiary`.
  </action>
  <verify>
Run `npm run lint && npm run build` to verify no errors. Visually inspect that the credits display has no dollar amounts and color labels are visible.
  </verify>
  <done>
Credit display shows only "X credits" with no dollar amount. Color palette entries show their role label clearly when the role field is present.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix blank asset rectangles and broken downloads</name>
  <files>
    src/components/tools/brand-scraper/BrandCardLogos.tsx
    src/components/tools/brand-scraper/BrandCardDownloads.tsx
  </files>
  <action>
**BrandCardLogos.tsx** -- Fix blank asset rectangles:
1. The component filters logos/favicons/ogImages with `.filter((e) => e.value.url?.trim())` at lines 68-70. This should already filter out empty URLs. However, the user reports 11 blank rectangles after 2 logos for transparent.partners. The issue is likely that the `logos` array from the API contains entries with URLs that point to broken/invalid images. The current `AssetImage` component handles `onError` by showing a fallback broken-image icon -- but the user describes "blank rectangles" which suggests images that don't trigger `onerror` but render as empty (e.g., 1x1 transparent pixels or CSS background images with no src).
2. The real fix: The API is returning logo entries with URLs that either don't load or render as invisible. Since we can't control what the API returns, add client-side filtering PLUS better empty-state handling:
   - Keep the existing URL filter
   - In the `AssetImage` component, add an `onLoad` handler that checks if the natural width/height is suspiciously small (e.g., <= 1px) and treats those as failed too
   - This way, 1x1 tracking pixels or empty images get the broken-image placeholder instead of blank space
3. Additionally, if after filtering there are 0 visible assets in a section, hide that section header entirely (already handled by the `logos.length > 0` checks).

**BrandCardDownloads.tsx** -- Fix Download Brand JSON and Download Assets:
1. **Download Brand JSON** issue: The `brandJsonUrl` is a GCS signed URL (starts with `https://storage.googleapis.com/...`). The Button component renders it as `<a href={url} target="_blank" download="brand.json">`. The `download` attribute is ignored for cross-origin URLs, so the browser opens it in a new tab instead of downloading. Fix: Replace the Button link approach with an onClick handler that fetches the JSON via `fetch()`, creates a Blob, and triggers a download via `URL.createObjectURL()`. This works for cross-origin resources.
2. **Download Assets (zip)** 403 error: The zip endpoint proxies to the backend brand scraper service. A 403 suggests the backend is rejecting the request -- this could be a CORS issue or the backend service not being configured to accept requests from the Next.js server. The frontend code looks correct (it passes the auth token). The proxy route at `src/app/api/tools/brand-scraper/jobs/[id]/assets/zip/route.ts` does NOT forward the auth token to the backend -- it just proxies without auth headers. If the backend requires auth or has IP restrictions, this would 403. **Fix:** Add a forwarding header or API key to the proxy request if one exists. However, since we can't change the backend service, the error message should at least be more helpful. Update the error handling to suggest the user try the JSON download as a fallback. Also ensure the proxy passes along any needed headers.

For the Brand JSON download specifically:
```typescript
const handleJsonDownload = useCallback(async () => {
  if (!brandJsonUrl) return;
  try {
    const res = await fetch(brandJsonUrl);
    if (!res.ok) throw new Error("Download failed");
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "brand.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch {
    // Fallback: open in new tab if fetch fails (CORS)
    window.open(brandJsonUrl, "_blank");
  }
}, [brandJsonUrl]);
```

Replace the Button with `href={brandJsonUrl}` with a Button using `onClick={handleJsonDownload}`.
  </action>
  <verify>
Run `npm run lint && npm run build` to verify no errors. Test that:
1. AssetImage shows broken-image placeholder for tiny/empty images
2. Brand JSON download triggers a file save dialog (or at worst opens in new tab as fallback)
3. Zip download error message is clear and suggests JSON alternative
  </verify>
  <done>
No blank asset rectangles for logos with broken/tiny images. Brand JSON downloads as a file. Zip download errors display helpful message with JSON fallback suggestion.
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with zero errors
2. `npm run build` succeeds
3. `npm test` passes
4. No dollar amounts visible in brand scraper credits display
5. Color palette shows role labels clearly
6. Blank asset rectangles are eliminated (broken/tiny images show placeholder)
7. Brand JSON download triggers file save, not new tab
</verification>

<success_criteria>
All 4 Brand Scraper feedback items addressed: no dollar pricing display, no blank rectangles, secondary color labeled, download buttons functional.
</success_criteria>

<output>
After completion, create `.planning/phases/01-testing-feedback-md/01-01-SUMMARY.md`
</output>
