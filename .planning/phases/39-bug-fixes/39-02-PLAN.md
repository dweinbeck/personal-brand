---
phase: 39-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - firestore.indexes.json
  - src/app/api/assistant/chat/route.ts
  - src/lib/assistant/fastapi-client.ts
autonomous: true

must_haves:
  truths:
    - "The research assistant conversation history endpoint loads past conversations without Firestore index errors"
    - "The AI assistant chat route returns graceful error messages with actionable context when the external service is unavailable"
    - "Firestore composite index for research_conversations covers the userId + status + updatedAt query"
  artifacts:
    - path: "firestore.indexes.json"
      provides: "Composite index for research_conversations collection"
      contains: "research_conversations"
    - path: "src/app/api/assistant/chat/route.ts"
      provides: "Improved error messages for assistant chat failures"
      contains: "error"
    - path: "src/lib/assistant/fastapi-client.ts"
      provides: "Better error context in FastApiError messages"
      contains: "FastApiError"
  key_links:
    - from: "src/lib/research-assistant/conversation-store.ts"
      to: "firestore.indexes.json"
      via: "Firestore compound query requires matching composite index"
      pattern: "research_conversations"
---

<objective>
Fix external service integration bugs: (1) Add missing Firestore composite index that causes research assistant conversation history to fail (BUG-05), (2) improve AI assistant error handling to surface actionable messages instead of generic errors (BUG-03), and (3) document what requires work in external repos for BUG-03 and BUG-04.

Purpose: Research assistant conversation history will load correctly once the Firestore index is deployed. The AI assistant will provide clearer error messages when the chatbot-assistant backend is misconfigured. External service issues are documented for follow-up in their respective repos.

Output: Updated firestore.indexes.json, improved assistant error handling, and diagnostic notes for external service fixes.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@firestore.indexes.json
@src/lib/research-assistant/conversation-store.ts
@src/app/api/assistant/chat/route.ts
@src/lib/assistant/fastapi-client.ts
@src/app/api/tools/research-assistant/chat/route.ts
@src/app/api/tools/research-assistant/conversations/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add missing Firestore composite index for research_conversations and scrape_history</name>
  <files>firestore.indexes.json</files>
  <action>
The `listConversations` function in `src/lib/research-assistant/conversation-store.ts` (line 134-140) runs:
```
db.collection("research_conversations")
  .where("userId", "==", uid)
  .where("status", "==", "active")
  .orderBy("updatedAt", "desc")
  .limit(limit)
```

This compound query with two `where` clauses and an `orderBy` on a different field REQUIRES a Firestore composite index. Without it, the query throws a Firestore error, which is the root cause of BUG-05 (conversation history returning errors).

Similarly, `getUserHistory` in `src/lib/brand-scraper/history.ts` (line 88-92) runs:
```
historyCol()
  .where("uid", "==", uid)
  .orderBy("createdAt", "desc")
  .limit(limit)
```

This also requires a composite index on (uid ASC, createdAt DESC).

Add the missing composite indexes to `firestore.indexes.json`:

1. For `research_conversations`: fields `userId` (ASC) + `status` (ASC) + `updatedAt` (DESC)
2. For `scrape_history`: fields `uid` (ASC) + `createdAt` (DESC)

The updated indexes array should include the existing 3 indexes plus these 2 new ones.

IMPORTANT: After updating the file, the user must deploy the indexes with:
```
firebase deploy --only firestore:indexes
```
This is a checkpoint-free task because the code change is just the JSON file. The actual deployment is noted in the summary but not gated.
  </action>
  <verify>Run `cat firestore.indexes.json | python3 -m json.tool` to verify valid JSON. Confirm the file contains 5 total index entries. Run `npm run build` to confirm no issues.</verify>
  <done>firestore.indexes.json contains composite indexes for research_conversations (userId+status+updatedAt) and scrape_history (uid+createdAt). Ready for `firebase deploy --only firestore:indexes`.</done>
</task>

<task type="auto">
  <name>Task 2: Improve AI assistant and research assistant error handling with actionable messages</name>
  <files>src/app/api/assistant/chat/route.ts, src/lib/assistant/fastapi-client.ts, src/app/api/tools/research-assistant/conversations/route.ts</files>
  <action>
BUG-03 (AI assistant RAG): The chatbot-assistant FastAPI service returns "no repos indexed" or similar errors when its knowledge base is not synced. The personal-brand proxy route currently maps these to generic "Something went wrong" messages. Improve error handling to surface more specific error messages.

BUG-04 (Research assistant chat errors): The research assistant chat route currently returns generic 500 errors. Improve the error response to include more diagnostic info.

BUG-05 (Research assistant conversations errors): The conversations route has minimal error handling. Add try/catch with specific error messages for Firestore failures.

**Step 1 -- Improve `src/lib/assistant/fastapi-client.ts`:**

In the `askFastApi` function, when a non-200 response is received (line 46-47), the current error message is just `FastAPI returned ${res.status}`. Attempt to extract a more specific error from the response body:

```typescript
if (!res.ok) {
  let detail = `FastAPI returned ${res.status}`;
  try {
    const errBody = await res.json();
    if (typeof errBody?.detail === "string") detail = errBody.detail;
    else if (typeof errBody?.error === "string") detail = errBody.error;
    else if (typeof errBody?.message === "string") detail = errBody.message;
  } catch {
    // Response body is not JSON
  }
  throw new FastApiError(detail, res.status);
}
```

This ensures we capture the actual error message from the chatbot-assistant service (like "no repos indexed") instead of a generic status code message.

**Step 2 -- Improve `src/app/api/assistant/chat/route.ts`:**

In the catch block (line 80-100), update the error mapping to pass through more specific error messages from the FastAPI backend. Currently, most errors map to "Something went wrong." Instead:

```typescript
if (err instanceof FastApiError) {
  let userMessage: string;
  if (err.isTimeout) {
    userMessage = "The assistant is taking too long to respond. Please try again.";
  } else if (err.status === 429) {
    userMessage = "Too many messages. Please wait a moment.";
  } else if (err.status === 503) {
    userMessage = "The assistant is currently unavailable. Please try again later.";
  } else if (err.status === 500) {
    userMessage = "The assistant service encountered an error. This may indicate the knowledge base needs to be re-synced.";
  } else {
    userMessage = err.message || "Something went wrong. Please try again.";
  }
  // ...
}
```

The key change is the 500 case: instead of generic "Something went wrong", mention that the knowledge base may need re-syncing. This surfaces BUG-03's root cause to the user.

**Step 3 -- Improve `src/app/api/tools/research-assistant/conversations/route.ts`:**

Wrap the `listConversations` call in a try/catch to handle Firestore index errors gracefully:

```typescript
export async function GET(request: Request) {
  const auth = await verifyUser(request);
  if (!auth.authorized) return unauthorizedResponse(auth);

  try {
    const conversations = await listConversations(auth.uid, 20);
    return Response.json({ conversations });
  } catch (error) {
    const message = error instanceof Error ? error.message : "Failed to load conversations.";
    // Firestore index errors contain "requires an index" in the message
    const isIndexError = message.includes("requires an index") || message.includes("FAILED_PRECONDITION");
    const status = isIndexError ? 503 : 500;
    const userMessage = isIndexError
      ? "Conversation history is temporarily unavailable. The database index is being created."
      : "Failed to load conversations. Please try again.";
    console.error("listConversations failed:", message);
    return Response.json({ error: userMessage }, { status });
  }
}
```

This ensures a missing Firestore index (BUG-05) returns a helpful 503 instead of a bare 500 crash.

Run `npm run lint && npm run build` after all changes.
  </action>
  <verify>Run `npm run lint && npm run build` -- zero errors. Verify the conversations route has try/catch. Verify the fastapi-client extracts error details from response body.</verify>
  <done>Error messages for all three external service bugs are improved: (1) AI assistant surfaces knowledge base sync issues, (2) research assistant conversations route handles Firestore index errors gracefully, (3) FastAPI client extracts specific error messages from response bodies.</done>
</task>

</tasks>

<verification>
- `npm run lint` passes with zero errors
- `npm run build` succeeds with zero errors
- `npm test` passes (if applicable tests exist)
- `firestore.indexes.json` is valid JSON with 5 index entries
- Conversations route has try/catch error handling
- FastAPI client extracts error details from response bodies
- Assistant chat route maps 500 errors to knowledge-base-specific messages
</verification>

<success_criteria>
1. firestore.indexes.json includes composite indexes for research_conversations and scrape_history collections
2. Research assistant conversations endpoint returns graceful error message instead of crashing on missing index
3. AI assistant chat endpoint surfaces specific error messages from the chatbot-assistant backend
4. Build, lint, and tests all pass
5. NOTE: Full resolution of BUG-03 requires knowledge base sync in the chatbot-assistant repo (external). Full resolution of BUG-04 depends on model API keys being correctly configured in the deployed environment. These are documented in the summary as external follow-ups.
</success_criteria>

<output>
After completion, create `.planning/phases/39-bug-fixes/39-02-SUMMARY.md`

The summary MUST document these external follow-ups:
- BUG-03 EXTERNAL: chatbot-assistant repo needs knowledge base re-sync (run indexing pipeline)
- BUG-04 EXTERNAL: verify OPENAI_API_KEY and GOOGLE_GENERATIVE_AI_API_KEY are set in Cloud Run environment
- BUG-05 DEPLOY: run `firebase deploy --only firestore:indexes` to create the new composite indexes
</output>
