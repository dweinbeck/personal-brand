---
phase: 32-effort-scoring
plan: 02
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - /Users/dweinbeck/Documents/todoist/src/lib/effort.ts
  - /Users/dweinbeck/Documents/todoist/src/components/tasks/section-header.tsx
  - /Users/dweinbeck/Documents/todoist/src/app/tasks/[projectId]/project-view.tsx
  - /Users/dweinbeck/Documents/todoist/src/components/tasks/board-view.tsx
  - /Users/dweinbeck/Documents/todoist/src/__tests__/effort-rollup.test.ts
autonomous: true

must_haves:
  truths:
    - "User sees the sum of effort scores for incomplete tasks on each section header"
    - "User sees the sum of effort scores for incomplete tasks on the project header"
    - "User sees the sum of effort scores per column in board view"
    - "Completed tasks are excluded from effort sums"
    - "Unscored tasks (null effort) are excluded from effort sums (not counted as 0)"
    - "Subtask effort is NOT included in rollup sums (avoids double-counting)"
    - "Unit tests verify all edge cases for effort rollup computation"
  artifacts:
    - path: "src/lib/effort.ts"
      provides: "EFFORT_VALUES constant, EffortValue type, computeEffortSum() pure function"
      exports: ["EFFORT_VALUES", "EffortValue", "computeEffortSum"]
      min_lines: 10
    - path: "src/components/tasks/section-header.tsx"
      provides: "Effort sum display next to task count"
      contains: "effortSum"
    - path: "src/app/tasks/[projectId]/project-view.tsx"
      provides: "Project-level effort sum and per-section effort computation"
      contains: "computeEffortSum"
    - path: "src/components/tasks/board-view.tsx"
      provides: "Per-column effort sum in board column headers"
      contains: "computeEffortSum"
    - path: "src/__tests__/effort-rollup.test.ts"
      provides: "Unit tests for computeEffortSum covering null, completed, empty, mixed cases"
      min_lines: 30
  key_links:
    - from: "src/app/tasks/[projectId]/project-view.tsx"
      to: "src/lib/effort.ts"
      via: "import computeEffortSum and call for each section + unsectioned tasks"
      pattern: "computeEffortSum"
    - from: "src/app/tasks/[projectId]/project-view.tsx"
      to: "src/components/tasks/section-header.tsx"
      via: "passes computed effortSum as prop"
      pattern: "effortSum"
    - from: "src/components/tasks/board-view.tsx"
      to: "src/lib/effort.ts"
      via: "import computeEffortSum for each column"
      pattern: "computeEffortSum"
    - from: "src/__tests__/effort-rollup.test.ts"
      to: "src/lib/effort.ts"
      via: "import and test computeEffortSum directly"
      pattern: "import.*computeEffortSum.*from.*effort"
---

<objective>
Create the effort rollup computation utility, display aggregate effort sums on section headers, the project header, and board view column headers, and write unit tests covering all edge cases.

Purpose: Completes the effort scoring feature by showing users the total effort remaining per section and per project, enabling capacity planning. Tests ensure the rollup logic handles null values, completed tasks, and empty arrays correctly.

Output: Section headers and project header show effort sums, board columns show effort sums, all unit tests pass.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-effort-scoring/32-RESEARCH.md
@.planning/phases/32-effort-scoring/32-01-SUMMARY.md

Source files (all in /Users/dweinbeck/Documents/todoist/):
@/Users/dweinbeck/Documents/todoist/src/components/tasks/section-header.tsx
@/Users/dweinbeck/Documents/todoist/src/app/tasks/[projectId]/project-view.tsx
@/Users/dweinbeck/Documents/todoist/src/components/tasks/board-view.tsx
@/Users/dweinbeck/Documents/todoist/src/types/index.ts
@/Users/dweinbeck/Documents/todoist/vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create effort utility and wire rollup sums into section headers and project view</name>
  <files>
    /Users/dweinbeck/Documents/todoist/src/lib/effort.ts
    /Users/dweinbeck/Documents/todoist/src/components/tasks/section-header.tsx
    /Users/dweinbeck/Documents/todoist/src/app/tasks/[projectId]/project-view.tsx
    /Users/dweinbeck/Documents/todoist/src/components/tasks/board-view.tsx
  </files>
  <action>
    **All work happens in the todoist repo at `/Users/dweinbeck/Documents/todoist`.**

    1. **Create `src/lib/effort.ts`** (new file):
       ```typescript
       export const EFFORT_VALUES = [1, 2, 3, 5, 8, 13] as const;
       export type EffortValue = (typeof EFFORT_VALUES)[number];

       /**
        * Compute sum of effort scores for incomplete, top-level tasks.
        * Tasks with null effort are excluded (not counted as 0).
        * Tasks with status !== "OPEN" are excluded.
        * Subtasks (parentTaskId !== null) should NOT be passed to this function
        * â€” the caller is responsible for filtering them out to avoid double-counting.
        */
       export function computeEffortSum(
         tasks: { effort: number | null; status: string }[],
       ): number {
         return tasks
           .filter((t) => t.status === "OPEN" && t.effort != null)
           .reduce((sum, t) => sum + (t.effort as number), 0);
       }
       ```

    2. **Update `src/components/tasks/section-header.tsx`**:
       - Add `effortSum` to the `SectionHeaderProps` interface: `effortSum: number;`
       - Accept `effortSum` as a prop alongside `section` and `taskCount`.
       - Display the effort sum next to the task count in the section name button, only when `effortSum > 0`:
         ```
         <span className="ml-2 text-xs font-normal text-text-tertiary">
           {taskCount}
         </span>
         {effortSum > 0 && (
           <span className="ml-1 text-xs font-normal text-amber">
             ({effortSum})
           </span>
         )}
         ```
         Place both spans inside the existing `<button>` element, after `{section.name}`.

    3. **Update `src/app/tasks/[projectId]/project-view.tsx`**:
       - Import `computeEffortSum` from `@/lib/effort`.
       - Compute project-level effort sum from ALL top-level tasks (both unsectioned and sectioned). Do NOT include subtasks. The project data structure has `project.tasks` (unsectioned top-level tasks) and `project.sections[].tasks` (sectioned top-level tasks). Both already exclude subtasks (they are nested inside `task.subtasks`).
         ```typescript
         const allTopLevelTasks = [
           ...project.tasks,
           ...project.sections.flatMap((s) => s.tasks),
         ];
         const projectEffortSum = computeEffortSum(allTopLevelTasks);
         ```
       - Display the project effort sum next to the project name (inside the non-editing branch, after the project name button), only when `projectEffortSum > 0`:
         ```
         {projectEffortSum > 0 && (
           <span className="ml-3 text-base font-normal text-amber">
             {projectEffortSum} effort
           </span>
         )}
         ```
       - For each section, compute and pass `effortSum` to `SectionHeader`:
         ```typescript
         <SectionHeader
           section={section}
           taskCount={section.tasks.length}
           effortSum={computeEffortSum(section.tasks)}
         />
         ```
       - Also compute and display an effort sum for the unsectioned tasks group. If `project.tasks.length > 0`, add a small effort indicator above the unsectioned task list when the sum is > 0:
         ```
         {computeEffortSum(project.tasks) > 0 && (
           <div className="text-xs text-amber mb-2">
             {computeEffortSum(project.tasks)} effort
           </div>
         )}
         ```

    4. **Update `src/components/tasks/board-view.tsx`**:
       - Import `computeEffortSum` from `@/lib/effort`.
       - In each column header (the `<div className="flex items-center justify-between mb-3 px-1">` block), add the effort sum next to the task count. Compute it from `col.tasks`:
         ```
         <span className="text-xs text-text-tertiary">
           {col.tasks.length}
         </span>
         {computeEffortSum(col.tasks) > 0 && (
           <span className="text-xs text-amber ml-1">
             ({computeEffortSum(col.tasks)})
           </span>
         )}
         ```
         Wrap both spans in a flex container to keep them on the same line.

    5. **Update inline EFFORT_VALUES in task-form.tsx and quick-add-modal.tsx** (from Plan 01): If Plan 01 defined `EFFORT_VALUES` inline in those components, update both to import from `@/lib/effort` instead:
       ```typescript
       import { EFFORT_VALUES } from "@/lib/effort";
       ```
       Remove the inline `const EFFORT_VALUES = ...` from each file.
  </action>
  <verify>
    From the todoist directory:
    1. `npm run build` passes with zero errors
    2. `npm run lint` passes
    3. Run `npm run dev` and manually verify:
       - Section headers show effort sum in amber next to task count (e.g., "3 (11)")
       - Project header shows total effort (e.g., "24 effort")
       - Board view column headers show effort sum next to task count
       - Completing a scored task reduces the effort sum
       - Sections/projects with no scored tasks show no effort indicator
  </verify>
  <done>
    - `src/lib/effort.ts` exports EFFORT_VALUES, EffortValue, and computeEffortSum
    - Section headers display effort sum in amber when > 0
    - Project header displays total effort sum when > 0
    - Board view column headers display effort sum when > 0
    - Completed tasks excluded from sums
    - Null-effort tasks excluded from sums (not counted as 0)
    - Subtask effort NOT double-counted in rollups
  </done>
</task>

<task type="auto">
  <name>Task 2: Write unit tests for effort rollup computation</name>
  <files>
    /Users/dweinbeck/Documents/todoist/src/__tests__/effort-rollup.test.ts
  </files>
  <action>
    **All work happens in the todoist repo at `/Users/dweinbeck/Documents/todoist`.**

    Create `src/__tests__/effort-rollup.test.ts` (new file). This is the first test file in the todoist project -- the `src/__tests__/` directory needs to be created. Vitest is configured with `root: "src"` so tests in `src/__tests__/` will be discovered automatically.

    Test `computeEffortSum` from `@/lib/effort` with these cases:

    ```typescript
    import { describe, expect, it } from "vitest";
    import { computeEffortSum, EFFORT_VALUES } from "@/lib/effort";

    describe("computeEffortSum", () => {
      it("sums effort for open tasks only", () => {
        const tasks = [
          { effort: 3, status: "OPEN" },
          { effort: 5, status: "COMPLETED" },
          { effort: 8, status: "OPEN" },
        ];
        expect(computeEffortSum(tasks)).toBe(11);
      });

      it("excludes tasks with null effort", () => {
        const tasks = [
          { effort: null, status: "OPEN" },
          { effort: 5, status: "OPEN" },
        ];
        expect(computeEffortSum(tasks)).toBe(5);
      });

      it("returns 0 for empty array", () => {
        expect(computeEffortSum([])).toBe(0);
      });

      it("returns 0 when all tasks are completed", () => {
        const tasks = [
          { effort: 3, status: "COMPLETED" },
          { effort: 5, status: "COMPLETED" },
        ];
        expect(computeEffortSum(tasks)).toBe(0);
      });

      it("returns 0 when all tasks are unscored", () => {
        const tasks = [
          { effort: null, status: "OPEN" },
          { effort: null, status: "OPEN" },
        ];
        expect(computeEffortSum(tasks)).toBe(0);
      });

      it("handles mix of scored, unscored, open, and completed tasks", () => {
        const tasks = [
          { effort: 1, status: "OPEN" },
          { effort: null, status: "OPEN" },
          { effort: 13, status: "COMPLETED" },
          { effort: 5, status: "OPEN" },
          { effort: null, status: "COMPLETED" },
          { effort: 8, status: "OPEN" },
        ];
        expect(computeEffortSum(tasks)).toBe(14); // 1 + 5 + 8
      });

      it("sums all valid effort values correctly", () => {
        const tasks = EFFORT_VALUES.map((v) => ({ effort: v, status: "OPEN" as const }));
        expect(computeEffortSum(tasks)).toBe(1 + 2 + 3 + 5 + 8 + 13); // 32
      });

      it("handles single scored open task", () => {
        const tasks = [{ effort: 13, status: "OPEN" }];
        expect(computeEffortSum(tasks)).toBe(13);
      });
    });

    describe("EFFORT_VALUES", () => {
      it("contains exactly the Fibonacci-like scale values", () => {
        expect([...EFFORT_VALUES]).toEqual([1, 2, 3, 5, 8, 13]);
      });
    });
    ```

    Ensure the test covers requirements:
    - TEST-02: null handling (two tests for null effort)
    - TEST-02: section sum (sums open tasks with non-null effort -- the function is used per-section)
    - TEST-02: project sum (same function, just called with all project tasks)

    Run `npm run test` to confirm all tests pass.
  </action>
  <verify>
    From the todoist directory:
    1. `npm run test` passes with all tests green
    2. `npm run build` still passes
    3. `npm run lint` still passes
  </verify>
  <done>
    - `src/__tests__/effort-rollup.test.ts` exists with 9+ test cases
    - All tests pass via `npm run test`
    - Tests cover: open-only filtering, null exclusion, empty array, all-completed, all-unscored, mixed scenarios, full value set, single task
    - Satisfies TEST-02 requirement
  </done>
</task>

</tasks>

<verification>
Full phase verification after both plans complete:
1. `npm run test` -- all effort rollup tests pass
2. `npm run build` -- zero errors
3. `npm run lint` -- zero errors
4. Create task with effort=5 via TaskForm -> amber "5" badge on card
5. Create task with no effort -> no badge
6. Section header shows sum of open-task effort (e.g., "3 (13)")
7. Project header shows total effort across all sections
8. Board view columns show effort sums
9. Complete a scored task -> effort sums decrease
10. All unscored tasks are excluded from sums (never show "0")
</verification>

<success_criteria>
- computeEffortSum() correctly filters OPEN + non-null effort and sums
- Section headers, project header, and board columns all display effort sums
- Sums update reactively when tasks are completed/toggled
- 9+ unit tests all pass
- Build, lint, and tests all green
</success_criteria>

<output>
After completion, create `.planning/phases/32-effort-scoring/32-02-SUMMARY.md`
</output>
