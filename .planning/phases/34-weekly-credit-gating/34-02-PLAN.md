---
phase: 34-weekly-credit-gating
plan: 02
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - todoist:src/lib/billing.ts
  - todoist:src/actions/task.ts
  - todoist:src/actions/project.ts
  - todoist:src/actions/section.ts
  - todoist:src/actions/workspace.ts
  - todoist:src/actions/tag.ts
  - todoist:src/components/billing/ReadOnlyBanner.tsx
  - todoist:src/components/billing/FreeWeekBanner.tsx
  - todoist:src/components/billing/BillingProvider.tsx
  - todoist:src/app/tasks/layout.tsx
autonomous: true
user_setup:
  - service: personal-brand billing API
    why: "Cross-service billing check from todoist to personal-brand"
    env_vars:
      - name: BILLING_API_URL
        source: "Set to https://dan-weinbeck.com (or http://localhost:3000 in dev)"
      - name: BILLING_URL
        source: "Set to https://dan-weinbeck.com/billing (or http://localhost:3000/billing in dev)"

must_haves:
  truths:
    - "All 17 mutation server actions return {error, code: 402} when billing mode is readonly"
    - "User sees ReadOnlyBanner with Buy Credits CTA when in readonly mode"
    - "User sees FreeWeekBanner during free trial week"
    - "Billing status is fetched once in layout and shared via BillingProvider context"
    - "Billing check defaults to readwrite if BILLING_API_URL is not set or unreachable"
  artifacts:
    - path: "todoist:src/lib/billing.ts"
      provides: "checkBillingAccess() server-only function"
      contains: "checkBillingAccess"
    - path: "todoist:src/components/billing/ReadOnlyBanner.tsx"
      provides: "Amber banner with Buy Credits link"
      contains: "ReadOnlyBanner"
    - path: "todoist:src/components/billing/FreeWeekBanner.tsx"
      provides: "Emerald banner explaining free week"
      contains: "FreeWeekBanner"
    - path: "todoist:src/components/billing/BillingProvider.tsx"
      provides: "Client-side context for billing status"
      contains: "BillingProvider"
  key_links:
    - from: "todoist:src/actions/task.ts"
      to: "todoist:src/lib/billing.ts"
      via: "import checkBillingAccess"
      pattern: "checkBillingAccess"
    - from: "todoist:src/lib/billing.ts"
      to: "personal-brand:GET /api/billing/tasks/access"
      via: "fetch with Bearer token"
      pattern: "BILLING_API_URL.*api/billing/tasks/access"
    - from: "todoist:src/app/tasks/layout.tsx"
      to: "todoist:src/components/billing/BillingProvider.tsx"
      via: "wraps children with BillingProvider"
      pattern: "BillingProvider"
---

<objective>
Integrate billing guards into all todoist server actions and add billing UI components.

Purpose: Enforces server-side read-only mode when credits are insufficient (402 on all mutations), and provides user-facing banners for billing status awareness.
Output: Billing guard on all 17 mutation actions, ReadOnlyBanner, FreeWeekBanner, BillingProvider context.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-weekly-credit-gating/34-RESEARCH.md
@.planning/phases/34-weekly-credit-gating/34-01-SUMMARY.md

Repo: todoist at /Users/dweinbeck/Documents/todoist

Reference for billing guard pattern:
@/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/ReadOnlyBanner.tsx
@/Users/dweinbeck/Documents/todoist/src/actions/task.ts (current state -- add billing guard)
@/Users/dweinbeck/Documents/todoist/src/actions/project.ts
@/Users/dweinbeck/Documents/todoist/src/actions/section.ts
@/Users/dweinbeck/Documents/todoist/src/actions/workspace.ts
@/Users/dweinbeck/Documents/todoist/src/actions/tag.ts
@/Users/dweinbeck/Documents/todoist/src/app/tasks/layout.tsx (add BillingProvider wrapping)
@/Users/dweinbeck/Documents/todoist/src/context/AuthContext.tsx (context provider pattern reference)
@/Users/dweinbeck/Documents/todoist/src/lib/auth.ts (server-only pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Billing helper, context provider, and banner components</name>
  <files>todoist:src/lib/billing.ts, todoist:src/components/billing/BillingProvider.tsx, todoist:src/components/billing/ReadOnlyBanner.tsx, todoist:src/components/billing/FreeWeekBanner.tsx</files>
  <action>
All files in /Users/dweinbeck/Documents/todoist.

**1. Create `src/lib/billing.ts`** (server-only helper):

```
import "server-only";
```

Export type `BillingStatus = { mode: "readwrite" | "readonly"; reason?: "free_week" | "unpaid"; weekStart: string; }`

Export `async function checkBillingAccess(idToken: string): Promise<BillingStatus>`:
- Read `BILLING_API_URL` from `process.env.BILLING_API_URL`
- If not set: `console.warn("BILLING_API_URL not set -- defaulting to readwrite")` and return `{ mode: "readwrite", weekStart: "" }`
- `fetch(`${BILLING_API_URL}/api/billing/tasks/access`, { headers: { Authorization: `Bearer ${idToken}` }, cache: "no-store" })`
- If `!res.ok`: `console.error(`Billing check failed: ${res.status}`)` and return `{ mode: "readwrite", weekStart: "" }` (graceful degradation)
- Otherwise: `return res.json()`

Also export a helper for mutation guards:
```
export function billingGuard(billing: BillingStatus): { error: string; code: number } | null {
  if (billing.mode === "readonly") {
    return { error: "Insufficient credits. Purchase credits to continue.", code: 402 };
  }
  return null;
}
```

**2. Create `src/components/billing/BillingProvider.tsx`** ("use client"):

Create a context that holds `BillingStatus` (serializable -- no server-only types):
- `BillingContextValue = { mode: "readwrite" | "readonly"; reason?: "free_week" | "unpaid" }`
- Default context value: `{ mode: "readwrite" }`
- `BillingProvider` accepts `{ billing: BillingContextValue; children: ReactNode }` and wraps children in context provider
- Export `useBilling()` hook that returns the context value

**3. Create `src/components/billing/ReadOnlyBanner.tsx`** ("use client"):

Amber banner matching the envelopes pattern. Accept `buyCreditsUrl: string` prop:
- Outer div: `className="mb-4 rounded-xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-800"`
- Bold "Read-Only Mode" header
- Description: "Your free week has ended. Purchase credits to continue creating, editing, and deleting tasks."
- Link: `<a href={buyCreditsUrl} target="_blank" rel="noopener noreferrer">` styled as underlined amber-900

**4. Create `src/components/billing/FreeWeekBanner.tsx`** ("use client"):

Emerald banner:
- Outer div: `className="mb-4 rounded-xl border border-emerald-200 bg-emerald-50 p-4 text-sm text-emerald-800"`
- Bold "Free Trial Week" header
- Description: "Welcome! You have free access this week. After your free week ends, task management costs 100 credits/week ($1/week)."
  </action>
  <verify>
Run `npm run build` in /Users/dweinbeck/Documents/todoist. Run `npm run lint`. All pass.
  </verify>
  <done>
`checkBillingAccess()` and `billingGuard()` exported from `src/lib/billing.ts`. `BillingProvider` with `useBilling()` hook exported. `ReadOnlyBanner` and `FreeWeekBanner` components created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire billing guards into all 17 mutation actions and update layout</name>
  <files>todoist:src/actions/task.ts, todoist:src/actions/project.ts, todoist:src/actions/section.ts, todoist:src/actions/workspace.ts, todoist:src/actions/tag.ts, todoist:src/app/tasks/layout.tsx</files>
  <action>
All files in /Users/dweinbeck/Documents/todoist.

**1. Add billing guard to all 5 action files (17 mutations total):**

In each file, add import at the top:
```
import { billingGuard, checkBillingAccess } from "@/lib/billing";
```

In each mutation function (create/update/delete/toggle/assignToSection), add the billing check AFTER the `verifyUser` auth check and BEFORE schema validation or business logic:

```
const billing = await checkBillingAccess(idToken);
const blocked = billingGuard(billing);
if (blocked) return blocked;
```

Apply this pattern to all 17 functions:
- `src/actions/task.ts`: createTaskAction, updateTaskAction, deleteTaskAction, toggleTaskAction, assignTaskToSectionAction (5 functions)
- `src/actions/project.ts`: createProjectAction, updateProjectAction, deleteProjectAction (3 functions)
- `src/actions/section.ts`: createSectionAction, updateSectionAction, deleteSectionAction (3 functions)
- `src/actions/workspace.ts`: createWorkspaceAction, updateWorkspaceAction, deleteWorkspaceAction (3 functions)
- `src/actions/tag.ts`: createTagAction, updateTagAction, deleteTagAction (3 functions)

IMPORTANT: The billing guard must be placed between the auth check (`verifyUser`) and the business logic. The `idToken` argument already exists in each action signature. Do NOT change function signatures.

**2. Update `src/app/tasks/layout.tsx`:**

Add imports:
```
import { checkBillingAccess } from "@/lib/billing";
import { BillingProvider } from "@/components/billing/BillingProvider";
import { ReadOnlyBanner } from "@/components/billing/ReadOnlyBanner";
import { FreeWeekBanner } from "@/components/billing/FreeWeekBanner";
```

After the existing `getUserIdFromCookie()` call, get the raw cookie token to check billing:
```
const cookieStore = await cookies();
const token = cookieStore.get("__session")?.value;
```

Add to the `Promise.all` (or parallel fetch) a billing check:
```
const billing = token ? await checkBillingAccess(token) : { mode: "readwrite" as const, weekStart: "" };
```

Wrap the existing JSX with `<BillingProvider billing={{ mode: billing.mode, reason: "reason" in billing ? billing.reason : undefined }}>`:

Inside the layout, above `{children}`, conditionally render banners:
```
{billing.mode === "readonly" && <ReadOnlyBanner buyCreditsUrl={process.env.BILLING_URL || "https://dan-weinbeck.com/billing"} />}
{billing.reason === "free_week" && <FreeWeekBanner />}
```

Place the banners inside `<main>` at the top, above `{children}`. Wrap them in a `<div className="px-6 pt-6">` for consistent padding.

Import `cookies` from `next/headers` (already used by `getUserIdFromCookie` internally, but now we need direct access for the token).
  </action>
  <verify>
Run `npm run build` in /Users/dweinbeck/Documents/todoist. Run `npm run lint`. Run `npm test`. All pass.

Verify billing guard exists in all action files:
- `grep -c "billingGuard" src/actions/task.ts` should return 5
- `grep -c "billingGuard" src/actions/project.ts` should return 3
- `grep -c "billingGuard" src/actions/section.ts` should return 3
- `grep -c "billingGuard" src/actions/workspace.ts` should return 3
- `grep -c "billingGuard" src/actions/tag.ts` should return 3
  </verify>
  <done>
All 17 mutation server actions return `{ error, code: 402 }` when billing check returns readonly. Layout fetches billing status, passes it via BillingProvider, and conditionally renders ReadOnlyBanner or FreeWeekBanner. Build, lint, and tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes in todoist repo
2. `npm run lint` passes in todoist repo
3. `npm test` passes in todoist repo
4. All 17 mutation actions contain `billingGuard` call
5. Layout wraps children in BillingProvider
6. ReadOnlyBanner and FreeWeekBanner components exist
</verification>

<success_criteria>
- Every mutation action checks billing before proceeding and returns 402-coded error when readonly
- Billing status flows from layout server component through BillingProvider to client components
- ReadOnlyBanner shows amber "Buy Credits" CTA linking to personal-brand billing page
- FreeWeekBanner shows emerald free week message
- Billing check gracefully degrades to readwrite if BILLING_API_URL unset or unreachable
</success_criteria>

<output>
After completion, create `.planning/phases/34-weekly-credit-gating/34-02-SUMMARY.md`
</output>
