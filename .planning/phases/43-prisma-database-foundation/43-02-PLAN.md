---
phase: 43-prisma-database-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - 43-01
files_modified:
  - Dockerfile
  - cloudbuild.yaml
  - scripts/validate-env.ts
autonomous: true
requirements:
  - DB-02
  - DB-03

must_haves:
  truths:
    - "Docker build generates Prisma client before Next.js build step"
    - "Docker production image includes generated Prisma client files"
    - "Cloud Run deploy includes --add-cloudsql-instances flag for chatbot-assistant"
    - "Cloud Run deploy includes DATABASE_URL from Secret Manager"
    - "validate-env script checks for DATABASE_URL presence"
  artifacts:
    - path: "Dockerfile"
      provides: "Multi-stage Docker build with Prisma generate step"
      contains: "prisma generate"
    - path: "cloudbuild.yaml"
      provides: "Cloud Run deploy with Cloud SQL instance and DATABASE_URL secret"
      contains: "add-cloudsql-instances"
    - path: "scripts/validate-env.ts"
      provides: "Environment validation including DATABASE_URL"
      contains: "DATABASE_URL"
  key_links:
    - from: "Dockerfile"
      to: "src/generated/prisma"
      via: "COPY generated client to production image"
      pattern: "generated/prisma"
    - from: "cloudbuild.yaml"
      to: "Cloud SQL chatbot-assistant instance"
      via: "--add-cloudsql-instances flag"
      pattern: "cloudsql-instances"
---

<objective>
Update the Docker build and Cloud Run deployment configuration to support Prisma in production.

Purpose: The personal-brand Cloud Run service needs to generate the Prisma client during Docker build, include it in the production image, connect to Cloud SQL via the Unix socket connector, and have DATABASE_URL provided as a secret.
Output: Updated Dockerfile, cloudbuild.yaml, and validate-env script ready for Cloud SQL database connectivity.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-prisma-database-foundation/43-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Dockerfile for Prisma client generation and inclusion</name>
  <files>Dockerfile</files>
  <action>
Update the existing Dockerfile to add Prisma generate and copy steps. The current Dockerfile uses a 3-stage build (deps -> builder -> runner) on node:20-alpine.

Changes needed in the **builder** stage (after `COPY . .` and before `RUN npm run build`):
1. Add a dummy DATABASE_URL env var so `prisma generate` can run without a real database connection (same pattern as todoist Dockerfile):
   ```dockerfile
   ENV DATABASE_URL="postgresql://dummy:dummy@localhost:5432/dummy"
   RUN npx prisma generate
   ```
2. Place this BEFORE the `RUN npm run build` line since the Next.js build needs the generated Prisma client.

Changes needed in the **runner** stage (after the existing COPY statements):
1. Copy the prisma schema directory (needed at runtime for Prisma client):
   ```dockerfile
   COPY --from=builder /app/prisma ./prisma
   ```
2. Copy the generated Prisma client:
   ```dockerfile
   COPY --from=builder --chown=nextjs:nodejs /app/src/generated/prisma ./src/generated/prisma
   ```

The full updated Dockerfile should look like:
```dockerfile
# syntax=docker.io/docker/dockerfile:1

FROM node:20-alpine AS base

# --- Stage 1: Install dependencies ---
FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm ci

# --- Stage 2: Build the application ---
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
ENV NEXT_TELEMETRY_DISABLED=1
ARG NEXT_PUBLIC_FIREBASE_API_KEY
ARG NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN
ARG NEXT_PUBLIC_FIREBASE_PROJECT_ID
ENV NEXT_PUBLIC_FIREBASE_API_KEY=$NEXT_PUBLIC_FIREBASE_API_KEY
ENV NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=$NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN
ENV NEXT_PUBLIC_FIREBASE_PROJECT_ID=$NEXT_PUBLIC_FIREBASE_PROJECT_ID
ENV DATABASE_URL="postgresql://dummy:dummy@localhost:5432/dummy"
RUN npx prisma generate
RUN npm run build

# --- Stage 3: Production runner ---
FROM base AS runner
WORKDIR /app

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV NEXT_SHARP_PATH=/app/node_modules/sharp

LABEL org.opencontainers.image.source="https://github.com/dweinbeck/personal-brand"

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
COPY --from=builder /app/prisma ./prisma
COPY --from=builder --chown=nextjs:nodejs /app/src/generated/prisma ./src/generated/prisma

USER nextjs

EXPOSE 3000
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

CMD ["node", "server.js"]
```

IMPORTANT: Do NOT change the base image (node:20-alpine), port (3000), or any existing build args. Only add Prisma-specific lines.
  </action>
  <verify>
Run `docker build --build-arg NEXT_PUBLIC_FIREBASE_API_KEY=test --build-arg NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=test --build-arg NEXT_PUBLIC_FIREBASE_PROJECT_ID=test -t personal-brand-test . 2>&1 | tail -20` to verify the Docker build succeeds. If Docker is not available locally, verify the Dockerfile syntax is correct by inspection. Run `grep "prisma generate" Dockerfile` and `grep "generated/prisma" Dockerfile` to confirm the lines exist.
  </verify>
  <done>Dockerfile generates Prisma client during build, copies prisma/ and src/generated/prisma/ to production image, builds successfully</done>
</task>

<task type="auto">
  <name>Task 2: Update cloudbuild.yaml with Cloud SQL instance and DATABASE_URL secret</name>
  <files>cloudbuild.yaml, scripts/validate-env.ts</files>
  <action>
1. Update `cloudbuild.yaml` deploy step (step 3) to add Cloud SQL connection and DATABASE_URL:

   In the `gcloud run deploy` args array, add these two lines:
   ```yaml
   - '--add-cloudsql-instances=${PROJECT_ID}:${_REGION}:chatbot-assistant'
   ```

   This is the EXACT pattern from the todoist cloudbuild.yaml. The Cloud SQL instance name is `chatbot-assistant` and it uses the `${PROJECT_ID}:${_REGION}:chatbot-assistant` format.

   Also update the `--set-secrets` line to append the DATABASE_URL secret:
   ```yaml
   - '--set-secrets=GITHUB_TOKEN=github-token:latest,STRIPE_SECRET_KEY=stripe-secret-key:latest,STRIPE_WEBHOOK_SECRET=stripe-webhook-secret:latest,OPENAI_API_KEY=openai-api-key:latest,GOOGLE_GENERATIVE_AI_API_KEY=google-ai-api-key:latest,CHATBOT_API_KEY=chatbot-api-key:latest,DATABASE_URL=tasks-database-url:latest'
   ```

   The secret name is `tasks-database-url` — same secret name used by the todoist service (see todoist cloudbuild.yaml line: `--set-secrets=DATABASE_URL=tasks-database-url:latest`). Both services share the same Cloud SQL database and the same secret.

   IMPORTANT: The `--set-env-vars` line should NOT include DATABASE_URL — it comes from Secret Manager via `--set-secrets`. Do NOT move existing env vars or secrets around. Only ADD the two new items.

2. Update `scripts/validate-env.ts` to include DATABASE_URL in its validation checks.

   Read the existing file first to understand its validation pattern. Add DATABASE_URL as an optional server-side env var check — it should be present in Cloud Run but may not be set in local development (where the developer uses .env.local). The validation should:
   - Check DATABASE_URL exists when other Cloud Run secrets exist (i.e., in production context)
   - Validate it starts with `postgresql://` if present
   - Warn (not error) if missing in local dev context

   Follow the existing validation patterns in the script. Do NOT restructure or rewrite the entire validation script.
  </action>
  <verify>
Run `grep "cloudsql-instances" cloudbuild.yaml` to confirm the flag exists. Run `grep "tasks-database-url" cloudbuild.yaml` to confirm the secret is referenced. Run `grep "DATABASE_URL" scripts/validate-env.ts` to confirm validation was added. Run `npm run lint` to verify no lint errors.
  </verify>
  <done>cloudbuild.yaml includes --add-cloudsql-instances for chatbot-assistant, DATABASE_URL secret from tasks-database-url, and validate-env checks for DATABASE_URL presence</done>
</task>

</tasks>

<verification>
- `Dockerfile` includes `prisma generate` before `npm run build`
- `Dockerfile` copies `prisma/` and `src/generated/prisma/` to production image
- `cloudbuild.yaml` has `--add-cloudsql-instances=${PROJECT_ID}:${_REGION}:chatbot-assistant`
- `cloudbuild.yaml` has `DATABASE_URL=tasks-database-url:latest` in `--set-secrets`
- `scripts/validate-env.ts` checks for DATABASE_URL
- `npm run lint` passes
</verification>

<success_criteria>
The Docker build includes Prisma generation and production image has generated client files. Cloud Run deployment configuration connects to the chatbot-assistant Cloud SQL instance and receives DATABASE_URL from Secret Manager. Environment validation script checks for DATABASE_URL.
</success_criteria>

<output>
After completion, create `.planning/phases/43-prisma-database-foundation/43-02-SUMMARY.md`
</output>
