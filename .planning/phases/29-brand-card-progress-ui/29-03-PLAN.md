---
phase: 29-brand-card-progress-ui
plan: 03
type: execute
wave: 3
depends_on: ["29-02"]
files_modified:
  - src/components/tools/brand-scraper/BrandCard.tsx
  - src/components/tools/brand-scraper/UserBrandScraperPage.tsx
autonomous: true

must_haves:
  truths:
    - "While a scrape job is running, the UI shows live lists of 'Pages being scraped' and 'Files saved' updating in real time"
    - "On completion, a single wide Brand Card shows a browser-tab header with favicon + hostname, logos, color palette swatches, and a description area rendered in the extracted font"
    - "The Brand Card has 'Download Brand JSON File' and 'Download Assets' buttons"
    - "The old 2x2 BrandResultsGallery is no longer used on the user-facing page"
    - "The unparseable result fallback UI still works"
    - "The 'Scrape Another URL' button still appears on terminal states"
  artifacts:
    - path: "src/components/tools/brand-scraper/BrandCard.tsx"
      provides: "Brand Card container composing all section components"
      exports: ["BrandCard"]
    - path: "src/components/tools/brand-scraper/UserBrandScraperPage.tsx"
      provides: "Updated user page with progress panel and Brand Card"
      contains: "ScrapeProgressPanel"
  key_links:
    - from: "src/components/tools/brand-scraper/BrandCard.tsx"
      to: "BrandCardHeader, BrandCardLogos, BrandCardColors, BrandCardDescription, BrandCardDownloads"
      via: "Composition: imports and renders all section components"
      pattern: "BrandCard(Header|Logos|Colors|Description|Downloads)"
    - from: "src/components/tools/brand-scraper/UserBrandScraperPage.tsx"
      to: "ScrapeProgressPanel"
      via: "Conditional render during polling state with events from data.pipeline_meta"
      pattern: "pipeline_meta.*events"
    - from: "src/components/tools/brand-scraper/UserBrandScraperPage.tsx"
      to: "BrandCard"
      via: "Conditional render on terminal success with parsed result data"
      pattern: "hasValidResult.*BrandCard"
---

<objective>
Compose the Brand Card container and wire everything into the user-facing Brand Scraper page, replacing the old gallery.

Purpose: This is the final assembly plan. It creates the BrandCard container that composes all section components (from Plan 02), then updates UserBrandScraperPage to show the progress panel during scraping and the Brand Card on completion. The old BrandResultsGallery import is removed.

Output: BrandCard.tsx container component and updated UserBrandScraperPage.tsx with full progress + results flow.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-brand-card-progress-ui/29-RESEARCH.md
@.planning/phases/29-brand-card-progress-ui/29-01-SUMMARY.md
@.planning/phases/29-brand-card-progress-ui/29-02-SUMMARY.md
@src/components/tools/brand-scraper/UserBrandScraperPage.tsx
@src/components/tools/brand-scraper/ScrapeProgressPanel.tsx
@src/components/tools/brand-scraper/BrandCardHeader.tsx
@src/components/tools/brand-scraper/BrandCardLogos.tsx
@src/components/tools/brand-scraper/BrandCardColors.tsx
@src/components/tools/brand-scraper/BrandCardDescription.tsx
@src/components/tools/brand-scraper/BrandCardDownloads.tsx
@src/lib/brand-scraper/types.ts
@src/lib/brand-scraper/hooks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BrandCard container component</name>
  <files>src/components/tools/brand-scraper/BrandCard.tsx</files>
  <action>
Create `src/components/tools/brand-scraper/BrandCard.tsx` as a `"use client"` component.

**Props:**
```typescript
type BrandCardProps = {
  result: BrandTaxonomy;
  brandJsonUrl?: string;
  jobId: string;
  token: string;
};
```

Import all 5 section components from their respective files and `BrandTaxonomy` type from `@/lib/brand-scraper/types`.

**Logic:**
1. Extract hostname from `result.source.site_url` using `new URL(siteUrl).hostname`. Wrap in try/catch — fall back to the raw site_url string if URL parsing fails.
2. Find the first favicon from `result.assets?.favicons` — take `result.assets?.favicons?.[0]?.value?.url` or undefined.
3. The component is a single wide card (CARD-01) with:
   - Outer wrapper: `rounded-2xl border border-border bg-white shadow-sm overflow-hidden` (the full card)
   - BrandCardHeader at the top (outside padding) with favicon + hostname
   - Content area with `p-6 space-y-6`:
     - BrandCardLogos — pass `result.assets`
     - BrandCardColors — pass `result.color`
     - BrandCardDescription — pass `result.identity` and `result.typography`
     - `div` with `flex justify-end gap-3 pt-4 border-t border-border`:
       - BrandCardDownloads — pass brandJsonUrl, jobId, token

**Important:** This component does NOT handle polling or state management. It receives parsed data and renders it. The parent (UserBrandScraperPage) decides WHEN to show this component.

Target: ~60 lines. Pure composition, no business logic.
  </action>
  <verify>
Run `npx tsc --noEmit` — zero type errors. Run `npm run lint` — clean. Verify BrandCard imports and renders all 5 section components.
  </verify>
  <done>BrandCard container composes all section components into a single wide card with browser-tab header, logos, colors, description, and download buttons.</done>
</task>

<task type="auto">
  <name>Task 2: Wire progress panel and Brand Card into UserBrandScraperPage</name>
  <files>src/components/tools/brand-scraper/UserBrandScraperPage.tsx</files>
  <action>
Update `src/components/tools/brand-scraper/UserBrandScraperPage.tsx` to replace the old gallery with the new progress panel and Brand Card.

**Changes to make:**

1. **Remove the BrandResultsGallery import** (line 5): Remove `import { BrandResultsGallery } from "@/components/admin/brand-scraper/BrandResultsGallery";`

2. **Add new imports:**
   ```typescript
   import { ScrapeProgressPanel } from "./ScrapeProgressPanel";
   import { BrandCard } from "./BrandCard";
   import type { ProgressEvent } from "@/lib/brand-scraper/types";
   ```

3. **Extract events from polling data** — add after the existing `parsed` variable declaration (around line 133-142):
   ```typescript
   // Extract pipeline events for progress panel
   const events: ProgressEvent[] = (data as Record<string, unknown>)?.pipeline_meta?.events as ProgressEvent[] ?? [];
   ```
   NOTE: Since `data` is typed as `JobStatus` which now includes `pipeline_meta` (from Plan 01), we can access `data?.pipeline_meta?.events` directly. But since the hook returns `JobStatus` with the extended schema, access it as:
   ```typescript
   const events = data?.pipeline_meta?.events ?? [];
   ```
   This works because Plan 01 added `pipeline_meta` to `jobStatusSchema` and the hook fetcher casts the response as `JobStatus`.

   WAIT — there's a subtlety. The `useJobStatus` hook in `hooks.ts` returns `data` typed as `JobStatus`, which is `z.infer<typeof jobStatusSchema>`. After Plan 01 extends `jobStatusSchema` to include `pipeline_meta`, `data?.pipeline_meta?.events` will be type-safe. So just use:
   ```typescript
   const events = data?.pipeline_meta?.events ?? [];
   ```

4. **Show ScrapeProgressPanel during active scraping** — replace or add ABOVE the existing `{hasValidResult && ...}` block. When job is active (not terminal, not timed out), show the progress panel:
   ```tsx
   {/* Progress panel during active scraping */}
   {jobId && !isTerminal && !isTimedOut && events.length > 0 && (
     <div className="mt-6">
       <ScrapeProgressPanel events={events} />
     </div>
   )}
   ```

5. **Replace BrandResultsGallery with BrandCard** — find the existing block:
   ```tsx
   {hasValidResult && parsed.success && (
     <div className="mt-6">
       <BrandResultsGallery
         result={parsed.data}
         brandJsonUrl={data.brand_json_url ?? undefined}
         assetsZipUrl={data.assets_zip_url ?? undefined}
       />
     </div>
   )}
   ```
   Replace with:
   ```tsx
   {hasValidResult && parsed.success && token && (
     <div className="mt-6">
       <BrandCard
         result={parsed.data}
         brandJsonUrl={data.brand_json_url ?? undefined}
         jobId={jobId}
         token={token}
       />
     </div>
   )}
   ```
   Note: `token` is already in the component state. `jobId` is also available. The `assetsZipUrl` prop is removed because the Brand Card handles zip creation on-demand via the proxy route.

6. **Keep existing functionality intact:**
   - JobStatusIndicator at the top (unchanged)
   - Unparseable result fallback (unchanged)
   - Failed job error display (unchanged)
   - "Scrape Another URL" button (unchanged)
   - "Check Again" timeout button (unchanged)
   - Balance display and URL form (unchanged)

**Do NOT change:**
- The form, billing, or auth logic
- The handleSubmit, handleNewScrape, or fetchBilling functions
- The error handling or timeout logic
- The AuthGuard wrapper

The only structural changes are: remove BrandResultsGallery import, add ScrapeProgressPanel and BrandCard imports, add events extraction, add progress panel conditional render, replace gallery with BrandCard.
  </action>
  <verify>
Run `npx tsc --noEmit` — zero type errors. Run `npm run lint` — clean. Run `npm run test` — all tests pass. Verify the file no longer imports BrandResultsGallery. Verify it imports ScrapeProgressPanel and BrandCard. Verify the progress panel renders when events exist during polling. Verify BrandCard renders on terminal success with parsed result.
  </verify>
  <done>UserBrandScraperPage shows ScrapeProgressPanel during active scraping (with live page + file lists) and BrandCard on completion (replacing the old 2x2 gallery), with all existing functionality preserved.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run lint` passes clean
3. `npm run test` — all existing tests still pass
4. UserBrandScraperPage.tsx does NOT import BrandResultsGallery
5. UserBrandScraperPage.tsx DOES import ScrapeProgressPanel and BrandCard
6. Progress panel shows during active polling when events are available
7. Brand Card replaces gallery on terminal success
8. All existing UI (form, billing, error handling, timeout) unchanged
</verification>

<success_criteria>
- Single wide Brand Card replaces old 2x2 gallery (CARD-01)
- Browser-tab header with favicon + hostname visible (CARD-02)
- Logos, colors, description, and download buttons all render (CARD-03 through CARD-06)
- Progress panel shows live page + file lists during scraping (PROG-04)
- Zip proxy route is used for "Download Assets" button (ASST-05)
- All Phase 29 success criteria are met
- All quality gates pass
</success_criteria>

<output>
After completion, create `.planning/phases/29-brand-card-progress-ui/29-03-SUMMARY.md`
</output>
