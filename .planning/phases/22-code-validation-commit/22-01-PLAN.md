---
phase: 22-code-validation-commit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .gitignore
  - .planning/REQUIREMENTS.md
  - .planning/ROADMAP.md
autonomous: true

must_haves:
  truths:
    - ".gitignore excludes node_modules at any depth (not just root)"
    - "repo.zip is gitignored and will never be accidentally committed"
    - "npm run build completes with zero TypeScript errors"
    - "npm run lint completes with zero Biome errors"
    - "npm test passes all 26 test cases"
    - "All ~2,810 LOC of billing, auth, and tool integration code is committed to master"
    - "No secrets, debug artifacts, repo.zip, or cache files are in the commit"
  artifacts:
    - path: ".gitignore"
      provides: "Corrected node_modules pattern and repo.zip exclusion"
      contains: "^node_modules$"
    - path: ".planning/REQUIREMENTS.md"
      provides: "Corrected test count"
      contains: "all 26 existing test cases"
    - path: ".planning/ROADMAP.md"
      provides: "Corrected test count"
      contains: "26"
  key_links:
    - from: ".gitignore"
      to: "git add"
      via: "gitignore pattern prevents src/node_modules from staging"
      pattern: "^node_modules$"
    - from: "git add (explicit paths)"
      to: "git commit"
      via: "only billing files staged, no repo.zip or cache"
      pattern: "src/app/api|src/lib/billing|src/components"
---

<objective>
Fix gitignore issues, correct planning doc test counts, run all quality gates, and commit the entire billing/credits system (~2,810 LOC, 29 new files + 9 modified files) to master.

Purpose: Establish a clean, validated baseline of billing code on master so deployment phases (23-25) have a known-good starting point.
Output: A single coherent commit on master containing all billing, auth, tool integration, and supporting config code.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-code-validation-commit/22-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix gitignore and correct planning doc test counts</name>
  <files>.gitignore, .planning/REQUIREMENTS.md, .planning/ROADMAP.md</files>
  <action>
    1. Edit `.gitignore`:
       - Change `/node_modules` (line 4) to `node_modules` (remove leading slash so it matches at any depth, covering both root `node_modules/` and `src/node_modules/` Vitest cache)
       - Add `repo.zip` on a new line at the end of the "# misc" section (after `.DS_Store` and `*.pem`)

    2. Edit `.planning/REQUIREMENTS.md`:
       - Line 14: Change "all 41 existing test cases" to "all 26 existing test cases"

    3. Edit `.planning/ROADMAP.md`:
       - Line 47 (Phase 22 Success Criteria #3): Change "passes all 41 existing test cases" to "passes all 26 existing test cases"

    These are the ONLY code/config changes needed for this phase. Research confirmed all three quality gates already pass with zero errors.
  </action>
  <verify>
    Run: `git check-ignore src/node_modules/test-file 2>/dev/null && echo "IGNORED" || echo "NOT IGNORED"` -- must print IGNORED.
    Run: `git check-ignore repo.zip 2>/dev/null && echo "IGNORED" || echo "NOT IGNORED"` -- must print IGNORED.
    Run: `grep "all 26 existing" .planning/REQUIREMENTS.md` -- must match.
    Run: `grep "26" .planning/ROADMAP.md | grep -i "test"` -- must show the corrected count.
  </verify>
  <done>
    .gitignore covers node_modules at any depth and excludes repo.zip.
    Planning docs reflect the actual test count of 26 (not 41).
  </done>
</task>

<task type="auto">
  <name>Task 2: Run quality gates, stage billing code, verify, and commit to master</name>
  <files>
    All 29 new files:
      src/app/api/admin/billing/pricing/route.ts
      src/app/api/admin/billing/usage/[usageId]/refund/route.ts
      src/app/api/admin/billing/users/route.ts
      src/app/api/admin/billing/users/[uid]/route.ts
      src/app/api/admin/billing/users/[uid]/adjust/route.ts
      src/app/api/billing/checkout/route.ts
      src/app/api/billing/me/route.ts
      src/app/api/billing/webhook/route.ts
      src/app/api/tools/brand-scraper/jobs/[id]/route.ts
      src/app/api/tools/brand-scraper/scrape/route.ts
      src/app/apps/brand-scraper/page.tsx
      src/app/billing/page.tsx
      src/app/billing/cancel/page.tsx
      src/app/billing/success/page.tsx
      src/app/control-center/billing/page.tsx
      src/app/control-center/billing/[uid]/page.tsx
      src/components/admin/billing/AdminBillingPage.tsx
      src/components/admin/billing/AdminBillingUserDetail.tsx
      src/components/auth/AuthGuard.tsx
      src/components/billing/BillingPage.tsx
      src/components/tools/brand-scraper/UserBrandScraperPage.tsx
      src/lib/auth/user.ts
      src/lib/billing/__tests__/credits.test.ts
      src/lib/billing/__tests__/types.test.ts
      src/lib/billing/firestore.ts
      src/lib/billing/stripe.ts
      src/lib/billing/tools.ts
      src/lib/billing/types.ts
      vitest.config.ts

    All 9 modified tracked files:
      .env.local.example
      cloudbuild.yaml
      docs/DEPLOYMENT.md
      package-lock.json
      package.json
      scripts/deploy.sh
      src/components/admin/ControlCenterNav.tsx
      src/components/layout/AuthButton.tsx
      src/lib/brand-scraper/hooks.ts

    Plus the files from Task 1:
      .gitignore
      .planning/REQUIREMENTS.md
      .planning/ROADMAP.md
  </files>
  <action>
    Step 1 -- Run all three quality gates sequentially. All must pass:
      npm run build   (expect: 43 pages, 0 TS errors)
      npm run lint    (expect: 145 files, 0 errors)
      npm test        (expect: 26/26 tests pass)

    If any gate fails, STOP and fix the issue before proceeding. Research confirmed all gates pass, but re-running is mandatory to verify after gitignore changes.

    Step 2 -- Stage files explicitly. Do NOT use `git add -A` or `git add .`. Use explicit paths:

      # Stage gitignore fix and planning doc corrections
      git add .gitignore .planning/REQUIREMENTS.md .planning/ROADMAP.md

      # Stage all new billing directories
      git add \
        src/app/api/admin/billing/ \
        src/app/api/billing/ \
        src/app/api/tools/ \
        src/app/apps/ \
        src/app/billing/ \
        src/app/control-center/billing/ \
        src/components/admin/billing/ \
        src/components/auth/ \
        src/components/billing/ \
        src/components/tools/ \
        src/lib/auth/user.ts \
        src/lib/billing/ \
        vitest.config.ts

      # Stage modified tracked files
      git add \
        .env.local.example \
        cloudbuild.yaml \
        docs/DEPLOYMENT.md \
        package-lock.json \
        package.json \
        scripts/deploy.sh \
        src/components/admin/ControlCenterNav.tsx \
        src/components/layout/AuthButton.tsx \
        src/lib/brand-scraper/hooks.ts

    Step 3 -- Verify staged diff before committing:
      Run `git diff --staged --stat` to see file count and line changes.
      Run `git diff --staged -- .env.local.example` to confirm no real secrets (only placeholder variable names).
      Verify: no `repo.zip`, no `src/node_modules/`, no `.env` files (other than `.env.local.example`), no `console.log` or `debugger` statements in staged files.

    Step 4 -- Commit with descriptive message:
      git commit -m "feat(billing): add billing, credits, auth, and tool integration system

      Add ~2,810 LOC across 29 new files implementing:
      - Ledger-based credits system with Firestore transactions
      - Stripe Checkout integration (webhook, checkout, success/cancel pages)
      - Firebase Auth user verification (verifyUser/verifyAdmin)
      - Brand scraper user flow with credit debit/refund
      - Admin billing panel (user list, detail, adjust credits, refund, pricing)
      - AuthGuard component for protected routes
      - Vitest test suite (26 tests across types and credits)

      Also includes:
      - .gitignore fix for nested node_modules (Vitest cache)
      - Updated nav links (billing in Control Center + user dropdown)
      - Deploy config for Stripe secrets and brand scraper URL
      - Planning doc corrections (test count 41 -> 26)"

    Step 5 -- Post-commit verification:
      Run `npm run build && npm run lint && npm test` again to confirm everything still passes after commit.
      Run `git status` to confirm clean working tree (only repo.zip and src/node_modules/ should remain as untracked, both gitignored).
      Run `git log --oneline -1` to confirm commit message looks correct.
  </action>
  <verify>
    Pre-commit gates: `npm run build` exits 0, `npm run lint` exits 0, `npm test` shows 26/26 pass.
    Staged diff: `git diff --staged --stat` shows ~40 files changed, ~2,810 insertions.
    No forbidden content: `git diff --staged` contains no API keys, no `console.log`, no `debugger`.
    Post-commit: `npm run build && npm run lint && npm test` all pass.
    Clean tree: `git status` shows no unstaged billing files. Only `repo.zip` and possibly `src/node_modules/` remain (both gitignored).
    Commit exists: `git log --oneline -1` shows the billing commit on master.
  </verify>
  <done>
    All three quality gates pass (build, lint, 26/26 tests).
    All billing code is committed to master in a single coherent commit.
    Working tree is clean of billing-related unstaged files.
    No secrets, debug artifacts, cache files, or repo.zip in the commit.
  </done>
</task>

</tasks>

<verification>
Phase 22 is complete when ALL of the following are true:

1. `npm run build` completes with zero TypeScript errors (exit code 0)
2. `npm run lint` completes with zero Biome errors (exit code 0)
3. `npm test` passes all 26 test cases (exit code 0)
4. `git log --oneline -1` shows the billing commit on master
5. `git status` shows no unstaged billing files
6. `.gitignore` properly excludes `node_modules` at any depth and `repo.zip`
7. Planning docs (REQUIREMENTS.md, ROADMAP.md) reflect correct test count of 26
</verification>

<success_criteria>
- VAL-01: `npm run build` passes with zero errors -- VERIFIED by pre-commit and post-commit gate runs
- VAL-02: `npm run lint` passes with zero errors -- VERIFIED by pre-commit and post-commit gate runs
- VAL-03: `npm test` passes all 26 test cases -- VERIFIED by pre-commit and post-commit gate runs
- VAL-04: All billing code committed to master -- VERIFIED by git log showing commit and git status showing clean tree
</success_criteria>

<output>
After completion, create `.planning/phases/22-code-validation-commit/22-01-SUMMARY.md`
</output>
