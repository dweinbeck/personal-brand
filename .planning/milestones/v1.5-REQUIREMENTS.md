# Requirements Archive: v1.5 Billing & Credits System

**Archived:** 2026-02-10
**Status:** SHIPPED

This is the archived requirements specification for v1.5.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

## v1.5 Requirements

Requirements for Billing & Credits System -- validate, configure, deploy.

### Code Validation

- [x] **VAL-01**: Billing code passes `npm run build` with zero TypeScript errors
- [x] **VAL-02**: Billing code passes `npm run lint` with zero Biome errors
- [x] **VAL-03**: Billing tests pass via `npm test` (all 26 existing test cases)
- [x] **VAL-04**: All billing code committed to master (~3K LOC across 30+ files)

### Infrastructure -- Stripe

- [x] **INFRA-01**: Stripe secrets (stripe-secret-key, stripe-webhook-secret) created in GCP Secret Manager
- [x] **INFRA-02**: Stripe webhook endpoint registered in Stripe Dashboard pointing to `https://dan-weinbeck.com/api/billing/webhook` listening for `checkout.session.completed`
- [x] **INFRA-03**: Cloud Run service account has `secretmanager.secretAccessor` on both Stripe secrets

### Infrastructure -- Firebase Auth

- [x] **INFRA-04**: `dan-weinbeck.com` and Cloud Run `.run.app` domain added to Firebase Auth authorized domains
- [x] **INFRA-05**: Google Sign-In provider enabled in Firebase Console
- [x] **INFRA-06**: `NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN` correctly set in Cloud Build trigger substitutions

### Infrastructure -- Firestore

- [x] **INFRA-07**: Composite indexes created for billing queries (`billing_tool_usage` uid+createdAt, uid+externalJobId; `billing_purchases` uid+createdAt)
- [x] **INFRA-08**: Tool pricing seed data populated in production Firestore (`brand_scraper` active at 50 credits, 3 inactive placeholders)
- [x] **INFRA-09**: Firestore security rules deny client-side access to all billing collections

### Infrastructure -- Deploy

- [x] **INFRA-10**: Billing-enabled build deployed to Cloud Run via Cloud Build
- [x] **INFRA-11**: All Cloud Build trigger substitution variables verified (Firebase, Stripe, Brand Scraper URL)

### Brand Scraper v1.1 Integration

- [x] **BSINT-01**: `BRAND_SCRAPER_API_URL` updated to real Cloud Run URL when brand-scraper v1.1 is deployed
- [x] **BSINT-02**: GCS signed URL passthrough verified end-to-end (brand_json_url and assets_zip_url render as download buttons) -- ACCEPTED: code is correct, blocked on external brand scraper worker not processing jobs. Will resolve when worker is deployed.

### End-to-End Validation

- [x] **E2E-01**: User can sign in with Google on production domain
- [x] **E2E-02**: New user receives 100 free credits on first sign-in (signup grant)
- [x] **E2E-03**: User can purchase 500 credits for $5 via Stripe Checkout (test mode)
- [x] **E2E-04**: Stripe webhook fires and credits are granted after purchase
- [x] **E2E-05**: User can submit a brand scrape and credits are debited (50 credits)
- [x] **E2E-06**: Failed scrape job auto-refunds credits to user -- ACCEPTED: code is correct, blocked on external brand scraper worker. Admin can manually refund as workaround.
- [x] **E2E-07**: Admin can view all billing users with balance and margin data
- [x] **E2E-08**: Admin can adjust credits and refund usage from user detail page
- [x] **E2E-09**: Admin can edit tool pricing from pricing tab
- [x] **E2E-10**: Live mode verified -- real $5 purchase completes and credits are granted

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| VAL-01 | Phase 22 | Complete |
| VAL-02 | Phase 22 | Complete |
| VAL-03 | Phase 22 | Complete |
| VAL-04 | Phase 22 | Complete |
| INFRA-01 | Phase 23 | Complete |
| INFRA-02 | Phase 23 | Complete |
| INFRA-03 | Phase 23 | Complete |
| INFRA-04 | Phase 23 | Complete |
| INFRA-05 | Phase 23 | Complete |
| INFRA-06 | Phase 23 | Complete |
| INFRA-07 | Phase 23 | Complete |
| INFRA-08 | Phase 23 | Complete |
| INFRA-09 | Phase 23 | Complete |
| INFRA-10 | Phase 24 | Complete |
| INFRA-11 | Phase 24 | Complete |
| BSINT-01 | Phase 24 | Complete |
| BSINT-02 | Phase 24 | Accepted (external blocker) |
| E2E-01 | Phase 24 | Complete |
| E2E-02 | Phase 24 | Complete |
| E2E-03 | Phase 24 | Complete |
| E2E-04 | Phase 24 | Complete |
| E2E-05 | Phase 24 | Complete |
| E2E-06 | Phase 24 | Accepted (external blocker) |
| E2E-07 | Phase 24 | Complete |
| E2E-08 | Phase 24 | Complete |
| E2E-09 | Phase 24 | Complete |
| E2E-10 | Phase 25 | Complete |

**Coverage:**
- v1.5 requirements: 27 total
- Complete: 25
- Accepted (external blocker): 2
- Unmapped: 0

---

## Milestone Summary

**Shipped:** 25 of 27 v1.5 requirements
**Adjusted:**
- BSINT-02: Marked as accepted despite external blocker -- billing code is correct, download button code exists and is wired correctly
- E2E-06: Marked as accepted despite external blocker -- auto-refund code exists and is correct, admin can manually refund as workaround

**Dropped:** None

---
*Archived: 2026-02-10 as part of v1.5 milestone completion*
