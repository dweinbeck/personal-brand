# Milestone v1.5: Billing & Credits System

**Status:** SHIPPED 2026-02-10
**Phases:** 22-25
**Total Plans:** 6

## Overview

Validate, configure infrastructure for, and deploy the existing billing/credits system with Stripe payments, Firebase Auth for end users, brand-scraper v1.1 integration, and admin billing management. This is a validation and deployment milestone -- the code already exists (~3K LOC, 30+ files).

## Phases

### Phase 22: Code Validation & Commit

**Goal**: Existing billing code passes all quality gates and is committed to master, establishing a clean baseline for deployment
**Depends on**: Nothing (first phase of v1.5)
**Plans**: 1 plan

Plans:
- [x] 22-01: Fix gitignore, correct planning docs, run quality gates, and commit all billing code to master

**Details:**
- Requirements: VAL-01, VAL-02, VAL-03, VAL-04
- Success Criteria: build passes (0 TS errors), lint passes (0 Biome errors), tests pass (26/26), all ~3K LOC committed
- Duration: 2 min
- Commits: 5641c98 (fix), ebeed66 (feat)
- Files: 38 (29 created, 9 modified)

### Phase 23: Infrastructure Configuration

**Goal**: All external services (GCP Secret Manager, Stripe, Firebase Auth, Firestore) are configured and ready to receive a deployment
**Depends on**: Phase 22
**Plans**: 2 plans

Plans:
- [x] 23-01: Create Firestore indexes, firebase.json, seed script, and fix DEPLOYMENT.md IAM instructions
- [x] 23-02: Execute infrastructure configuration: GCP secrets, Stripe webhook, Firebase Auth, Firestore deploy, Cloud Build verification

**Details:**
- Requirements: INFRA-01 through INFRA-09
- Success Criteria: Stripe secrets in GCP, webhook registered, Google Sign-In working, Firestore indexes/rules/seed data deployed
- Duration: ~10 min (2 min code + 8 min CLI execution)
- Commits: 6bb86f9 (chore), 95127fe (chore)
- Files: 4 (2 created, 2 modified) + external service configurations

### Phase 24: Deploy & Smoke Test

**Goal**: Billing-enabled site is live on Cloud Run and every user flow works end-to-end with Stripe test payments
**Depends on**: Phase 23
**Plans**: 2 plans

Plans:
- [x] 24-01: Trigger Cloud Build deployment and verify environment configuration
- [x] 24-02: Smoke test all E2E user flows (auth, billing, brand scraper, admin panel)

**Details:**
- Requirements: INFRA-10, INFRA-11, BSINT-01, BSINT-02, E2E-01 through E2E-09
- Success Criteria: User sign-in, signup grant, Stripe purchase, brand scrape debit, admin panel all working
- Duration: ~83 min (8 min deploy + 75 min smoke tests with 3 fix-deploy-retest cycles)
- Commits: 8d712fe (fix), 0032d40 (fix), 83bb137 (fix)
- Files: 6 modified (3 production bug fixes)
- Bugs fixed: Checkout redirect URL (X-Forwarded-Host), Zod null handling (.nullish()), admin refund scope expansion

### Phase 25: Go Live

**Goal**: Billing system accepts real payments with live Stripe keys
**Depends on**: Phase 24
**Plans**: 1 plan

Plans:
- [x] 25-01: Update GCP secrets with live Stripe keys, redeploy, and verify real $5 purchase

**Details:**
- Requirements: E2E-10
- Success Criteria: Live Stripe keys in GCP Secret Manager, real $5 purchase completes end-to-end
- Duration: ~8h 40m wall clock (mostly user action time for Stripe account activation)
- Zero code changes — pure infrastructure swap from test to live keys
- Secret Manager versions: stripe-secret-key v4, stripe-webhook-secret v3

---

## Milestone Summary

**Key Decisions:**

- Ledger-based Firestore credits (transaction-safe, idempotent, audit trail for all balance mutations)
- Firebase Auth for end users (Google Sign-In enables public tool access without building custom auth)
- Stripe Checkout redirect (not embedded, hosted payment page, PCI-compliant out of the box)
- IAM binding corrected to Cloud Run SA (cloudrun-site@) for runtime secret access
- Firebase auth domain uses *.firebaseapp.com (not custom domain — custom auth domains require Firebase Hosting)
- Admin can refund any non-refunded usage regardless of status (expanded from started/failed only)
- Used daniel.weinbeck@gmail.com for Stripe account (consistent with admin identity)

**Issues Resolved:**

- Stripe Checkout redirect URL returning 0.0.0.0 on Cloud Run (fixed with X-Forwarded-Host headers)
- Zod schema rejecting null values from brand scraper API (fixed .optional() → .nullish())
- Admin refund button hidden for succeeded usage records (expanded status check)
- Secret Manager secrets versioned up from placeholder values (v1 → v2 → v4 for live keys)
- Firebase CLI auth with wrong account (re-authenticated with project owner)
- Firestore seeding via REST API when local Admin SDK credentials unavailable

**Issues Deferred:**

- BSINT-02: GCS signed URL passthrough — blocked on external brand scraper worker not processing jobs
- E2E-06: Failed scrape auto-refund — blocked on external brand scraper worker (code is correct, cannot exercise)

**Technical Debt Incurred:**

None. All code is production-grade with proper error handling, comprehensive typing, and Firestore transaction safety. Zero TODO/FIXME/HACK comments.

---

_For current project status, see .planning/MILESTONES.md_
