---
phase: 43-prisma-database-foundation
plan: 03
type: execute
wave: 2
depends_on:
  - 43-01
files_modified:
  - src/lib/actions/tasks-test.ts
  - src/app/api/tasks-test/route.ts
autonomous: true
requirements:
  - DB-01
  - DB-04

must_haves:
  truths:
    - "A server action can query the PostgreSQL database and return workspace data"
    - "Existing data (workspaces, projects, tasks) is readable and unchanged"
    - "The Prisma client connects successfully when DATABASE_URL is set"
    - "A test API route exists to verify connectivity without deploying"
  artifacts:
    - path: "src/lib/actions/tasks-test.ts"
      provides: "Test server action that queries workspaces via Prisma"
      exports: ["getTestWorkspaces"]
    - path: "src/app/api/tasks-test/route.ts"
      provides: "GET endpoint to verify database connectivity"
      exports: ["GET"]
  key_links:
    - from: "src/lib/actions/tasks-test.ts"
      to: "src/lib/prisma.ts"
      via: "import prisma singleton"
      pattern: "import.*prisma.*from.*@/lib/prisma"
    - from: "src/lib/actions/tasks-test.ts"
      to: "prisma.workspace.findMany"
      via: "Prisma query"
      pattern: "prisma\\.workspace\\.(findMany|count)"
    - from: "src/app/api/tasks-test/route.ts"
      to: "src/lib/actions/tasks-test.ts"
      via: "imports test action"
      pattern: "import.*getTestWorkspaces"
---

<objective>
Create a test server action and API route to verify that the personal-brand app can read from the existing PostgreSQL database via Prisma.

Purpose: Confirm end-to-end database connectivity and that existing Tasks data (workspaces, projects, tasks) is accessible and unchanged after Prisma integration. This verifies DB-01 (Prisma connects) and DB-04 (existing data preserved).
Output: Test action and API route that can be hit locally or after deployment to verify database connectivity.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-prisma-database-foundation/43-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test server action for database connectivity</name>
  <files>src/lib/actions/tasks-test.ts</files>
  <action>
Create `src/lib/actions/tasks-test.ts` with a test function that queries the existing PostgreSQL database:

```typescript
"use server";

import { prisma } from "@/lib/prisma";

/**
 * Test action to verify Prisma can connect to the PostgreSQL database
 * and read existing Tasks data. This is a temporary verification action
 * that will be removed once Phase 44 migrates the real server actions.
 */
export async function getTestWorkspaces() {
  try {
    // Count total records to verify connectivity
    const [workspaceCount, projectCount, taskCount] = await Promise.all([
      prisma.workspace.count(),
      prisma.project.count(),
      prisma.task.count(),
    ]);

    // Fetch first workspace with its projects to verify relations work
    const firstWorkspace = await prisma.workspace.findFirst({
      include: {
        projects: {
          select: {
            id: true,
            name: true,
            _count: {
              select: { tasks: true },
            },
          },
          take: 3,
        },
      },
    });

    return {
      success: true,
      counts: {
        workspaces: workspaceCount,
        projects: projectCount,
        tasks: taskCount,
      },
      sampleWorkspace: firstWorkspace
        ? {
            id: firstWorkspace.id,
            name: firstWorkspace.name,
            projectCount: firstWorkspace.projects.length,
            projects: firstWorkspace.projects.map((p) => ({
              id: p.id,
              name: p.name,
              taskCount: p._count.tasks,
            })),
          }
        : null,
    };
  } catch (error) {
    return {
      success: false,
      error: error instanceof Error ? error.message : "Unknown error",
    };
  }
}
```

This action:
- Uses the Prisma singleton from Plan 01
- Counts workspaces, projects, and tasks to verify connectivity
- Fetches one workspace with related projects to verify relations work
- Returns structured data (no sensitive info) for verification
- Wraps in try/catch so connection errors are reported, not thrown
- Is a "use server" directive so it can be called from both server and client code
- Does NOT modify any data (read-only queries only — critical for DB-04)
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles. Run `npm run lint` to verify lint passes. Run `npm run build` to verify build succeeds.
  </verify>
  <done>src/lib/actions/tasks-test.ts exports getTestWorkspaces function that performs read-only queries against PostgreSQL, compiles without errors</done>
</task>

<task type="auto">
  <name>Task 2: Create test API route for connectivity verification</name>
  <files>src/app/api/tasks-test/route.ts</files>
  <action>
Create `src/app/api/tasks-test/route.ts` — a GET endpoint that calls the test action and returns the results as JSON:

```typescript
import { NextResponse } from "next/server";
import { getTestWorkspaces } from "@/lib/actions/tasks-test";

export async function GET() {
  const result = await getTestWorkspaces();

  if (!result.success) {
    return NextResponse.json(result, { status: 500 });
  }

  return NextResponse.json(result);
}
```

This route:
- Exposes the test action as a simple GET endpoint at `/api/tasks-test`
- Returns 200 with counts and sample data on success
- Returns 500 with error message on connection failure
- Has NO authentication (temporary test endpoint — will be removed in Phase 44)
- Is read-only (no POST/PUT/DELETE)

After creating the files, verify the build passes:
1. Run `npm run build` — must succeed
2. Run `npm run lint` — must pass
3. Run `npm test` — must pass (existing tests should not break)

To test locally (if DATABASE_URL is configured in .env.local):
- Run `npm run dev` and `curl http://localhost:3000/api/tasks-test`
- Expected: JSON with `{ success: true, counts: { workspaces: N, projects: N, tasks: N }, sampleWorkspace: {...} }`
- If DATABASE_URL is not set locally, expect: `{ success: false, error: "..." }`

NOTE: This test endpoint and action are TEMPORARY. They will be removed when Phase 44 migrates the real Tasks server actions. Their purpose is solely to verify database connectivity for Phase 43 acceptance criteria.
  </action>
  <verify>
Run `npm run build` to verify the build completes. Run `npm run lint` to verify no lint errors. Run `npm test` to verify existing tests still pass. If DATABASE_URL is configured locally, run `curl http://localhost:3000/api/tasks-test` (with dev server running) and verify the response contains workspace/project/task counts.
  </verify>
  <done>GET /api/tasks-test endpoint returns database connectivity status and existing data counts, project builds and lints cleanly, existing tests pass</done>
</task>

</tasks>

<verification>
- `src/lib/actions/tasks-test.ts` exists and exports `getTestWorkspaces`
- `src/app/api/tasks-test/route.ts` exists and exports `GET`
- `npm run build` passes
- `npm run lint` passes
- `npm test` passes
- When DATABASE_URL is set, GET /api/tasks-test returns `{ success: true }` with workspace/project/task counts
- All queries are READ-ONLY (no mutations to existing data)
</verification>

<success_criteria>
A test server action and API route demonstrate that the personal-brand app can connect to the existing PostgreSQL database via Prisma and read workspace, project, and task data. Existing data is accessible and unchanged. The project builds, lints, and all existing tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/43-prisma-database-foundation/43-03-SUMMARY.md`
</output>
