---
phase: 43-prisma-database-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - prisma/schema.prisma
  - src/lib/prisma.ts
  - .gitignore
autonomous: true
requirements:
  - MIG-01
  - DB-01
  - DB-03

must_haves:
  truths:
    - "Prisma and @prisma/client are installed as dependencies"
    - "prisma/schema.prisma contains all 6 Tasks models identical to the standalone todoist app"
    - "Prisma client can be generated without errors"
    - "A singleton Prisma client module exists for import by server actions"
    - "DATABASE_URL is documented and .gitignore excludes generated Prisma output"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Prisma schema with 6 models (Workspace, Project, Section, Task, Tag, TaskTag)"
      contains: "model Workspace"
    - path: "src/lib/prisma.ts"
      provides: "Singleton Prisma client for server-side use"
      exports: ["prisma"]
    - path: "package.json"
      provides: "prisma and @prisma/client dependencies"
      contains: "@prisma/client"
  key_links:
    - from: "src/lib/prisma.ts"
      to: "src/generated/prisma"
      via: "import from generated client"
      pattern: "from.*generated/prisma"
    - from: "prisma/schema.prisma"
      to: "src/generated/prisma"
      via: "generator output path"
      pattern: 'output.*src/generated/prisma'
---

<objective>
Install Prisma into the personal-brand project, copy the Tasks Prisma schema, configure the database connection, and generate the Prisma client.

Purpose: Establish the database foundation so that later plans can build Cloud Run deployment config and test server actions against the existing PostgreSQL database.
Output: Working Prisma setup with schema, generated client, and singleton module ready for import.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Prisma dependencies and copy schema</name>
  <files>package.json, prisma/schema.prisma, .gitignore</files>
  <action>
1. Install Prisma dependencies:
   ```
   npm install prisma@^6.19.2 @prisma/client@^6.19.2
   ```
   These versions match the standalone todoist app (see /Users/dweinbeck/ai/todoist/package.json).

2. Create `prisma/schema.prisma` with the EXACT content from the todoist app. The schema has:
   - generator: provider "prisma-client", output "../src/generated/prisma"
   - datasource: provider "postgresql", url from env("DATABASE_URL")
   - 6 models: Workspace, Project, Section, Task, Tag, TaskTag
   - All relations, indexes, and defaults must be identical

   CRITICAL: Do NOT modify ANY model, field, relation, index, or default. The schema must be byte-for-byte identical to the todoist app's schema. The existing PostgreSQL database was created from this schema and any deviation will cause errors or data corruption.

   Full schema to copy:
   ```prisma
   generator client {
     provider = "prisma-client"
     output   = "../src/generated/prisma"
   }

   datasource db {
     provider = "postgresql"
     url      = env("DATABASE_URL")
   }

   model Workspace {
     id        String    @id @default(cuid())
     userId    String
     name      String
     projects  Project[]
     createdAt DateTime  @default(now())
     updatedAt DateTime  @updatedAt

     @@index([userId])
   }

   model Project {
     id          String    @id @default(cuid())
     workspaceId String
     workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
     name        String
     viewMode    String    @default("list")
     sections    Section[]
     tasks       Task[]
     createdAt   DateTime  @default(now())
     updatedAt   DateTime  @updatedAt
   }

   model Section {
     id        String   @id @default(cuid())
     projectId String
     project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
     name      String
     order     Float    @default(0)
     tasks     Task[]
     createdAt DateTime @default(now())
     updatedAt DateTime @updatedAt
   }

   model Task {
     id           String    @id @default(cuid())
     userId       String
     projectId    String
     project      Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
     sectionId    String?
     section      Section?  @relation(fields: [sectionId], references: [id], onDelete: SetNull)
     parentTaskId String?
     parentTask   Task?     @relation("TaskSubtasks", fields: [parentTaskId], references: [id], onDelete: Cascade)
     subtasks     Task[]    @relation("TaskSubtasks")
     name         String
     description  String?
     deadlineAt   DateTime?
     status       String    @default("OPEN")
     effort       Int?
     order        Float     @default(0)
     tags         TaskTag[]
     createdAt    DateTime  @default(now())
     updatedAt    DateTime  @updatedAt

     @@index([userId, status])
     @@index([userId, deadlineAt])
   }

   model Tag {
     id     String    @id @default(cuid())
     userId String
     name   String
     color  String?
     tasks  TaskTag[]

     @@unique([userId, name])
     @@index([userId])
   }

   model TaskTag {
     taskId String
     task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
     tagId  String
     tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

     @@id([taskId, tagId])
   }
   ```

3. Update `.gitignore` to exclude the Prisma generated output directory. Add after the existing entries:
   ```
   # prisma
   /src/generated/prisma
   ```

4. Add a `db:generate` script to package.json scripts:
   ```json
   "db:generate": "prisma generate"
   ```
  </action>
  <verify>
Run `ls prisma/schema.prisma` to confirm file exists. Run `grep -c "model" prisma/schema.prisma` and verify it returns 6. Run `grep "@prisma/client" package.json` to confirm dependency is installed. Run `grep "src/generated/prisma" .gitignore` to confirm gitignore entry.
  </verify>
  <done>prisma/schema.prisma exists with all 6 models identical to todoist app, @prisma/client and prisma are in package.json dependencies, .gitignore excludes generated output, db:generate script added</done>
</task>

<task type="auto">
  <name>Task 2: Generate Prisma client and create singleton module</name>
  <files>src/lib/prisma.ts</files>
  <action>
1. Run `npx prisma generate` to generate the Prisma client into `src/generated/prisma/`. This requires no DATABASE_URL since generation only reads the schema — it does NOT connect to the database. The todoist Dockerfile uses a dummy DATABASE_URL for this exact reason.

   NOTE: If `prisma generate` requires DATABASE_URL to be set even for generation, set a dummy: `DATABASE_URL="postgresql://dummy:dummy@localhost:5432/dummy" npx prisma generate`

2. Create `src/lib/prisma.ts` — a singleton Prisma client module:
   ```typescript
   import { PrismaClient } from "@/generated/prisma";

   const globalForPrisma = globalThis as unknown as {
     prisma: PrismaClient | undefined;
   };

   export const prisma = globalForPrisma.prisma ?? new PrismaClient();

   if (process.env.NODE_ENV !== "production") {
     globalForPrisma.prisma = prisma;
   }
   ```

   This pattern prevents hot-reload from creating multiple Prisma clients in development. It matches the standard Next.js + Prisma singleton pattern.

   The import uses the `@/` path alias (mapped to `./src/*` in tsconfig.json), so `@/generated/prisma` resolves to `src/generated/prisma/` — the exact output path in the schema.

3. Verify the build still works: run `npm run build`. The Prisma client must be generated BEFORE the build since `src/lib/prisma.ts` imports from `@/generated/prisma`.

   If the build fails due to Prisma-related issues, check:
   - Is `src/generated/prisma/` populated? (Should have index.ts, client.ts, etc.)
   - Does the tsconfig `include` pattern `**/*.ts` cover `src/generated/prisma/*.ts`?
   - Is the Biome linter complaining about generated files? If so, add `src/generated` to biome.json's `files.ignore` array.
  </action>
  <verify>
Run `ls src/generated/prisma/index.ts` to confirm generated client exists. Run `npx tsc --noEmit src/lib/prisma.ts 2>&1 | head -5` or `npm run build` to verify no TypeScript errors. Run `npm run lint` to verify no lint errors (generated files may need Biome ignore).
  </verify>
  <done>Prisma client generated at src/generated/prisma/, singleton module at src/lib/prisma.ts compiles without errors, `npm run build` passes, `npm run lint` passes</done>
</task>

</tasks>

<verification>
- `prisma/schema.prisma` contains exactly 6 models: Workspace, Project, Section, Task, Tag, TaskTag
- `src/generated/prisma/` contains generated Prisma client files
- `src/lib/prisma.ts` exports a `prisma` singleton
- `npm run build` completes without errors
- `npm run lint` completes without errors
- `.gitignore` excludes `src/generated/prisma`
</verification>

<success_criteria>
Prisma is installed, the schema matches the todoist app exactly, the client generates successfully, the singleton module compiles, and the project builds and lints cleanly.
</success_criteria>

<output>
After completion, create `.planning/phases/43-prisma-database-foundation/43-01-SUMMARY.md`
</output>
