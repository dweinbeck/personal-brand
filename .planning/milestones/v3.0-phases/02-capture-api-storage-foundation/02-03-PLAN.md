---
phase: 02-capture-api-storage-foundation
plan: 03
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - src/app/api/gsd/capture/screenshot/route.ts
  - next.config.ts
autonomous: true
requirements:
  - CAP-SCREEN
  - CAP-ASYNC

must_haves:
  truths:
    - "POST /api/gsd/capture/screenshot with valid API key and screenshot file returns 202 with { status: 'queued', id }"
    - "POST /api/gsd/capture/screenshot without X-API-Key header returns 401"
    - "POST /api/gsd/capture/screenshot without a file returns 400"
    - "POST /api/gsd/capture/screenshot with file >10MB returns 413"
    - "POST /api/gsd/capture/screenshot with non-image content type returns 400"
    - "Screenshot is uploaded to Cloud Storage at gsd-captures/{id}/screenshot.{ext}"
    - "Capture document is written to Firestore with screenshotUrl referencing the gs:// path"
    - "next.config.ts has experimental.serverActions.bodySizeLimit set to '10mb'"
    - "Response time is under 5 seconds for typical screenshots (2-5MB)"
  artifacts:
    - path: "src/app/api/gsd/capture/screenshot/route.ts"
      provides: "Screenshot capture POST endpoint with multipart FormData handling"
      exports: ["POST"]
    - path: "next.config.ts"
      provides: "Body size limit increased to 10MB for screenshot uploads"
      contains: "bodySizeLimit"
  key_links:
    - from: "src/app/api/gsd/capture/screenshot/route.ts"
      to: "src/lib/auth/api-key.ts"
      via: "import verifyApiKey"
      pattern: "import.*verifyApiKey.*from.*auth/api-key"
    - from: "src/app/api/gsd/capture/screenshot/route.ts"
      to: "src/lib/gsd/storage.ts"
      via: "import uploadScreenshot"
      pattern: "import.*uploadScreenshot.*from.*gsd/storage"
    - from: "src/app/api/gsd/capture/screenshot/route.ts"
      to: "src/lib/gsd/capture.ts"
      via: "import saveCapture"
      pattern: "import.*saveCapture.*from.*gsd/capture"
---

<objective>
Create the screenshot capture endpoint at POST /api/gsd/capture/screenshot and increase the Next.js body size limit. This is the second input path for Builder OS: the user takes a screenshot and shares it via the iPhone Share Sheet, which sends the image as multipart form data to this endpoint.

Purpose: Enable screenshot ingest from iPhone Share Sheet. The endpoint validates the file, uploads to Cloud Storage, persists the capture reference to Firestore, and returns 202 immediately.

Output: One new route handler file and one config modification.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-capture-api-storage-foundation/02-RESEARCH.md
@.planning/phases/02-capture-api-storage-foundation/02-01-SUMMARY.md

# Pattern reference
@src/app/api/tools/brand-scraper/scrape/route.ts
@next.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add body size limit to next.config.ts</name>
  <files>next.config.ts</files>
  <action>
    Add the `experimental` section to the `nextConfig` object in `next.config.ts`. Place it after the existing `images` property:

    ```typescript
    experimental: {
      serverActions: {
        bodySizeLimit: "10mb",
      },
    },
    ```

    This is a global setting (no per-route override in App Router). 10MB is safe — existing API routes handle JSON payloads well under 1MB. iPhone screenshots are typically 2-8MB.

    The final nextConfig object should look like:
    ```typescript
    const nextConfig: NextConfig = {
      output: "standalone",
      pageExtensions: ["js", "jsx", "md", "mdx", "ts", "tsx"],
      images: {
        qualities: [25, 50, 75, 100],
      },
      experimental: {
        serverActions: {
          bodySizeLimit: "10mb",
        },
      },
      async redirects() { ... },
    };
    ```
  </action>
  <verify>
    1. `npm run build` succeeds (config is valid)
    2. `npm run lint` passes
    3. Verify the experimental section is inside the nextConfig object (not outside it)
  </verify>
  <done>
    - next.config.ts has experimental.serverActions.bodySizeLimit set to "10mb"
    - Build succeeds with the new config
  </done>
</task>

<task type="auto">
  <name>Task 2: Create screenshot capture route handler with tests</name>
  <files>
    src/app/api/gsd/capture/screenshot/route.ts
    src/lib/gsd/__tests__/screenshot-route.test.ts
  </files>
  <action>
    **2a. Create `src/app/api/gsd/capture/screenshot/route.ts`:**

    Implementation:

    ```typescript
    import { verifyApiKey, apiKeyUnauthorizedResponse } from "@/lib/auth/api-key";
    import { saveCapture } from "@/lib/gsd/capture";
    import { screenshotCaptureSchema } from "@/lib/gsd/schemas";
    import { uploadScreenshot } from "@/lib/gsd/storage";

    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
    const ALLOWED_TYPES = ["image/png", "image/jpeg", "image/jpg", "image/heic", "image/heif", "image/webp"];

    export async function POST(request: Request) {
      // 1. Auth check
      const auth = verifyApiKey(request);
      if (!auth.authorized) return apiKeyUnauthorizedResponse(auth);

      // 2. Parse multipart form data
      let formData: FormData;
      try {
        formData = await request.formData();
      } catch {
        return Response.json({ error: "Invalid form data." }, { status: 400 });
      }

      // 3. Extract screenshot file (case-insensitive field lookup for Shortcuts compatibility)
      const file = (formData.get("screenshot") ?? formData.get("Screenshot")) as File | null;
      if (!file || !(file instanceof File) || file.size === 0) {
        return Response.json({ error: "No screenshot provided." }, { status: 400 });
      }

      // 4. Validate file size
      if (file.size > MAX_FILE_SIZE) {
        return Response.json({ error: "File too large (10MB max)." }, { status: 413 });
      }

      // 5. Validate content type
      if (!ALLOWED_TYPES.includes(file.type)) {
        return Response.json(
          { error: "Invalid file type. Accepted: PNG, JPEG, HEIC, WebP." },
          { status: 400 },
        );
      }

      // 6. Parse optional context from form data
      const contextRaw = formData.get("context") ?? formData.get("Context");
      const contextStr = typeof contextRaw === "string" ? contextRaw : undefined;
      const metaParsed = screenshotCaptureSchema.safeParse({ context: contextStr });
      // If context validation fails, proceed without context (non-blocking)
      const context = metaParsed.success ? metaParsed.data.context : undefined;

      // 7. Upload to Cloud Storage
      const captureId = crypto.randomUUID();
      let screenshotUrl: string;
      try {
        const buffer = Buffer.from(await file.arrayBuffer());
        screenshotUrl = await uploadScreenshot(captureId, buffer, file.type);
      } catch (err) {
        console.error("Failed to upload screenshot:", err);
        return Response.json(
          { error: "Failed to upload screenshot." },
          { status: 500 },
        );
      }

      // 8. Persist capture to Firestore
      try {
        await saveCapture({
          id: captureId,
          type: "screenshot",
          screenshotUrl,
          context,
        });
      } catch (err) {
        console.error("Failed to save capture:", err);
        return Response.json(
          { error: "Failed to save capture." },
          { status: 500 },
        );
      }

      // 9. Async processing placeholder (Phase 3 will add LLM routing here)
      // processCapture(captureId).catch(console.error);

      // 10. Respond immediately
      return Response.json(
        { status: "queued", id: captureId },
        { status: 202 },
      );
    }
    ```

    Key decisions:
    - Case-insensitive field lookup (`screenshot` and `Screenshot`) for iPhone Shortcuts compatibility (Pitfall 12)
    - HEIC and WebP accepted as valid image types (iPhone sends HEIC natively)
    - Context validation failure is non-blocking (screenshot is the important part)
    - File is buffered to Buffer via `file.arrayBuffer()` — acceptable for <10MB files
    - Returns 202 with same format as dictation endpoint for consistent Shortcuts handling

    **2b. Create `src/lib/gsd/__tests__/screenshot-route.test.ts`:**

    Unit test with Vitest mocks:

    - Mock `@/lib/auth/api-key` (verifyApiKey, apiKeyUnauthorizedResponse)
    - Mock `@/lib/gsd/capture` (saveCapture)
    - Mock `@/lib/gsd/storage` (uploadScreenshot → returns "gs://test-bucket/gsd-captures/test-id/screenshot.png")

    Test cases:
    1. Valid PNG screenshot → 202 with { status: "queued", id }
    2. Valid JPEG screenshot → 202
    3. Screenshot with optional context field → 202, context passed to saveCapture
    4. Missing API key → 401
    5. No file in form data → 400
    6. File too large (>10MB) → 413
    7. Invalid content type (text/plain) → 400
    8. Cloud Storage upload failure → 500
    9. Firestore save failure → 500

    Create test File objects using `new File([buffer], "test.png", { type: "image/png" })` and FormData instances.
  </action>
  <verify>
    1. `npm run build` succeeds
    2. `npm run lint` passes
    3. `npm test -- --run src/lib/gsd/__tests__/screenshot-route.test.ts` — all 9 test cases pass
    4. `npm test` — all tests pass (no regressions)
  </verify>
  <done>
    - POST /api/gsd/capture/screenshot route handler handles multipart uploads
    - File validation covers size (10MB max), type (PNG/JPEG/HEIC/WebP), and presence
    - Case-insensitive form field lookup for Shortcuts compatibility
    - Screenshots uploaded to Cloud Storage, reference stored in Firestore
    - All 9 test cases pass
    - Build succeeds with body size limit config change
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` — zero errors
2. `npm run build` — zero errors (includes next.config.ts validation)
3. `npm test` — all tests pass including new screenshot route tests
4. Manual verification: next.config.ts contains `bodySizeLimit: "10mb"` inside experimental.serverActions
5. Manual curl test (if dev server running with FIREBASE_STORAGE_BUCKET set):
   - `curl -X POST http://localhost:3000/api/gsd/capture/screenshot -H "X-API-Key: $GSD_API_KEY" -F "screenshot=@test-image.png"` returns 202
</verification>

<success_criteria>
- next.config.ts has 10MB body size limit configured
- Route handler exists at src/app/api/gsd/capture/screenshot/route.ts
- POST returns 202 with { status: "queued", id } for valid screenshot uploads
- File validation rejects oversized and wrong-type files with appropriate status codes
- Case-insensitive field name matching for Shortcuts compatibility
- All tests pass, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-capture-api-storage-foundation/02-03-SUMMARY.md`
</output>
